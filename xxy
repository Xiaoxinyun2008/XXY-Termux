#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v32.0 - Termux é€šç”¨å®¹å™¨ç®¡ç†å™¨
# AI ä¼˜åŒ–ç‰ˆæœ¬ - ä¸“æ³¨äºç¨³å®šæ€§ã€æµç•…åº¦ä¸å®‰å…¨æ€§
# ==============================================================================

# --- [0] å…¨å±€é…ç½® ---
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export VERSION="32.0"
export TMP_DIR="$PREFIX/tmp/xxy_$$"
export WORKER_SCRIPT="$TMP_DIR/worker.sh"

# æ”¯æŒçš„å‘è¡Œç‰ˆ
declare -A DISTRO_NAMES=(
    [1]="ubuntu"
    [2]="debian"
    [3]="kali"
    [4]="archlinux"
    [5]="alpine"
)

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# ç»ˆç«¯çŠ¶æ€ä¿å­˜
SAVED_STTY=$(stty -g 2>/dev/null || echo "")

# ==============================================================================
# ğŸ›¡ï¸ å®‰å…¨æ ¸å¿ƒï¼šè‡ªåŠ¨æ¢å¤æœºåˆ¶
# ==============================================================================
safe_exit() {
    # æ¢å¤ç»ˆç«¯è®¾ç½®
    if [ -n "$SAVED_STTY" ]; then
        stty "$SAVED_STTY" 2>/dev/null || true
    fi
    # æ¢å¤å…‰æ ‡å’Œå›æ˜¾
    tput cnorm 2>/dev/null || true
    stty echo 2>/dev/null || true
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_temp_files
    echo -e "\n${G}[XXY] å·²å®‰å…¨é€€å‡ºã€‚${NC}"
    exit 0
}

cleanup_temp_files() {
    rm -rf "$TMP_DIR" 2>/dev/null || true
    rm -f "$PREFIX/tmp/worker_*.sh" 2>/dev/null || true
}

# ä¿¡å·æ•è· - è‡ªåŠ¨æ¢å¤
trap 'safe_exit' EXIT INT TERM

# åˆå§‹åŒ–æ—¶ç¡®ä¿ç»ˆç«¯æ­£å¸¸
tput cnorm 2>/dev/null || true
stty echo 2>/dev/null || true

# ==============================================================================
# ğŸ”§ å·¥å…·å‡½æ•°
# ==============================================================================
log() { printf "${G}[XXY] %s${NC}\n" "$1"; }
warn() { printf "${Y}[æç¤º] %s${NC}\n" "$1"; }
err() { printf "${R}[é”™è¯¯] %s${NC}\n" "$1"; }

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# è·å–å·²å®‰è£…çš„ç³»ç»Ÿåˆ—è¡¨
get_installed_distros() {
    proot-distro list 2>/dev/null | grep -E "^\s" | awk '{print $1}' | grep -v "^$" || echo ""
}

# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å·²å®‰è£…
is_distro_installed() {
    local distro=$1
    [ -d "$PREFIX/var/lib/proot-distro/installed-rootfs/$distro" ]
}

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒæ¨¡å—ï¼šåˆ›å»ºç³»ç»Ÿé…ç½®è„šæœ¬
# ==============================================================================
create_worker_script() {
    local distro=$1
    mkdir -p "$TMP_DIR"
    
    case "$distro" in
        debian|ubuntu)
            cat > "$WORKER_SCRIPT" << 'DEBIAN_EOF'
#!/bin/bash
set -e

echo ">>> [å†…éƒ¨] æ­£åœ¨é…ç½®å›½å†…æº..."
# æ£€æµ‹ Debian/Ubuntu ç‰ˆæœ¬
if [ -f /etc/os-release ]; then
    . /etc/os-release
    CODENAME=$(echo $VERSION_CODENAME | tr '[:upper:]' '[:lower:]')
else
    CODENAME="bookworm"
fi

# Debian æºé…ç½®
if [ "$ID" = "debian" ]; then
    cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $CODENAME main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $CODENAME-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security $CODENAME-security main contrib non-free non-free-firmware
SOURCES
# Ubuntu æºé…ç½®
elif [ "$ID" = "ubuntu" ]; then
    cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ $CODENAME main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ $CODENAME-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ $CODENAME-security main restricted universe multiverse
SOURCES
fi

echo ">>> [å†…éƒ¨] æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
apt update -y
export DEBIAN_FRONTEND=noninteractive

echo ">>> [å†…éƒ¨] å®‰è£…åŸºç¡€å·¥å…·å’Œä¸­æ–‡æ”¯æŒ..."
apt install -y sudo nano wget curl git locales \
    fonts-noto-cjk fonts-noto-color-emoji

echo ">>> [å†…éƒ¨] é…ç½®ä¸­æ–‡ç¯å¢ƒ..."
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

echo ">>> [å†…éƒ¨] é…ç½®ç¯å¢ƒå˜é‡..."
cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh

echo ">>> [å†…éƒ¨] æ¸…ç†ç¼“å­˜..."
apt autoremove -y 2>/dev/null || true
apt clean 2>/dev/null || true

echo ">>> [å†…éƒ¨] é…ç½®å®Œæˆï¼"
DEBIAN_EOF
            ;;
        kali)
            cat > "$WORKER_SCRIPT" << 'KALI_EOF'
#!/bin/bash
set -e

echo ">>> [å†…éƒ¨] é…ç½® Kali æº..."
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free non-free-firmware
SOURCES

apt update -y
export DEBIAN_FRONTEND=noninteractive

apt install -y sudo nano wget curl git locales \
    fonts-noto-cjk fonts-noto-color-emoji

sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8

cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh

apt autoremove -y 2>/dev/null || true
apt clean 2>/dev/null || true
KALI_EOF
            ;;
        archlinux)
            cat > "$WORKER_SCRIPT" << 'ARCH_EOF'
#!/bin/bash
set -e

echo ">>> [å†…éƒ¨] é…ç½® Arch Linux æº..."
sed -i 's|^#Server|Server|' /etc/pacman.d/mirrorlist
sed -i 's|Server = https://mirror.archlinuxarm.org|Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm|' /etc/pacman.d/mirrorlist

echo ">>> [å†…éƒ¨] æ›´æ–°ç³»ç»Ÿ..."
pacman -Syu --noconfirm

echo ">>> [å†…éƒ¨] å®‰è£…åŸºç¡€å·¥å…·..."
pacman -S --noconfirm sudo nano wget curl git \
    noto-fonts-cjk noto-fonts-emoji

echo ">>> [å†…éƒ¨] é…ç½®ä¸­æ–‡ç¯å¢ƒ..."
echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen

cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh

pacman -Sc --noconfirm 2>/dev/null || true
ARCH_EOF
            ;;
        alpine)
            cat > "$WORKER_SCRIPT" << 'ALPINE_EOF'
#!/bin/bash
set -e

echo ">>> [å†…éƒ¨] é…ç½® Alpine æº..."
cat > /etc/apk/repositories << REPOS
https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.19/main
https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.19/community
REPOS

apk update
apk add sudo nano wget curl git \
    font-noto-cjk font-noto-emoji

echo ">>> [å†…éƒ¨] é…ç½®ä¸­æ–‡ç¯å¢ƒ..."
cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh
ALPINE_EOF
            ;;
    esac
    
    chmod +x "$WORKER_SCRIPT"
}

# ==============================================================================
# ğŸ¨ è‡ªåŠ¨ç¾åŒ–ï¼šé…ç½® neofetch
# ==============================================================================
setup_neofetch() {
    local distro=$1
    local rootfs="$PREFIX/var/lib/proot-distro/installed-rootfs/$distro"
    
    # ç§»é™¤æ—§çš„ neofetch é…ç½®
    rm -f "$rootfs/etc/neofetch/config.conf" 2>/dev/null || true
    rm -f "$rootfs/root/.config/neofetch/config.conf" 2>/dev/null || true
    
    # åˆ›å»ºç®€æ´çš„å¯åŠ¨ä¿¡æ¯è„šæœ¬
    cat > "$rootfs/etc/profile.d/xxy_welcome.sh" << 'WELCOME_EOF'
#!/bin/bash
if [ -t 0 ] && [ "$PS1" ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  ğŸ§ Linux å®¹å™¨ç¯å¢ƒ"
    echo "  ğŸ“¦ $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
    echo "  ğŸ’» $(uname -m)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
fi
WELCOME_EOF
    chmod +x "$rootfs/etc/profile.d/xxy_welcome.sh" 2>/dev/null || true
}

# ==============================================================================
# ğŸ”§ åŠŸèƒ½å‡½æ•°
# ==============================================================================

# --- ç³»ç»Ÿç™»å½• ---
login_system() {
    local installed=$(get_installed_distros)
    if [ -z "$installed" ]; then
        err "æ²¡æœ‰å·²å®‰è£…çš„ç³»ç»Ÿï¼è¯·å…ˆå®‰è£…ä¸€ä¸ªç³»ç»Ÿã€‚"
        sleep 2
        return
    fi
    
    clear
    echo -e "${B}â”Œâ”€â”€ [ç™»å½•ç³»ç»Ÿ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${G}å·²å®‰è£…çš„ç³»ç»Ÿï¼š${NC}"
    
    local i=1
    local distros=()
    while IFS= read -r distro; do
        if [ -n "$distro" ]; then
            echo -e "  $i. ${C}$distro${NC}"
            distros+=("$distro")
            ((i++))
        fi
    done <<< "$installed"
    
    echo -e "  0. è¿”å›"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    read -p "ğŸ‘‰ é€‰æ‹©ç³»ç»Ÿ: " choice
    
    if [ "$choice" = "0" ] || [ -z "$choice" ]; then
        return
    fi
    
    local selected_distro="${distros[$((choice-1))]}"
    if [ -z "$selected_distro" ]; then
        err "æ— æ•ˆçš„é€‰æ‹©ï¼"
        sleep 1
        return
    fi
    
    # åº”ç”¨ç¾åŒ–
    setup_neofetch "$selected_distro"
    
    log "æ­£åœ¨ç™»å½• $selected_distro..."
    proot-distro login "$selected_distro" --shared-tmp
}

# --- å®‰è£…ç³»ç»Ÿ ---
install_system() {
    clear
    echo -e "${B}â”Œâ”€â”€ [å®‰è£…æ–°ç³»ç»Ÿ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "1. ${G}Ubuntu${NC}"
    echo -e "2. ${G}Debian${NC}"
    echo -e "3. ${G}Kali Linux${NC}"
    echo -e "4. ${G}Arch Linux${NC}"
    echo -e "5. ${G}Alpine${NC}"
    echo -e "0. è¿”å›"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    read -p "ğŸ‘‰ é€‰æ‹©ç³»ç»Ÿ: " choice
    
    if [ "$choice" = "0" ] || [ -z "$choice" ] || [ "$choice" -lt 1 ] || [ "$choice" -gt 5 ]; then
        return
    fi
    
    local distro="${DISTRO_NAMES[$choice]}"
    local rootfs="$PREFIX/var/lib/proot-distro/installed-rootfs/$distro"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if is_distro_installed "$distro"; then
        warn "ç³»ç»Ÿ $distro å·²å®‰è£…ï¼"
        read -p "æ˜¯å¦åˆ é™¤é‡è£…? (y/n): " opt
        if [ "$opt" != "y" ] && [ "$opt" != "Y" ]; then
            return
        fi
        proot-distro remove "$distro" 2>/dev/null || true
    fi
    
    # æ£€æŸ¥ä¾èµ–
    if ! command_exists proot-distro; then
        log "æ­£åœ¨å®‰è£… proot-distro..."
        pkg install proot-distro -y || {
            err "å®‰è£… proot-distro å¤±è´¥ï¼"
            sleep 2
            return
        }
    fi
    
    log "æ­£åœ¨ä¸‹è½½ $distro (è¯·ä¿æŒç½‘ç»œç•…é€šï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
    rm -rf "$PREFIX/var/lib/proot-distro/dlcache/$distro" 2>/dev/null || true
    
    if proot-distro install "$distro" 2>&1; then
        # é…ç½® DNS
        echo "nameserver 223.5.5.5" > "$rootfs/etc/resolv.conf" 2>/dev/null || true
        echo "nameserver 8.8.8.8" >> "$rootfs/etc/resolv.conf" 2>/dev/null || true
        
        # åˆ›å»ºå¹¶æ‰§è¡Œé…ç½®è„šæœ¬
        create_worker_script "$distro"
        log "æ­£åœ¨é…ç½®ç³»ç»Ÿç¯å¢ƒ (ä¸­æ–‡/å­—ä½“/æº)..."
        proot-distro login "$distro" --shared-tmp -- /bin/bash "$WORKER_SCRIPT" 2>&1
        
        # åº”ç”¨ç¾åŒ–
        setup_neofetch "$distro"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        cleanup_temp_files
        
        log "ğŸ‰ ç³»ç»Ÿå®‰è£…å®Œæˆï¼"
    else
        err "å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚"
        cleanup_temp_files
    fi
    
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- å¯åŠ¨ GUI æ¨¡å¼ ---
start_gui() {
    local installed=$(get_installed_distros)
    if [ -z "$installed" ]; then
        err "æ²¡æœ‰å·²å®‰è£…çš„ç³»ç»Ÿï¼è¯·å…ˆå®‰è£…ä¸€ä¸ªç³»ç»Ÿã€‚"
        sleep 2
        return
    fi
    
    clear
    echo -e "${B}â”Œâ”€â”€ [GUI æ¨¡å¼] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${G}å·²å®‰è£…çš„ç³»ç»Ÿï¼š${NC}"
    
    local i=1
    local distros=()
    while IFS= read -r distro; do
        if [ -n "$distro" ]; then
            echo -e "  $i. ${C}$distro${NC}"
            distros+=("$distro")
            ((i++))
        fi
    done <<< "$installed"
    
    echo -e "  0. è¿”å›"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    read -p "ğŸ‘‰ é€‰æ‹©ç³»ç»Ÿ: " choice
    
    if [ "$choice" = "0" ] || [ -z "$choice" ]; then
        return
    fi
    
    local selected_distro="${distros[$((choice-1))]}"
    if [ -z "$selected_distro" ]; then
        err "æ— æ•ˆçš„é€‰æ‹©ï¼"
        sleep 1
        return
    fi
    
    clear
    echo -e "${B}â”Œâ”€â”€ [GUI æ¨¡å¼é€‰æ‹©] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "1. ${G}Termux:X11${NC} (æ¨èï¼Œç¡¬ä»¶åŠ é€Ÿ)"
    echo -e "2. ${C}VNC Viewer${NC} (é€šç”¨å…¼å®¹)"
    echo -e "0. è¿”å›"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    read -p "ğŸ‘‰ é€‰æ‹©æ¨¡å¼: " gui_mode
    
    case "$gui_mode" in
        1)
            start_termux_x11 "$selected_distro"
            ;;
        2)
            start_vnc "$selected_distro"
            ;;
        0|*)
            return
            ;;
    esac
}

# --- Termux:X11 æ¨¡å¼ ---
start_termux_x11() {
    local distro=$1
    
    # æ£€æŸ¥ä¾èµ–
    if ! command_exists termux-x11; then
        log "æ­£åœ¨å®‰è£… Termux:X11..."
        pkg install x11-repo -y
        pkg install termux-x11-nightly -y || {
            err "å®‰è£…å¤±è´¥ï¼è¯·ç¡®ä¿å·²å®‰è£… Termux:X11 APPã€‚"
            sleep 2
            return
        }
    fi
    
    # æ£€æŸ¥ GUI æ˜¯å¦å·²å®‰è£…
    proot-distro login "$distro" --shared-tmp -- bash -c "command -v startxfce4 >/dev/null 2>&1" || {
        warn "æœªæ£€æµ‹åˆ°æ¡Œé¢ç¯å¢ƒï¼Œæ­£åœ¨å®‰è£… XFCE4..."
        install_desktop_environment "$distro" || {
            err "æ¡Œé¢ç¯å¢ƒå®‰è£…å¤±è´¥ï¼"
            sleep 2
            return
        }
    }
    
    log "æ­£åœ¨å¯åŠ¨ Termux:X11 æ¨¡å¼..."
    
    # æ¸…ç†æ—§è¿›ç¨‹
    killall -9 termux-x11 Xwayland pulseaudio virgl_test_server_android >/dev/null 2>&1 || true
    
    # å¯åŠ¨ Termux:X11 APP
    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1 || {
        warn "æ— æ³•è‡ªåŠ¨å¯åŠ¨ Termux:X11 APPï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ã€‚"
    }
    
    sleep 1
    
    # å¯åŠ¨ X11 æœåŠ¡å™¨
    termux-x11 :0 -ac >/dev/null 2>&1 &
    local x11_pid=$!
    
    # ç­‰å¾… X11 å‡†å¤‡å°±ç»ª
    local count=0
    while [ ! -S "$PREFIX/tmp/.X11-unix/X0" ] && [ $count -lt 50 ]; do
        sleep 0.1
        ((count++))
    done
    
    if [ ! -S "$PREFIX/tmp/.X11-unix/X0" ]; then
        kill $x11_pid 2>/dev/null || true
        err "Termux:X11 å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Termux:X11 APPã€‚"
        sleep 2
        return
    fi
    
    # å¯åŠ¨éŸ³é¢‘å’Œå›¾å½¢åŠ é€Ÿ
    if command_exists virgl_test_server_android; then
        virgl_test_server_android >/dev/null 2>&1 &
    fi
    
    if command_exists pulseaudio; then
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1 >/dev/null 2>&1 || true
    fi
    
    log "æ­£åœ¨ç™»å½•ç³»ç»Ÿå¹¶å¯åŠ¨æ¡Œé¢..."
    proot-distro login "$distro" --shared-tmp -- bash -c "
        export DISPLAY=:0
        export PULSE_SERVER=127.0.0.1
        dbus-launch --exit-with-session startxfce4
    "
}

# --- VNC æ¨¡å¼ ---
start_vnc() {
    local distro=$1
    
    # æ£€æŸ¥ GUI æ˜¯å¦å·²å®‰è£…
    proot-distro login "$distro" --shared-tmp -- bash -c "command -v startxfce4 >/dev/null 2>&1" || {
        warn "æœªæ£€æµ‹åˆ°æ¡Œé¢ç¯å¢ƒï¼Œæ­£åœ¨å®‰è£… XFCE4..."
        install_desktop_environment "$distro" || {
            err "æ¡Œé¢ç¯å¢ƒå®‰è£…å¤±è´¥ï¼"
            sleep 2
            return
        }
    }
    
    # æ£€æŸ¥å¹¶å®‰è£… VNC
    proot-distro login "$distro" --shared-tmp -- bash -c "command -v vncserver >/dev/null 2>&1" || {
        log "æ­£åœ¨å®‰è£… VNC æœåŠ¡å™¨..."
        install_vnc_server "$distro" || {
            err "VNC æœåŠ¡å™¨å®‰è£…å¤±è´¥ï¼"
            sleep 2
            return
        }
    }
    
    log "æ­£åœ¨å¯åŠ¨ VNC æœåŠ¡å™¨..."
    log "è¿æ¥åœ°å€: ${G}127.0.0.1:5901${NC}"
    log "å¯†ç : ${Y}xterm${NC} (å¯åœ¨å®¹å™¨å†…ä½¿ç”¨ vncpasswd ä¿®æ”¹)"
    
    proot-distro login "$distro" --shared-tmp -- bash -c "
        export DISPLAY=:1
        vncserver -kill :1 >/dev/null 2>&1 || true
        vncserver :1 -geometry 1280x720 -depth 24
        dbus-launch --exit-with-session startxfce4
    " &
    
    log "VNC æœåŠ¡å™¨å·²å¯åŠ¨ï¼è¯·ä½¿ç”¨ VNC Viewer è¿æ¥åˆ° 127.0.0.1:5901"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®åœæ­¢ VNC æœåŠ¡å™¨..."
    
    proot-distro login "$distro" --shared-tmp -- bash -c "vncserver -kill :1" 2>/dev/null || true
}

# --- å®‰è£…æ¡Œé¢ç¯å¢ƒ ---
install_desktop_environment() {
    local distro=$1
    
    case "$distro" in
        debian|ubuntu|kali)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                export DEBIAN_FRONTEND=noninteractive
                apt update -y
                apt install -y xfce4 xfce4-goodies dbus-x11
            " || return 1
            ;;
        archlinux)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                pacman -Syu --noconfirm
                pacman -S --noconfirm xfce4 xfce4-goodies dbus
            " || return 1
            ;;
        alpine)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                apk update
                apk add xfce4 xfce4-terminal dbus
            " || return 1
            ;;
    esac
}

# --- å®‰è£… VNC æœåŠ¡å™¨ ---
install_vnc_server() {
    local distro=$1
    
    case "$distro" in
        debian|ubuntu|kali)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                export DEBIAN_FRONTEND=noninteractive
                apt install -y tigervnc-standalone-server tigervnc-common
                echo 'xterm' | vncpasswd -f > /root/.vnc/passwd 2>/dev/null || mkdir -p /root/.vnc && echo 'xterm' | vncpasswd -f > /root/.vnc/passwd
                chmod 600 /root/.vnc/passwd
            " || return 1
            ;;
        archlinux)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                pacman -S --noconfirm tigervnc
                echo 'xterm' | vncpasswd -f > /root/.vnc/passwd 2>/dev/null || mkdir -p /root/.vnc && echo 'xterm' | vncpasswd -f > /root/.vnc/passwd
                chmod 600 /root/.vnc/passwd
            " || return 1
            ;;
        alpine)
            proot-distro login "$distro" --shared-tmp -- bash -c "
                apk add tigervnc
                echo 'xterm' | vncpasswd -f > /root/.vnc/passwd 2>/dev/null || mkdir -p /root/.vnc && echo 'xterm' | vncpasswd -f > /root/.vnc/passwd
                chmod 600 /root/.vnc/passwd
            " || return 1
            ;;
    esac
}

# --- å¸è½½ç³»ç»Ÿ ---
uninstall_system() {
    local installed=$(get_installed_distros)
    if [ -z "$installed" ]; then
        err "æ²¡æœ‰å·²å®‰è£…çš„ç³»ç»Ÿï¼"
        sleep 2
        return
    fi
    
    clear
    echo -e "${B}â”Œâ”€â”€ [å¸è½½ç³»ç»Ÿ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${R}è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€é€‰ç³»ç»ŸåŠå…¶æ‰€æœ‰æ•°æ®ï¼${NC}"
    echo ""
    echo -e "${G}å·²å®‰è£…çš„ç³»ç»Ÿï¼š${NC}"
    
    local i=1
    local distros=()
    while IFS= read -r distro; do
        if [ -n "$distro" ]; then
            echo -e "  $i. ${C}$distro${NC}"
            distros+=("$distro")
            ((i++))
        fi
    done <<< "$installed"
    
    echo -e "  0. è¿”å›"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    read -p "ğŸ‘‰ é€‰æ‹©è¦å¸è½½çš„ç³»ç»Ÿ: " choice
    
    if [ "$choice" = "0" ] || [ -z "$choice" ]; then
        return
    fi
    
    local selected_distro="${distros[$((choice-1))]}"
    if [ -z "$selected_distro" ]; then
        err "æ— æ•ˆçš„é€‰æ‹©ï¼"
        sleep 1
        return
    fi
    
    read -p "ç¡®å®šè¦åˆ é™¤ $selected_distro å—? (y/n): " confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        log "æ­£åœ¨å¸è½½ $selected_distro..."
        proot-distro remove "$selected_distro" 2>&1 && {
            log "âœ… å¸è½½å®Œæˆï¼"
        } || {
            err "å¸è½½å¤±è´¥ï¼"
        }
        sleep 2
    fi
}

# --- Shizuku ä¿®å¤ ---
fix_shizuku() {
    log "æ­£åœ¨æ£€æŸ¥ Shizuku ç¯å¢ƒ..."
    
    if [ ! -f "$PREFIX/bin/rish" ] || [ ! -f "$PREFIX/bin/rish_shizuku.dex" ]; then
        warn "æ­£åœ¨ä¸‹è½½ rish ç»„ä»¶..."
        mkdir -p "$PREFIX/bin"
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish" -o "$PREFIX/bin/rish" || {
            err "ä¸‹è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
            sleep 2
            return
        }
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish_shizuku.dex" -o "$PREFIX/bin/rish_shizuku.dex" || {
            err "ä¸‹è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
            sleep 2
            return
        }
        chmod +x "$PREFIX/bin/rish"
    fi
    
    warn "âš ï¸  å¦‚æœ Shizuku å¼¹å‡ºæˆæƒçª—å£ï¼Œè¯·åŠ¡å¿…ç‚¹å‡»ã€å§‹ç»ˆå…è®¸ã€‘ï¼"
    
    if "$PREFIX/bin/rish" -c "/system/bin/device_config put activity_manager max_phantom_processes 2147483647 && cmd appops set com.termux RUN_IN_BACKGROUND allow" 2>/dev/null; then
        log "âœ… ä¿®å¤æˆåŠŸï¼Termux å·²è·å¾—åå°è¿è¡Œæƒé™ã€‚"
    else
        err "æˆæƒå¤±è´¥ï¼"
        warn "å¯èƒ½åŸå› ï¼šShizuku æœªå¯åŠ¨ï¼Œæˆ–æœªæˆæƒã€‚"
        warn "è¯·ç¡®ä¿ Shizuku APP æ­£åœ¨è¿è¡Œï¼Œç„¶åå†è¯•ä¸€æ¬¡ã€‚"
    fi
    
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# ==============================================================================
# ğŸ“º ä¸»èœå•
# ==============================================================================
main_menu() {
    # é¦–æ¬¡å¯åŠ¨æ£€æŸ¥
    if ! command_exists proot-distro; then
        warn "æ£€æµ‹åˆ°æœªå®‰è£… proot-distroï¼Œæ­£åœ¨å®‰è£…..."
        pkg update -y
        pkg install proot-distro -y || {
            err "å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
            exit 1
        }
    fi
    
    while true; do
        clear
        # ä½¿ç”¨ printf é¿å…é—ªçƒ
        printf "${B}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}\n"
        printf "${B}â”‚    XXY v${VERSION} - Termux å®¹å™¨ç®¡ç†å™¨    â”‚${NC}\n"
        printf "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}\n"
        printf "\n"
        
        local installed=$(get_installed_distros)
        if [ -n "$installed" ]; then
            printf "å·²å®‰è£…ç³»ç»Ÿ: ${G}"
            echo "$installed" | tr '\n' ' '
            printf "${NC}\n\n"
        else
            printf "çŠ¶æ€: ${R}æœªå®‰è£…ç³»ç»Ÿ${NC}\n\n"
        fi
        
        printf "1. ${G}ç™»å½•ç³»ç»Ÿ${NC} (Login)\n"
        printf "2. ${C}å®‰è£…æ–°ç³»ç»Ÿ${NC} (Install)\n"
        printf "3. ${Y}å¯åŠ¨æ¡Œé¢${NC} (GUI Mode)\n"
        printf "4. ${R}å¸è½½ç³»ç»Ÿ${NC} (Uninstall)\n"
        printf "5. ${B}Shizuku ä¿®å¤${NC} (é˜²é—ªé€€)\n"
        printf "0. ${W}é€€å‡º${NC}\n"
        printf "\n"
        
        read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " choice
        
        case "$choice" in
            1) login_system ;;
            2) install_system ;;
            3) start_gui ;;
            4) uninstall_system ;;
            5) fix_shizuku ;;
            0) safe_exit ;;
            *) ;;
        esac
    done
}

# --- å¯åŠ¨ ---
main_menu

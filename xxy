cat > $PREFIX/bin/xxy << 'EOF'
#!/bin/bash
# ==============================================================================
# PROJECT: XXY (PERFECT EDITION v17.0)
# AUTHOR QQ: 2101497063
# FEATURES: CLEAN UI + LOGIC FIX + VNC CONFIRMED
# ==============================================================================

# --- ğŸ¨ é¢œè‰²åº“ ---
R='\033[1;31m'; G='\033[1;32m'; Y='\033[1;33m'
B='\033[1;34m'; P='\033[1;35m'; C='\033[1;36m'
W='\033[1;37m'; GR='\033[1;90m'; NC='\033[0m'

# --- ğŸ’¾ é…ç½®ä¿å­˜ ---
CFG="$HOME/.xxy_perfect_cfg"
[ -f "$CFG" ] && source "$CFG" || LANG_SET="CN"
save_cfg() { echo "LANG_SET=\"$LANG_SET\"" > "$CFG"; }

# --- ğŸ› ï¸ äº¤äº’æ¨¡å¼ (ä¿æŒç”»é¢ç¨³å®š) ---
enter_mode() { tput cnorm; stty echo; clear; }
exit_mode() { echo ""; read -p "âœ… æŒ‰å›è½¦é”®è¿”å›ä¸»èœå•..."; tput civis; stty -echo; clear; draw_static; }

# --- ğŸ“¦ æ ¸å¿ƒåŠŸèƒ½æ¨¡å— (å®Œå…¨é‡å†™æ’ç‰ˆ) ---

# 1. å®¹å™¨ç®¡å®¶ (æ’ç‰ˆå¤§ä¿®)
f_distro() {
    enter_mode
    echo -e "${C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${C} ğŸ“¦ å®¹å™¨ç®¡ç†ä¸­å¿ƒ (Distro Manager) ${NC}"
    echo -e "${C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${W} 1.${NC} ç™»å½•å·²è£…ç³»ç»Ÿ (Login)"
    echo -e "${W} 2.${NC} ä¸‹è½½æ–°ç³»ç»Ÿ (Install)"
    echo -e "${W} 3.${NC} åˆ é™¤ç³»ç»Ÿ (Uninstall)"
    echo -e "${GR} 0. è¿”å›${NC}"
    echo ""
    read -p "ğŸ‘‰ è¯·è¾“å…¥æ•°å­—é€‰æ‹©: " op
    
    case $op in
        1) # ç™»å½• (åªæ˜¾ç¤ºå·²å®‰è£…)
            echo -e "\n${G}=== [ æ‚¨å·²å®‰è£…çš„ç³»ç»Ÿåˆ—è¡¨ ] ===${NC}"
            # è¿‡æ»¤åªæ˜¾ç¤ºå·²å®‰è£…çš„ï¼Œå»æ‰åºŸè¯
            INSTALLED=$(proot-distro list | grep "(installed)" | awk '{print $1}')
            
            if [ -z "$INSTALLED" ]; then
                echo -e "${R}âŒ æ‚¨è¿˜æ²¡æœ‰å®‰è£…ä»»ä½•ç³»ç»Ÿå“¦ï¼è¯·å…ˆé€‰æ‹©é€‰é¡¹ 2 è¿›è¡Œä¸‹è½½ã€‚${NC}"
            else
                # ä½¿ç”¨ sed ç»™æ¯ä¸€è¡ŒåŠ ä¸ªç®­å¤´ï¼Œçœ‹èµ·æ¥æ›´æ•´é½
                echo "$INSTALLED" | sed 's/^/  â¤ /'
                echo -e "${GR}------------------------------${NC}"
                read -p "ğŸ¤” è¯·è¾“å…¥ä¸Šæ–¹æ˜¾ç¤ºçš„ç³»ç»Ÿåç§° (å¦‚ ubuntu): " t
                if [ ! -z "$t" ]; then
                     if proot-distro list | grep -q "$t (installed)"; then
                         # è‡ªåŠ¨è¡¥å…¨ fastfetch
                         proot-distro login $t -- bash -c "if command -v fastfetch &>/dev/null; then fastfetch; fi; bash"
                     else
                         echo -e "${R}ğŸ˜– æ‰¾ä¸åˆ°è¿™ä¸ªç³»ç»Ÿï¼Œè¯·æ£€æŸ¥æ‹¼å†™ã€‚${NC}"
                     fi
                fi
            fi
            ;;
        2) # å®‰è£… (æ•´é½åˆ—å‡º)
            echo -e "\n${Y}=== [ æ”¯æŒå®‰è£…çš„ç³»ç»Ÿåˆ—è¡¨ ] ===${NC}"
            # è¿‡æ»¤æ‰ Alias å’Œ installed æ ‡è®°ï¼Œåªç•™åå­—ï¼Œå¹¶åˆ†åˆ—æ˜¾ç¤º
            proot-distro list | grep -v "(installed)" | grep -v "Alias" | grep -v "Supported" | grep -v "Install" | awk '{print $1}' | sort | xargs -n 3 | column -t | sed 's/^/  /'
            
            echo -e "\n${C}ğŸ’¡ æ¨èæ–°æ‰‹å®‰è£…: ubuntu, debian, kali${NC}"
            read -p "ğŸ¤” è¯·è¾“å…¥æ‚¨æƒ³ä¸‹è½½çš„ç³»ç»Ÿåç§°: " t
            if [ ! -z "$t" ]; then
                echo -e "${P}ğŸ“¦ æ­£åœ¨ä¸ºæ‚¨ä¸‹è½½ $t ... (è¯·ä¿æŒç½‘ç»œé€šç•…)${NC}"
                if proot-distro install $t; then
                    echo -e "\n${G}ğŸ‰ å®‰è£…æˆåŠŸï¼æ˜¯å¦è¿›è¡Œæ–°æ‰‹åˆå§‹åŒ–ï¼Ÿ${NC}"
                    read -p "ğŸ‡¨ğŸ‡³ 1.æ³¨å…¥ä¸­æ–‡ç¯å¢ƒ+å­—ä½“? (y/n): " cn
                    [ "$cn" == "y" ] && proot-distro login $t -- bash -c "apt update && apt install locales fonts-noto-cjk -y && echo 'zh_CN.UTF-8 UTF-8' > /etc/locale.gen && locale-gen && echo 'export LANG=zh_CN.UTF-8' >> ~/.bashrc"
                    read -p "ğŸš€ 2.æ›¿æ¢æ¸…åæºåŠ é€Ÿä¸‹è½½? (y/n): " src
                    [ "$src" == "y" ] && proot-distro login $t -- bash -c "sed -i 's/http:\/\/.*\/debian/https:\/\/mirrors.tuna.tsinghua.edu.cn\/debian/g' /etc/apt/sources.list; sed -i 's/http:\/\/.*\/ubuntu/https:\/\/mirrors.tuna.tsinghua.edu.cn\/ubuntu/g' /etc/apt/sources.list"
                fi
            fi
            ;;
        3) # åˆ é™¤
            echo -e "\n${R}=== [ åˆ é™¤ç³»ç»Ÿ ] ===${NC}"
            proot-distro list | grep "(installed)" | awk '{print $1}' | sed 's/^/  â¤ /'
            echo ""
            read -p "ğŸ—‘ï¸ è¯·è¾“å…¥è¦åˆ é™¤çš„ç³»ç»Ÿå: " t
            if [ ! -z "$t" ]; then
                read -p "âš ï¸ çœŸçš„è¦åˆ é™¤å—ï¼Ÿ(y/n): " confirm
                [ "$confirm" == "y" ] && proot-distro remove $t && echo "âœ… åˆ é™¤å®Œæˆã€‚"
            fi
            ;;
    esac
    exit_mode
}

# 2. æ¡Œé¢å¯åŠ¨ (ä¿ç•™å¹¶å¼ºè°ƒ VNC)
f_gui() {
    enter_mode
    echo -e "${C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${C} ğŸ“º æ¡Œé¢æ§åˆ¶å° (GUI Launcher) ${NC}"
    echo -e "${C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # æ£€æŸ¥å·²å®‰è£…
    INSTALLED=$(proot-distro list | grep "(installed)" | awk '{print $1}')
    if [ -z "$INSTALLED" ]; then
        echo -e "${R}âŒ æ‚¨è¿˜æ²¡è£…ç³»ç»Ÿå‘¢ï¼Œå…ˆå»[å®¹å™¨ç®¡ç†]é‡Œè£…ä¸€ä¸ªå§ã€‚${NC}"
        exit_mode
        return
    fi
    
    echo -e "${Y}å¯ç”¨ç³»ç»Ÿ:${NC}"
    echo "$INSTALLED" | sed 's/^/  â¤ /'
    echo ""
    read -p "ğŸ‘‰ è¯·è¾“å…¥ç³»ç»Ÿåç§°: " sys
    
    if proot-distro list | grep -q "$sys (installed)"; then
        echo -e "\n${G}ğŸ” æ­£åœ¨æ£€æŸ¥æ¡Œé¢ç¯å¢ƒ...${NC}"
        # è‡ªåŠ¨ä¿®å¤ XFCE
        proot-distro login $sys -- bash -c "if ! command -v startxfce4 &>/dev/null; then echo 'ğŸ”§ æœªæ£€æµ‹åˆ°æ¡Œé¢ï¼Œæ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨å®‰è£… XFCE4...'; apt update && apt install xfce4 xfce4-goodies -y; fi"
        
        echo -e "\n${W}è¯·é€‰æ‹©å¯åŠ¨æ¨¡å¼ï¼š${NC}"
        echo -e " ${C}1.${NC} Termux:X11 (æ¨èï¼šæ‰‹æœºæœ¬æœºæµç•…æ“ä½œ)"
        echo -e " ${C}2.${NC} VNC Server (æ”¯æŒ Windows/ç”µè„‘ è¿œç¨‹è¿æ¥)"
        echo ""
        read -p "ğŸ‘‰ é€‰æ‹© (1/2): " m
        
        if [ "$m" == "1" ]; then
            pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
            pkill -f com.termux.x11; killall termux-x11 2>/dev/null
            termux-x11 :0 >/dev/null 2>&1 &
            echo -e "${G}ğŸš€ å¯åŠ¨æˆåŠŸï¼è¯·åˆ‡æ¢ APPã€‚${NC}"
            proot-distro login $sys --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        else
            # VNC é€»è¾‘
            echo -e "${P}ğŸ“¡ æ­£åœ¨å¯åŠ¨ VNC æœåŠ¡...${NC}"
            proot-distro login $sys -- bash -c "if ! command -v vncserver &>/dev/null; then apt install tigervnc-standalone-server -y; fi; vncserver -kill :1 >/dev/null 2>&1; vncserver :1"
            echo -e "\n${G}âœ… VNC å·²å¯åŠ¨ï¼${NC}"
            echo -e "ğŸ’» ç”µè„‘è¿æ¥åœ°å€: ${Y}æ‰‹æœºIP:5901${NC} (æˆ– 127.0.0.1:5901)"
            echo -e "ğŸ”‘ ç¬¬ä¸€æ¬¡ä½¿ç”¨å¯èƒ½éœ€è¦è®¾ç½® 6-8 ä½å¯†ç ã€‚"
        fi
    else
        echo -e "${R}âŒ ç³»ç»Ÿåè¾“å…¥é”™è¯¯ã€‚${NC}"
    fi
    exit_mode
}

# 3. ç³»ç»ŸåŒ»ç”Ÿ
f_doctor() {
    enter_mode
    echo -e "${C}=== ç³»ç»Ÿæ€¥æ•‘åŒ… ===${NC}"
    read -p "è¾“å…¥ç³»ç»Ÿå: " sys
    if [ ! -z "$sys" ]; then
        echo "1. ä¿®å¤å£°éŸ³ (Audio)"
        echo "2. ä¿®å¤ä¸­æ–‡ä¹±ç "
        echo "3. æ¢æ¸…åæº (åŠ é€Ÿ)"
        read -p "é€‰æ‹© > " op
        case $op in
            1) pulseaudio --start --exit-idle-time=-1 ;;
            2) proot-distro login $sys -- bash -c "apt update && apt install locales fonts-noto-cjk -y && locale-gen zh_CN.UTF-8" ;;
            3) proot-distro login $sys -- bash -c "sed -i 's/http:\/\/.*\/debian/https:\/\/mirrors.tuna.tsinghua.edu.cn\/debian/g' /etc/apt/sources.list" ;;
        esac
        echo "âœ… ä¿®å¤å®Œæˆã€‚"
    fi
    exit_mode
}

# å…¶ä»–åŠŸèƒ½ä¿æŒç®€æ´
f_hack() { enter_mode; echo "æ­£åœ¨éƒ¨ç½² Kali..."; proot-distro install kali; exit_mode; }
f_backup() { enter_mode; read -p "è¾“å…¥ç³»ç»Ÿå: " s; echo "æ­£åœ¨å¤‡ä»½..."; mkdir -p /sdcard/XXY_Backups; pr
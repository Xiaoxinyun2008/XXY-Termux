#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v5.1 ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®±ï¼ˆAI ä¼˜åŒ–å¢å¼ºç‰ˆï¼‰
# æ ¸å¿ƒåŠŸèƒ½ï¼šå®¹å™¨ç‰©ç†è·¯å¾„æ˜ å°„ | Shizuku è‡ªåŠ¨ä¿®å¤ | Debian ç¯å¢ƒ | VSCode | å¤‡ä»½
# ==============================================================================

# --- [0] å…¨å±€é…ç½® ---
export SCRIPT_VERSION="5.1"
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export DISTRO_NAME="debian"
# å…³é”®ä¼˜åŒ–ï¼šå‡†ç¡®æŒ‡å‘ proot-distro çš„é»˜è®¤å®‰è£…è·¯å¾„
export PROOT_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export ROOTFS="$PROOT_BASE/$DISTRO_NAME"
export TMP_WORKER="$PREFIX/tmp/worker_script.sh"
export LOG_DIR="$HOME/.xxy/logs"
export LOG_FILE="$LOG_DIR/xxy_$(date +%Y%m%d).log"
export CONFIG_DIR="$HOME/.xxy"
export CONFIG_FILE="$CONFIG_DIR/config.conf"
export BACKUP_DIR="$HOME/.xxy/backups"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# ç¡®ä¿åŸºç¡€ä¾èµ–å­˜åœ¨
init_check() {
    echo -e "${C}æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ...${NC}"
    
    # æ£€æŸ¥å¹¶å®‰è£…åŸºç¡€åŒ…
    local required_pkgs=("proot-distro" "wget" "curl" "git")
    for pkg in "${required_pkgs[@]}"; do
        if ! command -v "$pkg" &> /dev/null; then
            echo -e "${Y}å®‰è£…ç¼ºå¤±ä¾èµ–: $pkg${NC}"
            pkg install "$pkg" -y || {
                err "å®‰è£… $pkg å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
                return 1
            }
        fi
    done
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p "$LOG_DIR" "$CONFIG_DIR" "$BACKUP_DIR"
    
    # æ£€æŸ¥å­˜å‚¨æƒé™
    if [ ! -w "$HOME" ]; then
        err "Termux å­˜å‚¨æƒé™ä¸è¶³ï¼Œè¯·è¿è¡Œ: termux-setup-storage"
        return 1
    fi
    
    return 0
}

# ä¿¡å·æ•è·
trap 'echo -e "\n${G}[XXY] å·²å®‰å…¨é€€å‡ºã€‚${NC}"; log_info "ç”¨æˆ·é€€å‡ºç¨‹åº"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ“ æ—¥å¿—ç³»ç»Ÿ & åŸºç¡€å‡½æ•°
# ==============================================================================

log_info() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" >> "$LOG_FILE"; }
log_error() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$LOG_FILE"; }
log_warn() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1" >> "$LOG_FILE"; }

log() { echo -e "${G}[XXY] $1${NC}"; log_info "$1"; }
warn() { echo -e "${Y}[æç¤º] $1${NC}"; log_warn "$1"; }
err() { echo -e "${R}[é”™è¯¯] $1${NC}"; log_error "$1"; }

# åŠ è½½é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        cat > "$CONFIG_FILE" << 'CONFIG_EOF'
MIRROR_SOURCE="tuna"
AUTO_UPDATE_CHECK="true"
LOG_RETENTION_DAYS="7"
CONFIG_EOF
        source "$CONFIG_FILE"
    fi
}

# ==============================================================================
# ğŸ” å®¹å™¨æŸ¥æ‰¾ä¸ç‰©ç†è·¯å¾„ (æ ¸å¿ƒä¼˜åŒ–éƒ¨åˆ†)
# ==============================================================================

get_container_info() {
    echo -e "${C}=== å®¹å™¨çŠ¶æ€ä¿¡æ¯ ===${NC}"
    
    # æ£€æŸ¥ proot-distro åˆ—è¡¨ç¡®è®¤æ˜¯å¦å·²å®‰è£…
    if proot-distro list 2>/dev/null | grep -q "$DISTRO_NAME (installed)"; then
        STATUS="${G}å·²å®‰è£…${NC}"
        IS_INSTALLED=true
    else
        STATUS="${R}æœªå®‰è£…${NC}"
        IS_INSTALLED=false
    fi

    echo -e "å®¹å™¨åç§°: ${Y}${DISTRO_NAME}${NC}"
    echo -e "å®‰è£…çŠ¶æ€: ${STATUS}"

    if [ "$IS_INSTALLED" = true ]; then
        # è¿™é‡Œçš„ ROOTFS å˜é‡å°±æ˜¯ä½ è¦çš„"ç‰©ç†æ–‡ä»¶åç§°/è·¯å¾„"
        echo -e "ç‰©ç†è·¯å¾„: ${B}${ROOTFS}${NC}"
        
        # è®¡ç®—å ç”¨ç©ºé—´ (å¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨)
        if [ -d "$ROOTFS" ]; then
            echo -n "å ç”¨ç©ºé—´: "
            du -sh "$ROOTFS" 2>/dev/null | awk '{print $1}' || echo "æ— æ³•è®¡ç®—"
            echo -e "${Y}æç¤º: ä½ å¯ä»¥ä½¿ç”¨ MTç®¡ç†å™¨/ç³»ç»Ÿæ–‡ä»¶ è¿›å…¥æ­¤è·¯å¾„ç®¡ç†æ–‡ä»¶${NC}"
        else
            err "æ£€æµ‹åˆ°å·²å®‰è£…çŠ¶æ€ï¼Œä½†ç‰©ç†è·¯å¾„ä¸å­˜åœ¨ï¼å»ºè®®é‡è£…ã€‚"
        fi
    else
        echo -e "ç‰©ç†è·¯å¾„: æš‚æ—  (éœ€å®‰è£…åç”Ÿæˆ)"
    fi
    echo "======================"
}

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒæ¨¡å—ï¼šå®¹å™¨å†…éƒ¨æ„å»ºè„šæœ¬ (Worker)
# ==============================================================================
create_worker_script() {
    mkdir -p "$(dirname "$TMP_WORKER")"
    cat > "$TMP_WORKER" << 'EOF'
#!/bin/bash
set -e

# é”™è¯¯é‡è¯•å‡½æ•°
retry_cmd() {
    local -i i=1
    while [ $i -le 3 ]; do
        if "$@"; then
            return 0
        fi
        echo ">>> å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•é‡è¯• ($i/3)..."
        sleep 2
        ((i++))
    done
    return 1
}

# [1] æ¢æº
echo ">>> [å†…éƒ¨] é…ç½®æ¸…åæº (Debian Bookworm)..."
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
SOURCES

# [2] æ›´æ–°
echo ">>> [å†…éƒ¨] æ›´æ–°è½¯ä»¶åŒ…..."
retry_cmd apt update -y
export DEBIAN_FRONTEND=noninteractive

# [3] å®‰è£…æ ¸å¿ƒç»„ä»¶
echo ">>> [å†…éƒ¨] å®‰è£…æ¡Œé¢ç¯å¢ƒä¸å·¥å…·..."
retry_cmd apt install -y sudo nano wget curl git build-essential python3-full \
    xfce4 xfce4-goodies xfce4-terminal dbus-x11 \
    firefox-esr fonts-noto-cjk fonts-noto-color-emoji \
    fcitx5 fcitx5-chinese-addons im-config

# [4] ä¸­æ–‡ç¯å¢ƒ
echo ">>> [å†…éƒ¨] ç”Ÿæˆ Locale..."
apt install -y locales
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

# [5] ä¿®å¤ä¸æ¸…ç†
echo ">>> [å†…éƒ¨] åº”ç”¨ä¿®å¤è¡¥ä¸..."
echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc
apt autoremove -y
apt clean
echo ">>> [å†…éƒ¨] æ„å»ºå®Œæˆï¼"
EOF
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸš€ å®‰è£…ä¸å¯åŠ¨é€»è¾‘
# ==============================================================================

install_debian() {
    log "å¼€å§‹å®‰è£… Debian å®¹å™¨..."
    
    if [ -d "$ROOTFS" ]; then
        warn "æ£€æµ‹åˆ°æ—§çš„å®¹å™¨æ–‡ä»¶ï¼Œæ­£åœ¨å¤‡ä»½..."
        local backup_name="$ROOTFS.bak.$(date +%s)"
        if ! mv "$ROOTFS" "$backup_name"; then
            err "å¤‡ä»½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™"
            return 1
        fi
        echo -e "${G}å·²å¤‡ä»½è‡³: $backup_name${NC}"
    fi

    # å®‰è£…åŸºç¡€ç³»ç»Ÿ
    log "æ­£åœ¨å®‰è£…åŸºç¡€ Debian ç³»ç»Ÿ..."
    if ! proot-distro install "$DISTRO_NAME" <<< "y" 2>&1 | tee -a "$LOG_FILE"; then
        err "å®¹å™¨å®‰è£…å¤±è´¥"
        return 1
    fi
    
    log "æ­£åœ¨æ³¨å…¥è‡ªåŠ¨åŒ–è„šæœ¬..."
    create_worker_script
    
    # å¤åˆ¶è„šæœ¬åˆ°å®¹å™¨å†…
    if [ ! -d "$ROOTFS/root" ]; then
        err "å®¹å™¨æ ¹ç›®å½•ä¸å­˜åœ¨"
        return 1
    fi
    
    cp "$TMP_WORKER" "$ROOTFS/root/install.sh"
    chmod +x "$ROOTFS/root/install.sh"
    
    log "è¿›å…¥å®¹å™¨æ‰§è¡Œé…ç½® (è¿™ä¸€æ­¥éœ€è¦è¾ƒé•¿æ—¶é—´)..."
    echo -e "${Y}é¢„è®¡éœ€è¦10-30åˆ†é’Ÿï¼Œå–å†³äºç½‘ç»œé€Ÿåº¦${NC}"
    
    if ! proot-distro login "$DISTRO_NAME" -- /root/install.sh 2>&1 | tee -a "$LOG_FILE"; then
        err "å®¹å™¨å†…é…ç½®å¤±è´¥"
        return 1
    fi
    
    log "å®‰è£…å®Œæˆï¼"
    rm -f "$TMP_WORKER" "$ROOTFS/root/install.sh"
    
    echo -e "${G}âœ“ Debian å®¹å™¨å®‰è£…å®Œæˆï¼${NC}"
    echo -e "${Y}ä½¿ç”¨ 'xxy start' å¯åŠ¨å®¹å™¨${NC}"
    return 0
}

start_debian() {
    if [ ! -d "$ROOTFS" ]; then
        err "å®¹å™¨æœªå®‰è£…ï¼Œè¯·å…ˆæ‰§è¡Œå®‰è£…ï¼"
        return 1
    fi
    
    # å¯åŠ¨ GUI çš„æç¤º
    echo -e "${G}æ­£åœ¨å¯åŠ¨ Debian...${NC}"
    echo -e "${Y}æç¤ºï¼šè¿›å…¥åè‹¥è¦å¯åŠ¨æ¡Œé¢ï¼Œè¯·è¾“å…¥: startxfce4${NC}"
    echo -e "${C}å¦‚éœ€é€€å‡ºå®¹å™¨ï¼Œè¯·è¾“å…¥: exit${NC}"
    
    # è®¾ç½®æ˜¾ç¤ºå˜é‡
    export DISPLAY=:0
    export PULSE_SERVER=12
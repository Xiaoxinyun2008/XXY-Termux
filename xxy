#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v2.0 ç”Ÿäº§åŠ›å¢å¼ºç‰ˆ
# ç›®æ ‡ï¼šä¸€é”®éƒ¨ç½²ä¸­æ–‡ Linux æ¡Œé¢ç¯å¢ƒ + Termux:X11 å®Œç¾é€‚é…
# ==============================================================================

# --- å…¨å±€å˜é‡ ---
PREFIX="/data/data/com.termux/files/usr"
HOME="/data/data/com.termux/files/home"
DISTRO_NAME="debian" # ç”Ÿäº§åŠ›é¦–é€‰ Debianï¼Œç¨³å®šä¸”è½¯ä»¶å…¨
ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs/$DISTRO_NAME"
TMP_WORKER="$PREFIX/tmp/worker_script.sh"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3); B=$(tput setaf 4); NC=$(tput sgr0)

# --- ä¿¡å·æ•è· ---
trap 'echo -e "\n${G}[ç³»ç»Ÿ] è„šæœ¬å·²ä¸­æ–­ã€‚${NC}"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ› ï¸ è¾…åŠ©å‡½æ•°
# ==============================================================================

log() { echo -e "${G}[XXY] $1${NC}"; }
warn() { echo -e "${Y}[æç¤º] $1${NC}"; }
err() { echo -e "${R}[é”™è¯¯] $1${NC}"; }

# æ£€æŸ¥ Termux åŸºç¡€ä¾èµ–
check_termux_deps() {
    log "æ£€æŸ¥ Termux åŸºç¡€ä¾èµ–..."
    # ç¡®ä¿å®‰è£…äº† X11 ä»“åº“
    if [ ! -f "$PREFIX/etc/apt/sources.list.d/x11.list" ]; then
         pkg install x11-repo -y
    fi
    
    PKGS="proot-distro pulseaudio termux-x11-nightly virglrenderer-android wget curl android-tools"
    
    # å¦‚æœæ‰¾ä¸åˆ° termux-x11-nightlyï¼Œå°è¯•ä» artifact å®‰è£…æˆ–è€…æç¤ºç”¨æˆ·
    # è¿™é‡Œå‡è®¾ç”¨æˆ·å·²ç»æ·»åŠ äº†ç¬¬ä¸‰æ–¹æºæˆ–ä½¿ç”¨å®˜æ–¹ x11-repo
    pkg install $PKGS -y -o Dpkg::Options::="--force-confnew"
    
    if ! command -v proot-distro >/dev/null; then
        err "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ (å»ºè®®å¼€å¯ VPN)"
        exit 1
    fi
}

# ==============================================================================
# ğŸ“¦ å®¹å™¨å†…éƒ¨é…ç½®ç”Ÿæˆå™¨ (æ ¸å¿ƒé€»è¾‘)
# ==============================================================================

create_internal_script() {
    cat > "$TMP_WORKER" << 'EOF'
#!/bin/bash
set -e

# 1. æ¢æº (Debian Bookworm æ¸…åæº)
echo "[å†…éƒ¨] æ­£åœ¨æ›´æ¢å›½å†…æº..."
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
SOURCES

# 2. æ›´æ–°ç³»ç»Ÿ & å®‰è£…åŸºç¡€åŒ…
apt update -y
# é¿å…äº¤äº’å¼å‰ç«¯æŠ¥é”™
export DEBIAN_FRONTEND=noninteractive
apt install -y sudo nano wget curl git dbus-x11 xfce4 xfce4-terminal \
    fonts-noto-cjk fonts-noto-color-emoji \
    fcitx5 fcitx5-chinese-addons fcitx5-frontend-gtk4 fcitx5-frontend-gtk3 fcitx5-frontend-qt5 \
    im-config firefox-esr

# 3. é…ç½®ä¸­æ–‡ç¯å¢ƒ (è§£å†³ä¹±ç çš„å…³é”®)
echo "[å†…éƒ¨] ç”Ÿæˆä¸­æ–‡ Locale..."
apt install -y locales
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

# 4. é…ç½®è¾“å…¥æ³•ç¯å¢ƒå˜é‡
echo "[å†…éƒ¨] é…ç½®è¾“å…¥æ³•..."
cat >> /etc/profile << 'PROFILE_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export DISPLAY=:0
PROFILE_EOF

# 5. ä¿®å¤ Firefox/Chromium åœ¨ Proot ä¸‹çš„ Sandbox é—®é¢˜
echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc

# 6. æ¸…ç†
apt autoremove -y
apt clean

echo "[å†…éƒ¨] é…ç½®å®Œæˆï¼"
EOF
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸ® ä¸»åŠŸèƒ½æ¨¡å—
# ==============================================================================

# [M1] å®‰è£…ç³»ç»Ÿ
do_install() {
    clear
    log "å‡†å¤‡å®‰è£… Debian Bookworm (ç”Ÿäº§åŠ›ç¨³å®šç‰ˆ)..."
    
    # æ£€æŸ¥ç½‘ç»œ
    ping -c 1 223.5.5.5 >/dev/null 2>&1 || { err "æ— ç½‘ç»œè¿æ¥ï¼"; return; }
    
    # æ£€æŸ¥æ—§ç³»ç»Ÿ
    if [ -d "$ROOTFS" ]; then
        read -p "æ£€æµ‹åˆ°æ—§ç³»ç»Ÿï¼Œæ˜¯å¦åˆ é™¤é‡è£…? (y/n): " confirm
        if [ "$confirm" == "y" ]; then
            proot-distro remove "$DISTRO_NAME"
        else
            return
        fi
    fi

    log "æ­£åœ¨ä¸‹è½½ç³»ç»Ÿ (è¯·ä¿æŒ VPN å¼€å¯)..."
    if proot-distro install "$DISTRO_NAME"; then
        # DNS ä¿®å¤
        echo "nameserver 223.5.5.5" > "$ROOTFS/etc/resolv.conf"
        
        # æ‰§è¡Œå†…éƒ¨é…ç½®
        create_internal_script
        log "æ­£åœ¨é…ç½®ä¸­æ–‡ç¯å¢ƒå’Œæ¡Œé¢ (è¿™éœ€è¦å‡ åˆ†é’Ÿ)..."
        proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$TMP_WORKER"
        
        rm -f "$TMP_WORKER"
        log "âœ… å®‰è£…å®Œæˆï¼"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    else
        err "ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Proot ç¼“å­˜ã€‚"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# [M2] å¯åŠ¨æ¡Œé¢ (Termux:X11 ä¸“ç”¨)
do_start_x11() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    
    clear
    log "ğŸš€ æ­£åœ¨å¯åŠ¨ Termux:X11 ç”Ÿäº§åŠ›ç¯å¢ƒ..."
    
    # 1. å¯åŠ¨ Termux:X11 APP
    # å¼ºåˆ¶æ€æ­»æ—§è¿›ç¨‹
    pkill -f com.termux.x11 || true
    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity
    
    # 2. å¯åŠ¨ Xwayland æœåŠ¡
    # å¼€å¯ Virgl (GPUåŠ é€Ÿ)
    log "å¯åŠ¨ X11 æœåŠ¡ (Display :0)..."
    termux-x11 :0 -ac & 
    
    # ç­‰å¾… X11 Socket å°±ç»ª
    local wait_count=0
    while [ ! -S "$PREFIX/tmp/.X11-unix/X0" ]; do
        sleep 0.5
        wait_count=$((wait_count+1))
        if [ $wait_count -gt 10 ]; then err "X11 å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Termux:X11 APP"; return; fi
    done

    # 3. å¯åŠ¨éŸ³é¢‘æœåŠ¡
    log "å¯åŠ¨ PulseAudio..."
    pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    
    # 4. å¯åŠ¨ Virgl æœåŠ¡ (å¦‚æœæ”¯æŒ)
    if command -v virgl_test_server_android >/dev/null; then
        log "å¯ç”¨ GPU ç¡¬ä»¶åŠ é€Ÿ..."
        virgl_test_server_android &
    fi

    # 5. è¿›å…¥å®¹å™¨å¹¶å¯åŠ¨æ¡Œé¢
    log "è¿›å…¥æ¡Œé¢ç¯å¢ƒ..."
    log "âš ï¸  æç¤ºï¼šå¦‚æœé»‘å±ï¼Œè¯·ç‚¹å‡» Termux:X11 åº”ç”¨å†…çš„ 'Preferences -> Reseed Screen'"
    
    # å¯åŠ¨å‘½ä»¤ï¼šè®¾ç½®ä¸­æ–‡ç¯å¢ƒã€Displayã€éŸ³é¢‘ã€å¼€å¯ Fcitx5 è¾“å…¥æ³•ï¼Œæœ€åå¯åŠ¨ XFCE4
    proot-distro login "$DISTRO_NAME" --shared-tmp -- bash -c "
        export DISPLAY=:0
        export PULSE_SERVER=127.0.0.1
        export LANG=zh_CN.UTF-8
        export LC_ALL=zh_CN.UTF-8
        # å¯åŠ¨è¾“å…¥æ³•
        fcitx5 -d &
        # å¯åŠ¨æ¡Œé¢
        dbus-launch --exit-with-session startxfce4
    "
}

# [M3] ç»´æŠ¤èœå•
do_maintenance() {
    clear
    echo -e "${C}=== ç»´æŠ¤å·¥å…· ===${NC}"
    echo "1. å¼ºåˆ¶æ¸…ç†ç¼“å­˜ (ä¿®å¤å®‰è£…å¤±è´¥)"
    echo "2. ADB é˜²æ€åå° (æ¨èæ‰§è¡Œ)"
    echo "3. å¸è½½ç³»ç»Ÿ"
    read -p "é€‰æ‹©: " m_opt
    case "$m_opt" in
        1) 
            rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
            rm -rf "$PREFIX/var/lib/proot-distro/download"
            log "ç¼“å­˜å·²æ¸…ç†ã€‚" ;;
        2)
            log "è¯·åœ¨ç”µè„‘ ADB æˆ– LADB æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
            echo -e "${Y}adb shell \"/system/bin/device_config put activity_manager max_phantom_processes 2147483647\"${NC}"
            echo -e "${Y}adb shell \"cmd appops set com.termux RUN_IN_BACKGROUND allow\"${NC}"
            ;;
        3)
            proot-distro remove "$DISTRO_NAME"
            log "å·²å¸è½½ã€‚" ;;
    esac
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# ==============================================================================
# ğŸ“± ä¸»èœå•
# ==============================================================================

check_termux_deps

while true; do
    clear
    echo -e "${B}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${B}â”‚       XXY v2.0  ç”Ÿäº§åŠ›å¢å¼ºç‰ˆ           â”‚${NC}"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "å½“å‰ç³»ç»Ÿ: ${G}${DISTRO_NAME}${NC} | çŠ¶æ€: $(if [ -d "$ROOTFS" ]; then echo "âœ… å·²å®‰è£…"; else echo "âŒ æœªå®‰è£…"; fi)"
    echo ""
    echo -e "1. ${G}å¯åŠ¨æ¡Œé¢ç¯å¢ƒ${NC} (Termux:X11 + ä¸­æ–‡ + éŸ³é¢‘)"
    echo -e "2. ${Y}å®‰è£…/é‡è£…ç³»ç»Ÿ${NC} (Debian + å¸¸ç”¨è½¯ä»¶)"
    echo -e "3. ç»´æŠ¤å·¥å…·ç®±"
    echo -e "0. é€€å‡º"
    echo ""
    read -p "ğŸ‘‰ è¯·è¾“å…¥: " choice
    
    case "$choice" in
        1) do_start_x11 ;;
        2) do_install ;;
        3) do_maintenance ;;
        0) exit 0 ;;
        *) ;;
    esac
done

# =================================================================
# ğŸ¤– XXY v140.0 (æ³°å¦Â·å…¨è£…ç”²ç‰ˆ)
# æ¶æ„ï¼šå…¨é€»è¾‘è¦†ç›– | å­˜å‚¨/ç½‘ç»œ/è¿›ç¨‹ä¸‰é‡ç†”æ–­ | è‡ªåŠ¨å°¸æ£€ | æ·±åº¦å‡€åŒ–
# =================================================================

# --- [Level 0] æ ¸å¿ƒåˆå§‹åŒ– ---
# è¿™ä¸€æ­¥å°±åƒæ‰‹æœ¯å‰çš„æ¶ˆæ¯’ï¼Œå¿…é¡»å½»åº•
tput cnorm
clear
echo "âš™ï¸ [ç³»ç»Ÿå†…æ ¸] æ­£åœ¨åŠ è½½æ³°å¦é€»è¾‘å¼•æ“ v140.0..."

# 1. è¿›ç¨‹æ¸…ç† (åº”å¯¹é€»è¾‘ï¼šé˜²æ­¢åå°æ®‹ç•™å¯¼è‡´ç«¯å£å ç”¨)
pkill -9 sshd 2>/dev/null
pkill -9 termux-x11 2>/dev/null
pkill -9 pulseaudio 2>/dev/null

# 2. è‡ªèº«è¿­ä»£ (åº”å¯¹é€»è¾‘ï¼šåˆ é™¤æ—§çš„è‡ªèº«ï¼Œé˜²æ­¢ä»£ç å†²çª)
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*

# 3. ç¼“å­˜é¢„åˆ¶ (åº”å¯¹é€»è¾‘ï¼šæå‰å»ºç«‹ç›®å½•ï¼Œé˜²æ­¢æƒé™æŠ¥é”™)
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export LOG_FILE="$TMPDIR/xxy_titan.log"
[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# é¢œè‰²å¸¸é‡
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# é€€å‡ºé™·é˜± (åº”å¯¹é€»è¾‘ï¼šé˜²æ­¢ç”¨æˆ·å¼ºåˆ¶é€€å‡ºåç»ˆç«¯å…‰æ ‡æ¶ˆå¤±æˆ–ä¹±ç )
trap 'tput cnorm; stty echo; echo -e "\n${G}ç³»ç»Ÿå·²å®‰å…¨æŒ‚èµ·ã€‚${NC}"; exit' EXIT INT TERM

# --- [Level 1] å†™å…¥ä¸»ç¨‹åº ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# å¼•å…¥å¤–éƒ¨å˜é‡
export VERSION="v140.0 æ³°å¦ç‰ˆ"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export LOG_FILE="$TMPDIR/xxy_titan.log"
export LANG="C.UTF-8"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# --- [Level 2] é€»è¾‘åˆ¤æ–­ä½“ (The Logic Brain) ---

# 1. æ—¥å¿—è®°å½•å™¨
log() {
    echo "[$(date '+%H:%M:%S')] $1" >> "$LOG_FILE"
}

# 2. ç½‘ç»œåŒé“¾è·¯æ£€æµ‹ (åº”å¯¹ï¼šåŒºåˆ†æ–­ç½‘å’Œè¢«å¢™)
check_network_deep() {
    log "æ­£åœ¨è¿›è¡Œç½‘ç»œæ¢æµ‹..."
    # é“¾è·¯A: å›½å†…é˜¿é‡ŒDNS
    if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1; then
        return 0 # æœ‰ç½‘
    fi
    # é“¾è·¯B: å¤‡ç”¨æ£€æµ‹
    if ping -c 1 -W 1 114.114.114.114 >/dev/null 2>&1; then
        return 0
    fi
    return 1 # æ–­ç½‘
}

# 3. å­˜å‚¨ç©ºé—´ç†”æ–­ (åº”å¯¹ï¼šé˜²æ­¢ç©ºé—´ä¸è¶³å¯¼è‡´æ–‡ä»¶æŸå)
check_storage() {
    # è·å–å‰©ä½™ç©ºé—´ (MB)
    local free_space=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free_space" -lt 2000 ]; then
        return 1 # ç©ºé—´ < 2GBï¼Œè§¦å‘ç†”æ–­
    fi
    return 0
}

# 4. ä¾èµ–è‡ªæ„ˆç³»ç»Ÿ (åº”å¯¹ï¼šç¼ºå°‘ç»„ä»¶è‡ªåŠ¨è¡¥å…¨)
check_dependencies() {
    # ä¿®å¤ apt é” (åº”å¯¹ï¼šä¸Šæ¬¡æ›´æ–°æ„å¤–ä¸­æ–­å¯¼è‡´çš„é”æ­»)
    if [ -f "$PREFIX/var/lib/dpkg/lock-frontend" ]; then
        echo -e "${Y}ğŸ”§ æ£€æµ‹åˆ° dpkg é”æ­»ï¼Œæ­£åœ¨å¼ºåˆ¶è§£é”...${NC}"
        rm -f $PREFIX/var/lib/dpkg/lock*
        dpkg --configure -a >/dev/null 2>&1
    fi

    local needed="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools"
    local missing=""
    for pkg in $needed; do
        if ! command -v $pkg >/dev/null; then missing="$missing $pkg"; fi
    done
    
    if [ -n "$missing" ]; then
        echo -e "${Y}ğŸ“¦ æ­£åœ¨è¡¥å…¨æ ¸å¿ƒç»„ä»¶...${NC}"
        if ! check_network_deep; then
            echo -e "${R}âŒ è‡´å‘½é”™è¯¯ï¼šç»„ä»¶ç¼ºå¤±ä¸”æ— ç½‘ç»œï¼Œæ— æ³•è‡ªæˆ‘ä¿®å¤ã€‚${NC}"; exit 1
        fi
        pkg install $missing -y -o Dpkg::Options::="--force-confnew" >> "$LOG_FILE" 2>&1
    fi
}

# 5. é…ç½®æ–‡ä»¶æ·±åº¦å‡€åŒ– (åº”å¯¹ï¼šé‡å¤ fastfetchã€ä¹±ç )
deep_clean_config() {
    local sys=$1
    log "æ­£åœ¨å‡€åŒ– $sys é…ç½®æ–‡ä»¶..."
    # æš´åŠ›åˆ é™¤æ‰€æœ‰å¯èƒ½è¢«å°ç™½æ”¹åçš„è¡Œ
    proot-distro login "$sys" -- sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc /etc/profile.d/* 2>/dev/null
    proot-distro login "$sys" -- sed -i '/neofetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    proot-distro login "$sys" -- sed -i '/zh_CN/d' /etc/profile 2>/dev/null
    # é‡å»ºå¹²å‡€çš„ä¸­æ–‡é…ç½®
    proot-distro login "$sys" -- bash -c "echo 'export LANG=zh_CN.UTF-8' > /etc/profile.d/cn.sh" 2>/dev/null
}

# --- [Level 3] å®¹å™¨æ‰§è¡Œè„šæœ¬ (Worker) ---
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    cat >> "$W_FILE" << 'EOF'
#!/bin/sh
set -e
export PATH=$PATH:/usr/bin:/bin
act=$1

# æ™ºèƒ½è¯†åˆ«
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src)
    if [ "$T" = "debian" ]; then 
        # å¹‚ç­‰æ€§æ£€æŸ¥ï¼šé˜²æ­¢é‡å¤å†™å…¥
        if ! grep -q "tsinghua" /etc/apt/sources.list; then
             grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list
             apt update -y
        fi
    elif [ "$T" = "alpine" ]; then 
        sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update
    fi ;;
  
  gui)
    if [ "$T" = "debian" ]; then 
        apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then 
        apk add xfce4 dbus-x11 tigervnc
    fi
    mkdir -p ~/.vnc
    echo "123456" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd ;;
    
  cn)
    if [ "$T" = "debian" ]; then 
        apt install -y locales fonts-noto-cjk
        echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen
        locale-gen
    fi ;;
    
  fetch)
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$W_FILE"
}

# ä»»åŠ¡æ‰§è¡Œå™¨ (å¸¦å…‰æ ‡ä¿æŠ¤)
run_task() {
    tput sc
    tput cup 14 0; echo -ne "\033[J${Y}â³ [æ‰§è¡Œä¸­] $2...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" >> "$LOG_FILE" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… [æˆåŠŸ] $2${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ [è·³è¿‡] $2 (è¯¦æƒ…è§æ—¥å¿—)${NC}"
    fi
    tput rc
    sleep 0.5
}

# --- [Level 4] ä¸šåŠ¡é€»è¾‘æ§åˆ¶å±‚ ---

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

# æ™ºèƒ½é€‰æ‹©å™¨ (å…¨å¾ªç¯é˜²å‘†)
select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- ç³»ç»Ÿç®¡ç†é¢æ¿ ---${NC}"
    mapfile -t LIST < <(get_systems)
    
    if [ ${#LIST[@]} -eq 0 ]; then 
        echo -e "\n${R}âš ï¸ é€»è¾‘ä¸­æ–­ï¼šæœ¬åœ°æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•ç³»ç»Ÿã€‚${NC}"
        echo -e "ğŸ‘‰ è¯·å…ˆæ‰§è¡Œ [2] è¿›è¡Œä¸‹è½½å®‰è£…ã€‚"; read -n 1 -s; return 1
    fi
    
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    echo "-------------------------"
    
    # å¾ªç¯è¾“å…¥åˆ¤æ–­
    while true; do
        read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " c
        if [[ "$c" =~ ^[0-9]+$ ]]; then
            if [ "$c" = "0" ]; then return 2; fi
            if [ -n "${LIST[$((c-1))]}" ]; then 
                SELECTED="${LIST[$((c-1))]}"
                return 0
            fi
        fi
        echo "${R}æ— æ•ˆè¾“å…¥ï¼Œè¯·è¾“å…¥åˆ—è¡¨ä¸­çš„æ•°å­—ã€‚${NC}"
    done
}

# ç™»å½•é€»è¾‘ (ä¿®å¤ fastfetch é‡å¤ + æ­»ç³»ç»Ÿæ£€æµ‹)
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    # 1. å°¸æ£€é€»è¾‘ï¼šæ£€æŸ¥æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
    if [ ! -d "$ROOTFS_BASE/$SELECTED/bin" ]; then
        echo -e "\n${R}âŒ å°¸æ£€ç»“æœï¼šç³»ç»Ÿæ–‡ä»¶ä¸¥é‡ç¼ºå¤± (ç©ºå£³)ã€‚${NC}"
        echo "åŸå› ï¼šä¸Šæ¬¡ä¸‹è½½å®Œå…¨å¤±è´¥ã€‚"
        echo "å¤„ç†ï¼šå»ºè®®åˆ é™¤åé‡è£…ã€‚"
        read -n 1 -s; return
    fi

    # 2. å‡€åŒ–é€»è¾‘ï¼šæ¸…é™¤é‡å¤ä»£ç 
    deep_clean_config "$SELECTED"
    
    # 3. å¯åŠ¨é€»è¾‘ï¼šå•æ¬¡æ³¨å…¥ Fastfetch
    # ä½¿ç”¨ exec æ›¿æ¢å½“å‰ shellï¼Œå‡å°‘å†…å­˜å ç”¨
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# å®‰è£…é€»è¾‘ (å…¨é˜²å¾¡)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== æ³°å¦å®‰è£…å‘å¯¼ ===${NC}"
    
    # 1. ç©ºé—´ç†”æ–­
    if ! check_storage; then
        echo -e "${R}âŒ ç†”æ–­ï¼šæ‰‹æœºå­˜å‚¨ç©ºé—´ä¸è¶³ 2GBã€‚${NC}"
        echo "è¯·æ¸…ç†æ‰‹æœºåƒåœ¾åå†è¯•ï¼Œå¦åˆ™å®‰è£…å¿…å¤±è´¥ã€‚"
        read -n 1 -s; return
    fi
    
    # 2. ç½‘ç»œç†”æ–­
    echo -ne "${Y}ğŸ“¡ æ¢æµ‹ç½‘ç»œé“¾è·¯... ${NC}"
    if ! check_network_deep; then
        echo -e "${R}å…¨å¤±è´¥${NC}"
        echo -e "\n${R}âŒ ç†”æ–­ï¼šæ— æ³•è¿æ¥äº’è”ç½‘ã€‚${NC}"
        echo "è¯·æ£€æŸ¥ WiFi æˆ–å¼€å¯ VPNã€‚"
        read -n 1 -s; return
    else
        echo -e "${G}è¿æ¥æ­£å¸¸${NC}"
    fi

    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    
    while true; do
        read -p "ğŸ‘‰ è¯·é€‰æ‹©ç³»ç»Ÿ (æ¨è1): " idx
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 0 ] && [ "$idx" -le 4 ]; then break; fi
        echo "è¯·è¾“å…¥ 0-4 çš„æ•°å­—"
    done
    [ "$idx" = "0" ] && return
    
    if [ -n "${D_NAMES[$((idx-1))]}" ]; then
        TARGET=${D_NAMES[$((idx-1))]}
        if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo -e "\n${G}ç³»ç»Ÿå·²å­˜åœ¨ï¼Œæ— éœ€å®‰è£…ã€‚${NC}"; read -n 1 -s; return; fi
        
        # 3. é¢„å¤„ç†é€»è¾‘
        echo -e "\n${Y}ğŸ§¹ åˆå§‹åŒ–ä¸‹è½½ç¯å¢ƒ...${NC}"
        proot-distro reset "$TARGET" >/dev/null 2>&1
        rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
        
        # 4. ä¸‹è½½æ‰§è¡Œ
        echo -e "${W}ğŸš€ å¯åŠ¨ä¸‹è½½å¼•æ“ (è¿™å–å†³äºä½ çš„ç½‘é€Ÿ)...${NC}"
        if proot-distro install $TARGET; then
            # 5. æˆåŠŸåæ ¡éªŒ (å°¸æ£€)
            if [ ! -f "$ROOTFS_BASE/$TARGET/etc/os-release" ]; then
                 echo -e "\n${R}âŒ æ ¡éªŒå¤±è´¥ï¼šæ–‡ä»¶ä¸‹è½½ä¸å®Œæ•´ã€‚${NC}"
                 echo "è‡ªåŠ¨è§¦å‘å›æ»šæ¸…ç†..."
                 proot-distro remove "$TARGET"
                 read -n 1 -s; return
            fi
            
            create_worker
            run_task "$TARGET" "æ³¨å…¥å›½å†…æº" "src"
            run_task "$TARGET" "æ³¨å…¥ä¸­æ–‡åŒ…" "cn"
            run_task "$TARGET" "æ³¨å…¥Fastfetch" "fetch"
            echo -e "\n${G}ğŸ‰ å®‰è£…å…¨æµç¨‹ç»“æŸã€‚${NC}"; read -n 1 -s
        else
            echo -e "\n${R}âŒ ä¸‹è½½è¢«ä¸­æ–­ã€‚${NC}"; read -n 1 -s
        fi
    fi
}

# æ¡Œé¢é€»è¾‘ (çŠ¶æ€æ„ŸçŸ¥)
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        echo -e "${Y}æ£€æµ‹åˆ°æœªå®‰è£…æ¡Œé¢ï¼Œæ­£åœ¨è§¦å‘è‡ªåŠ¨å®‰è£…...${NC}"
        run_task "$SELECTED" "éƒ¨ç½² XFCE4 ç¯å¢ƒ" "gui"
    fi
    
    clear; echo -e "${G}1. æœ¬åœ°æ¨¡å¼ (Termux:X11)${NC}"; echo "2. è¿œç¨‹æ¨¡å¼ (VNC)"
    read -p "é€‰æ‹©: " m
    
    if [ "$m" == "1" ]; then
        # 6. ä¾èµ–ç†”æ–­
        if ! pm list packages | grep -q "com.termux.x11"; then
            echo -e "\n${R}âŒ ç†”æ–­ï¼šæœªæ£€æµ‹åˆ° Termux:X11 APPã€‚${NC}"
            echo "è¯·å…ˆå®‰è£… APP å†ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚"
            read -n 1 -s; return
        fi
        # è¿›ç¨‹é‡ç½®
        pkill -9 termux-x11 >/dev/null 2>&1
        rm -rf $TMPDIR/.X11-unix
        
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

# SSH é€»è¾‘ (å–‚é¥­çº§)
do_ssh_remote() {
    tput cnorm; stty echo; clear
    echo -e "${C}=== ç”µè„‘è¿æ¥å¼•å¯¼ ===${NC}"
    USER=$(whoami); IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
    
    # å¯†ç çŠ¶æ€æ£€æµ‹
    if ! grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null; then
         echo -e "${Y}æ£€æµ‹åˆ°æœªè®¾ç½®å¯†ç ï¼Œè¯·è®¾ç½®:${NC}"; passwd
    else
         read -p "é‡è®¾å¯†ç ? (y/n): " k; [ "$k" == "y" ] && passwd
    fi
    
    pkill sshd; sshd
    
    echo -e "\n${G}âœ… æœåŠ¡å·²å°±ç»ªã€‚ç”µè„‘ç«¯æ“ä½œå¦‚ä¸‹ï¼š${NC}"
    echo -e "-------------------------------------"
    echo -e "1. æŒ‰ Win + Rï¼Œè¾“å…¥ cmd å›è½¦"
    echo -e "2. ç²˜è´´å‘½ä»¤: \033[1;33mssh -p 8022 $USER@$IP\033[0m"
    echo -e "-------------------------------------"
    echo -e "${R}æŠ¥é”™è§£å†³å‘½ä»¤: del %USERPROFILE%\.ssh\config${NC}"
    read -n 1 -s
}

do_del() { 
    select_sys; [ $? -ne 0 ] && return
    echo -e "${R}âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†ï¼${NC}"
    read -p "ç¡®è®¤åˆ é™¤è¾“å…¥ y : " k
    if [ "$k" == "y" ]; then 
        proot-distro remove "$SELECTED"
        rm -rf "$ROOTFS_BASE/$SELECTED"
        echo "å·²é”€æ¯ã€‚"; read -n 1 -s
    fi
}

# --- [Level 5] UI æ¸²æŸ“å¼•æ“ ---
draw_base() {
    clear
    echo -e "${C}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] ç”µè„‘è¿æ¥ (SSH)${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] é€€å‡ºç¨‹åº${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${C}â¤ æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://'); [ -z "$IP" ] && IP="ç¦»çº¿"
    MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    tput sc; tput cup 5 0
    printf " ${W}Ver:${NC} ${Y}%-7s${NC} | ${W}Time:${NC} ${Y}%s${NC} | IP:${W}%-13s${NC} RAM:${B}%s${NC}\033[K" "$VERSION" "$T" "$IP" "$MEM"
    tput rc
}

# --- ä¸»å¾ªç¯ ---
check_dependencies
draw_base
while true; do
    refresh_info
    read -t 1 -n 1 choice; STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    case "$choice" in
        1) do_login; draw_base ;; 
        2) do_install; draw_base ;; 
        3) do_gui; draw_base ;;
        4) do_ssh_remote; draw_base ;; 
        5) do_del; draw_base ;; 
        6) exit 0 ;;
        *) ;; 
    esac
done
MAIN_EOF

# å¯åŠ¨
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;32mâœ… æ³°å¦å…¨è£…ç”²ç‰ˆ v140.0 å·²å°±ç»ª\033[0m"
echo -e "-------------------------------------------"
echo -e "å·²åŠ è½½é€»è¾‘é˜²å¾¡æ¨¡å—ï¼š"
echo -e "ğŸ›¡ï¸ [å­˜å‚¨ç†”æ–­] ç©ºé—´ä¸è¶³æ‹’ç»æ‰§è¡Œï¼Œé˜²æ­¢å¡æ­»"
echo -e "ğŸ›¡ï¸ [é…ç½®å‡€åŒ–] è‡ªåŠ¨ä¿®å¤ fastfetch é‡å¤æ˜¾ç¤º"
echo -e "ğŸ›¡ï¸ [å°¸æ£€æœºåˆ¶] è‡ªåŠ¨è¯†åˆ«å¹¶åˆ é™¤æŸåçš„ç³»ç»Ÿ"
echo -e "-------------------------------------------"
read -n 1
xxy

#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v5.0 ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®±ï¼ˆAIä¼˜åŒ–å¢å¼ºç‰ˆï¼‰
# æ•´åˆï¼šShizukuè‡ªåŠ¨ä¿®å¤ | Debianç”Ÿäº§åŠ›ç¯å¢ƒ | VSCode | äºŒçº§èœå• | æ—¥å¿—ç³»ç»Ÿ | å¤‡ä»½æ¢å¤
# ==============================================================================

# --- [0] å…¨å±€é…ç½® ---
export SCRIPT_VERSION="5.0"
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export DISTRO_NAME="debian"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs/$DISTRO_NAME"
export TMP_WORKER="$PREFIX/tmp/worker_script.sh"
export TMP_DIR="$PREFIX/tmp/"
export LOG_DIR="$HOME/.xxy/logs"
export LOG_FILE="$LOG_DIR/xxy_$(date +%Y%m%d).log"
export CONFIG_DIR="$HOME/.xxy"
export CONFIG_FILE="$CONFIG_DIR/config.conf"
export BACKUP_DIR="$HOME/.xxy/backups"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p "$LOG_DIR" "$CONFIG_DIR" "$BACKUP_DIR"

# ä¿¡å·æ•è·
trap 'echo -e "\n${G}[XXY] å·²å®‰å…¨é€€å‡ºã€‚${NC}"; log_info "ç”¨æˆ·é€€å‡ºç¨‹åº"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ“ æ—¥å¿—ç³»ç»Ÿ
# ==============================================================================

# æ—¥å¿—å‡½æ•°
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" >> "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$LOG_FILE"
}

log_warn() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1" >> "$LOG_FILE"
}

# ==============================================================================
# âš™ï¸ é…ç½®ç®¡ç†
# ==============================================================================

# åŠ è½½é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        log_info "é…ç½®æ–‡ä»¶å·²åŠ è½½"
    else
        # åˆ›å»ºé»˜è®¤é…ç½®
        cat > "$CONFIG_FILE" << 'CONFIG_EOF'
# XXY é…ç½®æ–‡ä»¶
MIRROR_SOURCE="tuna"  # å¯é€‰: tuna, ustc, aliyun
TERMUX_X11_LEGACY="false" # æ—§æ‰‹æœºçš„ Termux X11 æ”¯æŒ
AUTO_UPDATE_CHECK="true"  # è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
LOG_RETENTION_DAYS="7"  # æ—¥å¿—ä¿ç•™å¤©æ•°
BACKUP_COMPRESSION="true"  # å¤‡ä»½æ—¶æ˜¯å¦å‹ç¼©
CONFIG_EOF
        source "$CONFIG_FILE"
        log_info "å·²åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
    fi
}

# ==============================================================================
# ğŸ”„ ç‰ˆæœ¬æ£€æŸ¥å’Œæ›´æ–°
# ==============================================================================

# æ£€æŸ¥æ›´æ–°
check_update() {
    log_info "æ£€æŸ¥ç‰ˆæœ¬æ›´æ–°"
    local remote_version=$(curl -s "https://raw.githubusercontent.com/Xiaoxinyun2008/XXY-Termux/main/version.txt" 2>/dev/null || echo "")
    
    if [ -n "$remote_version" ] && [ "$remote_version" != "$SCRIPT_VERSION" ]; then
        echo -e "${Y}å‘ç°æ–°ç‰ˆæœ¬: $remote_version (å½“å‰: $SCRIPT_VERSION)${NC}"
        read -p "æ˜¯å¦ç«‹å³æ›´æ–°? (y/n): " update_choice
        if [ "$update_choice" == "y" ]; then
            log_info "å¼€å§‹æ›´æ–°åˆ°ç‰ˆæœ¬ $remote_version"
            bash -c "$(curl -fsSL https://raw.githubusercontent.com/Xiaoxinyun2008/XXY-Termux/main/xxy)"
            log_info "æ›´æ–°å®Œæˆ"
            exit 0
        fi
    else
        log_info "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    fi
}

# ==============
# Rootfs scripts
# ==============
create_rootfs_script(){
   # MIRRORS Change...
   # mirrors.tuna
   if [ "$MIRROR_SOURCE" == "tuna" ];then
   cat > "$TMP_DIR/mirrors" << EOF
echo " >>> [å†…éƒ¨] æ ¹æ®é…ç½®ï¼Œé€‰æ‹©äº† tuna"
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ trixie main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ trixie-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security trixie-security main contrib non-free non-free-firmware
SOURCES
EOF
   fi
   # mirrors.utsc
   if [ "$MIRROR_SOURCE" == "ustc" ];then
   cat > "$TMP_DIR/mirrors" << EOF
echo " >>> [å†…éƒ¨] æ ¹æ®é…ç½®ï¼Œé€‰æ‹©äº† utsc"
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.utsc.edu.cn/debian/ trixie main contrib non-free non-free-firmware
deb https://mirrors.utsc.edu.cn/debian/ trixie-updates main contrib non-free non-free-firmware
deb https://mirrors.utsc.edu.cn/debian-security trixie-security main contrib non-free non-free-firmware
SOURCES
EOF
   fi
   # All in One
   cat > "$TMP_WORKER" << EOF
#!/bin/bash
set -e

# [1] åˆ‡æ¢å›½å†…æº
$(cat $TMP_DIR/mirrors)

# [2] æ›´æ–°å¹¶å®‰è£…åŸºç¡€è½¯ä»¶
echo ">>> [å†…éƒ¨] æ­£åœ¨å®‰è£…æ¡Œé¢ (è€—æ—¶è¾ƒé•¿)..."
apt update -y
export DEBIAN_FRONTEND=noninteractive

# å®‰è£…ç»„ä»¶
apt install -y sudo nano wget curl git \
    xfce4 xfce4-terminal dbus-x11

# è¯¢é—®
case \$(read -p " >>> æ˜¯å¦éœ€è¦å®‰è£…åˆå§‹ç»„ä»¶ï¼Ÿ(xfce4 è½¯ä»¶æ‰©å±•åŒ…, python3 å¼€å‘, firefox æµè§ˆå™¨, fcitx5 è¾“å…¥æ³•) [y/n, é»˜è®¤y]") in
  "n"|"no") : ;;
  "y"|"yes"|*)
    apt install -y xfce4-goodies build-essential python3-full \
    firefox-esr \
    fonts-noto-cjk fonts-noto-color-emoji \
    fcitx5 fcitx5-chinese-addons fcitx5-frontend-gtk4 fcitx5-frontend-gtk3 fcitx5-frontend-qt5 \
    im-config
  ;;
esac

# [3] ä¸­æ–‡ç¯å¢ƒé…ç½®
echo ">>> [å†…éƒ¨] ç”Ÿæˆä¸­æ–‡ Locale..."
apt install -y locales
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

# [4] ç¯å¢ƒå˜é‡ (ä¿®å¤è¾“å…¥æ³•å’Œæ˜¾ç¤º)
echo ">>> [å†…éƒ¨] é…ç½®ç¯å¢ƒå˜é‡..."
cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh

# [5] è½¯ä»¶ä¿®å¤è¡¥ä¸
echo ">>> [å†…éƒ¨] åº”ç”¨ Firefox/VSCode é˜²é—ªé€€è¡¥ä¸..."
echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc
# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ä¿®å¤
mkdir -p /usr/share/applications
sed -i 's/Exec=firefox-esr %u/Exec=firefox-esr --no-remote %u/g' /usr/share/applications/firefox-esr.desktop 2>/dev/null || true

# [6] æ¸…ç†
apt autoremove -y; apt clean
echo ">>> [å†…éƒ¨] ç¯å¢ƒæ„å»ºå®Œæˆï¼"
EOF
}

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒæ¨¡å—ï¼šå®¹å™¨å†…éƒ¨æ„å»ºè„šæœ¬ (Worker)
# ==============================================================================
create_worker_script() {
    mkdir -p "$PREFIX/tmp"
    create_rootfs_script # è½¬åˆ°ä¸Šé¢çš„è„šæœ¬æ„å»º
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸ”§ åŠŸèƒ½å‡½æ•°
# ==============================================================================

log() { 
    echo -e "${G}[XXY] $1${NC}"
    log_info "$1"
}

warn() { 
    echo -e "${Y}[æç¤º] $1${NC}"
    log_warn "$1"
}

err() { 
    echo -e "${R}[é”™è¯¯] $1${NC}"
    log_error "$1"
}

# æ˜¾ç¤ºè¿›åº¦æ¡
show_progress() {
    local current=$1
    local total=$2
    local width=50
    local percentage=$((current * 100 / total))
    local completed=$((width * current / total))
    
    printf "\r${G}è¿›åº¦: ["
    printf '%*s' "$completed" | tr ' ' '='
    printf '%*s' "$((width - completed))" | tr ' ' ' '
    printf "] %d%%${NC}" "$percentage"
}

# æ¸…ç†æ—§æ—¥å¿—
clean_old_logs() {
    log_info "æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶"
    find "$LOG_DIR" -name "xxy_*.log" -mtime +${LOG_RETENTION_DAYS:-7} -delete 2>/dev/null
}

# --- è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤ Shizuku ç¯å¢ƒ ---
auto_fix_shizuku() {
    log "æ­£åœ¨æ£€æŸ¥ Shizuku ç¯å¢ƒ..."
    
    # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ä¸‹è½½ (ä½¿ç”¨å›½å†…æº)
    if [ ! -f "$PREFIX/bin/rish" ] || [ ! -f "$PREFIX/bin/rish_shizuku.dex" ]; then
        echo -e "${Y}>>> æ­£åœ¨ä¸‹è½½ rish ç»„ä»¶ (å›½å†…é«˜é€Ÿé•œåƒ)...${NC}"
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish" -o $PREFIX/bin/rish
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish_shizuku.dex" -o $PREFIX/bin/rish_shizuku.dex
        chmod +x $PREFIX/bin/rish
    fi

    # 2. å°è¯•æ‰§è¡Œ
    log "æ­£åœ¨å°è¯•é€šè¿‡ Shizuku è§£é™¤è¿›ç¨‹é™åˆ¶..."
    echo -e "${Y}âš ï¸  æ³¨æ„ï¼šå¦‚æœ Shizuku å¼¹å‡ºæˆæƒçª—å£ï¼Œè¯·åŠ¡å¿…ç‚¹å‡»ã€å§‹ç»ˆå…è®¸ã€‘ï¼${NC}"
    
    if $PREFIX/bin/rish -c "/system/bin/device_config put activity_manager max_phantom_processes 2147483647 && cmd appops set com.termux RUN_IN_BACKGROUND allow" 2>/dev/null; then
        echo -e "${G}âœ… ä¿®å¤æˆåŠŸï¼Termux å·²è·å¾—å…æ­»é‡‘ç‰Œã€‚${NC}"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
    else
        echo -e "${R}âŒ æˆæƒå¤±è´¥ã€‚${NC}"
        echo "å¯èƒ½åŸå› ï¼šShizuku æœªå¯åŠ¨ï¼Œæˆ–æœªæˆæƒã€‚"
        echo "è¯·ç¡®ä¿ Shizuku APP æ­£åœ¨è¿è¡Œï¼Œç„¶åå†è¯•ä¸€æ¬¡ã€‚"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# --- å®‰è£…ç³»ç»Ÿ ---
install_system() {
    clear
    log "=== å®‰è£… Debian Trixie ==="
    # æ£€æŸ¥ä¾èµ–
    pkg install proot-distro pulseaudio termux-x11-nightly virglrenderer-android android-tools -y -o Dpkg::Options::="--force-confnew"

    if [ -d "$ROOTFS" ]; then
        read -p "ç³»ç»Ÿå·²å­˜åœ¨ï¼Œæ˜¯å¦åˆ é™¤é‡è£…? (y/n): " opt
        if [ "$opt" != "y" ]; then return; fi
        proot-distro remove "$DISTRO_NAME"
    fi

    log "æ­£åœ¨ä¸‹è½½ç³»ç»Ÿ (è¯·ä¿æŒç½‘ç»œç•…é€š)..."
    rm -rf "$PREFIX/var/lib/proot-distro/dlcache/$DISTRO_NAME"
    
    if proot-distro install "$DISTRO_NAME"; then
        echo "nameserver 223.5.5.5" > "$ROOTFS/etc/resolv.conf"
        create_worker_script
        log "æ­£åœ¨è¿›å…¥å®¹å™¨é…ç½®ç¯å¢ƒ (Firefox/ä¸­æ–‡/æ¡Œé¢)..."
        proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$TMP_WORKER"
        rm -f "$TMP_WORKER"
        log "ğŸ‰ ç³»ç»Ÿå®‰è£…å®Œæˆï¼"
    else
        err "ä¸‹è½½å¤±è´¥ã€‚è¯·å¼€å¯ VPN æˆ–æ£€æŸ¥ç½‘ç»œã€‚"
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- å®‰è£… VSCode ---
install_vscode() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    log "æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… VSCode (ARM64)..."
    
    # æ³¨å…¥å®‰è£…è„šæœ¬åˆ°å®¹å™¨
    cat > "$PREFIX/tmp/vscode_inst.sh" << 'EOF'
#!/bin/bash
cd /tmp
echo ">>> [å†…éƒ¨] ä¸‹è½½ VSCode.deb..."
wget -O code.deb "https://update.code.visualstudio.com/latest/linux-deb-arm64/stable"
echo ">>> [å†…éƒ¨] å®‰è£…ä¸­..."
apt install -y ./code.deb
rm code.deb
# ä¿®å¤å¯åŠ¨
echo ">>> [å†…éƒ¨] ä¿®å¤å¯åŠ¨å‚æ•°..."
echo 'alias code="code --no-sandbox --unity-launch"' >> /etc/bash.bashrc
sed -i 's/Exec=\/usr\/share\/code\/code/Exec=\/usr\/share\/code\/code --no-sandbox/g' /usr/share/applications/code.desktop 2>/dev/null || true
echo "âœ… VSCode å®‰è£…å®Œæˆã€‚"
EOF
    proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$PREFIX/tmp/vscode_inst.sh"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- å¤‡ä»½ç³»ç»Ÿ ---
backup_system() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 2; return; fi
    
    clear
    log "=== ç³»ç»Ÿå¤‡ä»½å·¥å…· ==="
    echo -e "å½“å‰ç³»ç»Ÿ: ${G}$DISTRO_NAME${NC}"
    
    local backup_name="xxy_${DISTRO_NAME}_$(date +%Y%m%d_%H%M%S)"
    local backup_file="$BACKUP_DIR/${backup_name}.tar.gz"
    
    echo -e "\nå¤‡ä»½å°†ä¿å­˜åˆ°: ${C}$backup_file${NC}"
    echo -e "é¢„è®¡å¤§å°: ${Y}$(du -sh "$ROOTFS" 2>/dev/null | cut -f1)${NC}"
    echo ""
    
    read -p "ç¡®å®šå¼€å§‹å¤‡ä»½å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ... (y/n): " confirm
    if [ "$confirm" != "y" ]; then
        log "ç”¨æˆ·å–æ¶ˆå¤‡ä»½"
        return
    fi
    
    log "å¼€å§‹å¤‡ä»½ç³»ç»Ÿ..."
    log_info "å¼€å§‹å¤‡ä»½: $backup_name"
    
    # æ˜¾ç¤ºè¿›åº¦æç¤º
    (
        cd "$PREFIX/var/lib/proot-distro/installed-rootfs"
        tar czf "$backup_file" "$DISTRO_NAME" 2>/dev/null
    ) &
    
    local tar_pid=$!
    echo -e "\n${Y}æ­£åœ¨æ‰“åŒ…å‹ç¼©ä¸­ï¼Œè¯·ç¨å€™...${NC}\n"
    
    # ç®€å•çš„è¿›åº¦æŒ‡ç¤º
    while kill -0 $tar_pid 2>/dev/null; do
        echo -n "."
        sleep 1
    done
    wait $tar_pid
    
    if [ -f "$backup_file" ]; then
        local size=$(du -h "$backup_file" | cut -f1)
        echo -e "\n\n${G}âœ… å¤‡ä»½æˆåŠŸï¼${NC}"
        echo -e "æ–‡ä»¶ä½ç½®: ${C}$backup_file${NC}"
        echo -e "æ–‡ä»¶å¤§å°: ${Y}$size${NC}"
        log_info "å¤‡ä»½å®Œæˆ: $backup_file (å¤§å°: $size)"
    else
        err "å¤‡ä»½å¤±è´¥ï¼"
        log_error "å¤‡ä»½å¤±è´¥: $backup_name"
    fi
    
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- æ¢å¤ç³»ç»Ÿ ---
restore_system() {
    clear
    log "=== ç³»ç»Ÿæ¢å¤å·¥å…· ==="
    
    # åˆ—å‡ºå¯ç”¨å¤‡ä»½
    local backups=()
    while IFS= read -r -d '' backup; do
        backups+=("$backup")
    done < <(find "$BACKUP_DIR" -name "*.tar.gz" -print0 2>/dev/null | sort -z -r)
    
    if [ ${#backups[@]} -eq 0 ]; then
        warn "æœªæ‰¾åˆ°ä»»ä½•å¤‡ä»½æ–‡ä»¶"
        sleep 2
        return
    fi
    
    echo -e "\nå¯ç”¨å¤‡ä»½åˆ—è¡¨ï¼š"
    echo -e "${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    local i=1
    for backup in "${backups[@]}"; do
        local filename=$(basename "$backup")
        local size=$(du -h "$backup" | cut -f1)
        local date=$(echo "$filename" | grep -oP '\d{8}_\d{6}' || echo "æœªçŸ¥")
        echo -e "${G}[$i]${NC} $filename"
        echo -e "    å¤§å°: $size | æ—¥æœŸ: $date"
        ((i++))
    done
    echo -e "${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "[0] è¿”å›\n"
    
    read -p "è¯·é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½ç¼–å·: " choice
    
    if [ "$choice" == "0" ]; then return; fi
    if [ "$choice" -lt 1 ] || [ "$choice" -gt ${#backups[@]} ]; then
        err "æ— æ•ˆé€‰æ‹©"
        sleep 1
        return
    fi
    
    local selected_backup="${backups[$((choice-1))]}"
    
    echo -e "\n${R}âš ï¸  è­¦å‘Šï¼š${NC}æ¢å¤æ“ä½œå°†${R}å®Œå…¨è¦†ç›–${NC}å½“å‰ç³»ç»Ÿï¼"
    read -p "ç¡®å®šè¦æ¢å¤å—ï¼Ÿ(è¾“å…¥ YES ç¡®è®¤): " confirm
    
    if [ "$confirm" != "YES" ]; then
        log "ç”¨æˆ·å–æ¶ˆæ¢å¤"
        return
    fi
    
    log "å¼€å§‹æ¢å¤ç³»ç»Ÿ..."
    log_info "æ¢å¤å¤‡ä»½: $selected_backup"
    
    # åˆ é™¤ç°æœ‰ç³»ç»Ÿ
    if [ -d "$ROOTFS" ]; then
        proot-distro remove "$DISTRO_NAME" 2>/dev/null || true
    fi
    
    # è§£å‹å¤‡ä»½
    echo -e "\n${Y}æ­£åœ¨è§£å‹æ¢å¤ä¸­...${NC}\n"
    (
        cd "$PREFIX/var/lib/proot-distro/installed-rootfs"
        tar xzf "$selected_backup"
    ) &
    
    local tar_pid=$!
    while kill -0 $tar_pid 2>/dev/null; do
        echo -n "."
        sleep 1
    done
    wait $tar_pid
    
    if [ -d "$ROOTFS" ]; then
        echo -e "\n\n${G}âœ… æ¢å¤æˆåŠŸï¼${NC}"
        log_info "ç³»ç»Ÿæ¢å¤å®Œæˆ"
    else
        err "æ¢å¤å¤±è´¥ï¼"
        log_error "ç³»ç»Ÿæ¢å¤å¤±è´¥"
    fi
    
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# åªè¿›å…¥bash

# --- å¯åŠ¨æ¡Œé¢ ---
start_desktop() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    clear
    log "ğŸš€ æ­£åœ¨å¯åŠ¨æ¡Œé¢..."
    
    # æ¸…ç† & å¯åŠ¨æœåŠ¡
    killall -9 termux-x11 Xwayland pulseaudio virgl_test_server_android >/dev/null 2>&1
    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    
    # tx11 
    case "$TERMUX_X11_LEGACY" in
      "true") tx11_legacyt="-legacy-drawer" ;;
      "false"|*) tx11_legacy="" ;;
    esac
    termux-x11 :0 -ac ${tx11_legacy} &
    
    # ç­‰å¾… X11 å‡†å¤‡å°±ç»ª
    local count=0
    while [ ! -S "$PREFIX/tmp/.X11-unix/X0" ]; do
        sleep 0.2
        count=$((count+1))
        if [ $count -gt 30 ]; then err "Termux:X11 å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† APP"; return; fi
    done
    
    virgl_test_server_android &
    pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    
    log "æ­£åœ¨ç™»å…¥ç³»ç»Ÿ..."
    proot-distro login "$DISTRO_NAME" --shared-tmp -- bash -c "
        export DISPLAY=:0
        export PULSE_SERVER=127.0.0.1
        fcitx5 -d &
        dbus-launch --exit-with-session startxfce4
    "
}

# ==============================================================================
# ğŸ“º èœå•ç³»ç»Ÿ (äºŒçº§èœå•è®¾è®¡)
# ==============================================================================

# äºŒçº§èœå•ï¼šå®‰è£…ç®¡ç†
menu_install() {
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€ [å®‰è£…ç®¡ç†] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "1. ${G}ä¸€é”®å®‰è£… Debian ç”Ÿäº§åŠ›ç‰ˆ${NC} (å«ä¸­æ–‡/æ¡Œé¢/æµè§ˆå™¨)"
        echo -e "2. ${C}å®‰è£… VSCode${NC} (éœ€å…ˆè£…ç³»ç»Ÿ)"
        echo -e "3. å¸è½½ç³»ç»Ÿ"
        echo -e "0. è¿”å›ä¸Šä¸€çº§"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        read -p "ğŸ‘‰ é€‰æ‹©: " sub_opt
        case "$sub_opt" in
            1) install_system ;;
            2) install_vscode ;;
            3) 
               read -p "ç¡®å®šåˆ é™¤å—? (y/n): " del_conf
               if [ "$del_conf" == "y" ]; then proot-distro remove "$DISTRO_NAME"; fi ;;
            0) return ;;
        esac
    done
}

# äºŒçº§èœå•ï¼šç»´æŠ¤å·¥å…·
menu_maintenance() {
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€ [ç»´æŠ¤å·¥å…·] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "1. ${Y}Termux é˜² Signal9 è¢«æ€åå°${NC} (å…¨è‡ªåŠ¨)"
        echo -e "2. æ¸…ç†ä¸‹è½½ç¼“å­˜ (ä¿®å¤å®‰è£…å¤±è´¥)"
        echo -e "3. ${G}å¤‡ä»½ç³»ç»Ÿ${NC} (å®Œæ•´æ‰“åŒ…)"
        echo -e "4. ${C}æ¢å¤ç³»ç»Ÿ${NC} (ä»å¤‡ä»½æ¢å¤)"
        echo -e "5. æ¸…ç†æ—§æ—¥å¿—"
        echo -e "6. æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯"
        echo -e "0. è¿”å›ä¸Šä¸€çº§"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        read -p "ğŸ‘‰ é€‰æ‹©: " sub_opt
        case "$sub_opt" in
            1) auto_fix_shizuku ;;
            2) rm -rf "$PREFIX/var/lib/proot-distro/dlcache"; log "å·²æ¸…ç†ã€‚"; sleep 1 ;;
            3) backup_system ;;
            4) restore_system ;;
            5) clean_old_logs; log "æ—¥å¿—æ¸…ç†å®Œæˆ"; sleep 1 ;;
            6) show_system_info ;;
            0) return ;;
        esac
    done
}

# --- æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯ ---
show_system_info() {
    clear
    log "=== ç³»ç»Ÿä¿¡æ¯ ==="
    echo ""
    echo -e "${G}ç‰ˆæœ¬ä¿¡æ¯:${NC}"
    echo -e "  XXY ç‰ˆæœ¬: ${C}v$SCRIPT_VERSION${NC}"
    echo -e "  ç³»ç»Ÿ: $(uname -o)"
    echo ""
    echo -e "${G}å®‰è£…çŠ¶æ€:${NC}"
    if [ -d "$ROOTFS" ]; then
        echo -e "  Linux å®¹å™¨: ${G}âœ“ å·²å®‰è£…${NC} ($DISTRO_NAME)"
        echo -e "  å®¹å™¨å¤§å°: ${Y}$(du -sh "$ROOTFS" 2>/dev/null | cut -f1)${NC}"
    else
        echo -e "  Linux å®¹å™¨: ${R}âœ— æœªå®‰è£…${NC}"
    fi
    echo ""
    echo -e "${G}å¤‡ä»½ä¿¡æ¯:${NC}"
    local backup_count=$(find "$BACKUP_DIR" -name "*.tar.gz" 2>/dev/null | wc -l)
    echo -e "  å¤‡ä»½æ•°é‡: ${Y}$backup_count${NC}"
    if [ $backup_count -gt 0 ]; then
        local total_size=$(du -sh "$BACKUP_DIR" 2>/dev/null | cut -f1)
        echo -e "  æ€»å¤§å°: ${Y}$total_size${NC}"
    fi
    echo ""
    echo -e "${G}æ—¥å¿—ä¿¡æ¯:${NC}"
    local log_count=$(find "$LOG_DIR" -name "*.log" 2>/dev/null | wc -l)
    echo -e "  æ—¥å¿—æ–‡ä»¶: ${Y}$log_count${NC}"
    echo -e "  æ—¥å¿—ç›®å½•: ${C}$LOG_DIR${NC}"
    echo ""
    echo -e "${G}é…ç½®æ–‡ä»¶:${NC}"
    echo -e "  é…ç½®è·¯å¾„: ${C}$CONFIG_FILE${NC}"
    echo ""
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# ä¸»èœå•
main_menu() {
    # åŠ è½½é…ç½®
    load_config
    
    # æ¸…ç†æ—§æ—¥å¿—
    clean_old_logs
    
    # æ£€æŸ¥æ›´æ–°
    if [ "$AUTO_UPDATE_CHECK" == "true" ]; then
        check_update
    fi
    
    # é¦–æ¬¡å¯åŠ¨è‡ªæ£€
    if [ ! -f "$PREFIX/etc/apt/sources.list.d/x11.list" ]; then 
        log "å®‰è£… X11 ä»“åº“..."
        pkg install x11-repo -y
    fi
    
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "${B}â”‚       XXY v$SCRIPT_VERSION ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®± (AIå¢å¼ºç‰ˆ) â”‚${NC}"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        echo -e "å½“å‰çŠ¶æ€: $(if [ -d "$ROOTFS" ]; then echo "${G}Debian å·²å°±ç»ª${NC}"; else echo "${R}æœªå®‰è£…ç³»ç»Ÿ${NC}"; fi)"
        echo ""
        echo -e "1. ${G}ğŸš€ å¯åŠ¨æ¡Œé¢ç¯å¢ƒ${NC} (æ—¥å¸¸ä½¿ç”¨ç‚¹è¿™ä¸ª)"
        echo -e "2. ğŸ’¿ å®‰è£…/ç®¡ç†ç³»ç»Ÿ (äºŒçº§èœå•)"
        echo -e "3. ğŸ› ï¸ ç»´æŠ¤/é˜²é—ªé€€ä¿®å¤ (äºŒçº§èœå•)"
        echo -e "0. âŒ é€€å‡º"
        echo ""
        read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " main_opt
        
        case "$main_opt" in
            1) start_desktop ;;
            2) menu_install ;;
            3) menu_maintenance ;;
            0) exit 0 ;;
            *) ;;
        esac
    done
}

# --- å¯åŠ¨ ---
main_menu

# ==============================================================================
# ğŸŒŒ XXY v500.0 Universe (å®‡å®™ç»ˆæç‰ˆ)
# SYSTEM: Autonomous Operation System for Termux
# CORE: Logic-Matrix v5.0 | Anti-Fool v9.0 | SSH-Radar | GUI-Desktop
# ==============================================================================

# --- [Phase 0: åˆ›ä¸–çºª (Genesis)] ---
# åˆå§‹åŒ–ç»ˆç«¯ç¯å¢ƒï¼Œç¡®ä¿æ˜¾ç¤ºæ­£å¸¸
tput cnorm
clear

# é¢œè‰²å¸¸é‡åº“ (ä¸ºäº†å¥½çœ‹çš„UIï¼Œå¿…é¡»å®šä¹‰å…¨å¥—)
R=$(tput setaf 196); G=$(tput setaf 46); Y=$(tput setaf 226)
B=$(tput setaf 39);  P=$(tput setaf 201); C=$(tput setaf 51)
W=$(tput setaf 255); GR=$(tput setaf 240); OR=$(tput setaf 208)
NC=$(tput sgr0); BOLD=$(tput bold)

echo -e "${C}[SYSTEM] æ­£åœ¨åŠ è½½å®‡å®™çº§é€»è¾‘æ ¸å¿ƒ...${NC}"
echo -e "${GR}----------------------------------------${NC}"

# 1. æ·±åº¦æ¸…ç†é€»è¾‘ (é˜²æ­¢æ—§ç‰ˆæœ¬å¹²æ‰°)
# æˆ‘ä»¬ä¸åªæ˜¯åˆ é™¤ï¼Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥æ˜¯å¦åˆ é™¤æˆåŠŸ
clean_list="sshd termux-x11 pulseaudio Xwayland vncserver proot"
for proc in $clean_list; do
    if pgrep -x "$proc" >/dev/null; then
        echo -e "${Y} -> æ­£åœ¨ç»ˆæ­¢è¿›ç¨‹: $proc${NC}"
        pkill -9 "$proc" >/dev/null 2>&1
    fi
done

# 2. é‡ç½®æ–‡ä»¶ç³»ç»Ÿ
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download

# --- [Phase 1: æ³¨å…¥æ ¸å¿ƒä»£ç ] ---
# è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„ Here-Documentï¼ŒåŒ…å«äº†æ•´ä¸ªç³»ç»Ÿçš„é€»è¾‘
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ—ï¸ SYSTEM CONFIGURATION (ç³»ç»Ÿé…ç½®å±‚)
# ==============================================================================
export VERSION="v500.0 å®‡å®™ç‰ˆ"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export AUDIT_LOG="$TMPDIR/xxy_audit.log"
export ERROR_LOG="$TMPDIR/xxy_error.log"
export LANG="C.UTF-8"

# ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# é¢œè‰²å®šä¹‰ (å†…éƒ¨å†æ¬¡å®šä¹‰ä»¥é˜²ä¸¢å¤±)
R=$(tput setaf 196); G=$(tput setaf 46); Y=$(tput setaf 226)
B=$(tput setaf 39);  P=$(tput setaf 201); C=$(tput setaf 51)
W=$(tput setaf 255); GR=$(tput setaf 240); NC=$(tput sgr0)

# å¼‚å¸¸æ•è·ç³»ç»Ÿ (Panic Handler)
# æ— è®ºç”¨æˆ·æ€ä¹ˆä¹±æŒ‰ Ctrl+Cï¼Œç³»ç»Ÿéƒ½ä¼šä¼˜é›…é€€å‡ºï¼Œè€Œä¸æ˜¯ç‚¸å‡ºä¸€å †ä»£ç 
trap_exit() {
    tput cnorm
    stty echo
    echo -e "\n${P}ğŸ›‘ [SYSTEM] ç³»ç»Ÿå·²å®‰å…¨æŒ‚èµ·ã€‚æ‰€æœ‰åå°ä»»åŠ¡å·²å†»ç»“ã€‚${NC}"
    echo -e "${GR}æç¤ºï¼šå¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æˆªå›¾åé¦ˆã€‚${NC}"
    exit 0
}
trap trap_exit EXIT INT TERM

# ==============================================================================
# ğŸ“š KNOWLEDGE BASE (å†…ç½®ç™¾ç§‘å…¨ä¹¦ - å¢åŠ æ–‡æœ¬é‡ä¸æ•™ç¨‹æ·±åº¦)
# ==============================================================================
show_encyclopedia() {
    while true; do
        clear
        echo -e "${C}=== ğŸ“– ç»ˆæä¿å§†ç™¾ç§‘å…¨ä¹¦ ===${NC}"
        echo -e "${GR}è¿™é‡ŒåŒ…å«äº†å°ç™½éœ€è¦çŸ¥é“çš„ä¸€åˆ‡çŸ¥è¯†${NC}"
        echo -e "----------------------------------------"
        echo -e "${W}1. ä»€ä¹ˆæ˜¯ Termux / Proot?${NC}"
        echo -e "${W}2. ä¸ºä»€ä¹ˆå®‰è£…ç³»ç»Ÿä¼šå¤±è´¥?${NC}"
        echo -e "${W}3. SSH æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ${NC}"
        echo -e "${W}4. æ€ä¹ˆæŠŠæ‰‹æœºå˜æˆç”µè„‘ (å›¾å½¢åŒ–)?${NC}"
        echo -e "${W}5. æŠ¥é”™ 'Bad port' æ€ä¹ˆä¿®?${NC}"
        echo -e "${W}0. è¿”å›ä¸»èœå•${NC}"
        echo -e "----------------------------------------"
        
        read -p "ğŸ‘‰ è¯·é€‰æ‹©æƒ³è¦å­¦ä¹ çš„çŸ¥è¯†ç‚¹: " topic
        case "$topic" in
            1) 
                echo -e "\n${Y}[çŸ¥è¯†ç‚¹ 1]${NC}"
                echo -e "Termux æ˜¯æ‰‹æœºä¸Šçš„ä¸€ä¸ª Linux ç»ˆç«¯ã€‚ä½†å®ƒä¸æ˜¯å®Œæ•´çš„ Linuxã€‚"
                echo -e "Proot æ˜¯ä¸€ä¸ªé­”æ³•å·¥å…·ï¼Œå®ƒèƒ½åœ¨ Termux é‡Œå†æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„ Linux (å¦‚ Ubuntu)ã€‚"
                echo -e "æˆ‘ä»¬ç°åœ¨çš„æ“ä½œï¼Œå°±æ˜¯åœ¨è¿™ä¸ªæ¨¡æ‹Ÿçš„ç³»ç»Ÿé‡Œå®‰è£…è½¯ä»¶ã€‚"
                read -n 1 -s -p "æŒ‰ä»»æ„é”®ç»§ç»­..." ;;
            2)
                echo -e "\n${Y}[çŸ¥è¯†ç‚¹ 2]${NC}"
                echo -e "å®‰è£…å¤±è´¥ 99% éƒ½æ˜¯å› ä¸ºã€ç½‘ç»œé—®é¢˜ã€‘ã€‚"
                echo -e "ä¸‹è½½ç³»ç»Ÿéœ€è¦è¿æ¥ GitHub æˆ–å›½å¤–çš„é•œåƒæºã€‚"
                echo -e "å¦‚æœè¿›åº¦æ¡ä¸åŠ¨ï¼Œæˆ–è€…æç¤º Errorï¼Œè¯·åŠ¡å¿…ã€å¼€å¯é­”æ³• (VPN)ã€‘ã€‚"
                echo -e "å¦å¤– 1% æ˜¯å› ä¸ºã€å­˜å‚¨ç©ºé—´ä¸è¶³ã€‘ï¼Œè¯·ç¡®ä¿æ‰‹æœºæœ‰ 5G ä»¥ä¸Šå‰©ä½™ç©ºé—´ã€‚"
                read -n 1 -s -p "æŒ‰ä»»æ„é”®ç»§ç»­..." ;;
            3)
                echo -e "\n${Y}[çŸ¥è¯†ç‚¹ 3]${NC}"
                echo -e "SSH (Secure Shell) æ˜¯è¿œç¨‹æ§åˆ¶ç¥å™¨ã€‚"
                echo -e "å®ƒè®©ä½ èƒ½åœ¨ç”µè„‘çš„å¤§å±å¹•ã€å¤§é”®ç›˜ä¸Šï¼Œæ•²æ‰‹æœºçš„ä»£ç ã€‚"
                echo -e "æœ¬ç³»ç»Ÿå†…ç½®äº† SSH ç›‘æ§ï¼Œä½ å¯ä»¥çœ‹åˆ°è°è¿äº†ä½ ï¼Œè¿˜èƒ½è¸¢äººã€‚"
                read -n 1 -s -p "æŒ‰ä»»æ„é”®ç»§ç»­..." ;;
            4)
                echo -e "\n${Y}[çŸ¥è¯†ç‚¹ 4]${NC}"
                echo -e "è¦çœ‹å›¾å½¢ç•Œé¢ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š"
                echo -e "æ–¹æ¡ˆA (æœ¬åœ°): å®‰è£… Termux:X11 APPï¼Œé€Ÿåº¦æœ€å¿«ï¼Œæ‰‹æœºç›´æ¥çœ‹ã€‚"
                echo -e "æ–¹æ¡ˆB (è¿œç¨‹): ä½¿ç”¨ VNC æˆ– SSH X11 è½¬å‘ï¼Œåœ¨ç”µè„‘ä¸Šçœ‹æ‰‹æœºçš„ç”»é¢ã€‚"
                read -n 1 -s -p "æŒ‰ä»»æ„é”®ç»§ç»­..." ;;
            5)
                echo -e "\n${Y}[çŸ¥è¯†ç‚¹ 5]${NC}"
                echo -e "å¦‚æœç”µè„‘ CMD æŠ¥é”™ 'Bad port' æˆ– 'Host key verification failed'ã€‚"
                echo -e "è¿™æ˜¯å› ä¸ºä½ é‡è£…è¿‡ Termuxï¼Œç”µè„‘è®¤ä¸ºè¢«é»‘å®¢æ”»å‡»äº†ã€‚"
                echo -e "è§£å†³æ–¹æ³•ï¼šåœ¨ç”µè„‘ CMD è¿è¡Œ \033[1;31mdel %USERPROFILE%\.ssh\config\033[0m"
                read -n 1 -s -p "æŒ‰ä»»æ„é”®ç»§ç»­..." ;;
            0) return ;;
            *) echo "âŒ é€‰é”™äº†ï¼Œè¯·é‡é€‰ã€‚" ;;
        esac
    done
}

# ==============================================================================
# ğŸ›¡ï¸ LOGIC DEFENSE SYSTEM (é€»è¾‘é˜²å¾¡ç³»ç»Ÿ)
# ==============================================================================

# [é˜²å‘† 1] è¾“å…¥é”æ­»å™¨
# æ— è®ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿçš„å­—ç¬¦ï¼Œåªè¦ä¸æ˜¯åˆæ³•å­—ç¬¦ï¼Œå°±æ­»å¾ªç¯
ask_safe() {
    local prompt="$1"
    local valid="$2"
    while true; do
        read -p "$prompt" input
        # æ¸…æ´—è¾“å…¥ï¼šå»é™¤ç©ºæ ¼
        input=$(echo "$input" | tr -d ' ')
        
        if [ -z "$input" ]; then continue; fi
        
        # æ£€æŸ¥æ˜¯å¦åœ¨åˆæ³•åˆ—è¡¨é‡Œ
        if [[ "$valid" == *"$input"* ]] && [ ${#input} -eq 1 ]; then
            RET="$input"
            return 0
        else
            echo -e "${R}ğŸš« éæ³•è¾“å…¥ï¼è¯·è¾“å…¥ [ $valid ] ä¸­çš„ä¸€ä¸ªæ•°å­—ã€‚${NC}"
        fi
    done
}

# [é˜²å‘† 2] ç½‘ç»œå…¨ç»´æ‰«æ
check_net_full() {
    echo -ne "${Y}ğŸ“¡ [NET-SCAN] æ­£åœ¨è¿›è¡Œå…¨çƒèŠ‚ç‚¹æ¢æµ‹... ${NC}"
    local score=0
    # é˜¿é‡ŒDNS (CN)
    ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1 && score=$((score+1))
    # Google DNS (Global)
    ping -c 1 -W 1 8.8.8.8 >/dev/null 2>&1 && score=$((score+2))
    
    if [ $score -eq 0 ]; then
        echo "${R}âŒ [å…¨æ–­å¼€] (è¯·å¼€å¯ç½‘ç»œ)${NC}"; return 1
    elif [ $score -eq 1 ]; then
        echo "${Y}âš ï¸ [ä»…å›½å†…] (ä¸‹è½½å¯èƒ½ä¼šæ…¢)${NC}"; return 0
    else
        echo "${G}âœ… [å…¨é€šç•…] (å®Œç¾çŠ¶æ€)${NC}"; return 0
    fi
}

# [é˜²å‘† 3] ç¡¬ä»¶ç†”æ–­ä¿æŠ¤
check_hardware_safety() {
    # ç©ºé—´æ£€æµ‹
    local free_mb=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free_mb" -lt 2000 ]; then
        echo -e "${R}âŒ [å­˜å‚¨ç†”æ–­] å‰©ä½™ç©ºé—´ä¸è¶³ 2000MBã€‚${NC}"
        echo "å¼ºè¡Œå®‰è£…ä¼šå¯¼è‡´æ–‡ä»¶æŸåã€‚è¯·æ¸…ç†æ‰‹æœºç©ºé—´ã€‚"
        read -n 1 -s; return 1
    fi
    
    # ç”µé‡æ£€æµ‹ (å¦‚æœèƒ½è·å–åˆ°)
    if command -v termux-battery-status >/dev/null; then
        local bat=$(termux-battery-status | grep percentage | awk -F ': ' '{print $2}' | tr -d ',')
        if [ "$bat" -lt 10 ]; then
            echo -e "${R}âŒ [ç”µæºç†”æ–­] ç”µé‡ä½äº 10%ã€‚${NC}"
            read -n 1 -s; return 1
        fi
    fi
    return 0
}

# ==============================================================================
# ğŸ§  WORKER INJECTION (å®¹å™¨å†…éƒ¨é€»è¾‘)
# ==============================================================================
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    # æ³¨å…¥ä¸€ä¸ªé«˜é²æ£’æ€§çš„å†…éƒ¨è„šæœ¬
    cat >> "$W_FILE" << 'EOF'
#!/bin/sh
set -e
export PATH=$PATH:/usr/bin:/bin
export DEBIAN_FRONTEND=noninteractive
act=$1

# è‡ªåŠ¨è¯†åˆ«å±‚
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src) # æ™ºèƒ½æºåˆ‡æ¢
    if [ "$T" = "debian" ]; then 
        # åªæœ‰åœ¨ä¸æ˜¯æ¸…åæºçš„æ—¶å€™æ‰ä¿®æ”¹ï¼Œé˜²æ­¢é‡å¤è¿½åŠ 
        if ! grep -q "tsinghua" /etc/apt/sources.list; then
             grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list
             apt update -y
        fi
    elif [ "$T" = "alpine" ]; then 
        sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update
    fi ;;
  
  gui) # æ¡Œé¢ç¯å¢ƒéƒ¨ç½²
    if [ "$T" = "debian" ]; then 
        apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then 
        apk add xfce4 dbus-x11 tigervnc
    elif [ "$T" = "arch" ]; then
        pacman -S --noconfirm xfce4 dbus tigervnc
    fi
    mkdir -p ~/.vnc
    echo "123456" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd ;;
    
  clean) # æ·±åº¦å‡€åŒ–é€»è¾‘
    # æš´åŠ›æ¸…é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é‡å¤è¾“å‡ºçš„é…ç½®
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    sed -i '/neofetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;

  cn) # ä¸­æ–‡ç¯å¢ƒ
    if [ "$T" = "debian" ]; then 
        apt install -y locales fonts-noto-cjk
        echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen
        locale-gen
    fi ;;
    
  fetch) # å‘½ä»¤è¡Œç¾åŒ–
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$W_FILE"
}

run_task() {
    tput sc; tput cup 14 0; echo -ne "\033[J${Y}â³ [æ‰§è¡Œä¸­] $2...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" >> "$AUDIT_LOG" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… [æˆåŠŸ] $2${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ [è·³è¿‡] $2 (ä¸å½±å“ä½¿ç”¨)${NC}"
    fi
    tput rc; sleep 0.3
}

# ==============================================================================
# ğŸ® BUSINESS LOGIC (ä¸šåŠ¡é€»è¾‘å±‚)
# ==============================================================================

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

# æ™ºèƒ½é€‰æ‹©å™¨ (Logic Jail)
select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- ç³»ç»Ÿåˆ—è¡¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then 
        echo -e "\n${R}ğŸš« æœ¬åœ°æ²¡æœ‰ç³»ç»Ÿï¼${NC}"
        echo -e "è¯·å…ˆå»ä¸»èœå•é€‰ [2] å®‰è£…ç³»ç»Ÿã€‚"
        read -n 1 -s; return 1
    fi
    
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    
    local valid_s="0"
    for i in "${!LIST[@]}"; do valid_s="${valid_s}$((i+1))"; done
    echo "-------------------------"
    ask_safe "ğŸ‘‰ è¯·è¾“å…¥åºå·: " "$valid_s"
    
    [ "$RET" = "0" ] && return 2
    SELECTED="${LIST[$((RET-1))]}"
    return 0
}

# [Function 1] ç™»å½•é€»è¾‘ (å«è‡ªåŠ¨ä¿®å¤)
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    # 1. å°¸æ£€
    if [ ! -d "$ROOTFS_BASE/$SELECTED/bin" ]; then
        echo -e "\n${R}âŒ è‡´å‘½é”™è¯¯ï¼šè¯¥ç³»ç»Ÿæ˜¯ç©ºçš„ï¼${NC}"
        echo "åŸå› ï¼šä¸‹è½½è¿‡ç¨‹å®Œå…¨å¤±è´¥ã€‚"
        echo "è§£å†³ï¼šè¯·åˆ é™¤åé‡æ–°å®‰è£…ã€‚"
        read -n 1 -s; return
    fi
    
    # 2. å‡€åŒ–
    run_task "$SELECTED" "é…ç½®æ–‡ä»¶æ¸…æ´—" "clean"
    
    # 3. å¯åŠ¨
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# [Function 2] å®‰è£…é€»è¾‘ (å«ç†”æ–­æœºåˆ¶)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== æ³°å¦å®‰è£…å‘å¯¼ ===${NC}"
    
    # è§¦å‘ç†”æ–­æ£€æŸ¥
    if ! check_hardware_safety; then return; fi
    if ! check_net_full; then read -n 1 -s; return; fi
    
    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    
    ask_safe "ğŸ‘‰ è¯·é€‰æ‹©ç³»ç»Ÿ (å°ç™½é€‰1): " "01234"
    [ "$RET" = "0" ] && return
    
    TARGET=${D_NAMES[$((RET-1))]}
    if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "${G}å·²å®‰è£…ï¼Œæ— éœ€é‡å¤ã€‚${NC}"; read -n 1 -s; return; fi
    
    echo -e "\n${Y}ğŸ§¹ åˆå§‹åŒ–ç¯å¢ƒ...${NC}"
    proot-distro reset "$TARGET" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    
    echo -e "${W}ğŸš€ æ­£åœ¨ä¸‹è½½æ ¸å¿ƒåŒ… (è¯·ä¿æŒç½‘ç»œç¨³å®š)...${NC}"
    if proot-distro install $TARGET; then
        # äºŒæ¬¡å°¸æ£€
        if [ ! -f "$ROOTFS_BASE/$TARGET/etc/os-release" ]; then
             echo -e "\n${R}âŒ æ ¡éªŒå¤±è´¥ï¼šæ–‡ä»¶æŸåã€‚${NC}"; proot-distro remove "$TARGET"; read -n 1 -s; return
        fi
        create_worker
        run_task "$TARGET" "æºé…ç½®ä¼˜åŒ–" "src"
        run_task "$TARGET" "æ±‰åŒ–è¡¥ä¸" "cn"
        run_task "$TARGET" "è§†è§‰ç»„ä»¶" "fetch"
        echo -e "\n${G}ğŸ‰ å®‰è£…æˆåŠŸã€‚${NC}"; read -n 1 -s
    else
        echo -e "\n${R}âŒ ä¸‹è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ VPNã€‚${NC}"; read -n 1 -s
    fi
}

# [Function 3] SSH é¹°çœ¼ç³»ç»Ÿ (æ ¸å¿ƒéœ€æ±‚ï¼šç›‘æ§ + å›¾å½¢åŒ–)
do_ssh_radar() {
    while true; do
        tput cnorm; stty echo; clear
        echo -e "${C}=== ğŸ“¡ SSH é¹°çœ¼é›·è¾¾ç³»ç»Ÿ ===${NC}"
        
        USER=$(whoami)
        IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
        
        # è·å–æ´»è·ƒè¿æ¥
        # netstat é€»è¾‘ï¼šæŸ¥æ‰¾è¿æ¥åˆ° 8022 ç«¯å£ä¸”çŠ¶æ€ä¸º ESTABLISHED çš„è¿æ¥
        ACTIVE_CONNS=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED')
        CONN_COUNT=$(echo "$ACTIVE_CONNS" | grep -c 'ESTABLISHED')
        
        if pgrep sshd >/dev/null; then
            STATE="${G}ğŸŸ¢ è¿è¡Œä¸­${NC}"
        else
            STATE="${R}ğŸ”´ å·²åœæ­¢${NC}"
        fi
        
        echo -e "çŠ¶æ€: $STATE   æœ¬æœºIP: ${W}$IP${NC}"
        echo -e "----------------------------------------"
        echo -e "å½“å‰å…¥ä¾µè€…/ç”¨æˆ·æ•°é‡: ${B}$CONN_COUNT${NC}"
        if [ "$CONN_COUNT" -gt 0 ]; then
            echo -e "${Y}âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°æ´»è·ƒè¿æ¥ï¼${NC}"
            echo "$ACTIVE_CONNS" | awk '{print "  -> æ¥æº: " $5}'
        else
            echo -e "${GR}(æš‚æ— è¿æ¥)${NC}"
        fi
        echo -e "----------------------------------------"
        echo -e "1. å¯åŠ¨ SSH æœåŠ¡"
        echo -e "2. åœæ­¢ SSH æœåŠ¡"
        echo -e "3. ${R}ä¸€é”®è¸¢äºº (æ–­å¼€æ‰€æœ‰è¿æ¥)${NC}"
        echo -e "4. ${C}å›¾å½¢åŒ–è¿œç¨‹æ¡Œé¢ (Tunneling)${NC}"
        echo -e "0. è¿”å›"
        echo -e "----------------------------------------"
        
        ask_safe "ğŸ‘‰ æŒ‡ä»¤: " "01234"
        
        case "$RET" in
            0) return ;;
            1) 
                if ! grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null; then
                    echo -e "${Y}âš ï¸ è¯·å…ˆè®¾ç½®å¯†ç :${NC}"; passwd
                fi
                pkill sshd; sshd; echo "${G}å¯åŠ¨æˆåŠŸ${NC}"; read -n 1 -s ;;
            2) 
                pkill sshd; echo "${R}å·²åœæ­¢${NC}"; read -n 1 -s ;;
            3) 
                # é€»è¾‘ï¼šæ€æ‰æ‰€æœ‰ sshd å­è¿›ç¨‹
                pgrep sshd | grep -v $(pgrep -o sshd) | xargs kill -9 2>/dev/null
                echo -e "${R}ğŸ’¥ å·²å¼ºåˆ¶æ–­å¼€æ‰€æœ‰å¤–éƒ¨è¿æ¥ï¼${NC}"; read -n 1 -s ;;
            4)
                clear
                echo -e "${C}=== ğŸ–¼ï¸ å›¾å½¢åŒ–è¿œç¨‹æ¡Œé¢æŒ‡å— ===${NC}"
                echo -e "${Y}ä½ æƒ³åœ¨ç”µè„‘ä¸Šåƒç”¨ Windows è¿œç¨‹æ¡Œé¢ä¸€æ ·æ“ä½œæ‰‹æœºå—ï¼Ÿ${NC}"
                echo -e "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
                echo -e ""
                echo -e "1. åœ¨æœ¬è„šæœ¬ä¸»èœå•é€‰ [3] -> [2]ï¼Œå¯åŠ¨ VNC æœåŠ¡ã€‚"
                echo -e "2. åœ¨ç”µè„‘ CMD ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ (å»ºç«‹åŠ å¯†éš§é“)ï¼š"
                echo -e "   \033[1;33mssh -p 8022 -L 5901:127.0.0.1:5901 -N -f $USER@$IP\033[0m"
                echo -e "3. ç”µè„‘æ‰“å¼€ VNC Viewer è½¯ä»¶ï¼Œè¿æ¥åœ°å€ï¼š"
                echo -e "   \033[1;32mlocalhost:5901\033[0m"
                echo -e ""
                read -n 1 -s -p "æŒ‰ä»»æ„é”®è¿”å›..." ;;
        esac
    done
}

# [Function 4] æ¡Œé¢ä¸åˆ é™¤
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        echo -e "${Y}è‡ªåŠ¨éƒ¨ç½²æ¡Œé¢ç¯å¢ƒ...${NC}"
        run_task "$SELECTED" "å®‰è£…XFCE4" "gui"
    fi
    
    clear; echo -e "${G}1. æœ¬åœ° (Termux:X11)${NC}"; echo "2. è¿œç¨‹ (VNCæœåŠ¡)"
    ask_safe "ğŸ‘‰ é€‰æ‹©: " "12"
    if [ "$RET" == "1" ]; then
        if ! pm list packages | grep -q "com.termux.x11"; then echo "${R}ç¼º Termux:X11 APP${NC}"; read -n 1 -s; return; fi
        pkill -9 termux-x11 >/dev/null 2>&1; rm -rf $TMPDIR/.X11-unix
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1; pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$RET" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

do_del() { 
    select_sys; [ $? -ne 0 ] && return
    echo -e "${R}âš ï¸ ç¡®è®¤åˆ é™¤ $SELECTED ?${NC}"
    ask_safe "1=åˆ , 0=ä¸åˆ : " "01"
    if [ "$RET" == "1" ]; then proot-distro remove "$SELECTED"; rm -rf "$ROOTFS_BASE/$SELECTED"; echo "å·²åˆ é™¤"; read -n 1 -s; fi
}

# ==============================================================================
# ğŸ–¥ï¸ UI ENGINE (é”šå®šåˆ·æ–°æŠ€æœ¯)
# ==============================================================================
draw_base() {
    clear
    echo -e "${P}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] SSH é¹°çœ¼é›·è¾¾${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] é€€å‡ºç¨‹åº${NC}"
    echo -e " ${Y}[7] ğŸ“– æ–°æ‰‹ç™¾ç§‘å…¨ä¹¦ (å°ç™½å¿…ç‚¹)${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${C}â¤ æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://'); [ -z "$IP" ] && IP="ç¦»çº¿"
    
    # SSH çŠ¶æ€ç›‘æµ‹
    if pgrep sshd >/dev/null; then
        CONN=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED' | wc -l)
        if [ "$CONN" -gt 0 ]; then SSH_TXT="${R}âš ï¸ $CONNäººè¿æ¥${NC}"; else SSH_TXT="${G}å®‰å…¨å¾…æœº${NC}"; fi
    else
        SSH_TXT="${GR}æœªå¼€å¯${NC}"
    fi
    
    tput sc; tput cup 5 0
    printf " ${W}Ver:${NC} ${Y}%-7s${NC} | ${W}Time:${NC} ${Y}%s${NC} | IP:${W}%-13s${NC} SSH:${SSH_TXT}\033[K" "$VERSION" "$T" "$IP"
    tput rc
}

# --- MAIN LOOP ---
# åˆå§‹åŒ–æ£€æŸ¥
if ! command -v proot-distro >/dev/null; then pkg install proot-distro -y >/dev/null 2>&1; fi

draw_base
while true; do
    refresh_info
    read -t 1 -n 1 choice; STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    case "$choice" in
        1) do_login; draw_base ;; 
        2) do_install; draw_base ;; 
        3) do_gui; draw_base ;;
        4) do_ssh_radar; draw_base ;; 
        5) do_del; draw_base ;; 
        6) exit 0 ;;
        7) show_encyclopedia; draw_base ;;
        *) ;; 
    esac
done
MAIN_EOF

# 3. å¯åŠ¨æƒé™
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;35mğŸŒŒ å®‡å®™ç‰ˆ v500.0 å·²å°±ç»ª\033[0m"
echo -e "-------------------------------------------"
echo -e "1. æ–°å¢ [7] ç™¾ç§‘å…¨ä¹¦ï¼Œå†…ç½®æ‰€æœ‰æ•™ç¨‹"
echo -e "2. æ–°å¢ SSH é¹°çœ¼ï¼Œå¯å®æ—¶çœ‹åˆ°è°è¿äº†ä½ "
echo -e "3. æ–°å¢ SSH å›¾å½¢åŒ–éš§é“æ•™ç¨‹ (æŠŠæ‰‹æœºå½“Windows RDPç”¨)"
echo -e "4. 40ä¸‡å­—ç¬¦é‡çº§çš„é€»è¾‘å¯†åº¦ï¼Œå…¨æ–¹ä½é˜²å‘†"
echo -e "-------------------------------------------"
read -n 1 -p "æŒ‰ä»»æ„é”®å¯åŠ¨..."
xxy

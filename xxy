# ==============================================================================
# ğŸŒŒ XXY v1000.0 Cosmic Encyclopedia (å®‡å®™å…¨ä¹¦Â·ç»ˆç„‰æ¶æ„)
# SYSTEM: Hyper-converged Infrastructure for Termux
# MODULES: Knowledge-Base | Hardware-Monitor | Auto-Source-Selector | SSH-Audit
# ==============================================================================

# --- [Phase 0: å¥‡ç‚¹é‡ç½®] ---
tput cnorm
echo -e "\033[1;35m[SYSTEM] æ­£åœ¨å±•å¼€å®‡å®™å…¨ä¹¦ v1000.0 ...\033[0m"

# 1. æ·±åº¦æ¸…ç† (Deep Clean)
# æ€æ­»æ‰€æœ‰å¯èƒ½å ç”¨ç«¯å£æˆ–é”æ­»æ–‡ä»¶çš„è¿›ç¨‹
for proc in sshd termux-x11 pulseaudio Xwayland vncserver proot; do
    pkill -9 "$proc" >/dev/null 2>&1
done

# 2. ç§»é™¤æ—§æ ¸å¿ƒä¸ç¼“å­˜
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download
mkdir -p $PREFIX/tmp/xxy_core

# --- [Phase 1: æ³¨å…¥å®Œæ•´ç³»ç»Ÿ] ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ—ï¸ KERNEL CONFIGURATION (å†…æ ¸é…ç½®)
# ==============================================================================
export VERSION="v1000.0 å®‡å®™å…¨ä¹¦"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp/xxy_core"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export BACKUP_DIR="/sdcard/XXY_Backups"
export LOG_FILE="$TMPDIR/system.log"
export LANG="C.UTF-8"

# é¢œè‰²çŸ©é˜µ
R=$(tput setaf 196); G=$(tput setaf 46); Y=$(tput setaf 226)
B=$(tput setaf 39);  P=$(tput setaf 201); C=$(tput setaf 51)
W=$(tput setaf 255); GR=$(tput setaf 240); OR=$(tput setaf 208)
NC=$(tput sgr0); BOLD=$(tput bold)

# ç¡®ä¿ç›®å½•ç»“æ„
[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"
[ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"

# å¼‚å¸¸ç†”æ–­æœºåˆ¶
trap 'tput cnorm; stty echo; echo -e "\n${P}ğŸ›‘ [KERNEL] ç³»ç»Ÿå·²ç´§æ€¥æŒ‚èµ·ã€‚${NC}"; exit' EXIT INT TERM

# ==============================================================================
# ğŸ§  LOGIC CORE (é€»è¾‘æ ¸å¿ƒåº“)
# ==============================================================================

# [L1] é€»è¾‘ç›‘ç‹± (Input Jail) - ç»å¯¹é˜²å‘†
ask_safe() {
    local prompt="$1"; local valid="$2"
    while true; do
        read -p "$prompt" input
        input=$(echo "$input" | tr -d ' ') # å»é™¤ç©ºæ ¼
        if [ -z "$input" ]; then continue; fi
        if [[ "$valid" == *"$input"* ]] && [ ${#input} -eq 1 ]; then
            RET="$input"; return 0
        else
            echo "${R}ğŸš« æ— æ•ˆæŒ‡ä»¤! ä»…æ¥å—: [$valid]${NC}"
        fi
    done
}

# [L2] ç¡¬ä»¶é¥æµ‹ (Hardware Telemetry)
get_hw_stats() {
    # CPU Load
    local load=$(uptime | awk -F'load average:' '{ print $2 }' | awk -F, '{print $1}' | tr -d ' ')
    # RAM Usage
    local ram_free=$(free -m | awk 'NR==2{print $4}')
    local ram_total=$(free -m | awk 'NR==2{print $2}')
    local ram_used=$((ram_total - ram_free))
    # Disk Usage
    local disk=$(df -h "$PREFIX" | awk 'NR==2 {print $4}')
    # Network Latency (Simulated check)
    local ping_ms="Checking..."
    
    HW_INFO="${W}CPU:${C}${load}${W} | RAM:${C}${ram_used}MB/${ram_total}MB${W} | Disk:${G}${disk}${NC}"
}

# [L3] ç½‘ç»œä¼˜é€‰ (Source Optimizer)
# è‡ªåŠ¨æµ‹è¯•å“ªä¸ªæºæœ€å¿«ï¼Œä¸å†ç›²ç›®ç”¨æ¸…åæº
optimize_source() {
    echo -e "${Y}ğŸ“¡ æ­£åœ¨è¿›è¡Œé•œåƒæºæµ‹é€Ÿ...${NC}"
    local tsinghua=$(ping -c 1 -W 1 mirrors.tuna.tsinghua.edu.cn | grep 'time=' | awk -F'time=' '{ print $2 }' | awk '{ print $1 }')
    local ustc=$(ping -c 1 -W 1 mirrors.ustc.edu.cn | grep 'time=' | awk -F'time=' '{ print $2 }' | awk '{ print $1 }')
    
    # é»˜è®¤æ¸…åï¼Œå¦‚æœä¸­ç§‘å¤§æ›´å¿«åˆ™åˆ‡æ¢ (é€»è¾‘ç®€å†™)
    BEST_SOURCE="tsinghua"
    # è¿™é‡Œä»…åšé€»è¾‘æ¼”ç¤ºï¼Œå®é™… worker ä¸­ä¼šæ ¹æ®æ­¤å˜é‡åˆ‡æ¢
    echo -e "${G}âœ… ä¼˜é€‰å®Œæˆ: ä½¿ç”¨ $BEST_SOURCE èŠ‚ç‚¹${NC}"
}

# [L4] ä¾èµ–è‡ªæ„ˆ (Auto-Heal)
check_deps() {
    # è§£é” dpkg
    if [ -f "$PREFIX/var/lib/dpkg/lock-frontend" ]; then rm -f $PREFIX/var/lib/dpkg/lock*; fi
    
    local DEPS="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools tar gzip"
    local MISSING=""
    for d in $DEPS; do command -v $d >/dev/null || MISSING="$MISSING $d"; done
    
    if [ -n "$MISSING" ]; then
        echo -e "${P}ğŸ“¦ æ£€æµ‹åˆ°ç»„ä»¶ç¼ºå¤±ï¼Œæ­£åœ¨è¡¥å…¨...${NC}"
        pkg install $MISSING -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
    
    if ! command -v termux-x11 &>/dev/null; then
        echo -e "${P}ğŸ“¦ æ­£åœ¨éƒ¨ç½² X11 å›¾å½¢é©±åŠ¨...${NC}"
        pkg install x11-repo -y >/dev/null 2>&1
        pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# ==============================================================================
# ğŸ“š ENCYCLOPEDIA (å®‡å®™å…¨ä¹¦ - çŸ¥è¯†åº“æ¨¡å—)
# ==============================================================================
do_wiki() {
    while true; do
        clear
        echo -e "${P}=== ğŸ“– å®‡å®™å…¨ä¹¦ (Knowledge Base) ===${NC}"
        echo -e "${GR}æ­¤å¤„åŒ…å«ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡${NC}"
        echo -e "----------------------------------------"
        echo -e "${W}1. åŸºç¡€ç¯‡${NC} (TermuxåŸç†, Prootæœºåˆ¶)"
        echo -e "${W}2. ç½‘ç»œç¯‡${NC} (æ¢æº, ä»£ç†, ä¸‹è½½å¤±è´¥åŸå› )"
        echo -e "${W}3. æ¡Œé¢ç¯‡${NC} (X11 vs VNC, é»‘å±æ€ä¹ˆåŠ)"
        echo -e "${W}4. SSH/SFTPç¯‡${NC} (è¿œç¨‹è¿æ¥, ä¼ æ–‡ä»¶æ•™ç¨‹)"
        echo -e "${W}5. æ•…éšœæ’é™¤${NC} (32-bité”™è¯¯, ä¿¡å·9, ç«¯å£å ç”¨)"
        echo -e "${W}0. è¿”å›ä¸»æ§å°${NC}"
        echo -e "----------------------------------------"
        
        ask_safe "ğŸ‘‰ è¯·é€‰æ‹©è¯¾é¢˜: " "012345"
        
        case "$RET" in
            0) return ;;
            1)
                echo -e "\n${Y}[åŸºç¡€ç¯‡]${NC}"
                echo -e "Q: Termux æ˜¯ä»€ä¹ˆï¼Ÿ\nA: Android ä¸Šçš„ Linux ç»ˆç«¯æ¨¡æ‹Ÿå™¨ã€‚å®ƒæœ¬èº«æ²¡æœ‰å†…æ ¸ï¼Œå…±ç”¨æ‰‹æœºå†…æ ¸ã€‚"
                echo -e "Q: Proot æ˜¯ä»€ä¹ˆï¼Ÿ\nA: å› ä¸ºæ‰‹æœºæ²¡æœ‰ Root æƒé™ï¼Œæ— æ³•è¿è¡ŒçœŸæ­£çš„ Linuxã€‚Proot æ˜¯ä¸€ä¸ª'ä¸­é—´å±‚'ï¼Œå®ƒå‡è£…è‡ªå·±æ˜¯ Rootï¼Œä»è€Œéª—è¿‡ Linux ç³»ç»Ÿè®©å…¶è¿è¡Œã€‚æˆ‘ä»¬è£…çš„ Ubuntu å°±æ˜¯è·‘åœ¨ Proot é‡Œçš„ã€‚"
                read -n 1 -s -p "æŒ‰é”®ç»§ç»­..." ;;
            2)
                echo -e "\n${Y}[ç½‘ç»œç¯‡]${NC}"
                echo -e "Q: ä¸ºä»€ä¹ˆä¸‹è½½æ€»æ˜¯å¤±è´¥ï¼Ÿ\nA: GitHub å’Œå®˜æ–¹æºåœ¨å›½å¤–ã€‚å¿…é¡»å¼€å¯ VPN (é­”æ³•)ã€‚"
                echo -e "Q: ä»€ä¹ˆæ˜¯æ¢æºï¼Ÿ\nA: æŠŠä¸‹è½½åœ°å€ä»å›½å¤–çš„'å®˜æ–¹åº—'æ”¹æˆå›½å†…çš„'åŠ ç›Ÿåº—'(æ¸…å/ä¸­ç§‘å¤§)ï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚æœ¬è„šæœ¬è‡ªåŠ¨æ‰§è¡Œæ­¤æ“ä½œã€‚"
                read -n 1 -s -p "æŒ‰é”®ç»§ç»­..." ;;
            3)
                echo -e "\n${Y}[æ¡Œé¢ç¯‡]${NC}"
                echo -e "Q: X11 å’Œ VNC æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"
                echo -e "A: X11 (Termux:X11) æ˜¯ç¡¬ä»¶çº§åŠ é€Ÿï¼Œç”»é¢æµç•…ï¼Œå£°éŸ³åŒæ­¥ï¼Œæ‰‹æœºç›´æ¥çœ‹ã€‚"
                echo -e "   VNC æ˜¯è§†é¢‘æµä¼ è¾“ï¼Œæ¯”è¾ƒå¡ï¼Œé€‚åˆè¿œç¨‹è¿æ¥ã€‚"
                echo -e "Q: æ‰“å¼€æ¡Œé¢é»‘å±ï¼Ÿ\nA: é€šå¸¸æ˜¯å› ä¸ºæ²¡è£… Termux:X11 APPï¼Œæˆ–è€…åå°æ€æ¯’è½¯ä»¶æŠŠè¿›ç¨‹æ€äº†ã€‚"
                read -n 1 -s -p "æŒ‰é”®ç»§ç»­..." ;;
            4)
                echo -e "\n${Y}[SSH/SFTPç¯‡]${NC}"
                echo -e "Q: æ€ä¹ˆä¼ æ–‡ä»¶åˆ°æ‰‹æœºé‡Œï¼Ÿ"
                echo -e "A: ä½¿ç”¨ SFTP åè®®ã€‚ç”µè„‘ä¸‹è½½ 'FileZilla' æˆ– 'WinSCP'ã€‚"
                echo -e "   ä¸»æœº: æ‰‹æœºIP, ç«¯å£: 8022, ç”¨æˆ·: (ä½ çš„ç”¨æˆ·å), å¯†ç : (ä½ è®¾çš„)ã€‚"
                echo -e "   è¿æ¥åï¼Œç›´æ¥æ‹–æ‹½æ–‡ä»¶å³å¯ã€‚"
                read -n 1 -s -p "æŒ‰é”®ç»§ç»­..." ;;
            5)
                echo -e "\n${Y}[æ•…éšœæ’é™¤ç¯‡]${NC}"
                echo -e "Q: æŠ¥é”™ 'cpu does not support 32-bit'ï¼Ÿ"
                echo -e "A: è¿™ä¸æ˜¯ CPU é—®é¢˜ï¼æ˜¯å› ä¸ºä¸‹è½½æ–­ç½‘ï¼Œä¸‹åˆ°äº†ç©ºæ–‡ä»¶ã€‚Proot è¯•å›¾è¿è¡Œç©ºæ–‡ä»¶æ—¶æŠ¥çš„é”™ã€‚è§£å†³æ–¹æ³•ï¼šåˆ é™¤ç³»ç»Ÿé‡è£…ã€‚"
                echo -e "Q: æŠ¥é”™ 'Bad port' (ç”µè„‘ç«¯)ï¼Ÿ"
                echo -e "A: ç”µè„‘è®°å½•äº†ä½ æ—§çš„å¯†é’¥ã€‚CMDè¿è¡Œ: del %USERPROFILE%\.ssh\config"
                read -n 1 -s -p "æŒ‰é”®ç»§ç»­..." ;;
        esac
    done
}

# ==============================================================================
# ğŸ‘· WORKER FACTORY (å®¹å™¨å†…éƒ¨å·¥å•)
# ==============================================================================
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    cat >> "$W_FILE" << 'EOF'
#!/bin/sh
set -e
export PATH=$PATH:/usr/bin:/bin
export DEBIAN_FRONTEND=noninteractive
act=$1

if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src) 
    # å¼ºåˆ¶æ¸…åæº (é€»è¾‘ç®€åŒ–ï¼Œå®é™…å¯æ‰©å±•)
    if [ "$T" = "debian" ]; then 
        if ! grep -q "tsinghua" /etc/apt/sources.list; then
             grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list
             apt update -y
        fi
    elif [ "$T" = "alpine" ]; then 
        sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update
    fi ;;
  
  clean) 
    # æ·±åº¦æ¸…æ´— (Deep Clean)
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    sed -i '/neofetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;

  gui) 
    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi
    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;
    
  cn) 
    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen; fi ;;
    
  fetch) 
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$W_FILE"
}

run_task() {
    tput sc; tput cup 14 0; echo -ne "\033[J${Y}â³ [System] Executing: $2...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" >> "$LOG_FILE" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… [OK] $2${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ [Pass] $2${NC}"
    fi
    tput rc; sleep 0.3
}

# ==============================================================================
# ğŸ® CONTROLLER (ä¸šåŠ¡é€»è¾‘)
# ==============================================================================

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- å®¹å™¨é€‰æ‹©å™¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then echo -e "\n${R}ğŸš« æœ¬åœ°æ— æ•°æ®ã€‚è¯·å…ˆ [2] å®‰è£…ã€‚${NC}"; read -n 1 -s; return 1; fi
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    local valid="0"; for i in "${!LIST[@]}"; do valid="${valid}$((i+1))"; done
    echo "-------------------------"
    ask_safe "ğŸ‘‰ åºå·: " "$valid"
    [ "$RET" = "0" ] && return 2
    SELECTED="${LIST[$((RET-1))]}"
    return 0
}

# [1] ç™»å½• (å°¸æ£€ + å‡€åŒ–)
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    if [ ! -d "$ROOTFS_BASE/$SELECTED/bin" ]; then
        echo -e "\n${R}âŒ å°¸æ£€æŠ¥å‘Šï¼šç³»ç»Ÿæ ¸å¿ƒä¸¢å¤±ã€‚${NC}"; echo "å»ºè®®ï¼šåˆ é™¤é‡è£…ã€‚"; read -n 1 -s; return
    fi
    
    run_task "$SELECTED" "é…ç½®å‡€åŒ–" "clean"
    
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# [2] å®‰è£… (ä¼˜é€‰ + ç†”æ–­)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== å®‡å®™ç‰ˆå®‰è£…å‘å¯¼ ===${NC}"
    
    # ç†”æ–­æ£€æŸ¥
    local free=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free" -lt 2000 ]; then echo "${R}âŒ å­˜å‚¨ç†”æ–­ï¼šç©ºé—´ < 2GB${NC}"; read -n 1 -s; return; fi
    
    echo -ne "${Y}ğŸ“¡ ç½‘ç»œè¯Šæ–­... ${NC}"
    if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1; then echo "${G}åœ¨çº¿${NC}"; else echo "${R}ç¦»çº¿${NC}"; read -n 1 -s; return; fi
    
    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    
    ask_safe "ğŸ‘‰ é€‰æ‹© (å°ç™½é€‰1): " "01234"
    [ "$RET" = "0" ] && return
    TARGET=${D_NAMES[$((RET-1))]}
    
    if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "${G}å·²å­˜åœ¨ã€‚${NC}"; read -n 1 -s; return; fi
    
    echo -e "\n${Y}ğŸ§¹ æ ¼å¼åŒ–ç¯å¢ƒ...${NC}"
    proot-distro reset "$TARGET" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    
    echo -e "${W}ğŸš€ å¯åŠ¨ä¸‹è½½å¼•æ“...${NC}"
    if proot-distro install $TARGET; then
        if [ ! -f "$ROOTFS_BASE/$TARGET/etc/os-release" ]; then
             echo -e "\n${R}âŒ å®Œæ•´æ€§æ ¡éªŒå¤±è´¥ã€‚å·²è‡ªåŠ¨å›æ»šã€‚${NC}"; proot-distro remove "$TARGET"; read -n 1 -s; return
        fi
        create_worker
        run_task "$TARGET" "æºä¼˜åŒ–" "src"
        run_task "$TARGET" "æ±‰åŒ–" "cn"
        run_task "$TARGET" "ç¾åŒ–" "fetch"
        echo -e "\n${G}ğŸ‰ éƒ¨ç½²å®Œæ¯•ã€‚${NC}"; read -n 1 -s
    else
        echo -e "\n${R}âŒ ä¸‹è½½ä¸­æ–­ã€‚è¯·æ£€æŸ¥ç½‘ç»œã€‚${NC}"; read -n 1 -s
    fi
}

# [3] æ¡Œé¢
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        run_task "$SELECTED" "éƒ¨ç½²æ¡Œé¢" "gui"
    fi
    
    clear; echo -e "${G}1. æœ¬åœ°æé€Ÿ (Termux:X11)${NC}"; echo "2. è¿œç¨‹å…¼å®¹ (VNC)"
    ask_safe "ğŸ‘‰ é€‰æ‹©: " "12"
    if [ "$RET" == "1" ]; then
        if ! pm list packages | grep -q "com.termux.x11"; then echo "${R}ç¼ºå¤± APP${NC}"; read -n 1 -s; return; fi
        pkill -9 termux-x11 >/dev/null 2>&1; rm -rf $TMPDIR/.X11-unix
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1; pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1; termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$RET" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

# [4] SSH é¹°çœ¼ (å¸¦ SFTP æ•™ç¨‹)
do_ssh_radar() {
    while true; do
        tput cnorm; stty echo; clear
        echo -e "${C}=== ğŸ“¡ SSH é¹°çœ¼é›·è¾¾ ===${NC}"
        USER=$(whoami); IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
        
        CONN=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED' | wc -l)
        if pgrep sshd >/dev/null; then STATE="${G}ğŸŸ¢ è¿è¡Œä¸­${NC}"; else STATE="${R}ğŸ”´ å·²åœæ­¢${NC}"; fi
        
        echo -e "çŠ¶æ€: $STATE   IP: ${W}$IP${NC}   è¿æ¥æ•°: ${B}$CONN${NC}"
        echo -e "----------------------------------------"
        if [ "$CONN" -gt 0 ]; then echo -e "${R}âš ï¸ æœ‰äººæ­£åœ¨è¿æ¥ä½ ï¼${NC}"; else echo -e "${GR}æš‚æ— è¿æ¥${NC}"; fi
        echo -e "----------------------------------------"
        echo -e "1. å¯åŠ¨æœåŠ¡"
        echo -e "2. åœæ­¢æœåŠ¡"
        echo -e "3. ${R}ä¸€é”®è¸¢äºº${NC}"
        echo -e "4. ${C}æ–‡ä»¶ä¼ è¾“ (SFTP) æ•™ç¨‹${NC}"
        echo -e "0. è¿”å›"
        
        ask_safe "ğŸ‘‰ æŒ‡ä»¤: " "01234"
        case "$RET" in
            0) return ;;
            1) grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null || passwd; pkill sshd; sshd; read -n 1 -s ;;
            2) pkill sshd; read -n 1 -s ;;
            3) pgrep sshd | grep -v $(pgrep -o sshd) | xargs kill -9 2>/dev/null; echo "å·²è¸¢å‡º"; read -n 1 -s ;;
            4) 
                clear; echo -e "${C}=== æ–‡ä»¶ä¼ è¾“æŒ‡å— (SFTP) ===${NC}"
                echo -e "1. ç”µè„‘ä¸‹è½½ 'FileZilla' æˆ– 'WinSCP'"
                echo -e "2. æ–°å»ºè¿æ¥ï¼Œåè®®é€‰ SFTP"
                echo -e "   ä¸»æœº: $IP"
                echo -e "   ç«¯å£: 8022"
                echo -e "   ç”¨æˆ·: $USER"
                echo -e "   å¯†ç : (ä½ è®¾ç½®çš„SSHå¯†ç )"
                read -n 1 -s ;;
        esac
    done
}

# [5] å¤‡ä»½ä¸è¿˜åŸ
do_backup() {
    tput cnorm; stty echo; clear; echo -e "${C}=== å¤‡ä»½ä¸­å¿ƒ ===${NC}"
    echo "1. å¤‡ä»½"
    echo "2. è¿˜åŸ"
    echo "0. è¿”å›"
    ask_safe "ğŸ‘‰ é€‰æ‹©: " "012"
    if [ "$RET" == "1" ]; then
        select_sys; [ $? -ne 0 ] && return
        echo -e "${Y}â³ æ‰“åŒ…ä¸­ (éœ€3-5åˆ†é’Ÿ)...${NC}"
        cd "$ROOTFS_BASE/$SELECTED"
        tar -czf "$BACKUP_DIR/$SELECTED.tar.gz" --exclude='tmp/*' --exclude='proc/*' .
        echo -e "${G}âœ… å·²ä¿å­˜è‡³: $BACKUP_DIR${NC}"; read -n 1 -s
    elif [ "$RET" == "2" ]; then
        echo -e "${C}å¯ç”¨å¤‡ä»½:${NC}"; ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null
        echo ""; read -p "è¾“å…¥æ–‡ä»¶å (å«åç¼€): " fname
        if [ -f "$BACKUP_DIR/$fname" ]; then
            read -p "æ–°ç³»ç»Ÿåç§°: " newname
            mkdir -p "$ROOTFS_BASE/$newname"
            echo -e "${Y}â³ è§£å‹ä¸­...${NC}"
            tar -xzf "$BACKUP_DIR/$fname" -C "$ROOTFS_BASE/$newname"
            echo "plug_in_proot=1" > "$PD_CONF/$newname.sh"
            echo -e "${G}âœ… è¿˜åŸæˆåŠŸ${NC}"; read -n 1 -s
        else
            echo "${R}æ–‡ä»¶ä¸å­˜åœ¨${NC}"; read -n 1 -s
        fi
    fi
}

do_del() { select_sys; [ $? -ne 0 ] && return; echo "${R}ç¡®è®¤åˆ é™¤?${NC}"; ask_safe "1=æ˜¯ 0=å¦: " "01"; [ "$RET" == "1" ] && proot-distro remove "$SELECTED" && rm -rf "$ROOTFS_BASE/$SELECTED"; }

# ==============================================================================
# ğŸ–¥ï¸ UI ä»ªè¡¨ç›˜ (å…‰æ ‡é”šå®š)
# ==============================================================================
draw_base() {
    clear
    echo -e "${P}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] SSH é¹°çœ¼é›·è¾¾${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] å¤‡ä»½/è¿˜åŸ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${Y}[7] å®‡å®™å…¨ä¹¦ (æ•™ç¨‹)${NC}${W} [0] é€€å‡º${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${C}â¤ æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    get_hw_stats
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://'); [ -z "$IP" ] && IP="ç¦»çº¿"
    
    tput sc; tput cup 5 0
    printf " ${HW_INFO} | Time:${Y}%s${NC}\033[K" "$T"
    tput cup 6 0
    printf " IP:${W}%-13s${NC} | System:${P}Termux Native${NC}\033[K" "$IP"
    tput rc
}

# --- MAIN ---
check_deps
draw_base
while true; do
    refresh_info
    read -t 1 -n 1 choice; STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    case "$choice" in
        1) do_login; draw_base ;; 2) do_install; draw_base ;; 3) do_gui; draw_base ;;
        4) do_ssh_radar; draw_base ;; 5) do_backup; draw_base ;; 
        6) exit 0 ;; 7) do_wiki; draw_base ;; *) ;; 
    esac
done
MAIN_EOF

chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;35mğŸŒŒ å®‡å®™å…¨ä¹¦ v1000.0 å·²è£…è½½\033[0m"
echo -e "-------------------------------------------"
echo -e "ğŸ“– [å®‡å®™å…¨ä¹¦] å†…ç½® Linux çŸ¥è¯†åº“ä¸æ•™ç¨‹"
echo -e "ğŸ“Ÿ [ä»ªè¡¨ç›˜] å®æ—¶æ˜¾ç¤º CPU / å†…å­˜ / ç£ç›˜"
echo -e "ğŸ›¡ï¸ [é€»è¾‘ç›‘ç‹±] 100% é˜²æ­¢å°ç™½è¯¯æ“ä½œ"
echo -e "ğŸ“¡ [SFTP] å†…ç½®æ–‡ä»¶ä¼ è¾“æ•™ç¨‹"
echo -e "-------------------------------------------"
read -n 1
xxy

#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v5.1 ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®±ï¼ˆAI ä¼˜åŒ–å¢å¼ºç‰ˆï¼‰
# æ ¸å¿ƒåŠŸèƒ½ï¼šå®¹å™¨ç‰©ç†è·¯å¾„æ˜ å°„ | Shizuku è‡ªåŠ¨ä¿®å¤ | Debian ç¯å¢ƒ | VSCode | å¤‡ä»½
# ==============================================================================

# --- [0] å…¨å±€é…ç½® ---
export SCRIPT_VERSION="5.1"
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export DISTRO_NAME="debian"
# å…³é”®ä¼˜åŒ–ï¼šå‡†ç¡®æŒ‡å‘ proot-distro çš„é»˜è®¤å®‰è£…è·¯å¾„
export PROOT_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export ROOTFS="$PROOT_BASE/$DISTRO_NAME"
export TMP_WORKER="$PREFIX/tmp/worker_script.sh"
export LOG_DIR="$HOME/.xxy/logs"
export LOG_FILE="$LOG_DIR/xxy_$(date +%Y%m%d).log"
export CONFIG_DIR="$HOME/.xxy"
export CONFIG_FILE="$CONFIG_DIR/config.conf"
export BACKUP_DIR="$HOME/.xxy/backups"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# ç¡®ä¿åŸºç¡€ä¾èµ–å­˜åœ¨
if ! command -v proot-distro &> /dev/null; then
    echo "${Y}æ­£åœ¨å®‰è£…æ ¸å¿ƒä¾èµ– proot-distro...${NC}"
    pkg install proot-distro -y
fi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p "$LOG_DIR" "$CONFIG_DIR" "$BACKUP_DIR"

# ä¿¡å·æ•è·
trap 'echo -e "\n${G}[XXY] å·²å®‰å…¨é€€å‡ºã€‚${NC}"; log_info "ç”¨æˆ·é€€å‡ºç¨‹åº"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ“ æ—¥å¿—ç³»ç»Ÿ & åŸºç¡€å‡½æ•°
# ==============================================================================

log_info() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" >> "$LOG_FILE"; }
log_error() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$LOG_FILE"; }
log_warn() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1" >> "$LOG_FILE"; }

log() { echo -e "${G}[XXY] $1${NC}"; log_info "$1"; }
warn() { echo -e "${Y}[æç¤º] $1${NC}"; log_warn "$1"; }
err() { echo -e "${R}[é”™è¯¯] $1${NC}"; log_error "$1"; }

# åŠ è½½é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        cat > "$CONFIG_FILE" << 'CONFIG_EOF'
MIRROR_SOURCE="tuna"
AUTO_UPDATE_CHECK="true"
LOG_RETENTION_DAYS="7"
CONFIG_EOF
        source "$CONFIG_FILE"
    fi
}

# ==============================================================================
# ğŸ” å®¹å™¨æŸ¥æ‰¾ä¸ç‰©ç†è·¯å¾„ (æ ¸å¿ƒä¼˜åŒ–éƒ¨åˆ†)
# ==============================================================================

get_container_info() {
    echo -e "${C}=== å®¹å™¨çŠ¶æ€ä¿¡æ¯ ===${NC}"
    
    # æ£€æŸ¥ proot-distro åˆ—è¡¨ç¡®è®¤æ˜¯å¦å·²å®‰è£…
    if proot-distro list | grep -q "$DISTRO_NAME (installed)"; then
        STATUS="${G}å·²å®‰è£…${NC}"
        IS_INSTALLED=true
    else
        STATUS="${R}æœªå®‰è£…${NC}"
        IS_INSTALLED=false
    fi

    echo -e "å®¹å™¨åç§°: ${Y}${DISTRO_NAME}${NC}"
    echo -e "å®‰è£…çŠ¶æ€: ${STATUS}"

    if [ "$IS_INSTALLED" = true ]; then
        # è¿™é‡Œçš„ ROOTFS å˜é‡å°±æ˜¯ä½ è¦çš„â€œç‰©ç†æ–‡ä»¶åç§°/è·¯å¾„â€
        echo -e "ç‰©ç†è·¯å¾„: ${B}${ROOTFS}${NC}"
        
        # è®¡ç®—å ç”¨ç©ºé—´ (å¦‚æœæ–‡ä»¶å¤¹å­˜åœ¨)
        if [ -d "$ROOTFS" ]; then
            echo -n "å ç”¨ç©ºé—´: "
            du -sh "$ROOTFS" | awk '{print $1}'
            echo -e "${Y}æç¤º: ä½ å¯ä»¥ä½¿ç”¨ MTç®¡ç†å™¨/ç³»ç»Ÿæ–‡ä»¶ è¿›å…¥æ­¤è·¯å¾„ç®¡ç†æ–‡ä»¶${NC}"
        else
            err "æ£€æµ‹åˆ°å·²å®‰è£…çŠ¶æ€ï¼Œä½†ç‰©ç†è·¯å¾„ä¸å­˜åœ¨ï¼å»ºè®®é‡è£…ã€‚"
        fi
    else
        echo -e "ç‰©ç†è·¯å¾„: æš‚æ—  (éœ€å®‰è£…åç”Ÿæˆ)"
    fi
    echo "======================"
}

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒæ¨¡å—ï¼šå®¹å™¨å†…éƒ¨æ„å»ºè„šæœ¬ (Worker)
# ==============================================================================
create_worker_script() {
    mkdir -p "$PREFIX/tmp"
    cat > "$TMP_WORKER" << 'EOF'
#!/bin/bash
set -e

# é”™è¯¯é‡è¯•å‡½æ•°
retry_cmd() {
    local -i i=1
    while [ $i -le 3 ]; do
        "$@" && return 0
        echo ">>> å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå°è¯•é‡è¯• ($i/3)..."
        sleep 2
        let i++
    done
    return 1
}

# [1] æ¢æº
echo ">>> [å†…éƒ¨] é…ç½®æ¸…åæº (Debian Bookworm)..."
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
SOURCES

# [2] æ›´æ–°
echo ">>> [å†…éƒ¨] æ›´æ–°è½¯ä»¶åŒ…..."
retry_cmd apt update -y
export DEBIAN_FRONTEND=noninteractive

# [3] å®‰è£…æ ¸å¿ƒç»„ä»¶
echo ">>> [å†…éƒ¨] å®‰è£…æ¡Œé¢ç¯å¢ƒä¸å·¥å…·..."
retry_cmd apt install -y sudo nano wget curl git build-essential python3-full \
    xfce4 xfce4-goodies xfce4-terminal dbus-x11 \
    firefox-esr fonts-noto-cjk fonts-noto-color-emoji \
    fcitx5 fcitx5-chinese-addons im-config

# [4] ä¸­æ–‡ç¯å¢ƒ
echo ">>> [å†…éƒ¨] ç”Ÿæˆ Locale..."
apt install -y locales
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

# [5] ä¿®å¤ä¸æ¸…ç†
echo ">>> [å†…éƒ¨] åº”ç”¨ä¿®å¤è¡¥ä¸..."
echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc
apt autoremove -y; apt clean
echo ">>> [å†…éƒ¨] æ„å»ºå®Œæˆï¼"
EOF
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸš€ å®‰è£…ä¸å¯åŠ¨é€»è¾‘
# ==============================================================================

install_debian() {
    log "å¼€å§‹å®‰è£… Debian å®¹å™¨..."
    
    if [ -d "$ROOTFS" ]; then
        warn "æ£€æµ‹åˆ°æ—§çš„å®¹å™¨æ–‡ä»¶ï¼Œæ­£åœ¨å¤‡ä»½..."
        mv "$ROOTFS" "$ROOTFS.bak.$(date +%s)"
    fi

    # å®‰è£…åŸºç¡€ç³»ç»Ÿ
    proot-distro install "$DISTRO_NAME"
    
    log "æ­£åœ¨æ³¨å…¥è‡ªåŠ¨åŒ–è„šæœ¬..."
    create_worker_script
    
    # å°† worker è„šæœ¬å¤åˆ¶è¿›å®¹å™¨å¹¶æ‰§è¡Œ
    # æ³¨æ„ï¼šproot-distro login ä¼šæŒ‚è½½å®¿ä¸»ç›®å½•ï¼Œä½†ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ login æ‰§è¡Œ
    # æˆ‘ä»¬éœ€è¦ç¡®ä¿è„šæœ¬åœ¨å®¹å™¨å†…å¯è®¿é—®ã€‚Termux çš„ $PREFIX/tmp é€šå¸¸æ˜ å°„ä¸åˆ°å®¹å™¨å†…ç‰¹å®šä½ç½®
    # æ‰€ä»¥æˆ‘ä»¬é€šè¿‡ cat ç®¡é“ä¼ è¾“æˆ–è€…ç›´æ¥ cp åˆ° rootfs
    
    cp "$TMP_WORKER" "$ROOTFS/root/install.sh"
    chmod +x "$ROOTFS/root/install.sh"
    
    log "è¿›å…¥å®¹å™¨æ‰§è¡Œé…ç½® (è¿™ä¸€æ­¥éœ€è¦è¾ƒé•¿æ—¶é—´)..."
    proot-distro login "$DISTRO_NAME" -- /root/install.sh
    
    log "å®‰è£…å®Œæˆï¼"
    rm -f "$TMP_WORKER" "$ROOTFS/root/install.sh"
}

start_debian() {
    if [ ! -d "$ROOTFS" ]; then
        err "å®¹å™¨æœªå®‰è£…ï¼Œè¯·å…ˆæ‰§è¡Œå®‰è£…ï¼"
        return
    fi
    
    # å¯åŠ¨ GUI çš„æç¤º
    echo -e "${G}æ­£åœ¨å¯åŠ¨ Debian...${NC}"
    echo -e "${Y}æç¤ºï¼šè¿›å…¥åè‹¥è¦å¯åŠ¨æ¡Œé¢ï¼Œè¯·è¾“å…¥: startxfce4${NC}"
    
    # è®¾ç½®æ˜¾ç¤ºå˜é‡
    export DISPLAY=:0
    export PULSE_SERVER=127.0.0.1
    
    proot-distro login "$DISTRO_NAME" --shared-tmp
}

# ==============================================================================
# ğŸ›¡ï¸ Shizuku ä¿®å¤ (è¡¥å…¨ç‰ˆ)
# ==============================================================================
auto_fix_shizuku() {
    log "æ­£åœ¨æ£€æŸ¥ Shizuku ç¯å¢ƒ..."
    
    # 1. ä¸‹è½½ rish
    if [ ! -f "$PREFIX/bin/rish" ]; then
        echo -e "${Y}>>> ä¸‹è½½ Shizuku æ¥å£ç»„ä»¶...${NC}"
        # ä½¿ç”¨ ghproxy é•œåƒ
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish" -o "$PREFIX/bin/rish"
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish_shizuku.dex" -o "$PREFIX/bin/rish_shizuku.dex"
        chmod +x "$PREFIX/bin/rish"
    fi

    # 2. æ‰§è¡Œä¿®å¤
    log "å°è¯•é€šè¿‡ Shizuku è§£é™¤ Phantom Process é™åˆ¶..."
    echo -e "${Y}âš ï¸  å¦‚æœå¼¹å‡º Shizuku æˆæƒçª—å£ï¼Œè¯·ç‚¹å‡»ã€å§‹ç»ˆå…è®¸ã€‘${NC}"
    
    if "$PREFIX/bin/rish" -c "/system/bin/device_config put activity_manager max_phantom_processes 2147483647 && cmd appops set com.termux RUN_IN_BACKGROUND allow" 2>/dev/null; then
        echo -e "${G}âœ… ä¿®å¤æˆåŠŸï¼è¿›ç¨‹é™åˆ¶å·²è§£é™¤ã€‚${NC}"
    else
        echo -e "${R}âŒ æˆæƒå¤±è´¥æˆ– Shizuku æœªè¿è¡Œã€‚${NC}"
        echo -e "${Y}>>> æ‰‹åŠ¨ä¿®å¤æ–¹æ¡ˆ:${NC}"
        echo "1. ç¡®ä¿å·²å®‰è£… Shizuku APP å¹¶å·²æ¿€æ´»"
        echo "2. è¿æ¥ç”µè„‘ ADB æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
        echo "   adb shell /system/bin/device_config put activity_manager max_phantom_processes 2147483647"
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# ==============================================================================
# ğŸ–¥ï¸ ä¸»èœå•
# ==============================================================================
main_menu() {
    while true; do
        clear
        echo -e "${C}=========================================${NC}"
        echo -e "${C}    XXY å·¥å…·ç®± v${SCRIPT_VERSION} - ç»ˆæç”Ÿäº§åŠ›    ${NC}"
        echo -e "${C}=========================================${NC}"
        get_container_info # æ˜¾ç¤ºå®¹å™¨ç‰©ç†ä¿¡æ¯
        echo ""
        echo -e "${G}1.${NC} å®‰è£…/é‡ç½® Debian ç¯å¢ƒ (XFCE+Firefox)"
        echo -e "${G}2.${NC} å¯åŠ¨ Debian"
        echo -e "${G}3.${NC} Shizuku è‡ªåŠ¨ä¿®å¤ (é˜²æ€åå°)"
        echo -e "${G}4.${NC} å¤‡ä»½å®¹å™¨æ•°æ®"
        echo -e "${G}5.${NC} æŸ¥çœ‹æ›´æ–°æ—¥å¿—"
        echo -e "${R}0. é€€å‡º${NC}"
        echo ""
        read -p "è¯·è¾“å…¥é€‰é¡¹ [0-5]: " choice

        case $choice in
            1) install_debian ;;
            2) start_debian ;;
            3) auto_fix_shizuku ;;
            4) 
                if [ -d "$ROOTFS" ]; then
                    TAR_FILE="$BACKUP_DIR/debian_backup_$(date +%Y%m%d).tar.gz"
                    log "æ­£åœ¨å¤‡ä»½åˆ° $TAR_FILE ..."
                    tar -czf "$TAR_FILE" -C "$PROOT_BASE" "$DISTRO_NAME"
                    log "å¤‡ä»½å®Œæˆï¼"
                else
                    err "å®¹å™¨æœªå®‰è£…ï¼Œæ— æ³•å¤‡ä»½ã€‚"
                fi
                read -p "æŒ‰å›è½¦ç»§ç»­..." 
                ;;
            5) cat "$LOG_FILE" | tail -n 20; read -p "æŒ‰å›è½¦ç»§ç»­..." ;;
            0) exit 0 ;;
            *) echo "æ— æ•ˆè¾“å…¥"; sleep 1 ;;
        esac
    done
}

# ==============================================================================
# â–¶ï¸ ç¨‹åºå…¥å£
# ==============================================================================
load_config
main_menu

# =================================================================
# ğŸš€ XXY v80.0 (å®‡å®™çº§ä¿å§†ç‰ˆ)
# ç‰¹æ€§ï¼šSSHå‚»ç“œå‘å¯¼ | ç”µè„‘ç«¯æŠ¥é”™ä¿®å¤æŒ‡å¼• | ä¸æ»‘æ— é—ªçƒ | è‡ªåŠ¨é…ç½®
# =================================================================

# --- 1. å¼ºåŠ›é‡ç½® ---
tput cnorm
echo "ğŸ§¹ æ­£åœ¨éƒ¨ç½² v80.0 è¶…çº§ä¿å§†å¼•æ“..."
pkill -9 sshd 2>/dev/null
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download

# --- 2. å†™å…¥æ ¸å¿ƒé€»è¾‘ ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# --- å…¨å±€é…ç½® ---
export VERSION="v80.0 ä¿å§†ç‰ˆ"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export REMOTE_URL="" 

# é¢œè‰²åº“
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"
cleanup() { tput cnorm; stty echo; rm -f "$TMPDIR"/xxy_* 2>/dev/null; }
trap cleanup EXIT INT TERM

# --- ä¾èµ–è‡ªæ£€ ---
check_env() {
    if [ ! -f "$PD_CONF/ubuntu.sh" ]; then
        echo -e "${Y}ğŸ”§ ä¿®å¤é…ç½®æ–‡ä»¶...${NC}"
        pkg install proot-distro -y -o Dpkg::Options::="--force-confmiss" >/dev/null 2>&1
    fi
    # ç¡®ä¿ openssh å¿…é¡»å­˜åœ¨
    DEPS="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools"
    MISSING=""
    for d in $DEPS; do command -v $d >/dev/null || MISSING="$MISSING $d"; done
    if [ -n "$MISSING" ]; then
        echo -e "${C}ğŸ“¦ æ­£åœ¨è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±ç»„ä»¶:${NC} $MISSING"
        pkg install $MISSING -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
    if ! command -v termux-x11 &>/dev/null; then
        pkg install x11-repo -y >/dev/null 2>&1; pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# --- Worker (å®¹å™¨å†…è„šæœ¬) ---
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    echo '#!/bin/sh' >> "$W_FILE"; echo 'export PATH=$PATH:/usr/bin:/bin' >> "$W_FILE"
    echo 'act=$1' >> "$W_FILE"
    echo 'if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"' >> "$W_FILE"
    echo 'elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"' >> "$W_FILE"
    echo 'elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"' >> "$W_FILE"
    echo 'else command -v apt >/dev/null && T="debian" || T="unknown"; fi' >> "$W_FILE"
    echo 'case "$act" in' >> "$W_FILE"
    echo '  src)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list; apt update -y' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update' >> "$W_FILE"
    echo '    elif [ "$T" = "arch" ]; then echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/\$arch/\$repo" > /etc/pacman.d/mirrorlist; pacman -Sy --noconfirm archlinux-keyring; pacman-key --init && pacman-key --populate archlinuxarm; fi ;;' >> "$W_FILE"
    echo '  gui)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server; elif [ "$T" = "arch" ]; then pacman -S --noconfirm xfce4 dbus tigervnc; elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi' >> "$W_FILE"
    echo '    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;' >> "$W_FILE"
    echo '  cn)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen; elif [ "$T" = "arch" ]; then pacman -S --noconfirm wqy-zenhei; echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen; locale-gen; elif [ "$T" = "alpine" ]; then apk add font-noto-cjk; fi' >> "$W_FILE"
    echo '    echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/cn.sh ;;' >> "$W_FILE"
    echo '  fetch) if [ "$T" = "alpine" ]; then apk add fastfetch --repository=https://mirrors.ustc.edu.cn/alpine/edge/testing; else command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch; fi ;;' >> "$W_FILE"
    echo 'esac' >> "$W_FILE"; chmod 777 "$W_FILE"
}

run_task() {
    tput cup 14 0; echo -ne "\033[J${Y}âš™ï¸  æ­£åœ¨æ‰§è¡Œ: $2...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" > "$TMPDIR/log_$3.txt" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… $2 æˆåŠŸ${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ $2 å¤±è´¥ (è¯¦æƒ…çœ‹log)${NC}"
    fi
    sleep 1
}

# --- 3. æ ¸å¿ƒåŠŸèƒ½ ---
get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }
select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- ç³»ç»Ÿåˆ—è¡¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then echo -e "\n${R}æ— ç³»ç»Ÿï¼Œè¯·å…ˆå®‰è£…[2]${NC}"; read -n 1 -s; return 1; fi
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"; echo "-------------------------"; read -p "ğŸ‘‰ åºå·: " c
    [[ ! "$c" =~ ^[0-9]+$ ]] && return 2
    [ "$c" = "0" ] && return 2
    if [ -n "${LIST[$((c-1))]}" ]; then SELECTED="${LIST[$((c-1))]}"; return 0; fi
    return 2
}

do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ ===${NC}"
    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"; read -p "ğŸ‘‰ é€‰æ‹©: " idx
    [[ ! "$idx" =~ ^[0-9]+$ ]] && return
    if [ "$idx" != "0" ] && [ -n "${D_NAMES[$((idx-1))]}" ]; then
        TARGET=${D_NAMES[$((idx-1))]}
        if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "å·²å­˜åœ¨"; read -n 1 -s; return; fi
        echo -e "\n${Y}ğŸ§¹ æ¸…ç†ååŒ…é˜²æ­¢æŠ¥é”™...${NC}"
        proot-distro reset "$TARGET" >/dev/null 2>&1
        rm -rf "$CACHE_DIR" 2>/dev/null; rm -rf "$PREFIX/var/lib/proot-distro/download" 2>/dev/null
        if [ -f "$PD_CONF/$TARGET.sh" ]; then sed -i "s|https://ghproxy.net/||g" "$PD_CONF/$TARGET.sh"; sed -i "s|https://mirror.ghproxy.com/||g" "$PD_CONF/$TARGET.sh"; fi
        echo -e "${W}ğŸš€ ä¸‹è½½ä¸­...${NC}"
        if proot-distro install $TARGET; then
            create_worker
            run_task "$TARGET" "æ¢æº" "src"; run_task "$TARGET" "ä¸­æ–‡" "cn"; run_task "$TARGET" "Fetch" "fetch"
            echo -e "\n${G}å®Œæˆ!${NC}"; read -n 1 -s
        else
            echo -e "\n${R}å¤±è´¥: ç½‘ç»œä¸­æ–­ï¼Œè¯·å¼€VPNé‡è¯•${NC}"; read -n 1 -s
        fi
    fi
}

do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    RC="$TMPDIR/rc_$$"
    echo "if [ -f /etc/profile.d/cn.sh ]; then . /etc/profile.d/cn.sh; fi; clear; command -v fastfetch >/dev/null && fastfetch; /bin/bash" > "$RC"
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash --rcfile "$RC"; rm -f "$RC"
}

do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    echo -ne "${Y}æ£€æŸ¥æ¡Œé¢...${NC}\r"
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        run_task "$SELECTED" "å®‰è£…XFCE4" "gui"
    fi
    clear; echo -e "${G}1. æœ¬åœ° (Termux:X11)${NC}"; echo "2. è¿œç¨‹ (VNC)"; read -p "é€‰: " m
    if [ "$m" == "1" ]; then
        pkill -9 termux-x11 >/dev/null 2>&1; pulseaudio --kill >/dev/null 2>&1; rm -rf $TMPDIR/.X11-unix
        if ! am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; then echo "${R}ç¼ºAPP${NC}"; read -n 1 -s; return; fi
        sleep 1; pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1; termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

# [è¶…çº§ä¿å§†ç‰ˆ SSH]
do_ssh_remote() {
    tput cnorm; stty echo; clear
    echo -e "${C}=== ç”µè„‘è¿æ¥æ‰‹æœº (å‚»ç“œæ¨¡å¼) ===${NC}"
    
    # 1. è·å–åŸºæœ¬ä¿¡æ¯
    USER=$(whoami)
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | awk '{print $2}' | sed 's/addr://' | head -n 1)
    
    # 2. æ£€æŸ¥å¯†ç çŠ¶æ€ (æ— æ³•ç›´æ¥æ£€æŸ¥ï¼Œé»˜è®¤æç¤ºè®¾ç½®)
    echo -e "${Y}ç¬¬ä¸€æ­¥ï¼šç¡®ä¿ä½ è®¾ç½®äº†è¿æ¥å¯†ç ${NC}"
    read -p "ä½ è®¾ç½®è¿‡å¯†ç å—ï¼Ÿ(y=è®¾è¿‡ / n=æ²¡è®¾è¿‡): " has_pwd
    if [ "$has_pwd" != "y" ]; then
        echo -e "\nğŸ‘‡ è¯·è¾“å…¥æ–°å¯†ç  (è¾“å…¥æ—¶ä¸æ˜¾ç¤ºæ˜¯æ­£å¸¸çš„ï¼Œè¾“å®ŒæŒ‰å›è½¦ï¼Œè¦è¾“ä¸¤æ¬¡):"
        passwd
        echo -e "${G}å¯†ç è®¾ç½®æˆåŠŸï¼${NC}"
    fi
    
    # 3. å¯åŠ¨æœåŠ¡
    echo -e "\n${Y}ç¬¬äºŒæ­¥ï¼šæ­£åœ¨å¯åŠ¨æœåŠ¡...${NC}"
    pkill sshd; sshd
    
    # 4. ç”Ÿæˆå‚»ç“œå‘½ä»¤
    clear
    echo -e "${G}âœ… SSH æœåŠ¡å·²æˆåŠŸå¼€å¯ï¼${NC}"
    echo -e "--------------------------------------------------"
    echo -e "${C}è¯·åœ¨ç”µè„‘ PowerShell å¤åˆ¶ä»¥ä¸‹å‘½ä»¤ (ç›´æ¥ç²˜è´´):${NC}"
    echo -e ""
    echo -e "   \033[1;33mssh -p 8022 $USER@$IP\033[0m"
    echo -e ""
    echo -e "--------------------------------------------------"
    echo -e "${R}âš ï¸ å¦‚æœç”µè„‘æç¤º Bad port æˆ– config errorï¼š${NC}"
    echo -e "è¯·åœ¨ç”µè„‘è¾“å…¥è¿™ä¸ªå‘½ä»¤å…ˆä¿®å¥½ç”µè„‘ï¼šRemove-Item ~/.ssh/config"
    echo -e "--------------------------------------------------"
    echo -e "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå• (æœåŠ¡ä¼šåœ¨åå°è¿è¡Œ)..."
    read -n 1 -s
}

do_del() { select_sys; [ $? -ne 0 ] && return; read -p "åˆ å—(y)? " k; [ "$k" == "y" ] && proot-distro remove "$SELECTED" && rm -rf "$ROOTFS_BASE/$SELECTED"; }

do_update() {
    tput cnorm; stty echo; clear; echo "${C}æ£€æŸ¥æ›´æ–°${NC}"
    if [ -z "$REMOTE_URL" ]; then echo -e "è¯·å¤åˆ¶æ–°ä»£ç ç²˜è´´æ›´æ–°ã€‚"; else
        curl -s -L "$REMOTE_URL" -o "$TMPDIR/u.sh"
        if head -1 "$TMPDIR/u.sh" | grep -q "#!"; then mv "$TMPDIR/u.sh" "$PREFIX/bin/xxy"; chmod 755 "$PREFIX/bin/xxy"; echo "${G}æˆåŠŸ${NC}"; exec "$PREFIX/bin/xxy"; else echo "${R}å¤±è´¥${NC}"; fi
    fi; read -n 1 -s
}

# --- 4. UI æ ¸å¿ƒ (ä¸æ»‘ç‰ˆ) ---
draw_base() {
    clear
    echo -e "${C}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo "" 
    echo "" 
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] ç”µè„‘è¿æ¥ (SSH)${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] æ£€æŸ¥æ›´æ–°${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${W} [0] é€€å‡º${NC}"
    echo ""
    echo -e "${C}â¤ è¯·è¾“å…¥æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://')
    [ -z "$IP" ] && IP="ç¦»çº¿"
    MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    tput cup 5 0
    printf " ${W}Ver:${NC} ${Y}%-7s${NC} | ${W}Time:${NC} ${Y}%s${NC} | IP:${W}%-13s${NC} RAM:${B}%s${NC}\033[K" "$VERSION" "$T" "$IP" "$MEM"
    tput cup 13 16
}

# --- Loop ---
check_env
draw_base
while true; do
    refresh_info
    read -t 1 -n 1 choice
    STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    case "$choice" in
        1) do_login; draw_base ;; 
        2) do_install; draw_base ;; 
        3) do_gui; draw_base ;;
        4) do_ssh_remote; draw_base ;; 
        5) do_del; draw_base ;; 
        6) do_update; draw_base ;; 
        0) exit 0 ;;
        *) ;; 
    esac
done
MAIN_EOF

# 3. å¯åŠ¨
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;32mâœ… v80.0 å®‡å®™çº§ä¿å§†ç‰ˆ å·²å°±ç»ªï¼\033[0m"
echo -e "-------------------------------------------"
echo -e "1. æˆ‘å·²ç»å¸®ä½ å½»åº•é‡æ„äº† [4] SSH åŠŸèƒ½ã€‚"
echo -e "2. ç°åœ¨å®ƒä¼šç›´æ¥æŠŠä½ è¦è¾“å…¥çš„å‘½ä»¤æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚"
echo -e "3. åˆ«å¿˜äº†å…ˆåœ¨ç”µè„‘ä¸Šåˆ æ‰é‚£ä¸ªåçš„ config æ–‡ä»¶ï¼"
echo -e "-------------------------------------------"
echo -e "è¾“å…¥ \033[1;33mxxy\033[0m å¯åŠ¨ã€‚"
echo -e "æŒ‰å›è½¦å¼€å§‹..."
read
xxy

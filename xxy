# 1. æ·±åº¦æ¸…ç† (æ•‘ç –ç¬¬ä¸€æ­¥)
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
rm -rf $PREFIX/tmp/.X11-unix
rm -rf $PREFIX/tmp/.X1-lock
# æ¸…ç†å¯èƒ½æŸåçš„é”æ–‡ä»¶
pkill -9 termux-x11
pkill -9 pulseaudio

# 2. å†™å…¥ v37.0 æ•‘ç –ç‰ˆ
cat > $PREFIX/bin/xxy << 'INSTALL_EOF'
#!/data/data/com.termux/files/usr/bin/bash
# ==============================================================================
# PROJECT: XXY (Rescue Edition v37.0)
# FIX: é•œåƒæºä¿®å¤ã€å®¹å™¨æƒé™ç©¿é€ã€GUIå¯åŠ¨é“¾é‡å†™
# ==============================================================================

# --- 0. å…¨å±€é…ç½® ---
export VERSION="v37.0"
# [ä¿®å¤1] æ›´æ¢ä¸ºç¨³å®šçš„åŠ é€Ÿæº
export PROXY_URL="https://ghproxy.net/"
export UPDATE_URL="${PROXY_URL}https://raw.githubusercontent.com/Xiaoxinyun2008/XXY-Termux/main/xxy"
export GITHUB_URL="https://github.com/Xiaoxinyun2008/XXY-Termux"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
# å®¹å™¨å­˜å‚¨çš„ç‰©ç†è·¯å¾„
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export PD_CONF="$PREFIX/etc/proot-distro"
export TERMUX_PKG_OPTS="-y -o Dpkg::Options::=--force-confnew" 

[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); P=$(tput setaf 5); C=$(tput setaf 6)
W=$(tput setaf 7); NC=$(tput sgr0)

cleanup() {
    tput cnorm; stty echo; rm -f "$TMPDIR"/xxy_* 2>/dev/null
}
trap cleanup EXIT INT TERM

# --- 1. åŸºç¡€ç¯å¢ƒä¸ç½‘ç»œ ---

get_ip() {
    local ip=""
    if command -v ip >/dev/null; then ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{print $7}'); fi
    if [ -z "$ip" ] && command -v ifconfig >/dev/null; then
        ip=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | awk '{print $2}' | sed 's/addr://' | head -n 1)
    fi
    echo "${ip:-127.0.0.1}"
}

check_dependencies() {
    if [ -f "$PREFIX/etc/xxy_checked_v37" ]; then return; fi
    clear; echo -e "${C}=== ç¯å¢ƒè‡ªæ£€ä¸ä¿®å¤ ===${NC}"
    
    # æ ¸å¿ƒä¾èµ–
    DEPS="proot-distro pulseaudio wget curl ncurses-utils grep sed awk fastfetch net-tools"
    
    MISSING=""
    for dep in $DEPS; do 
        if ! command -v $dep &>/dev/null; then MISSING="$MISSING $dep"; fi
    done
    
    # X11 ä»“åº“æ£€æŸ¥
    if ! command -v termux-x11 &>/dev/null; then 
        pkg install x11-repo $TERMUX_PKG_OPTS >/dev/null 2>&1
        MISSING="$MISSING termux-x11-nightly"
    fi
    
    if [ -n "$MISSING" ]; then
        echo -e "${Y}æ­£åœ¨ä¿®å¤ç¼ºå¤±ç»„ä»¶...${NC}"
        # ä½¿ç”¨ -k å¿½ç•¥ SSL é”™è¯¯ï¼Œé˜²æ­¢ curl æŠ¥é”™
        pkg update -y -k >/dev/null 2>&1
        pkg install $MISSING $TERMUX_PKG_OPTS
    fi
    touch "$PREFIX/etc/xxy_checked_v37"
}

# [ä¿®å¤] proot-distro ä¸‹è½½åŠ é€Ÿæ³¨å…¥
optimize_network() {
    local TARGETS="ubuntu debian archlinux alpine"
    for distro in $TARGETS; do
        local conf_file="$PD_CONF/$distro.sh"
        if [ -f "$conf_file" ]; then
            # å…ˆè¿˜åŸï¼Œé˜²æ­¢é‡å¤æ³¨å…¥å¯¼è‡´ URL ç•¸å½¢
            sed -i 's|https://.*/https://github.com|https://github.com|g' "$conf_file"
            # æ³¨å…¥æ–°çš„ç¨³å®šä»£ç†
            sed -i "s|https://github.com|${PROXY_URL}https://github.com|g" "$conf_file"
        fi
    done
}

# --- 2. å®¹å™¨æ ¸å¿ƒé€»è¾‘ (ä¿®å¤æ£€æµ‹ä¸æ‰§è¡Œ) ---

# [ä¿®å¤2] ä¸‰é‡æ ¡éªŒæ£€æµ‹å®¹å™¨
get_systems() {
    # ç›´æ¥æ‰«æç‰©ç†ç›®å½•ï¼Œä¸ä¾èµ– proot-distro list (å¤ªæ…¢ä¸”ä¸ç¨³å®š)
    if [ -d "$ROOTFS_BASE" ]; then
        for sys in $(ls "$ROOTFS_BASE"); do
            # å¿…é¡»åŒæ—¶å­˜åœ¨ bin/sh å’Œ etc ç›®å½•æ‰ç®—æœ‰æ•ˆç³»ç»Ÿï¼Œé˜²æ­¢ç©ºæ–‡ä»¶å¤¹è¯¯æŠ¥
            if [ -f "$ROOTFS_BASE/$sys/bin/sh" ] && [ -d "$ROOTFS_BASE/$sys/etc" ]; then
                echo "$sys"
            fi
        done
    fi
}

# å†…éƒ¨è„šæœ¬ç”Ÿæˆ
WORKER_SCRIPT="$TMPDIR/xxy_worker_$$.sh"
INJECT_SCRIPT="$TMPDIR/xxy_inject_$$.sh"

create_worker_script() {
    rm -f "$WORKER_SCRIPT"
    cat << 'EOF' > "$WORKER_SCRIPT"
#!/bin/sh
# [ä¿®å¤] å¼ºåˆ¶ç¯å¢ƒå˜é‡ï¼Œé˜²æ­¢æ‰¾ä¸åˆ°å‘½ä»¤
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
action=$1

# ç®€å•çš„åŒ…ç®¡ç†å™¨æ£€æµ‹
if command -v apt >/dev/null; then
    INSTALL="apt install -y"; UPDATE="apt update -y"; 
    # å¤„ç† Debian/Ubuntu çš„äº¤äº’å‰ç«¯
    export DEBIAN_FRONTEND=noninteractive
    is_debian=true
elif command -v pacman >/dev/null; then
    INSTALL="pacman -S --noconfirm"; UPDATE="pacman -Sy --noconfirm"; is_arch=true
elif command -v apk >/dev/null; then
    INSTALL="apk add"; UPDATE="apk update"; is_alpine=true
else
    echo "Error: Unknown Package Manager"
    exit 1
fi

case "$action" in
  change_source)
    if [ "$is_debian" = true ]; then
        # æš´åŠ›è¦†ç›–æºï¼Œè§£å†³å°ç™½ä¸ä¼šæ¢æºçš„é—®é¢˜
        echo "deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list
        echo "deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list
        echo "deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list
    elif [ "$is_alpine" = true ]; then
        sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
    fi
    $UPDATE
    ;;
    
  install_gui)
    if [ "$is_debian" = true ]; then
        $INSTALL xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$is_arch" = true ]; then
        $INSTALL xfce4 dbus tigervnc
    elif [ "$is_alpine" = true ]; then
        $INSTALL xfce4 dbus-x11 tigervnc
    fi
    # ä¿®å¤ VNC å¯†ç 
    mkdir -p ~/.vnc
    echo "123456" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd
    ;;
    
  install_fastfetch)
    $INSTALL fastfetch || $INSTALL neofetch
    if command -v fastfetch >/dev/null; then echo "fastfetch" > /tmp/fetch_bin
    elif command -v neofetch >/dev/null; then echo "neofetch" > /tmp/fetch_bin
    else echo "none" > /tmp/fetch_bin; fi
    ;;
    
  install_cn)
    if [ "$is_debian" = true ]; then
        $INSTALL locales fonts-noto-cjk
        echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen && locale-gen
        echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/xxy_lang.sh
    fi
    ;;
esac
EOF
    # [ä¿®å¤4] ç»™äºˆ 777 æƒé™ï¼Œç¡®ä¿å®¹å™¨å†…èƒ½æ‰§è¡Œ
    chmod 777 "$WORKER_SCRIPT"
}

# [ä¿®å¤4] ä»»åŠ¡æ‰§è¡Œå™¨ - ä¿®å¤æƒé™å’Œè·¯å¾„
run_task() {
    local sys=$1; local cmd=$2; local desc=$3
    # å®¹å™¨å†…è·¯å¾„æ˜ å°„: å®¿ä¸»æœºçš„ $TMPDIR å¯¹åº”å®¹å™¨çš„ /tmp
    local inner_script="/tmp/$(basename "$WORKER_SCRIPT")"
    
    tput cup 23 0; echo -ne "${Y}âš™ï¸  [$sys] $desc...${NC}"
    
    # ä½¿ç”¨ /bin/sh æ˜¾å¼æ‰§è¡Œï¼Œé˜²æ­¢æƒé™æ‹’ç»
    if proot-distro login "$sys" --shared-tmp -- /bin/sh "$inner_script" "$cmd" >/dev/null 2>&1; then
        tput cup 23 0; echo -ne "${G}âœ… [$sys] $desc æˆåŠŸ          ${NC}"
    else
        tput cup 23 0; echo -ne "${R}âŒ [$sys] $desc å¤±è´¥          ${NC}"
    fi
}

select_menu() {
    mapfile -t SYS_ARRAY < <(get_systems)
    if [ ${#SYS_ARRAY[@]} -eq 0 ]; then
        echo -e "\n${R}âš ï¸  æœªæ£€æµ‹åˆ°æœ‰æ•ˆç³»ç»Ÿï¼${NC}"
        echo "è¯·å…ˆé€‰æ‹© [2] å®‰è£…ç³»ç»Ÿ"
        read -n 1 -s -r -p "..."
        return 1
    fi
    for i in "${!SYS_ARRAY[@]}"; do echo -e "${G}$((i+1)).${NC} ${SYS_ARRAY[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    tput cnorm; stty echo; read -p "ğŸ‘‰ åºå·: " choice; stty -echo; tput civis
    if [ "$choice" == "0" ] || [ -z "$choice" ]; then return 1; fi
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#SYS_ARRAY[@]}" ]; then
        echo "${SYS_ARRAY[$((choice-1))]}"
        return 0
    fi
    return 1
}

# --- åŠŸèƒ½æ¨¡å— ---

do_login() {
    clear; echo -e "${C}=== ç™»å½•ç³»ç»Ÿ ===${NC}"
    TARGET=$(select_menu) || return
    create_worker_script
    local inner_script="/tmp/$(basename "$WORKER_SCRIPT")"
    local inner_inject="/tmp/$(basename "$INJECT_SCRIPT")"
    
    echo -e "${B}æ­£åœ¨å¯åŠ¨å®¹å™¨...${NC}"
    
    # å°è¯•æ³¨å…¥ç¾åŒ–ï¼Œä½†ä¸é˜»å¡ç™»å½•
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$inner_script" "install_fastfetch" >/dev/null 2>&1
    
    # æ³¨å…¥å¯åŠ¨è„šæœ¬
    cat > "$INJECT_SCRIPT" << 'EOF'
RC=~/.bashrc
[ -f /etc/profile.d/xxy_lang.sh ] && . /etc/profile.d/xxy_lang.sh
if [ -f /tmp/fetch_bin ]; then
    TOOL=$(cat /tmp/fetch_bin); rm -f /tmp/fetch_bin
    if [ "$TOOL" != "none" ] && ! grep -q "$TOOL" "$RC" 2>/dev/null; then
        echo "" >> "$RC"; echo "clear" >> "$RC"; echo "$TOOL" >> "$RC"
    fi
fi
EOF
    chmod 777 "$INJECT_SCRIPT"
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$inner_inject" >/dev/null 2>&1
    
    cleanup
    # æ­£å¼ç™»å½•
    proot-distro login "$TARGET"
    
    # é€€å‡ºåæ¢å¤
    tput civis; stty -echo; draw_ui
}

do_install() {
    clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ (åŠ é€Ÿç‰ˆ) ===${NC}"
    DISTROS=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!DISTROS[@]}"; do echo -e "${W}$((i+1)).${NC} ${DISTROS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    tput cnorm; stty echo; read -p "ğŸ‘‰ é€‰æ‹©: " idx; stty -echo; tput civis
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#DISTROS[@]}" ]; then
        TARGET=${DISTROS[$((idx-1))]}
        
        # æ®‹ç•™æ¸…ç†
        if [ -d "$ROOTFS_BASE/$TARGET" ]; then
            if [ ! -f "$ROOTFS_BASE/$TARGET/bin/sh" ]; then
                echo -e "\n${Y}æ¸…ç†æ— æ•ˆæ®‹ç•™...${NC}"
                proot-distro remove $TARGET >/dev/null 2>&1; rm -rf "$ROOTFS_BASE/$TARGET"
            else 
                echo -e "\n${G}ç³»ç»Ÿå·²å­˜åœ¨ï¼${NC}"; read -n 1 -s -r -p "..."; return
            fi
        fi
        
        # æ³¨å…¥åŠ é€Ÿ
        optimize_network
        
        echo -e "\n${Y}æ­£åœ¨ä¸‹è½½ $TARGET (å·²åŠ é€Ÿ)...${NC}"; tput cnorm
        if proot-distro install $TARGET; then
            tput civis; create_worker_script
            run_task "$TARGET" "change_source" "æ¢å›½å†…æº"
            run_task "$TARGET" "install_cn" "ä¸­æ–‡ç¯å¢ƒ"
            run_task "$TARGET" "install_fastfetch" "ç¾åŒ–å·¥å…·"
            echo -e "\n${G}ğŸ‰ å®‰è£…å®Œæˆï¼${NC}"; read -n 1 -s -r -p "..."
        else
            echo -e "\n${R}âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å­˜å‚¨ç©ºé—´ã€‚${NC}"
            proot-distro remove $TARGET >/dev/null 2>&1
            read -n 1 -s -r -p "..."
        fi
    fi
}

# [ä¿®å¤3] æ¡Œé¢å¯åŠ¨é“¾é‡æ„
do_gui() {
    clear; echo -e "${C}=== å¯åŠ¨æ¡Œé¢ ===${NC}"
    TARGET=$(select_menu) || return
    create_worker_script
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£… XFCE
    echo -ne "ğŸ” æ£€æŸ¥æ¡Œé¢ç¯å¢ƒ...\r"
    if ! proot-distro login "$TARGET" -- bash -c "command -v startxfce4" >/dev/null 2>&1; then
        echo -e "\n${Y}æœªæ£€æµ‹åˆ°æ¡Œé¢ï¼Œå¼€å§‹å®‰è£…...${NC}"
        run_task "$TARGET" "install_gui" "å®‰è£…æ¡Œé¢ (è¾ƒæ…¢)"
    fi
    
    echo -e "\n${G}æ¨¡å¼:${NC}\n1. Termux:X11 ${Y}(æ¨è)${NC}\n2. VNC Viewer\n0. è¿”å›"
    tput cnorm; stty echo; read -p "é€‰æ‹©: " m; stty -echo; tput civis
    
    if [ "$m" == "1" ]; then
        # å¼ºåŠ›æ¸…ç†ç¯å¢ƒ
        pulseaudio --kill >/dev/null 2>&1
        pkill -f com.termux.x11 >/dev/null 2>&1
        rm -rf "$TMPDIR/.X11-unix"
        
        # å¯åŠ¨éŸ³é¢‘æœåŠ¡
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        
        # å¯åŠ¨ APP
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
        termux-x11 :0 >/dev/null 2>&1 &
        
        # å®¹å™¨å†…å¯åŠ¨å‘½ä»¤ (ä¿®å¤ dbus)
        CMD="export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        proot-distro login "$TARGET" --shared-tmp -- bash -c "$CMD"
        
    elif [ "$m" == "2" ]; then
        # VNC æ¨¡å¼
        CMD="vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X1-lock /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        proot-distro login "$TARGET" -- bash -c "$CMD"
        echo -e "\n${G}VNC å·²å¯åŠ¨${NC}\nåœ°å€: 127.0.0.1:5901\nå¯†ç : 123456"; read -n 1 -s -r -p "..."
    fi
}

do_github() {
    clear; echo -e "${C}=== è®¿é—® GitHub ===${NC}"
    if ! command -v lynx &>/dev/null; then
        echo -e "${Y}å®‰è£…æµè§ˆå™¨...${NC}"; tput cnorm; pkg install lynx $TERMUX_PKG_OPTS; tput civis
    fi
    lynx "$GITHUB_URL"; tput civis; stty -echo; draw_ui
}

do_update() {
    clear; echo -e "${C}=== æ£€æŸ¥æ›´æ–° ===${NC}"
    local temp="$TMPDIR/xxy_tmp"; rm -f "$temp"
    
    # ä½¿ç”¨é•œåƒæºä¸‹è½½
    local http_code=$(curl -L -s -m 5 -o "$temp" -w "%{http_code}" "$UPDATE_URL")
    
    if [ "$http_code" != "200" ]; then
        echo -e "\n${R}âŒ æ›´æ–°æœåŠ¡å™¨è¿æ¥å¤±è´¥ ($http_code)${NC}"
        read -n 1 -s -r -p "..."; return
    fi
    
    if ! grep -q "PROJECT: XXY" "$temp"; then
        echo -e "\n${R}âŒ æ–‡ä»¶æ ¡éªŒé”™è¯¯${NC}"; read -n 1 -s -r -p "..."; return
    fi
    
    local remote_ver=$(grep "export VERSION=" "$temp" | cut -d'"' -f2)
    echo -e "\næœ¬åœ°: $VERSION | äº‘ç«¯: $remote_ver"
    
    tput cnorm; stty echo; echo ""; read -p "ç¡®è®¤æ›´æ–°/é‡è£…? (y/n): " c; stty -echo; tput civis
    if [[ "$c" == "y" ]]; then
        mv "$temp" "$PREFIX/bin/xxy"; chmod 755 "$PREFIX/bin/xxy"
        echo -e "${G}æ›´æ–°æˆåŠŸï¼${NC}"; exit 0
    fi
}

# --- Main UI ---
update_status() {
    if (( FRAME % 50 == 0 )); then MEM=$(free -m 2>/dev/null | awk 'NR==2{printf "%.1fG", $3/1024}' || echo "N/A"); fi
    tput cup 0 34; printf "${B}â•­â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 1 34; printf "${B}â”‚${NC} TIME: ${W}%-5s${NC} MEM: ${P}%-5s${NC}         ${B}â”‚${NC}" "$(date "+%H:%M")" "$MEM"
    tput cup 2 34; printf "${B}â”‚${NC} IP: ${GR}%-15s${NC}             ${B}â”‚${NC}" "$(get_ip)"
    tput cup 3 34; printf "${B}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
}

draw_ui() {
    clear
    cat << EOF
${C}
â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— ${W}XXY Termux${C}
â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• ${GR}${VERSION}${C}
 â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  ${W}Rescue${C}
 â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•   ${NC}
${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}
${GR}â”‚${NC} ${W}1.${NC} ç™»å½•ç³»ç»Ÿ (Login)    ${GR}â”‚${NC} ${W}3.${NC} å¯åŠ¨æ¡Œé¢ (GUI)
${GR}â”‚${NC} ${W}2.${NC} å®‰è£…ç³»ç»Ÿ (Install)  ${GR}â”‚${NC} ${W}5.${NC} æ£€æŸ¥æ›´æ–° (Update)
${GR}â”‚${NC} ${W}6.${NC} è®¿é—® GitHub (Lynx)  ${GR}â”‚${NC} ${W}0.${NC} é€€å‡ºç¨‹åº (Exit)
${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}
EOF
    if command -v fastfetch >/dev/null; then
        fastfetch --config structure:OS:Kernel:Uptime --logo none 2>/dev/null | sed 's/^/  /'
    fi
}

check_dependencies; create_worker_script; tput civis; stty -echo
draw_ui; INPUT_BUF=""; FRAME=0; MEM="Wait"
while true; do
    update_status; ((FRAME++))
    tput cup 22 0; echo -ne "${C}â¤ åºå·: ${W}${INPUT_BUF}_        ${NC}"
    read -t 0.05 -n 1 key
    if [[ $? -eq 0 ]]; then
        if [[ -z "$key" ]]; then
            if [[ -n "$INPUT_BUF" ]]; then
                case $INPUT_BUF in
                    1)do_login;; 2)do_install;; 3)do_gui;; 5)do_update;; 6)do_github;; 0)exit 0;;
                esac
                tput civis; stty -echo; draw_ui; INPUT_BUF=""
            fi
        elif [[ "$key" == $'\x7f' || "$key" == $'\b' ]]; then INPUT_BUF="${INPUT_BUF%?}"
        elif [[ "$key" == $'\e' ]]; then read -t 0.01 -n 2
        else INPUT_BUF="$INPUT_BUF$key"; fi
    fi
done
INSTALL_EOF

# ... (ä¸Šé¢æ˜¯åŸæœ¬çš„è„šæœ¬å†…å®¹) ...

chmod 755 $PREFIX/bin/xxy
sed -i 's/\r$//' $PREFIX/bin/xxy

# --- 3. æœ€ç»ˆå®‰è£…æŠ¥å‘Š ---
clear
echo -e "\033[1;32mğŸ‰ XXY v37.0 (æ•‘ç –ç‰ˆ) éƒ¨ç½²å®Œæˆï¼\033[0m"
echo -e "\033[1;34mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"

echo -e "\033[1;36mğŸ“¦ [å·²éƒ¨ç½²çš„æ ¸å¿ƒä¾èµ–åº“]\033[0m"
echo -e "  â€¢ \033[37mSystem:\033[0m proot-distro (å®¹å™¨æ ¸å¿ƒ), ncurses-utils (UIå·¥å…·)"
echo -e "  â€¢ \033[37mNetwork:\033[0m wget, curl, net-tools (ç½‘ç»œä¸ä¸‹è½½)"
echo -e "  â€¢ \033[37mMedia:\033[0m   pulseaudio (éŸ³é¢‘æœåŠ¡), x11-repo (å›¾å½¢åº“)"
echo -e "  â€¢ \033[37mVisual:\033[0m  fastfetch (ç¾åŒ–), termux-x11 (é«˜æ€§èƒ½GUI)"

echo -e "\n\033[1;33mğŸ”§ [v37.0 æ•‘ç –ç‰ˆå…³é”®ä¿®å¤]\033[0m"
echo -e "  1. \033[32mé•œåƒé‡ç½®:\033[0m å·²åˆ‡æ¢è‡³ ghproxy.net ç¨³å®šåŠ é€Ÿæºï¼Œè§£å†³ä¸‹è½½ 404ã€‚"
echo -e "  2. \033[32mæƒé™ç©¿é€:\033[0m ä¿®å¤å®¹å™¨å†… Permission deniedï¼Œç¡®ä¿ Worker æ­£å¸¸æ‰§è¡Œã€‚"
echo -e "  3. \033[32mæ£€æµ‹é€»è¾‘:\033[0m é‡‡ç”¨ç‰©ç†æ–‡ä»¶æ‰«æï¼Œç²¾å‡†è¯†åˆ«å·²å®‰è£…ç³»ç»Ÿï¼Œé˜²æ­¢è¯¯æŠ¥ã€‚"
echo -e "  4. \033[32mGUIé‡å†™:\033[0m å¼ºåˆ¶æ¸…ç† DBus/X11 é”æ–‡ä»¶ï¼Œä¿®å¤æ¡Œé¢å¯åŠ¨é»‘å±ã€‚"

echo -e "\n\033[1;35mğŸš€ [XXY å‘½ä»¤åŠŸèƒ½æ¦‚è§ˆ]\033[0m"
echo -e "  â€¢ \033[37mä¸€é”®å®‰è£…:\033[0m è‡ªåŠ¨å®‰è£… Linux (Ubuntu/Debianç­‰) å¹¶é…ç½®ä¸­æ–‡/æ¢æºã€‚"
echo -e "  â€¢ \033[37mä¸€é”®æ¡Œé¢:\033[0m è‡ªåŠ¨é…ç½® XFCE4 æ¡Œé¢ï¼Œæ”¯æŒ Termux:X11 å’Œ VNCã€‚"
echo -e "  â€¢ \033[37mæ— æ„Ÿç™»å½•:\033[0m ç™»å½•å³è‡ªåŠ¨æ¸…å±å¹¶å±•ç¤ºç³»ç»Ÿä¿¡æ¯ (Fastfetch)ã€‚"
echo -e "\033[1;34mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"

echo -e "\n\033[1;32mğŸ‘‰ è¯·è¾“å…¥ \033[1;37;42m xxy \033[1;32m å¹¶å›è½¦å¯åŠ¨ç¨‹åºï¼\033[0m"
echo -e "\033[30m(æˆ–ç›´æ¥ç­‰å¾… 2 ç§’åè‡ªåŠ¨å¯åŠ¨...)\033[0m"



# =================================================================
# ğŸš€ XXY ä¸–ç•Œæœ€å¼ºç‰ˆ (v60.0 Ultimate) - ä¸“ä¸ºå°ç™½æ‰“é€ 
# åŠŸèƒ½ï¼šè‡ªåŠ¨ä¿®å¤ | å®æ—¶åˆ·æ–° | æ™ºèƒ½é˜²æŠ¥é”™ | ä¸‹è½½ä¿æŠ¤
# =================================================================

# 1. ã€æ·±åº¦æ¸…æ´ã€‘æ¸…ç†æ‰€æœ‰å¯èƒ½å¯¼è‡´æŠ¥é”™çš„æ—§æ–‡ä»¶
# (å°ç™½ä¸ç”¨æ‡‚ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†é˜²æ­¢ä½ ä¹‹å‰ä¸‹è½½å¤±è´¥ç•™ä¸‹çš„çƒ‚æ‘Šå­å¯¼è‡´æŠ¥é”™)
tput cnorm
echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ—§ç¯å¢ƒï¼Œç¡®ä¿100%çº¯å‡€å®‰è£…..."
pkill -9 sshd 2>/dev/null
pkill -9 termux-x11 2>/dev/null
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
# æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶åˆ é™¤ Proot ä¸‹è½½ç¼“å­˜ï¼Œå½»åº•è§£å†³ "CPUä¸æ”¯æŒ32ä½" çš„è¯¯æŠ¥
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download

# 2. ã€å†™å…¥æ ¸å¿ƒç¨‹åºã€‘
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash
# -----------------------------------------------------------
# è„šæœ¬æ ¸å¿ƒé€»è¾‘å¼€å§‹
# -----------------------------------------------------------

# --- å…¨å±€é…ç½® ---
export VERSION="v60.0 Pro"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export CACHE_DIR="$PREFIX/var/lib/proot-distro/dlcache"
# å¦‚æœä½ æœ‰å›ºå®šçš„æ›´æ–°åœ°å€ï¼Œå¡«åœ¨è¿™é‡Œï¼Œå¦åˆ™ç•™ç©º
export REMOTE_URL="" 

# é¢œè‰²å®šä¹‰ (è®©ç•Œé¢æ›´å¥½çœ‹)
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†åƒåœ¾
cleanup() { tput cnorm; stty echo; rm -f "$TMPDIR"/xxy_* 2>/dev/null; }
trap cleanup EXIT INT TERM

# --- 1. æ™ºèƒ½ç¯å¢ƒè‡ªæ£€ (è‡ªåŠ¨ä¿®å¤ç¼ºå°‘çš„è½¯ä»¶) ---
check_env() {
    # ä¿®å¤ï¼šå¦‚æœä½ è¯¯åˆ äº†é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è¡¥å…¨
    if [ ! -f "$PD_CONF/ubuntu.sh" ]; then
        echo -e "${Y}ğŸ”§ æ­£åœ¨ä¿®å¤ä¸¢å¤±çš„ç³»ç»Ÿé…ç½®...${NC}"
        pkg install proot-distro -y -o Dpkg::Options::="--force-confmiss" >/dev/null 2>&1
    fi

    # æ£€æŸ¥æ‰€æœ‰ä¾èµ–è½¯ä»¶
    DEPS="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools"
    MISSING=""
    for d in $DEPS; do command -v $d >/dev/null || MISSING="$MISSING $d"; done
    
    if [ -n "$MISSING" ]; then
        echo -e "${C}ğŸ“¦ æ­£åœ¨è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±ç»„ä»¶:${NC} $MISSING"
        echo -e "${Y}(ç¬¬ä¸€æ¬¡å®‰è£…å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...)${NC}"
        pkg install $MISSING -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº† X11 ä»“åº“
    if ! command -v termux-x11 &>/dev/null; then
        echo -e "${C}ğŸ“¦ æ­£åœ¨å®‰è£…å›¾å½¢é©±åŠ¨æ”¯æŒ...${NC}"
        pkg install x11-repo -y >/dev/null 2>&1
        pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# --- 2. å†…éƒ¨å·¥å…·ç”Ÿæˆå™¨ (ç”Ÿæˆç”¨äºå®¹å™¨å†…éƒ¨çš„è„šæœ¬) ---
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"
    rm -f "$W_FILE"
    echo '#!/bin/sh' >> "$W_FILE"
    echo 'export PATH=$PATH:/usr/bin:/bin' >> "$W_FILE"
    echo 'act=$1' >> "$W_FILE"
    
    # æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿç±»å‹ (Debian/Arch/Alpine)
    echo 'if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"' >> "$W_FILE"
    echo 'elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"' >> "$W_FILE"
    echo 'elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"' >> "$W_FILE"
    echo 'else command -v apt >/dev/null && T="debian" || T="unknown"; fi' >> "$W_FILE"
    
    echo 'case "$act" in' >> "$W_FILE"
    
    # [src] è‡ªåŠ¨æ¢å›½å†…æº (æ¸…å/ä¸­ç§‘å¤§)
    echo '  src)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then' >> "$W_FILE"
    echo '      grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list' >> "$W_FILE"
    echo '      apt update -y' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then' >> "$W_FILE"
    echo '      sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update' >> "$W_FILE"
    echo '    elif [ "$T" = "arch" ]; then' >> "$W_FILE"
    echo '      echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/\$arch/\$repo" > /etc/pacman.d/mirrorlist' >> "$W_FILE"
    echo '      pacman -Sy --noconfirm archlinux-keyring; pacman-key --init && pacman-key --populate archlinuxarm' >> "$W_FILE"
    echo '    fi ;;' >> "$W_FILE"
    
    # [gui] è‡ªåŠ¨å®‰è£…æ¡Œé¢ç¯å¢ƒ XFCE4
    echo '  gui)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server' >> "$W_FILE"
    echo '    elif [ "$T" = "arch" ]; then pacman -S --noconfirm xfce4 dbus tigervnc' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi' >> "$W_FILE"
    echo '    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;' >> "$W_FILE"
    
    # [cn] è‡ªåŠ¨å®‰è£…ä¸­æ–‡å­—ä½“
    echo '  cn)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen' >> "$W_FILE"
    echo '    elif [ "$T" = "arch" ]; then pacman -S --noconfirm wqy-zenhei; echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen; locale-gen' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then apk add font-noto-cjk; fi' >> "$W_FILE"
    echo '    echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/cn.sh ;;' >> "$W_FILE"
    
    # [fetch] å®‰è£…ç³»ç»Ÿä¿¡æ¯å±•ç¤º
    echo '  fetch)' >> "$W_FILE"
    echo '    if [ "$T" = "alpine" ]; then apk add fastfetch --repository=https://mirrors.ustc.edu.cn/alpine/edge/testing' >> "$W_FILE"
    echo '    else command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch; fi ;;' >> "$W_FILE"

    echo 'esac' >> "$W_FILE"
    chmod 777 "$W_FILE"
}

# ä»»åŠ¡æ‰§è¡Œæ˜¾ç¤ºæ¡
run_task() {
    tput cup 23 0; echo -ne "${Y}âš™ï¸  $2...${NC}\033[K"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" > "$TMPDIR/log_$3.txt" 2>&1; then
         tput cup 23 0; echo -ne "${G}âœ… $2 å®Œæˆ${NC}\033[K"
    else
         tput cup 23 0; echo -ne "${R}âš ï¸ $2 (è·³è¿‡,è¯¦æƒ…è§tmp/log)${NC}\033[K"
    fi
}

# --- 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å— ---

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

# é€‰æ‹©ç³»ç»Ÿèœå• (å¸¦é˜²å‘†é€»è¾‘)
select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- å·²å®‰è£…çš„ç³»ç»Ÿåˆ—è¡¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then 
        echo -e "\n${R}âŒ ä½ è¿˜æ²¡å®‰è£…ä»»ä½•ç³»ç»Ÿï¼${NC}"
        echo -e "è¯·åœ¨ä¸»èœå•é€‰æ‹© [2] å®‰è£…ç³»ç»Ÿã€‚"; read -n 1 -s; return 1
    fi
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    echo "-------------------------"
    read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " c
    
    # [å°ç™½ä¿æŠ¤] åªèƒ½è¾“å…¥æ•°å­—
    if [[ ! "$c" =~ ^[0-9]+$ ]]; then return 2; fi
    [ "$c" = "0" ] && return 2
    if [ -n "${LIST[$((c-1))]}" ]; then SELECTED="${LIST[$((c-1))]}"; return 0; fi
    return 2
}

# [åŠŸèƒ½1] å®‰è£…ç³»ç»Ÿ (æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ï¼Œå·²åŠ å›º)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== é€‰æ‹©è¦å®‰è£…çš„ç³»ç»Ÿ ===${NC}"
    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    echo -e "${Y}(æ¨èæ–°æ‰‹é€‰æ‹© Ubuntu)${NC}"
    read -p "ğŸ‘‰ è¯·é€‰æ‹©: " idx
    
    if [[ ! "$idx" =~ ^[0-9]+$ ]]; then echo "æ— æ•ˆè¾“å…¥"; sleep 0.5; return; fi
    
    if [ "$idx" != "0" ] && [ -n "${D_NAMES[$((idx-1))]}" ]; then
        TARGET=${D_NAMES[$((idx-1))]}
        if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "${G}è¿™ä¸ªç³»ç»Ÿä½ å·²ç»è£…è¿‡äº†ï¼${NC}"; read -n 1 -s; return; fi
        
        # --- æ ¸å¿ƒé˜²æŠ¤: æ ¹æ²» 32-bit æŠ¥é”™ ---
        echo -e "\n${Y}ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸‹è½½ç¼“å­˜ (é˜²æ­¢ååŒ…)...${NC}"
        proot-distro reset "$TARGET" >/dev/null 2>&1
        rm -rf "$CACHE_DIR" 2>/dev/null
        rm -rf "$PREFIX/var/lib/proot-distro/download" 2>/dev/null
        
        # æ¢å¤å®˜æ–¹æºé…ç½® (é˜²æ­¢ä½¿ç”¨äº†å¤±æ•ˆçš„ä»£ç†æº)
        if [ -f "$PD_CONF/$TARGET.sh" ]; then
            sed -i "s|https://ghproxy.net/||g" "$PD_CONF/$TARGET.sh"
            sed -i "s|https://mirror.ghproxy.com/||g" "$PD_CONF/$TARGET.sh"
        fi

        echo -e "\n${W}ğŸš€ æ­£åœ¨ä»å®˜æ–¹ä¸‹è½½ç³»ç»Ÿ (è¿™å–å†³äºä½ çš„ç½‘é€Ÿ)...${NC}"
        echo -e "${Y}âš ï¸ å¦‚æœæŠ¥é”™ '32-bit' æˆ– 'Format error'ï¼Œç»å¤§å¤šæ•°æ˜¯å› ä¸ºç½‘ç»œä¸­æ–­å¯¼è‡´æ–‡ä»¶æ²¡ä¸‹å®Œã€‚${NC}"
        echo -e "${Y}âš ï¸ è¯·ä¿æŒç½‘ç»œç¨³å®šæˆ–å¼€å¯ VPNã€‚${NC}\n"
        
        if proot-distro install $TARGET; then
            create_worker
            echo ""
            # è‡ªåŠ¨é…ç½®ä¸€æ¡é¾™
            run_task "$TARGET" "æ›´æ¢ä¸ºå›½å†…é•œåƒæº" "src"
            run_task "$TARGET" "å®‰è£…ä¸­æ–‡è¯­è¨€åŒ…" "cn"
            run_task "$TARGET" "å®‰è£…ç³»ç»Ÿä¿¡æ¯ç§€" "fetch"
            echo -e "\n${G}ğŸ‰ æ­å–œï¼ç³»ç»Ÿå®‰è£…æˆåŠŸï¼${NC}"; read -n 1 -s
        else
            echo -e "\n${R}âŒ ä¸‹è½½å¤±è´¥ï¼${NC}"
            echo "åŸå› å¯èƒ½æ˜¯ï¼šç½‘ç»œè¶…æ—¶ã€è¢«å¢™ã€æˆ–å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚"
            echo "è¯·å°è¯•ï¼šå¼€å¯ VPNï¼Œæˆ–è€…æ¢ä¸ªæ—¶é—´å†è¯•ã€‚"
            read -n 1 -s
        fi
    fi
}

# [åŠŸèƒ½2] ç™»å½•ç»ˆç«¯
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    # æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æŸå
    if ! proot-distro login "$SELECTED" -- true >/dev/null 2>&1; then
        echo "${R}âŒ æ— æ³•å¯åŠ¨ï¼šè¯¥å®¹å™¨æ–‡ä»¶ä¼¼ä¹å·²æŸå${NC}"; read -n 1 -s; return
    fi
    
    # ä¸´æ—¶å¯åŠ¨é…ç½®
    RC="$TMPDIR/rc_$$"
    echo "if [ -f /etc/profile.d/cn.sh ]; then . /etc/profile.d/cn.sh; fi; clear; command -v fastfetch >/dev/null && fastfetch; /bin/bash" > "$RC"
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash --rcfile "$RC"
    rm -f "$RC"
}

# [åŠŸèƒ½3] å¯åŠ¨å›¾å½¢ç•Œé¢ (GUI)
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    echo -ne "${Y}ğŸ” æ­£åœ¨æ£€æµ‹æ¡Œé¢ç¯å¢ƒ...${NC}\r"
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        echo ""; 
        echo -e "${C}ç¬¬ä¸€æ¬¡å¯åŠ¨éœ€è¦å®‰è£…æ¡Œé¢ï¼Œè¿™éœ€è¦ä¸‹è½½ 300MB+ æ•°æ®ï¼Œè¯·è€å¿ƒç­‰å¾…...${NC}"
        run_task "$SELECTED" "æ­£åœ¨å®‰è£… XFCE4 æ¡Œé¢ (ç¨å®‰å‹¿èº)" "gui"
    fi

    tput cnorm; stty echo; clear; echo -e "${G}--- å¯åŠ¨æ–¹å¼é€‰æ‹© ---${NC}"
    echo "1. æœ¬åœ°æ¨¡å¼ (æ¨è: éœ€è¦å®‰è£… Termux:X11 APP)"
    echo "2. è¿œç¨‹æ¨¡å¼ (å…¼å®¹: å¼€å¯ VNC ç«¯å£)"
    read -p "ğŸ‘‰ é€‰æ‹©: " m
    
    if [ "$m" == "1" ]; then
        # æ¸…ç†æ®‹ç•™è¿›ç¨‹
        pkill -9 termux-x11 >/dev/null 2>&1; pulseaudio --kill >/dev/null 2>&1; rm -rf $TMPDIR/.X11-unix
        
        # å”¤èµ· APP
        echo -e "${Y}æ­£åœ¨å°è¯•å”¤èµ· Termux:X11 APP...${NC}"
        if ! am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; then
             echo -e "\n${R}âŒ å¤±è´¥ï¼šä½ æ‰‹æœºä¸Šå¥½åƒæ²¡è£… Termux:X11 è¿™ä¸ªAPPã€‚${NC}"
             echo "è¯·å» GitHub æˆ– F-Droid ä¸‹è½½å®‰è£…å®ƒã€‚"; read -n 1 -s; return
        fi
        
        sleep 1
        # å¯åŠ¨éŸ³é¢‘å’Œå›¾å½¢æœåŠ¡
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        # è¿›å…¥å®¹å™¨å¯åŠ¨æ¡Œé¢
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    
    elif [ "$m" == "2" ]; then
        echo -e "${Y}æ­£åœ¨é‡ç½® VNC æœåŠ¡...${NC}"
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo -e "\n${G}âœ… VNC å·²å¼€å¯ï¼${NC}"
        echo -e "åœ°å€: 127.0.0.1:5901"
        echo -e "å¯†ç : 123456"
        echo -e "(å¦‚æœè¦ç”µè„‘è¿æ¥ï¼Œè¯·ç»“åˆä½¿ç”¨ä¸»èœå•çš„ [4] SSH åŠŸèƒ½)"
        read -n 1 -s
    fi
}

# [åŠŸèƒ½4] ç”µè„‘è¿œç¨‹è¿æ¥ (SSH)
do_ssh_remote() {
    tput cnorm; stty echo; clear
    echo -e "${C}=== SSH ç”µè„‘è¿œç¨‹è¿æ¥åŠ©æ‰‹ ===${NC}"
    
    if ! command -v sshd >/dev/null; then
        echo -e "${Y}æ­£åœ¨å®‰è£… OpenSSH Server...${NC}"
        pkg install openssh -y >/dev/null 2>&1
    fi
    
    echo "è®©ä½ å¯ä»¥ç”¨ç”µè„‘çš„ CMD æˆ– PuTTY æ§åˆ¶æ‰‹æœº Termux"
    echo "1. è®¾ç½®è¿æ¥å¯†ç  (å¿…åš)"
    echo "2. å¼€å¯ SSH æœåŠ¡"
    echo "3. å…³é—­ SSH æœåŠ¡"
    echo "0. è¿”å›"
    read -p "é€‰æ‹©: " s
    
    case "$s" in
        1) echo -e "\n${Y}ğŸ‘‡ è¯·è¾“å…¥ä½ è¦è®¾ç½®çš„å¯†ç  (è¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºï¼Œè¾“å®Œå›è½¦):${NC}"; passwd; read -p "å¯†ç å·²è®¾ç½®ã€‚æŒ‰å›è½¦ç»§ç»­..." ;;
        2) 
           pkill sshd; sshd
           IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | awk '{print $2}' | sed 's/addr://' | head -n 1)
           USER=$(whoami)
           echo -e "\n${G}âœ… SSH æœåŠ¡è¿è¡Œä¸­ï¼${NC}"
           echo -e "-----------------------------------------------"
           echo -e "ğŸ’» ç”µè„‘ç«¯è¿æ¥æŒ‡ä»¤: ssh -p 8022 $USER@$IP"
           echo -e "ğŸ”‘ å¯†ç : (ä½ åˆšæ‰è®¾ç½®çš„)"
           echo -e "-----------------------------------------------"
           read -p "æŒ‰å›è½¦è¿”å›..." ;;
        3) pkill sshd; echo -e "${R}SSH æœåŠ¡å·²åœæ­¢${NC}"; read -n 1 -s ;;
    esac
}

do_del() {
    select_sys; [ $? -ne 0 ] && return
    echo -e "${R}âš ï¸  è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤ ${SELECTED} ç³»ç»Ÿé‡Œçš„æ‰€æœ‰æ•°æ®ï¼${NC}"
    read -p "ç¡®å®šè¦åˆ é™¤å—? (è¾“å…¥ y ç¡®è®¤): " k
    if [ "$k" == "y" ]; then 
        proot-distro remove "$SELECTED"
        rm -rf "$ROOTFS_BASE/$SELECTED"
        echo "ğŸ—‘ï¸ å·²å½»åº•åˆ é™¤"; read -n 1 -s
    fi
}

# [åŠŸèƒ½6] æ£€æŸ¥æ›´æ–° (ä¿®å¤ç‰ˆ)
do_update() {
    tput cnorm; stty echo; clear; echo "${C}æ­£åœ¨è”ç½‘æ£€æŸ¥æ›´æ–°...${NC}"
    
    if [ -z "$REMOTE_URL" ]; then
        echo "${R}âŒ æœªé…ç½®æ›´æ–°åœ°å€${NC}"
        echo "æç¤ºï¼šè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°è„šæœ¬ã€‚å¦‚æœä½ æœ‰æ–°çš„è„šæœ¬é“¾æ¥ï¼Œè¯·ç¼–è¾‘æ–‡ä»¶å¡«å…¥ REMOTE_URLã€‚"
        read -n 1 -s; return
    fi

    echo "${Y}æ­£åœ¨ä¸‹è½½...${NC}"
    curl -s -L "$REMOTE_URL" -o "$TMPDIR/u.sh"
    
    # å®‰å…¨æ ¡éªŒï¼šç¡®ä¿ä¸‹è½½çš„æ˜¯ä¸ªè„šæœ¬ï¼Œä¸æ˜¯æŠ¥é”™ç½‘é¡µ
    if head -n 1 "$TMPDIR/u.sh" | grep -q "^#!" || grep -q "MAIN_EOF" "$TMPDIR/u.sh"; then
         mv "$TMPDIR/u.sh" "$PREFIX/bin/xxy"
         chmod 755 "$PREFIX/bin/xxy"
         echo "${G}âœ… æ›´æ–°æˆåŠŸï¼é‡å¯åç”Ÿæ•ˆã€‚${NC}"
         exit 0
    else 
         echo "${R}âŒ æ›´æ–°å¤±è´¥ï¼šä¸‹è½½æ–‡ä»¶æ— æ•ˆã€‚${NC}"
         rm -f "$TMPDIR/u.sh"
    fi
    read -n 1 -s
}

# --- 4. ç•Œé¢ç»˜åˆ¶ (å®æ—¶åˆ·æ–°) ---
draw() {
    clear; echo -e "${C}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"; echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"; echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "; echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "; echo ""
    T=$(date "+%H:%M:%S"); 
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://'); [ -z "$IP" ] && IP="ç¦»çº¿"
    MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    
    # ç•Œé¢å¸ƒå±€
    printf " ${W}ç‰ˆæœ¬:${NC} ${Y}%-7s${NC} | ${W}æ—¶é—´:${NC} ${Y}%s${NC}\n" "$VERSION" "$T"
    printf " ${W}æœ¬åœ°IP:${NC} %-14s ${W}å†…å­˜:${NC} ${B}%s${NC}\n" "$IP" "$MEM"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] ç™»å½•ç³»ç»Ÿ${NC}     ${W}[4] ç”µè„‘è¿œç¨‹è¿æ¥ (SSH)${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] æ£€æŸ¥æ›´æ–°${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

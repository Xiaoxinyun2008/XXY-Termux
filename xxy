# 1. å¼ºåˆ¶æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œé˜²æ­¢ç¼“å­˜å¹²æ‰°
rm -f $PREFIX/bin/xxy
rm -f $PREFIX/tmp/xxy_*

# 2. å†™å…¥æ–°ç‰ˆè„šæœ¬ (ä½¿ç”¨å®‰å…¨å†™å…¥æ¨¡å¼ï¼Œæœç»è¯­æ³•é”™è¯¯)
cat > $PREFIX/bin/xxy << 'INSTALL_EOF'
#!/data/data/com.termux/files/usr/bin/bash
# ==============================================================================
# PROJECT: XXY (Stable Edition v33.0)
# FIX: ä¿®å¤å®¹å™¨è¯†åˆ«é€»è¾‘ã€Workeræ‰§è¡Œæƒé™ã€GUIå¯åŠ¨é“¾
# ==============================================================================

# --- 0. åŸºç¡€ç¯å¢ƒè‡ªæ£€ ---
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# æ•è·å¼‚å¸¸é€€å‡ºï¼Œæ¢å¤ç»ˆç«¯
cleanup() {
    tput cnorm
    stty echo
    rm -f "$WORKER_SCRIPT" "$INJECT_SCRIPT" 2>/dev/null
}
trap cleanup EXIT INT TERM

# æ£€æŸ¥å¿…è¦ä¾èµ–
CHECK_DEPS="proot-distro pulseaudio wget curl ncurses-utils"
for dep in $CHECK_DEPS; do
    if ! command -v $dep &>/dev/null; then
        echo "æ­£åœ¨å®‰è£…ç¼ºå¤±ä¾èµ–: $dep ..."
        pkg update -y && pkg install $CHECK_DEPS -y
        break
    fi
done

# å®šä¹‰å†…éƒ¨è„šæœ¬è·¯å¾„
WORKER_SCRIPT="$TMPDIR/xxy_worker_$$.sh"
INJECT_SCRIPT="$TMPDIR/xxy_inject_$$.sh"

# --- ğŸ¨ é¢œè‰²å¸¸é‡ ---
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); P=$(tput setaf 5); C=$(tput setaf 6)
W=$(tput setaf 7); GR=$(tput setaf 8); NC=$(tput sgr0)

# --- ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

# 1. ç”Ÿæˆå®¹å™¨å†…éƒ¨æ‰§è¡Œçš„ Worker è„šæœ¬
# (ä½¿ç”¨å‡½æ•°å†™å…¥ï¼Œé¿å… EOF åµŒå¥—å¯¼è‡´çš„å˜é‡æ‰©å±•é”™è¯¯)
create_worker_script() {
    rm -f "$WORKER_SCRIPT"
    touch "$WORKER_SCRIPT"
    
    # é€è¡Œå†™å…¥ï¼Œç¡®ä¿ $1 ç­‰å˜é‡åœ¨å®¹å™¨å†…æ‰è¢«è§£æ
    echo '#!/bin/sh' >> "$WORKER_SCRIPT"
    echo 'action=$1' >> "$WORKER_SCRIPT"
    
    # æ™ºèƒ½è¯†åˆ«åŒ…ç®¡ç†å™¨
    echo 'if command -v apt >/dev/null; then' >> "$WORKER_SCRIPT"
    echo '    INSTALL="apt install -y"; UPDATE="apt update -y"' >> "$WORKER_SCRIPT"
    echo '    is_debian=true' >> "$WORKER_SCRIPT"
    echo 'elif command -v pacman >/dev/null; then' >> "$WORKER_SCRIPT"
    echo '    INSTALL="pacman -S --noconfirm"; UPDATE="pacman -Sy --noconfirm"' >> "$WORKER_SCRIPT"
    echo 'elif command -v apk >/dev/null; then' >> "$WORKER_SCRIPT"
    echo '    INSTALL="apk add"; UPDATE="apk update"' >> "$WORKER_SCRIPT"
    echo 'else echo "Unknown PM"; exit 1; fi' >> "$WORKER_SCRIPT"
    
    # ä»»åŠ¡åˆ†å‘
    echo 'case "$action" in' >> "$WORKER_SCRIPT"
    echo '  update) $UPDATE ;;' >> "$WORKER_SCRIPT"
    
    echo '  install_gui)' >> "$WORKER_SCRIPT"
    echo '    if [ "$is_debian" = true ]; then' >> "$WORKER_SCRIPT"
    echo '      DEBIAN_FRONTEND=noninteractive $INSTALL xfce4 xfce4-goodies dbus-x11' >> "$WORKER_SCRIPT"
    echo '    else' >> "$WORKER_SCRIPT"
    echo '      $INSTALL xfce4 dbus-x11' >> "$WORKER_SCRIPT"
    echo '    fi ;;' >> "$WORKER_SCRIPT"
    
    echo '  install_cn)' >> "$WORKER_SCRIPT"
    echo '    if [ "$is_debian" = true ]; then' >> "$WORKER_SCRIPT"
    echo '      DEBIAN_FRONTEND=noninteractive $INSTALL locales fonts-noto-cjk ttf-wqy-zenhei' >> "$WORKER_SCRIPT"
    echo '      echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen && locale-gen' >> "$WORKER_SCRIPT"
    echo '    elif command -v pacman >/dev/null; then' >> "$WORKER_SCRIPT"
    echo '      $INSTALL adobe-source-han-sans-cn-fonts' >> "$WORKER_SCRIPT"
    echo '      echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen && locale-gen' >> "$WORKER_SCRIPT"
    echo '    elif command -v apk >/dev/null; then' >> "$WORKER_SCRIPT"
    echo '      $INSTALL font-noto-cjk' >> "$WORKER_SCRIPT"
    echo '    fi' >> "$WORKER_SCRIPT"
    echo '    echo "export LANG=zh_CN.UTF-8" >> /etc/profile ;;' >> "$WORKER_SCRIPT"
    
    echo '  install_fetch)' >> "$WORKER_SCRIPT"
    echo '    $INSTALL fastfetch || $INSTALL neofetch' >> "$WORKER_SCRIPT"
    echo '    if command -v fastfetch >/dev/null; then echo "fastfetch" > /tmp/fetch_bin' >> "$WORKER_SCRIPT"
    echo '    elif command -v neofetch >/dev/null; then echo "neofetch" > /tmp/fetch_bin' >> "$WORKER_SCRIPT"
    echo '    else echo "none" > /tmp/fetch_bin; fi ;;' >> "$WORKER_SCRIPT"
    
    echo 'esac' >> "$WORKER_SCRIPT"
    
    chmod 755 "$WORKER_SCRIPT"
}

# 2. ç²¾ç¡®è·å–å·²å®‰è£…ç³»ç»Ÿ (æ’é™¤æ–‡ä»¶å¹²æ‰°)
get_systems() {
    # ä½¿ç”¨ proot-distro å®˜æ–¹ç›®å½•ç»“æ„åˆ¤æ–­
    ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs"
    if [ -d "$ROOTFS" ]; then
        # ä»…åˆ—å‡ºç›®å½•ï¼Œè¿‡æ»¤æ‰éæ–‡ä»¶å¤¹å†…å®¹
        find "$ROOTFS" -maxdepth 1 -mindepth 1 -type d -exec basename {} \;
    fi
}

# 3. åå°æ‰§è¡Œä»»åŠ¡
run_task() {
    local sys=$1
    local cmd=$2
    local text=$3
    
    tput cup 18 0
    echo -ne "${Y}âš™ï¸  æ­£åœ¨$text ($sys)... è¯·ç¨å€™${NC}"
    
    # ç™»å½•å®¹å™¨å¹¶æ‰§è¡Œ Worker è„šæœ¬
    proot-distro login "$sys" --shared-tmp -- /bin/sh "$WORKER_SCRIPT" "$cmd" >/dev/null 2>&1
    
    tput cup 18 0
    if [ $? -eq 0 ]; then
        echo -ne "${G}âœ… $sys $text æˆåŠŸ               ${NC}"
    else
        echo -ne "${R}âŒ $sys $text å¤±è´¥               ${NC}"
    fi
}

# 4. ç³»ç»Ÿé€‰æ‹©å™¨ (äº¤äº’é€»è¾‘ä¿®å¤)
select_menu() {
    # å°†å‡½æ•°è¾“å‡ºè½¬æ¢ä¸ºæ•°ç»„
    mapfile -t SYS_ARRAY < <(get_systems)
    
    if [ ${#SYS_ARRAY[@]} -eq 0 ]; then
        echo -e "\n${R}âš ï¸ æœªæ£€æµ‹åˆ°å·²å®‰è£…çš„ç³»ç»Ÿï¼${NC}"
        echo "è¯·å…ˆé€‰æ‹© [2] å®‰è£…æ–°ç³»ç»Ÿ"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
        return 1
    fi

    # æ‰“å°åˆ—è¡¨
    for i in "${!SYS_ARRAY[@]}"; do
        echo -e "${G}$((i+1)).${NC} ${SYS_ARRAY[$i]}"
    done
    echo -e "${W}0.${NC} è¿”å›ä¸»èœå•"
    
    # è·å–è¾“å…¥
    tput cnorm; stty echo
    read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " choice
    stty -echo; tput civis
    
    # éªŒè¯è¾“å…¥
    if [ "$choice" == "0" ] || [ -z "$choice" ]; then return 1; fi
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#SYS_ARRAY[@]}" ]; then
        # è¿”å›é€‰ä¸­çš„ç³»ç»Ÿåç§°
        echo "${SYS_ARRAY[$((choice-1))]}"
        return 0
    else
        echo "è¾“å…¥æ— æ•ˆ"; return 1
    fi
}

# --- ğŸ“¦ åŠŸèƒ½æ¨¡å—å®ç° ---

# [åŠŸèƒ½1] ç™»å½•
do_login() {
    clear; echo -e "${C}=== ç™»å½•ç³»ç»Ÿ ===${NC}"
    TARGET=$(select_menu) || return
    
    # è‡ªåŠ¨æ³¨å…¥ç¾åŒ–
    create_worker_script
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$WORKER_SCRIPT" "install_fetch" >/dev/null 2>&1
    
    # æ³¨å…¥ .bashrc (ä¸è¦†ç›–ç”¨æˆ·é…ç½®)
    cat > "$INJECT_SCRIPT" << 'EOF'
RC=~/.bashrc
if [ -f /tmp/fetch_bin ]; then
    TOOL=$(cat /tmp/fetch_bin)
    rm -f /tmp/fetch_bin
    if [ "$TOOL" != "none" ]; then
        # å¦‚æœ bashrc é‡Œæ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œåˆ™è¿½åŠ 
        if ! grep -q "$TOOL" "$RC" 2>/dev/null; then
            echo "" >> "$RC"
            echo "$TOOL" >> "$RC"
        fi
    fi
fi
EOF
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$INJECT_SCRIPT" >/dev/null 2>&1
    
    # æ­£å¼ç™»å½•
    cleanup
    proot-distro login "$TARGET"
    
    # é€€å‡ºåæ¢å¤ UI
    tput civis; stty -echo; draw_ui
}

# [åŠŸèƒ½2] å®‰è£…
do_install() {
    clear; echo -e "${C}=== å®‰è£…æ–°ç³»ç»Ÿ ===${NC}"
    DISTROS=("ubuntu" "debian" "kali" "archlinux" "alpine")
    for i in "${!DISTROS[@]}"; do echo -e "${W}$((i+1)).${NC} ${DISTROS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    
    tput cnorm; stty echo
    read -p "ğŸ‘‰ é€‰æ‹©å‘è¡Œç‰ˆ: " idx
    stty -echo; tput civis
    
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#DISTROS[@]}" ]; then
        TARGET=${DISTROS[$((idx-1))]}
        
        if [ -d "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET" ]; then
            echo -e "${R}ç³»ç»Ÿå·²å­˜åœ¨ï¼${NC}"; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."; return
        fi
        
        echo -e "\næ­£åœ¨ä¸‹è½½å¹¶å®‰è£… $TARGET..."
        tput cnorm
        if proot-distro install $TARGET; then
            tput civis
            create_worker_script
            run_task "$TARGET" "update" "æ›´æ–°è½¯ä»¶æº"
            run_task "$TARGET" "install_cn" "é…ç½®ä¸­æ–‡ç¯å¢ƒ"
            echo -e "\n${G}å®‰è£…å®Œæˆï¼${NC}"; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
        else
            echo -e "\n${R}å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚${NC}"; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
        fi
    fi
}

# [åŠŸèƒ½3] GUI æ¡Œé¢ (æ ¸å¿ƒä¿®å¤)
do_gui() {
    clear; echo -e "${C}=== å¯åŠ¨æ¡Œé¢ç¯å¢ƒ ===${NC}"
    TARGET=$(select_menu) || return
    
    create_worker_script
    
    # 1. æ£€æŸ¥æ˜¯å¦å®‰è£…äº†æ¡Œé¢
    echo "æ­£åœ¨æ£€æŸ¥æ¡Œé¢ç¯å¢ƒ..."
    if ! proot-distro login "$TARGET" -- bash -c "command -v startxfce4" >/dev/null 2>&1; then
        run_task "$TARGET" "install_gui" "å®‰è£… XFCE4 æ¡Œé¢ (è€—æ—¶è¾ƒé•¿)"
    fi

    echo -e "\n${G}è¯·é€‰æ‹©å¯åŠ¨æ¨¡å¼:${NC}"
    echo -e "1. Termux:X11 (ç¡¬ä»¶åŠ é€Ÿ/æµç•…/æ¨è)"
    echo -e "2. VNC Viewer (å…¼å®¹æ€§å¥½/é€šç”¨)"
    echo -e "0. è¿”å›"
    
    tput cnorm; stty echo
    read -p "æ¨¡å¼: " m
    stty -echo; tput civis
    
    CMD_XFCE="export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    
    if [ "$m" == "1" ]; then
        # æ¸…ç†ç¯å¢ƒ
        pulseaudio --kill >/dev/null 2>&1
        pkill -f com.termux.x11 >/dev/null 2>&1
        rm -rf "$TMPDIR/.X11-unix"
        
        # å¯åŠ¨æœåŠ¡
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        # å¯åŠ¨ Termux:X11 APP
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
        termux-x11 :0 >/dev/null 2>&1 &
        
        echo "æ­£åœ¨å¯åŠ¨ XFCE4..."
        proot-distro login "$TARGET" --shared-tmp -- bash -c "$CMD_XFCE"
        
    elif [ "$m" == "2" ]; then
        # VNC æ¨¡å¼
        echo "æ­£åœ¨å¯åŠ¨ VNC Server..."
        proot-distro login "$TARGET" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X1-lock; vncserver :1"
        echo -e "\n${G}VNC å·²å¯åŠ¨! åœ°å€: 127.0.0.1:5901${NC}"
        echo "å¯†ç é»˜è®¤ä¸ºç©ºæˆ–éœ€è¦åœ¨é¦–æ¬¡è¿è¡Œæ—¶è®¾ç½®"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# [åŠŸèƒ½4] å¸è½½
do_uninstall() {
    clear; echo -e "${R}=== å¸è½½ç®¡ç† ===${NC}"
    TARGET=$(select_menu) || return
    
    tput cnorm; stty echo
    read -p "âš ï¸ ç¡®è®¤å½»åº•åˆ é™¤ $TARGET ? (y/n): " confirm
    stty -echo; tput civis
    
    if [[ "$confirm" == "y" ]]; then
        proot-distro remove $TARGET
        # å¼ºåˆ¶æ·±åº¦æ¸…ç†
        rm -rf "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET"
        echo -e "\n${G}å·²æˆåŠŸåˆ é™¤ã€‚${NC}"
        read -n 1 -s -r -p "..."
    fi
}

# --- UI ç»˜åˆ¶å¾ªç¯ ---

update_status() {
    NOW=$(date "+%H:%M")
    # ä¼˜åŒ–ï¼šæ¯ 50 å¸§æ£€æŸ¥ä¸€æ¬¡å†…å­˜ï¼Œé¿å…å¡é¡¿
    if (( FRAME % 50 == 0 )); then
        MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    fi
    tput cup 0 34; printf "${B}â•­â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 1 34; printf "${B}â”‚${NC} TIME: ${W}%-5s${NC} MEM: ${P}%-5s${NC}         ${B}â”‚${NC}" "$NOW" "$MEM"
    tput cup 2 34; printf "${B}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
}

draw_ui() {
    clear
    printf "${C}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— ${W}XXY ç¨³å®šç‰ˆ${NC}\n"
    printf "${C}â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• ${GR}v33.0 | Stable${NC}\n"
    printf "${C} â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  ${NC}\n"
    printf "${C} â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•   ${NC}\n"
    
    tput cup 8 0
    printf "${GR}â•­â”€â”€ [ å¸¸ç”¨åŠŸèƒ½ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€ [ ç®¡ç†åŠŸèƒ½ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}\n"
    printf "${GR}â”‚${NC} ${W}1.${NC} ç™»å½•ç³»ç»Ÿ (Login)          ${GR}â”‚ â”‚${NC} ${W}4.${NC} å¸è½½ç³»ç»Ÿ (Uninstall)    ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}2.${NC} å®‰è£…ç³»ç»Ÿ (Install)        ${GR}â”‚ â”‚${NC} ${W}0.${NC} é€€å‡ºç¨‹åº (Exit)         ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}3.${NC} å¯åŠ¨æ¡Œé¢ (GUI Mode)       ${GR}â”‚ â”‚${NC}                                 ${GR}â”‚${NC}\n"
    printf "${GR}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}\n"
}

# --- ä¸»ç¨‹åºå…¥å£ ---
create_worker_script # åˆå§‹åŒ– Worker
tput civis           # éšè—å…‰æ ‡
stty -echo           # å…³é—­å›æ˜¾
draw_ui

INPUT_BUF=""
FRAME=0
COLORS=($R $Y $G $C $B $P)
MEM="Wait"

while true; do
    update_status
    ((FRAME++))
    C_IDX=$((FRAME % 6)); CUR_C=${COLORS[$C_IDX]}
    
    tput cup 14 0; printf "${CUR_C}â•­â”€â”€ è¯·è¾“å…¥åºå· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 15 0; printf "${CUR_C}â”‚${NC} ${C}â¤${NC} %-40s           ${CUR_C}â”‚${NC}" "$INPUT_BUF${W}â–ˆ${NC}"
    tput cup 16 0; printf "${CUR_C}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"

    # æé€Ÿå“åº”è¾“å…¥
    read -t 0.05 -n 1 key
    if [[ $? -eq 0 ]]; then
        if [[ -z "$key" ]]; then
            # å›è½¦é”®å¤„ç†
            if [[ -n "$INPUT_BUF" ]]; then
                case $INPUT_BUF in
                    1) do_login ;;
                    2) do_install ;;
                    3) do_gui ;;
                    4) do_uninstall ;;
                    0) exit 0 ;;
                esac
                # ä»»åŠ¡ç»“æŸåé‡ç½® UI
                tput civis; stty -echo; draw_ui; INPUT_BUF=""
            fi
        elif [[ "$key" == $'\x7f' || "$key" == $'\b' ]]; then
            # é€€æ ¼é”®ä¿®å¤
            INPUT_BUF="${INPUT_BUF%?}"
        elif [[ "$key" == $'\e' ]]; then
            # å¿½ç•¥ç‰¹æ®Šé”® (é˜²æ­¢ä¹±ç )
            read -t 0.01 -n 2
        else
            # è¿½åŠ è¾“å…¥
            INPUT_BUF="$INPUT_BUF$key"
        fi
    fi
done
INSTALL_EOF

# 3. èµ‹äºˆæƒé™å¹¶è‡ªåŠ¨ä¿®å¤æ ¼å¼
chmod 755 $PREFIX/bin/xxy
sed -i 's/\r$//' $PREFIX/bin/xxy

echo -e "\033[1;32mâœ… XXY v33.0 æ›´æ–°å®Œæˆï¼\nå·²ä¿®å¤å®¹å™¨æŸ¥æ‰¾å’Œ GUI å¯åŠ¨é—®é¢˜ã€‚\nè¾“å…¥ xxy å³å¯å¯åŠ¨ã€‚\033[0m"

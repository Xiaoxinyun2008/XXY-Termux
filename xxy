# ==============================================================================
# ğŸŒŒ XXY v400.0 Singularity (å¥‡ç‚¹Â·å…¨çŸ¥å…¨èƒ½ç‰ˆ)
# SYSTEM: Enterprise Linux Container Manager for Termux
# MODULES: SSH-Audit | X11-Tunneling | Process-Watchdog | Auto-Heal
# LINES: Logic equivalent to 800+ lines of standard shell script
# ==============================================================================

# --- [Phase 0: æ·±åº¦æ ¼å¼åŒ–] ---
# å½»åº•æ¸…ç†æ—§æ—¶ä»£çš„æ®‹ç•™ï¼Œç¡®ä¿æ–°ç³»ç»Ÿåœ¨çº¯å‡€åœŸå£¤ä¸Šè¿è¡Œ
tput cnorm
echo -e "\033[1;34m[SYSTEM] Initializing Singularity Core v400.0...\033[0m"

# 1. å¼ºåŠ›æ¸…ç†é€»è¾‘
pkill -9 sshd 2>/dev/null
pkill -9 termux-x11 2>/dev/null
pkill -9 pulseaudio 2>/dev/null
pkill -9 virgl_test_server 2>/dev/null
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*
# 2. é¢„åˆ¶ç›®å½•ç»“æ„
mkdir -p $PREFIX/tmp
mkdir -p $PREFIX/var/log/xxy_audit
# 3. æ¸…ç†æ½œåœ¨çš„ååŒ…
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download

# --- [Phase 1: æ³¨å…¥æ ¸å¿ƒä»£ç ] ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ—ï¸ CONFIGURATION & CONSTANTS
# ==============================================================================
export VERSION="v400.0 å¥‡ç‚¹"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export SSH_LOG="$PREFIX/var/log/xxy_audit/ssh_events.log"
export RUN_LOG="$TMPDIR/xxy_runtime.log"
export LANG="C.UTF-8"

# é«˜çº§é¢œè‰²åº“
R=$(tput setaf 196); G=$(tput setaf 46); Y=$(tput setaf 226)
B=$(tput setaf 39);  P=$(tput setaf 201); C=$(tput setaf 51)
W=$(tput setaf 255); GR=$(tput setaf 240); OR=$(tput setaf 208)
NC=$(tput sgr0)

# å¼‚å¸¸æ•è·ä¸èµ„æºé‡Šæ”¾
trap 'tput cnorm; stty echo; echo -e "\n${P}ğŸ›‘ [SYSTEM] Process Terminated Safely.${NC}"; exit' EXIT INT TERM

# ==============================================================================
# ğŸ› ï¸ SYSTEM KERNEL (æ ¸å¿ƒå·¥å…·åº“)
# ==============================================================================

# [K1] å®¡è®¡æ—¥å¿—è®°å½•å™¨
audit_log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [XXY-AUDIT] $1" >> "$SSH_LOG"
}

# [K2] è¾“å…¥ç†”æ–­å™¨ (å…¨é€»è¾‘æ­»é”)
# å‚æ•°1: æç¤ºè¯­, å‚æ•°2: åˆæ³•å­—ç¬¦é›†
ask_locked() {
    local prompt="$1"
    local valid_chars="$2"
    while true; do
        read -p "$prompt" input
        # 1. ç©ºæ£€æµ‹
        if [ -z "$input" ]; then
            echo "${R}ğŸš« è¾“å…¥ä¸ºç©ºï¼Œè¯·é‡è¯•ã€‚${NC}"; continue
        fi
        # 2. é•¿åº¦æ£€æµ‹
        if [ ${#input} -gt 1 ]; then
            echo "${R}ğŸš« è¾“å…¥è¿‡é•¿ï¼Œè¯·è¾“å…¥å•ä¸ªæ•°å­—ã€‚${NC}"; continue
        fi
        # 3. åˆæ³•æ€§æ£€æµ‹
        if [[ "$valid_chars" == *"$input"* ]]; then
            RET="$input"
            break
        else
            echo "${R}ğŸš« éæ³•æŒ‡ä»¤ [$input]ã€‚å…è®¸èŒƒå›´: [${valid_chars}]${NC}"
        fi
    done
}

# [K3] ç½‘ç»œå…¨é“¾è·¯è¯Šæ–­
check_net_matrix() {
    echo -ne "${Y}ğŸ“¡ [NET] æ­£åœ¨æ‰«æå…¨çƒç½‘ç»œèŠ‚ç‚¹... ${NC}"
    local score=0
    # èŠ‚ç‚¹A: é˜¿é‡Œäº‘ (å›½å†…)
    if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1; then score=$((score+1)); fi
    # èŠ‚ç‚¹B: è…¾è®¯äº‘ (å›½å†…)
    if ping -c 1 -W 1 119.29.29.29 >/dev/null 2>&1; then score=$((score+1)); fi
    # èŠ‚ç‚¹C: Google (å›½å¤–)
    if ping -c 1 -W 1 8.8.8.8 >/dev/null 2>&1; then score=$((score+2)); fi
    
    if [ $score -eq 0 ]; then
        echo "${R}âŒ [å…¨æ–­]${NC}"; return 1
    elif [ $score -lt 2 ]; then
        echo "${Y}âš ï¸ [æ³¢åŠ¨]${NC}"; return 0
    else
        echo "${G}âœ… [æä½³]${NC}"; return 0
    fi
}

# [K4] ä¾èµ–è‡ªæ„ˆç³»ç»Ÿ (Auto-Heal)
check_deps_integrity() {
    local needed="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools procps"
    local missing=""
    
    # æ£€æµ‹ dpkg é”
    if [ -f "$PREFIX/var/lib/dpkg/lock-frontend" ]; then
        rm -f $PREFIX/var/lib/dpkg/lock*
        dpkg --configure -a >/dev/null 2>&1
    fi
    
    for pkg in $needed; do
        if ! command -v $pkg >/dev/null; then missing="$missing $pkg"; fi
    done
    
    if [ -n "$missing" ]; then
        echo -e "${C}ğŸ“¦ [AUTO-HEAL] æ£€æµ‹åˆ°ç»„ä»¶ç¼ºå¤±ï¼Œæ­£åœ¨æ‰§è¡Œçƒ­è¡¥ä¸...${NC}"
        if ! check_net_matrix; then echo "${R}âŒ æ— æ³•ä¿®å¤ï¼šæ— ç½‘ç»œã€‚${NC}"; exit 1; fi
        pkg install $missing -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
    
    # X11 ç‹¬ç«‹æ£€æµ‹
    if ! command -v termux-x11 &>/dev/null; then
        pkg install x11-repo -y >/dev/null 2>&1
        pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# ==============================================================================
# ğŸ§  WORKER BRAIN (å®¹å™¨å†…éƒ¨é€»è¾‘)
# ==============================================================================
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    # è¿™æ˜¯ä¸€ä¸ªå¾®å‹çš„ Shell è„šæœ¬ï¼Œæ³¨å…¥åˆ°å®¹å™¨å†…éƒ¨æ‰§è¡Œ
    cat >> "$W_FILE" << 'EOF'
#!/bin/sh
set -e
export PATH=$PATH:/usr/bin:/bin
act=$1

# è‡ªåŠ¨æ¢æµ‹å‘è¡Œç‰ˆ
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src) # æ™ºèƒ½æ¢æº
    if [ "$T" = "debian" ]; then 
        if ! grep -q "tsinghua" /etc/apt/sources.list; then
             grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list
             apt update -y
        fi
    elif [ "$T" = "alpine" ]; then 
        sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update
    fi ;;
  
  gui) # æ¡Œé¢ç¯å¢ƒ
    if [ "$T" = "debian" ]; then 
        apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then 
        apk add xfce4 dbus-x11 tigervnc
    fi
    # å¼ºåˆ¶é‡ç½®VNCå¯†ç 
    mkdir -p ~/.vnc
    echo "123456" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd ;;
    
  clean) # æ·±åº¦æ¸…æ´—
    # ç§»é™¤æ‰€æœ‰å¯èƒ½çš„é‡å¤é…ç½®
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    sed -i '/neofetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    sed -i '/PULSE/d' ~/.bashrc 2>/dev/null ;;
    
  cn) # æ±‰åŒ–
    if [ "$T" = "debian" ]; then 
        apt install -y locales fonts-noto-cjk
        echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen
        locale-gen
    fi ;;
    
  fetch) # ç¾åŒ–
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$W_FILE"
}

run_task() {
    tput sc; tput cup 14 0; echo -ne "\033[J${Y}â³ [Processing] $2...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" >> "$RUN_LOG" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… [OK] $2${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ [Warn] $2 (è¯¦è§æ—¥å¿—)${NC}"
    fi
    tput rc; sleep 0.3
}

# ==============================================================================
# ğŸ® CONTROLLER (ä¸šåŠ¡é€»è¾‘)
# ==============================================================================

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- ç³»ç»Ÿé€‰æ‹©å™¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then echo -e "\n${R}ğŸš« æœ¬åœ°æ— ç³»ç»Ÿã€‚è¯·å…ˆæ‰§è¡Œ [2] å®‰è£…ã€‚${NC}"; read -n 1 -s; return 1; fi
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    
    local valid="0"
    for i in "${!LIST[@]}"; do valid="${valid}$((i+1))"; done
    echo "-------------------------"
    ask_locked "ğŸ‘‰ è¯·è¾“å…¥åºå·: " "$valid"
    
    [ "$RET" = "0" ] && return 2
    SELECTED="${LIST[$((RET-1))]}"
    return 0
}

# [1] ç™»å½• (æ·±åº¦æ¸…æ´—ç‰ˆ)
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    # å°¸æ£€
    if [ ! -d "$ROOTFS_BASE/$SELECTED/bin" ]; then
        echo -e "\n${R}âŒ é”™è¯¯ï¼šç³»ç»Ÿæ–‡ä»¶æŸåã€‚${NC}"; echo "è¯·åˆ é™¤åé‡è£…ã€‚"; read -n 1 -s; return
    fi
    
    # è‡ªåŠ¨æ¸…æ´—é…ç½®æ–‡ä»¶
    run_task "$SELECTED" "é…ç½®å‡€åŒ–" "clean"
    
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# [2] å®‰è£… (ç†”æ–­ä¿æŠ¤ç‰ˆ)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== æ³°å¦å®‰è£…å‘å¯¼ ===${NC}"
    
    local free=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free" -lt 2000 ]; then echo "${R}âŒ ç©ºé—´ä¸è¶³ 2GBï¼Œæ— æ³•å®‰è£…ã€‚${NC}"; read -n 1 -s; return; fi
    if ! check_net_matrix; then echo "${R}âŒ ç½‘ç»œä¸é€šï¼Œæ— æ³•å®‰è£…ã€‚${NC}"; read -n 1 -s; return; fi
    
    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    
    ask_locked "ğŸ‘‰ é€‰æ‹©ç³»ç»Ÿ (æ¨è1): " "01234"
    [ "$RET" = "0" ] && return
    
    TARGET=${D_NAMES[$((RET-1))]}
    if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "${G}å·²å­˜åœ¨ã€‚${NC}"; read -n 1 -s; return; fi
    
    echo -e "\n${Y}ğŸ§¹ æ­£åœ¨æ¸…ç†ç¼“å­˜...${NC}"
    proot-distro reset "$TARGET" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    
    echo -e "${W}ğŸš€ æ­£åœ¨ä¸‹è½½ (è¿™å–å†³äºä½ çš„ç½‘é€Ÿ)...${NC}"
    if proot-distro install $TARGET; then
        if [ ! -f "$ROOTFS_BASE/$TARGET/etc/os-release" ]; then
             echo -e "\n${R}âŒ æ ¡éªŒå¤±è´¥ï¼šä¸‹è½½ä¸å®Œæ•´ã€‚${NC}"; proot-distro remove "$TARGET"; read -n 1 -s; return
        fi
        create_worker
        run_task "$TARGET" "æºåŠ é€Ÿ" "src"
        run_task "$TARGET" "æ±‰åŒ–" "cn"
        run_task "$TARGET" "ç¾åŒ–" "fetch"
        echo -e "\n${G}ğŸ‰ å®‰è£…æˆåŠŸã€‚${NC}"; read -n 1 -s
    else
        echo -e "\n${R}âŒ ä¸‹è½½å¤±è´¥ã€‚è¯·å¼€ VPNã€‚${NC}"; read -n 1 -s
    fi
}

# [3] æ¡Œé¢ (å›¾å½¢åŒ–)
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        echo -e "${Y}æ­£åœ¨è‡ªåŠ¨éƒ¨ç½²æ¡Œé¢...${NC}"
        run_task "$SELECTED" "å®‰è£…æ¡Œé¢" "gui"
    fi
    
    clear; echo -e "${G}1. æœ¬åœ°æ˜¾ç¤º (Termux:X11 APP)${NC}"; echo "2. å¼€å¯ VNC æœåŠ¡"
    ask_locked "ğŸ‘‰ é€‰æ‹©: " "12"
    
    if [ "$RET" == "1" ]; then
        if ! pm list packages | grep -q "com.termux.x11"; then echo "${R}âŒ ç¼ºå°‘ Termux:X11 APP${NC}"; read -n 1 -s; return; fi
        pkill -9 termux-x11 >/dev/null 2>&1
        rm -rf $TMPDIR/.X11-unix
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$RET" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

# [4] SSH é¹°çœ¼ç³»ç»Ÿ (æ ¸å¿ƒæ›´æ–°)
do_ssh_manager() {
    while true; do
        tput cnorm; stty echo; clear
        echo -e "${C}=== SSH é¹°çœ¼ç®¡æ§ä¸­å¿ƒ ===${NC}"
        
        # çŠ¶æ€æ£€æµ‹
        if pgrep sshd >/dev/null; then
            STATUS="${G}â— è¿è¡Œä¸­${NC}"
        else
            STATUS="${R}â— å·²åœæ­¢${NC}"
        fi
        
        # è·å–æœ¬æœºä¿¡æ¯
        USER=$(whoami)
        IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
        
        echo -e "æœåŠ¡çŠ¶æ€: $STATUS   æœ¬æœºIP: ${W}$IP${NC}"
        echo -e "----------------------------------------"
        echo -e "1. å¼€å¯/é‡å¯æœåŠ¡ (Start)"
        echo -e "2. å…³é—­æœåŠ¡ (Stop)"
        echo -e "3. ç›‘æ§è¿æ¥ & è¸¢äºº (Monitor & Kick)"
        echo -e "4. ${Y}ç”µè„‘è¿œç¨‹æ¡Œé¢å‘å¯¼ (Tunneling)${NC}"
        echo -e "0. è¿”å›"
        echo -e "----------------------------------------"
        
        # å®æ—¶è¿æ¥æ•°
        CONN=$(netstat -tn | grep ':8022' | grep 'ESTABLISHED' | wc -l)
        echo -e "å½“å‰æ´»è·ƒè¿æ¥æ•°: ${B}$CONN${NC}"
        echo -e "----------------------------------------"
        
        ask_locked "ğŸ‘‰ è¯·é€‰æ‹©: " "01234"
        
        case "$RET" in
            0) return ;;
            
            1) # å¼€å¯
                if ! grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null; then
                    echo -e "${Y}âš ï¸ è¯·å…ˆè®¾ç½®å¯†ç :${NC}"; passwd
                fi
                pkill sshd; sshd
                echo -e "\n${G}âœ… SSH å·²å¯åŠ¨ã€‚${NC}"
                echo "ç”µè„‘è¿æ¥å‘½ä»¤: ssh -p 8022 $USER@$IP"
                audit_log "SSH Server Started"
                read -n 1 -s ;;
                
            2) # å…³é—­
                pkill sshd
                echo -e "${R}SSH å·²åœæ­¢ã€‚${NC}"; audit_log "SSH Server Stopped"; read -n 1 -s ;;
                
            3) # ç›‘æ§ä¸è¸¢äºº
                clear
                echo -e "${C}=== åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ ===${NC}"
                # ä½¿ç”¨ netstat å’Œ ps æ¨¡æ‹Ÿ who çš„åŠŸèƒ½ (Termuxä¸‹whoå¯èƒ½ä¸å‡†)
                echo -e "PID\t\tçŠ¶æ€\t\tæ¥æºIP"
                # è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç›‘æ§å®ç°
                netstat -tn | grep ':8022' | grep 'ESTABLISHED' | awk '{print $7 " " $6 " " $5}'
                echo -e "--------------------------------"
                echo -e "1. åˆ·æ–°"
                echo -e "2. è¸¢å‡ºæ‰€æœ‰è¿æ¥ (Kill All)"
                echo -e "0. è¿”å›"
                ask_locked "ğŸ‘‰ æ“ä½œ: " "012"
                if [ "$RET" == "2" ]; then
                    # æ€æ‰æ‰€æœ‰ sshd çš„å­è¿›ç¨‹ (é™¤äº†ä¸»è¿›ç¨‹)
                    pgrep sshd | grep -v $(pgrep -o sshd) | xargs kill -9 2>/dev/null
                    echo -e "${R}å·²è¸¢å‡ºæ‰€æœ‰ç”¨æˆ·ã€‚${NC}"
                    audit_log "Kicked all users"
                    read -n 1 -s
                fi ;;
                
            4) # éš§é“å‘å¯¼ (æŠŠSSHå˜è¿œç¨‹æ¡Œé¢)
                clear
                echo -e "${C}=== Windows è¿œç¨‹æ¡Œé¢ (Tunneling) ===${NC}"
                echo -e "${Y}åŸç†ï¼šé€šè¿‡ SSH åŠ å¯†éš§é“ï¼ŒæŠŠæ‰‹æœºçš„ VNC ç”»é¢ä¼ ç»™ç”µè„‘ã€‚${NC}"
                echo -e "è¿™æ¯”ç›´æ¥è¿ VNC æ›´å®‰å…¨ï¼Œä¸”ä¸éœ€è¦å…¬ç½‘IP (å±€åŸŸç½‘å†…)ã€‚"
                echo -e ""
                echo -e "æ­¥éª¤ 1: åœ¨æ‰‹æœºä¸Šå¯åŠ¨ç³»ç»Ÿï¼Œå¹¶é€‰ [3] -> [2] å¼€å¯ VNC æœåŠ¡ã€‚"
                echo -e "æ­¥éª¤ 2: åœ¨ç”µè„‘ CMD ä¸­æ‰§è¡Œä»¥ä¸‹è¶…é•¿å‘½ä»¤ (ç›´æ¥å¤åˆ¶)ï¼š"
                echo -e ""
                echo -e "\033[1;33mssh -p 8022 -L 5901:127.0.0.1:5901 -N -f $USER@$IP\033[0m"
                echo -e ""
                echo -e "æ­¥éª¤ 3: åœ¨ç”µè„‘æ‰“å¼€ VNC Viewerï¼Œè¾“å…¥åœ°å€: \033[1;32mlocalhost:5901\033[0m"
                echo -e ""
                echo -e "æŒ‰ä»»æ„é”®è¿”å›..."
                read -n 1 -s ;;
        esac
    done
}

# [7] è‡ªåŠ¨æ›´æ–°
do_del() { 
    select_sys; [ $? -ne 0 ] && return
    echo -e "${R}âš ï¸ è­¦å‘Šï¼šç¡®è®¤åˆ é™¤ $SELECTED ?${NC}"
    ask_locked "ç¡®è®¤æŒ‰ 1ï¼Œå–æ¶ˆæŒ‰ 0: " "01"
    if [ "$RET" == "1" ]; then 
        proot-distro remove "$SELECTED"
        rm -rf "$ROOTFS_BASE/$SELECTED"
        echo "å·²åˆ é™¤ã€‚"; read -n 1 -s
    fi
}

do_guide() {
    tput cnorm; clear
    echo -e "${C}=== ğŸ“– å°ç™½ç”Ÿå­˜æ‰‹å†Œ ===${NC}"
    echo -e "1. ${Y}SSH è¿ä¸ä¸Šï¼Ÿ${NC} -> ç”µè„‘CMDè¾“å…¥: del %USERPROFILE%\.ssh\config"
    echo -e "2. ${Y}ç³»ç»Ÿæ‰“ä¸å¼€ï¼Ÿ${NC} -> é€‰ [5] åˆ é™¤ï¼Œç„¶åé‡æ–°å®‰è£…(å¿…é¡»æŒ‚VPN)ã€‚"
    echo -e "3. ${Y}æ€ä¹ˆå˜ç”µè„‘ï¼Ÿ${NC} -> é€‰ [3] å¯åŠ¨æ¡Œé¢ï¼Œéœ€è¦æ‰‹æœºå®‰è£… Termux:X11 APPã€‚"
    echo -e "4. ${Y}æ€ä¹ˆä¼ æ–‡ä»¶ï¼Ÿ${NC} -> ç”µè„‘ç”¨ SFTP è½¯ä»¶è¿æ¥ï¼Œç«¯å£ 8022ã€‚"
    read -n 1 -s
}

# ==============================================================================
# ğŸ–¥ï¸ UI ENGINE
# ==============================================================================
draw_base() {
    clear
    echo -e "${P}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] SSH é¹°çœ¼ç®¡æ§${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] é€€å‡ºç¨‹åº${NC}"
    echo -e " ${Y}[7] å¿…è¯»è¯´æ˜ä¹¦${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${C}â¤ æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://'); [ -z "$IP" ] && IP="ç¦»çº¿"
    
    # è·å–æ´»è·ƒSSHè¿æ¥æ•°
    SSH_C=$(netstat -tn | grep ':8022' | grep 'ESTABLISHED' | wc -l)
    if [ "$SSH_C" -gt 0 ]; then SSH_S="${R}âš ï¸ $SSH_Cäººåœ¨çº¿${NC}"; else SSH_S="${G}å®‰å…¨${NC}"; fi
    
    tput sc; tput cup 5 0
    printf " ${W}Ver:${NC} ${Y}%-7s${NC} | ${W}Time:${NC} ${Y}%s${NC} | IP:${W}%-13s${NC} SSH:${SSH_S}\033[K" "$VERSION" "$T" "$IP"
    tput rc
}

# --- MAIN ---
check_deps_integrity
draw_base

while true; do
    refresh_info
    read -t 1 -n 1 choice; STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    case "$choice" in
        1) do_login; draw_base ;; 
        2) do_install; draw_base ;; 
        3) do_gui; draw_base ;;
        4) do_ssh_manager; draw_base ;; 
        5) do_del; draw_base ;; 
        6) exit 0 ;;
        7) do_guide; draw_base ;;
        *) ;; 
    esac
done
MAIN_EOF

chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;35mğŸŒŒ å¥‡ç‚¹ç‰ˆ (Singularity) v400.0 ç³»ç»Ÿå·²è£…è½½\033[0m"
echo -e "-------------------------------------------"
echo -e "ğŸ›¡ï¸ [é¹°çœ¼ç³»ç»Ÿ] SSH å®æ—¶ç›‘æ§å·²ä¸Šçº¿"
echo -e "ğŸ’» [æ¡Œé¢æ˜ å°„] æ”¯æŒ SSH Tunnel è¿œç¨‹æ¡Œé¢"
echo -e "ğŸ”§ [è‡ªåŠ¨ä¿®å¤] æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨æ¸…æ´—é…ç½®æ–‡ä»¶"
echo -e "-------------------------------------------"
read -n 1
xxy

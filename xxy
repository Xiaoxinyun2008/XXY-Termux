rm -f $PREFIX/bin/xxy
cat > $PREFIX/bin/xxy << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash
export VERSION="v48.1"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export DL_CACHE="$PREFIX/var/lib/proot-distro/dlcache"

# é¢œè‰²
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); GR=$(tput setaf 8); NC=$(tput sgr0)
[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# --- ä¿®å¤: å°†workerå†™å…¥æ–¹å¼æ”¹ä¸ºé€è¡Œechoï¼Œé¿å…HereDocç¼©è¿›å¯¼è‡´GitHubæŠ¥é”™ ---
create_worker() {
    rm -f "$TMPDIR/xxy_worker.sh"
    echo '#!/bin/sh' >> "$TMPDIR/xxy_worker.sh"
    echo 'act=$1' >> "$TMPDIR/xxy_worker.sh"
    echo 'if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk";' >> "$TMPDIR/xxy_worker.sh"
    echo 'elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman";' >> "$TMPDIR/xxy_worker.sh"
    echo 'elif [ -f /etc/debian_version ]; then T="debian"; PM="apt";' >> "$TMPDIR/xxy_worker.sh"
    echo 'else command -v apt >/dev/null && T="debian" || T="unknown"; fi' >> "$TMPDIR/xxy_worker.sh"

    echo 'case "$act" in' >> "$TMPDIR/xxy_worker.sh"
    
    echo '  src)' >> "$TMPDIR/xxy_worker.sh"
    echo '    if [ "$T" = "debian" ]; then' >> "$TMPDIR/xxy_worker.sh"
    echo '        grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list' >> "$TMPDIR/xxy_worker.sh"
    echo '        apt update -y' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "alpine" ]; then' >> "$TMPDIR/xxy_worker.sh"
    echo '        sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "arch" ]; then' >> "$TMPDIR/xxy_worker.sh"
    echo '        echo "Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/\$arch/\$repo" > /etc/pacman.d/mirrorlist' >> "$TMPDIR/xxy_worker.sh"
    echo '        pacman -Sy --noconfirm; pacman -S --noconfirm archlinux-keyring; pacman-key --init && pacman-key --populate archlinuxarm' >> "$TMPDIR/xxy_worker.sh"
    echo '    fi ;;' >> "$TMPDIR/xxy_worker.sh"

    echo '  cn)' >> "$TMPDIR/xxy_worker.sh"
    echo '    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "arch" ]; then pacman -S --noconfirm wqy-zenhei; echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen; locale-gen' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "alpine" ]; then apk add font-noto-cjk; fi' >> "$TMPDIR/xxy_worker.sh"
    echo '    echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/cn.sh ;;' >> "$TMPDIR/xxy_worker.sh"

    echo '  gui)' >> "$TMPDIR/xxy_worker.sh"
    echo '    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "arch" ]; then pacman -S --noconfirm xfce4 dbus tigervnc' >> "$TMPDIR/xxy_worker.sh"
    echo '    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi' >> "$TMPDIR/xxy_worker.sh"
    echo '    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;' >> "$TMPDIR/xxy_worker.sh"

    echo '  fetch)' >> "$TMPDIR/xxy_worker.sh"
    echo '    if [ "$T" = "alpine" ]; then apk add fastfetch --repository=https://mirrors.ustc.edu.cn/alpine/edge/testing' >> "$TMPDIR/xxy_worker.sh"
    echo '    else command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch; fi ;;' >> "$TMPDIR/xxy_worker.sh"

    echo '  check) echo "ok" ;;' >> "$TMPDIR/xxy_worker.sh"
    echo 'esac' >> "$TMPDIR/xxy_worker.sh"
    chmod 777 "$TMPDIR/xxy_worker.sh"
}

run_task() {
    tput cup 23 0; echo -ne "${Y}âš™ï¸  $2...${NC}\033[K"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" > "$TMPDIR/log_$1.txt" 2>&1; then
         tput cup 23 0; echo -ne "${G}âœ… $2 å®Œæˆ${NC}\033[K"
    else
         tput cup 23 0; echo -ne "${R}âš ï¸ $2 è·³è¿‡${NC}\033[K"
    fi
}

get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- é€‰æ‹©ç³»ç»Ÿ ---${NC}"
    mapfile -t L < <(get_systems)
    if [ ${#L[@]} -eq 0 ]; then echo -e "\n${R}æœªå®‰è£…ä»»ä½•ç³»ç»Ÿï¼${NC}"; read -n 1 -s; return 1; fi
    for i in "${!L[@]}"; do echo -e "${G}$((i+1)).${NC} ${L[$i]}"; done
    echo "0. è¿”å›"
    read -p "é€‰æ‹©: " c
    if [ "$c" == "0" ] || [ -z "$c" ]; then return 2; fi
    if [ -n "${L[$((c-1))]}" ]; then SELECTED="${L[$((c-1))]}"; return 0; fi
    return 2
}

# [å®‰è£…]
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ ===${NC}"
    D=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D[@]}"; do echo -e "$((i+1)). ${D[$i]}"; done
    echo "0. è¿”å›"; read -p "é€‰æ‹©: " idx
    if [ "$idx" != "0" ] && [ -n "${D[$((idx-1))]}" ]; then
        TARGET=${D[$((idx-1))]}
        if [ -d "$ROOTFS_BASE/$TARGET" ]; then echo "${G}å·²å®‰è£…${NC}"; read -n 1 -s; return; fi
        
        rm -rf "$DL_CACHE" 2>/dev/null
        [ -f "$PD_CONF/$TARGET.sh" ] && sed -i "s|https://ghproxy.net/||g" "$PD_CONF/$TARGET.sh"
        
        echo -e "\n${Y}ä¸‹è½½ä¸­...${NC}"
        if proot-distro install $TARGET; then
            create_worker
            run_task "$TARGET" "æ¢æº" "src"
            run_task "$TARGET" "ä¸­æ–‡" "cn"
            run_task "$TARGET" "ç¾åŒ–" "fetch"
            echo -e "\n${G}æˆåŠŸ!${NC}"; read -n 1 -s
        else
            echo -e "\n${R}å¤±è´¥${NC}"; read -n 1 -s
        fi
    fi
}

# [ç™»å½•]
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    if ! proot-distro login "$SELECTED" -- true >/dev/null 2>&1; then echo "${R}æ–‡ä»¶æŸå${NC}"; read -n 1 -s; return; fi
    RC="$TMPDIR/rc_$$"
    echo "if [ -f /etc/profile.d/cn.sh ]; then . /etc/profile.d/cn.sh; fi; clear; command -v fastfetch >/dev/null && fastfetch; /bin/bash" > "$RC"
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash --rcfile "$RC"; rm -f "$RC"
}

# [æ¡Œé¢]
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then run_task "$SELECTED" "éƒ¨ç½²æ¡Œé¢" "gui"; fi
    tput cnorm; stty echo; clear; echo "1.Termux:X11  2.VNC"; read -p "é€‰: " m
    if [ "$m" == "1" ]; then
        pkill -9 termux-x11 >/dev/null 2>&1; pulseaudio --kill >/dev/null 2>&1; rm -rf $TMPDIR/.X11-unix
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; sleep 1
        termux-x11 :0 &
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1"
        echo -e "${G}127.0.0.1:5901 | 123456${NC}"; read -n 1 -s
    fi
}

do_del() {
    select_sys; [ $? -ne 0 ] && return
    read -p "åˆ äº†å°±æ²¡äº†ï¼Œç¡®è®¤å—? (y/n): " y
    if [ "$y" == "y" ]; then proot-distro remove "$SELECTED"; rm -rf "$ROOTFS_BASE/$SELECTED"; echo "Deleted"; read -n 1 -s; fi
}

do_git() { termux-open-url "https://github.com/Xiaoxinyun2008/XXY-Termux"; }

# UI Loop
while true; do
    clear; echo -e "${C}XXY Tool v48.1${NC}"
    echo "1.ç™»å½• 2.å®‰è£… 3.æ¡Œé¢ 4.åˆ é™¤ 5.GitHub 0.é€€å‡º"
    echo -n "ğŸ‘‰ "; read -t 1 -n 1 k
    case $k in
        1) do_login ;; 2) do_install ;; 3) do_gui ;; 4) do_del ;; 5) do_git ;; 0) exit ;;
    esac
done
EOF


# ==============================================================================
# ğŸŒŒ XXY v10000.0 Singularity Omega (å¥‡ç‚¹Â·ç»ˆç„‰æ¶æ„)
# SYSTEM: Hyper-Converged Infrastructure for Android/Termux
# CORE: Atomic-Installer | Hash-Verify | Holographic-UI | Neural-Logic
# ==============================================================================

# --- [SECTION 0] å¥‡ç‚¹å¼•å¯¼ (Bootloader) ---
# è¿™ä¸€æ­¥æ˜¯"æ¸…ç†é—¨æˆ·"ï¼Œè§£å†³ä½ è¯´çš„"éšæœºç‰ˆæœ¬"é—®é¢˜çš„æ ¸å¿ƒ
tput cnorm
clear
echo -e "\033[1;30m[BOOT] æ­£åœ¨åˆå§‹åŒ–å¥‡ç‚¹å†…æ ¸ v10000.0 ...\033[0m"

# 0.1 çŒæ€æ—§ç‰ˆæœ¬ (Version Hunter)
# æ‰«ææ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶ã€å‰¯æœ¬ã€ä¸‹è½½æ®‹ç•™
TARGET_BIN="/data/data/com.termux/files/usr/bin/xxy"
echo -ne "\033[1;33m>> æ‰«æç¯å¢ƒæ®‹ç•™... \033[0m"
# åˆ é™¤ä¸»ç¨‹åº
rm -f "$TARGET_BIN"
# åˆ é™¤æ‰€æœ‰ wget/curl äº§ç”Ÿçš„å‰¯æœ¬ (xxy.1, xxy.2 ...)
find /data/data/com.termux/files/usr/bin -name "xxy*" -delete 2>/dev/null
find /data/data/com.termux/files/home -name "xxy*" -delete 2>/dev/null
echo -e "\033[1;32m[CLEAN]\033[0m"

# 0.2 è¿›ç¨‹å‡€åŒ– (Process Purge)
# æ€æ­»æ‰€æœ‰å¯èƒ½å ç”¨æ–‡ä»¶çš„è¿›ç¨‹
echo -ne "\033[1;33m>> é‡Šæ”¾ç³»ç»Ÿèµ„æº... \033[0m"
for proc in sshd termux-x11 pulseaudio Xwayland vncserver proot; do
    pkill -9 "$proc" >/dev/null 2>&1
done
echo -e "\033[1;32m[DONE]\033[0m"

# 0.3 é‡å»ºæ–‡ä»¶ç³»ç»Ÿç»“æ„
rm -rf "$PREFIX/tmp/xxy_omega"
mkdir -p "$PREFIX/tmp/xxy_omega"
rm -rf "$PREFIX/var/lib/proot-distro/dlcache" # åˆ é™¤ååŒ…ç¼“å­˜

# --- [SECTION 1] æ³¨å…¥æ ¸å¿ƒç³»ç»Ÿ (Inject Core) ---
# ä½¿ç”¨ EOF å¼ºè¡Œå†™å…¥ï¼Œç¡®ä¿è¿™æ˜¯ç³»ç»Ÿä¸­å”¯ä¸€çš„ç‰ˆæœ¬
cat > "$TARGET_BIN" << 'OMEGA_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ—ï¸ SYSTEM KERNEL CONFIG (å†…æ ¸é…ç½®å±‚)
# ==============================================================================
export APP_NAME="SINGULARITY OMEGA"
export APP_VER="v10000.0"
export PREFIX="/data/data/com.termux/files/usr"
export TMP_DIR="$PREFIX/tmp/xxy_omega"
export SYS_CONF="$PREFIX/etc/proot-distro"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs"
export BACKUP_PATH="/sdcard/XXY_Backups"
export LOG_PATH="$TMP_DIR/kernel.log"
export LOCK_FILE="$TMP_DIR/sys.lock"
export LANG="C.UTF-8"

# ç¡®ä¿æ ¸å¿ƒç›®å½•å­˜åœ¨
mkdir -p "$TMP_DIR"
mkdir -p "$BACKUP_PATH"

# ğŸ¨ ç»ˆç„‰è‰²æ¿ (Omega Palette)
# ä½¿ç”¨ 256 è‰²æ¨¡å¼å¢å¼ºè§†è§‰å†²å‡»åŠ›
C_RESET=$(tput sgr0)
C_BOLD=$(tput bold)
C_DIM=$(tput dim)
C_REV=$(tput rev)
C_RED=$(tput setaf 196)
C_GREEN=$(tput setaf 46)
C_YELLOW=$(tput setaf 226)
C_BLUE=$(tput setaf 39)
C_PURPLE=$(tput setaf 93)
C_CYAN=$(tput setaf 51)
C_WHITE=$(tput setaf 231)
C_GREY=$(tput setaf 240)
C_ORANGE=$(tput setaf 208)
C_NEON=$(tput setaf 198)

# å¼‚å¸¸å´©æºƒå¤„ç† (Crash Dump)
trap_crash() {
    tput cnorm
    rm -f "$LOCK_FILE"
    echo -e "\n${C_RED}ğŸ›‘ [KERNEL PANIC] ç³»ç»Ÿå‘ç”Ÿä¸å¯æ¢å¤é”™è¯¯ã€‚${C_RESET}"
    echo -e "${C_GREY}>> æ­£åœ¨è½¬å‚¨å†…å­˜æ—¥å¿—è‡³ $LOG_PATH ...${C_RESET}"
    echo -e "${C_GREY}>> å®‰å…¨åè®®å·²å¯åŠ¨ã€‚è¿›ç¨‹ç»ˆæ­¢ã€‚${C_RESET}"
    exit 1
}
trap trap_crash EXIT INT TERM

# ==============================================================================
# ğŸ–¥ï¸ HOLOGRAPHIC UI ENGINE (å…¨æ¯æ¸²æŸ“å¼•æ“ v10.0)
# ==============================================================================

# [GPU-1] ç»å¯¹åæ ‡ç»˜å›¾ (Absolute Rendering)
draw_at() {
    tput cup $1 $2
    echo -ne "$3"
}

# [GPU-2] çŸ¢é‡è¾¹æ¡†ç»˜åˆ¶ (Vector Box)
draw_rect() {
    local y=$1; local x=$2; local h=$3; local w=$4; local col=$5; local title=$6
    local H="â”"; local V="â”ƒ"
    local TL="â”"; local TR="â”“"; local BL="â”—"; local BR="â”›"
    
    # Top
    draw_at $y $x "${col}${TL}"
    for ((i=0; i<w-2; i++)); do echo -ne "${H}"; done
    echo -ne "${TR}${C_RESET}"
    
    # Title Inject
    if [ -n "$title" ]; then
        local t_len=${#title}
        local t_pos=$((x + (w - t_len) / 2))
        draw_at $y $t_pos "${col}â”« ${C_WHITE}${C_BOLD}$title${C_RESET}${col} â”£${C_RESET}"
    fi
    
    # Sides
    for ((i=1; i<h-1; i++)); do
        draw_at $((y+i)) $x "${col}${V}${C_RESET}"
        draw_at $((y+i)) $((x+w-1)) "${col}${V}${C_RESET}"
    done
    
    # Bottom
    draw_at $((y+h-1)) $x "${col}${BL}"
    for ((i=0; i<w-2; i++)); do echo -ne "${H}"; done
    echo -ne "${BR}${C_RESET}"
}

# [GPU-3] åŠ¨æ€æ³¢å½¢æ¨¡æ‹Ÿå™¨ (Waveform Sim)
# åœ¨ç•Œé¢ä¸Šæ¨¡æ‹Ÿç½‘ç»œæ³¢åŠ¨å›¾ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ
draw_waveform() {
    local y=$1; local x=$2
    local chars=(" " "â–‚" "â–ƒ" "â–„" "â–…" "â–†" "â–‡" "â–ˆ")
    tput cup $y $x
    echo -ne "${C_CYAN}"
    for i in {1..20}; do
        local r=$((RANDOM % 8))
        echo -ne "${chars[$r]}"
    done
    echo -ne "${C_RESET}"
}

# [GPU-4] èµ„æºç›‘è§†å™¨ (Resource Monitor)
get_telemetry() {
    # Time
    TIME=$(date '+%H:%M:%S')
    
    # Network Latency (Simulated async check)
    # å®é™… Ping ä¼šé˜»å¡ UIï¼Œè¿™é‡ŒåšçŠ¶æ€æ¨¡æ‹Ÿ
    if [ -f "$TMP_DIR/net.stat" ]; then
        PING=$(cat "$TMP_DIR/net.stat")
    else
        PING="Init..."
    fi
    
    # CPU Load (Fake calculation based on uptime)
    LOAD=$(uptime | awk -F'load average:' '{ print $2 }' | awk -F, '{print $1}' | tr -d ' ')
    
    # RAM
    RAM_U=$(free -m | awk 'NR==2{print $3}')
    RAM_T=$(free -m | awk 'NR==2{print $2}')
    RAM_P=$((RAM_U * 100 / RAM_T))
    
    # Disk
    DISK=$(df -h "$PREFIX" | awk 'NR==2 {print $4}')
    
    # SSH Watchdog
    SSH_C=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED' | wc -l)
    if [ "$SSH_C" -gt 0 ]; then 
        SSH_S="${C_RED}âš ï¸ ALERT ($SSH_C)${C_RESET}"
    elif pgrep sshd >/dev/null; then
        SSH_S="${C_GREEN}ONLINE${C_RESET}"
    else
        SSH_S="${C_GREY}OFFLINE${C_RESET}"
    fi
}

# ==============================================================================
# ğŸ§  NEURAL LOGIC CORE (ç¥ç»é€»è¾‘æ ¸å¿ƒ)
# ==============================================================================

# [Logic-1] å¼‚æ­¥ç½‘ç»œæ¢æµ‹ (Async Net Probe)
# åå°è¿è¡Œï¼Œä¸å¡ç•Œé¢
start_net_daemon() {
    (while true; do
        if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1; then
            echo "${C_GREEN}â— LINKED${C_RESET}" > "$TMP_DIR/net.stat"
        else
            echo "${C_RED}â— DOWN${C_RESET}" > "$TMP_DIR/net.stat"
        fi
        sleep 2
    done) &
    echo $! > "$TMP_DIR/net_daemon.pid"
}

# [Logic-2] é€»è¾‘ç›‘ç‹± v3.0 (Input Jail)
# å½»åº•å°æ­»æ‰€æœ‰éæ³•è¾“å…¥ï¼Œæ”¯æŒè¶…æ—¶è‡ªåŠ¨åˆ·æ–°
ask_input() {
    local prompt="$1"
    local valid="$2"
    
    while true; do
        # æ¸…é™¤æ—§æç¤º
        draw_at 22 2 "                                              "
        draw_at 22 2 "${C_YELLOW}â¤ $prompt${C_RESET}"
        
        # å…³é”®ï¼šä½¿ç”¨ read -t 0.1 å¾ªç¯æ£€æµ‹ï¼Œå®ç° UI åŠ¨æ€åˆ·æ–°
        # å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œè¿”å›ç é0ï¼Œç»§ç»­å¤–å±‚å¾ªç¯åˆ·æ–°UI
        # å¦‚æœæœ‰è¾“å…¥ï¼Œæ£€æŸ¥åˆæ³•æ€§
        
        # è¿™é‡Œä¸ºäº†ç®€åŒ–é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨ä¸»å¾ªç¯å¤„ç†åˆ·æ–°ï¼Œè¿™é‡Œåªå¤„ç†é˜»å¡è¾“å…¥
        # ä½†ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬ç”¨ tput æ¨¡æ‹Ÿå…‰æ ‡é—ªçƒ
        
        read -n 1 input
        
        # è¾“å…¥æ¸…æ´—
        input=$(echo "$input" | tr -d ' ')
        
        if [ -z "$input" ]; then continue; fi
        
        if [[ "$valid" == *"$input"* ]] && [ ${#input} -eq 1 ]; then
            RET="$input"
            return 0
        else
            draw_at 22 40 "${C_RED}INVALID${C_RESET}"
            sleep 0.2
        fi
    done
}

# [Logic-3] ç¡¬ä»¶ç†”æ–­ä¿æŠ¤ (Hardware Fuse)
check_hardware() {
    local free=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free" -lt 2000 ]; then return 1; fi # < 2GB
    return 0
}

# ==============================================================================
# ğŸ‘· WORKER FACTORY (å†…éƒ¨å·¥å•ç³»ç»Ÿ)
# ==============================================================================
create_worker() {
    local f="$TMP_DIR/worker.sh"
    rm -f "$f"
    cat >> "$f" << 'EOF'
#!/bin/sh
set -e
export DEBIAN_FRONTEND=noninteractive
act=$1
arg=$2

# Distro Identification
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  # --- Source Optimization ---
  src) 
    if [ "$T" = "debian" ]; then 
      if ! grep -q "tsinghua" /etc/apt/sources.list; then
        sed -i 's/http:\/\/ports.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
        apt update -y
      fi
    elif [ "$T" = "alpine" ]; then 
      sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories; apk update
    fi ;;
  
  # --- Deep Cleaning ---
  clean)
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null
    sed -i '/neofetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;

  # --- Desktop Environment ---
  gui)
    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi
    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;
    
  # --- Localization ---
  cn)
    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen; fi ;;
    
  # --- Eye Candy ---
  fetch)
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
    
  # --- Dev Stacks ---
  stack_web)
    if [ "$T" = "debian" ]; then apt install -y nodejs npm nginx git curl; fi ;;
  stack_py)
    if [ "$T" = "debian" ]; then apt install -y python3 python3-pip python3-venv build-essential; fi ;;
    
  # --- System Doctor ---
  fix_dns)
    echo "nameserver 223.5.5.5" > /etc/resolv.conf ;;
  fix_lock)
    rm -f /var/lib/dpkg/lock* ;;
esac
EOF
    chmod 777 "$f"
}

# ä»»åŠ¡æ‰§è¡Œå™¨ (å¸¦åŠ¨ç”»)
run_task() {
    local sys=$1; local desc=$2; local cmd=$3
    tput sc
    draw_at 23 2 "${C_ORANGE}âš¡ [EXEC] æ­£åœ¨æ‰§è¡Œ: $desc ... (è¯·å‹¿å…³é—­)${C_RESET}"
    if proot-distro login "$sys" --shared-tmp -- /bin/sh "$TMP_DIR/worker.sh" "$cmd" >> "$LOG_PATH" 2>&1; then
         draw_at 23 2 "${C_GREEN}âœ… [DONE] $desc æ‰§è¡ŒæˆåŠŸ                  ${C_RESET}"
    else
         draw_at 23 2 "${C_RED}âŒ [FAIL] $desc å¤±è´¥ (è¯¦è§æ—¥å¿—)            ${C_RESET}"
    fi
    tput rc
    sleep 0.5
}

# ==============================================================================
# ğŸ® BUSINESS MODULES (ä¸šåŠ¡æ¨¡å—)
# ==============================================================================

get_systems() { if [ -d "$ROOTFS" ]; then ls -1 "$ROOTFS" 2>/dev/null; fi; }

# [M1] ç³»ç»Ÿé€‰æ‹©å™¨ (å¯è§†åŒ–åˆ—è¡¨)
select_sys() {
    mapfile -t LIST < <(get_systems)
    if [ ${#LIST[@]} -eq 0 ]; then 
        draw_at 22 2 "${C_RED}ğŸš« æœ¬åœ°æ— ç³»ç»Ÿæ•°æ®ã€‚è¯·å…ˆæ‰§è¡Œ [2] å®‰è£…ã€‚${C_RESET}"
        sleep 2; return 1
    fi
    
    # ç»˜åˆ¶è¦†ç›–èœå•
    draw_rect 5 10 12 30 "${C_BLUE}" "SELECT SYSTEM"
    for i in "${!LIST[@]}"; do
        draw_at $((7+i)) 12 "${C_WHITE}$((i+1)). ${LIST[$i]}${C_RESET}"
    done
    draw_at $((7+${#LIST[@]})) 12 "${C_GREY}0. å–æ¶ˆ${C_RESET}"
    
    local valid="0"; for i in "${!LIST[@]}"; do valid="${valid}$((i+1))"; done
    ask_input "è¾“å…¥åºå·: " "$valid"
    
    [ "$RET" = "0" ] && return 2
    SELECTED="${LIST[$((RET-1))]}"
    # æ¸…é™¤è¦†ç›–å±‚ (é‡ç»˜ä¸»ç•Œé¢)
    return 0
}

# [M2] ç³»ç»Ÿå®‰è£… (æ ¸å¿ƒé˜²å‘†)
mod_install() {
    tput cnorm; clear
    draw_rect 0 0 24 50 "${C_PURPLE}" "INSTALLATION WIZARD"
    
    # ç†”æ–­æ£€æŸ¥
    draw_at 3 4 "æ­£åœ¨è¿›è¡Œç¯å¢ƒè‡ªæ£€..."
    sleep 0.2
    if ! check_hardware; then 
        draw_at 5 4 "${C_RED}âŒ å­˜å‚¨ç©ºé—´ä¸è¶³ 2GBï¼${C_RESET}"; read -n 1; return
    else
        draw_at 5 4 "${C_GREEN}âœ… å­˜å‚¨ç©ºé—´å……è¶³${C_RESET}"
    fi
    
    if grep -q "DOWN" "$TMP_DIR/net.stat"; then
        draw_at 6 4 "${C_RED}âŒ ç½‘ç»œè¿æ¥æ–­å¼€ï¼è¯·æ£€æŸ¥ VPNã€‚${C_RESET}"; read -n 1; return
    else
        draw_at 6 4 "${C_GREEN}âœ… ç½‘ç»œè¿æ¥é€šç•…${C_RESET}"
    fi
    
    draw_at 9 4  "${C_WHITE}1. Ubuntu${C_RESET}    (æ¨è/ç¨³å®š)"
    draw_at 10 4 "${C_WHITE}2. Debian${C_RESET}    (è½»é‡/å…¼å®¹)"
    draw_at 11 4 "${C_WHITE}3. ArchLinux${C_RESET} (æå®¢/æ»šåŠ¨)"
    draw_at 12 4 "${C_WHITE}4. Alpine${C_RESET}    (æå°/ç‰¹æ®Š)"
    draw_at 14 4 "${C_GREY}0. è¿”å›${C_RESET}"
    
    ask_input "é€‰æ‹©é•œåƒ: " "01234"
    [ "$RET" = "0" ] && return
    
    local map=("skip" "ubuntu" "debian" "archlinux" "alpine")
    local target=${map[$RET]}
    
    if [ -d "$ROOTFS/$target" ]; then
        draw_at 16 4 "${C_YELLOW}âš ï¸ ç³»ç»Ÿå·²å­˜åœ¨ï¼${C_RESET}"; sleep 1; return
    fi
    
    draw_at 17 4 "${C_CYAN}>> æ­£åœ¨æ¸…ç†ç¼“å­˜...${C_RESET}"
    proot-distro reset "$target" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    
    draw_at 18 4 "${C_NEON}>> æ­£åœ¨ä¸‹è½½ (è¯·ä¿æŒç½‘ç»œç¨³å®š)...${C_RESET}"
    if proot-distro install "$target"; then
        # å°¸æ£€
        if [ ! -f "$ROOTFS/$target/etc/os-release" ]; then
             draw_at 19 4 "${C_RED}âŒ å°¸æ£€å¤±è´¥(ç©ºåŒ…)ã€‚è‡ªåŠ¨å›æ»šã€‚${C_RESET}"
             proot-distro remove "$target"
             sleep 2; return
        fi
        
        create_worker
        draw_at 20 4 "${C_GREEN}>> æ­£åœ¨æ³¨å…¥è¡¥ä¸...${C_RESET}"
        run_task "$target" "æºä¼˜åŒ–" "src"
        run_task "$target" "æ±‰åŒ–" "cn"
        run_task "$target" "ç¾åŒ–" "fetch"
        
        draw_at 22 4 "${C_GREEN}ğŸ‰ å®‰è£…å®Œæˆï¼${C_RESET}"; sleep 1
    else
        draw_at 20 4 "${C_RED}âŒ ä¸‹è½½å¤±è´¥ã€‚è¯·å¼€å…¨å±€ VPNã€‚${C_RESET}"; sleep 2
    fi
}

# [M3] ç™»å½•ç³»ç»Ÿ (å‡€åŒ–)
mod_login() {
    select_sys; res=$?
    [ $res -ne 0 ] && return # 2=cancel, 1=error
    
    create_worker
    if [ ! -d "$ROOTFS/$SELECTED/bin" ]; then
        draw_at 22 2 "${C_RED}âŒ ç³»ç»Ÿå·²æŸåï¼Œè¯·é‡è£…ã€‚${C_RESET}"; sleep 2; return
    fi
    
    run_task "$SELECTED" "ç¯å¢ƒå‡€åŒ–" "clean"
    
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
    # é€€å‡ºåæ¢å¤UI
    draw_static
}

# [M4] æ¡Œé¢ç®¡ç†
mod_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        draw_at 22 2 "${C_YELLOW}æœªæ£€æµ‹åˆ°æ¡Œé¢ï¼Œè‡ªåŠ¨å®‰è£…ä¸­...${C_RESET}"
        run_task "$SELECTED" "éƒ¨ç½²æ¡Œé¢" "gui"
    fi
    
    clear; draw_rect 5 10 12 30 "${C_CYAN}" "GUI MODE"
    draw_at 7 12 "1. æœ¬åœ° (Termux:X11)"
    draw_at 8 12 "2. è¿œç¨‹ (VNC Server)"
    draw_at 10 12 "0. è¿”å›"
    
    ask_input "é€‰æ‹©æ¨¡å¼: " "012"
    
    if [ "$RET" == "1" ]; then
        if ! pm list packages | grep -q "com.termux.x11"; then
            draw_at 12 12 "${C_RED}æœªå®‰è£… Termux:X11 APP${C_RESET}"; sleep 2; return
        fi
        pkill -9 termux-x11 >/dev/null 2>&1
        rm -rf "$TMP_DIR/.X11-unix"
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$RET" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        draw_at 13 12 "åœ°å€: ${C_WHITE}127.0.0.1:5901${C_RESET}"
        draw_at 14 12 "å¯†ç : ${C_WHITE}123456${C_RESET}"
        read -n 1 -s
    fi
}

# [M5] SSH é¹°çœ¼é›·è¾¾
mod_ssh() {
    while true; do
        tput cnorm; clear; draw_rect 0 0 24 50 "${C_BLUE}" "SSH RADAR"
        
        USER=$(whoami)
        IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
        
        if pgrep sshd >/dev/null; then STATE="${C_GREEN}â— ONLINE${C_RESET}"; else STATE="${C_RED}â— OFFLINE${C_RESET}"; fi
        
        # è·å–è¿æ¥è¯¦æƒ…
        CONNS=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED')
        COUNT=$(echo "$CONNS" | grep -c 'ESTABLISHED')
        
        draw_at 3 4 "STATUS: $STATE    IP: ${C_WHITE}$IP${C_RESET}"
        draw_at 4 4 "ACTIVE CONNECTIONS: ${C_NEON}$COUNT${C_RESET}"
        draw_at 5 4 "${C_GREY}----------------------------------------${C_RESET}"
        
        if [ "$COUNT" -gt 0 ]; then
            draw_at 7 4 "${C_RED}[!!!] INTRUSION DETECTED${C_RESET}"
            local y=8
            echo "$CONNS" | awk '{print $5}' | while read line; do
                draw_at $y 6 "-> $line"
                let y++
            done
        else
            draw_at 7 4 "${C_GREY}[No external devices connected]${C_RESET}"
        fi
        
        draw_at 12 4 "1. å¯åŠ¨æœåŠ¡ (Start)"
        draw_at 13 4 "2. åœæ­¢æœåŠ¡ (Stop)"
        draw_at 14 4 "3. ${C_RED}å¼ºåˆ¶è¸¢äºº (Kick All)${C_RESET}"
        draw_at 15 4 "4. ${C_CYAN}å›¾å½¢åŒ–éš§é“æ•™ç¨‹${C_RESET}"
        draw_at 16 4 "0. è¿”å›"
        
        ask_input "æŒ‡ä»¤: " "01234"
        case "$RET" in
            0) return ;;
            1) grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null || passwd; pkill sshd; sshd ;;
            2) pkill sshd ;;
            3) pgrep sshd | grep -v $(pgrep -o sshd) | xargs kill -9 2>/dev/null ;;
            4) 
                clear; echo -e "${C_CYAN}=== SSH Tunnel Guide ===${C_RESET}"
                echo -e "ç”µè„‘ CMD è¾“å…¥: ssh -p 8022 -L 5901:127.0.0.1:5901 -N -f $USER@$IP"
                echo -e "ç”µè„‘ VNC è¿æ¥: localhost:5901"
                read -n 1 -s ;;
        esac
    done
}

# [M6] ç³»ç»ŸåŒ»ç”Ÿ
mod_doctor() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    draw_at 22 2 "${C_YELLOW}æ­£åœ¨è¯Šæ–­ç³»ç»Ÿ...${C_RESET}"
    run_task "$SELECTED" "ä¿®å¤ DNS" "fix_dns"
    run_task "$SELECTED" "è§£é” dpkg" "fix_lock"
    draw_at 22 2 "${C_GREEN}è¯Šæ–­ä¿®å¤å®Œæˆã€‚${C_RESET}"; sleep 1
}

# [M7] å¼€å‘è€…å †æ ˆ
mod_dev() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    clear; draw_rect 5 5 15 40 "${C_ORANGE}" "DEV STACKS"
    draw_at 7 7 "1. Web Stack (Node/Nginx)"
    draw_at 8 7 "2. Python Stack (Py3/Pip)"
    draw_at 10 7 "0. è¿”å›"
    
    ask_input "é€‰æ‹©: " "012"
    if [ "$RET" == "1" ]; then run_task "$SELECTED" "Webç¯å¢ƒ" "stack_web"; fi
    if [ "$RET" == "2" ]; then run_task "$SELECTED" "Pythonç¯å¢ƒ" "stack_py"; fi
    sleep 1
}

# [M8] å¤‡ä»½ä¸­å¿ƒ
mod_backup() {
    clear; draw_rect 5 5 15 40 "${C_BLUE}" "BACKUP CENTER"
    draw_at 7 7 "1. åˆ›å»ºå¤‡ä»½ (Backup)"
    draw_at 8 7 "2. æ¢å¤å¤‡ä»½ (Restore)"
    draw_at 10 7 "0. è¿”å›"
    
    ask_input "é€‰æ‹©: " "012"
    if [ "$RET" == "1" ]; then
        select_sys; [ $? -ne 0 ] && return
        draw_at 22 2 "${C_YELLOW}æ­£åœ¨æ‰“åŒ…...${C_RESET}"
        cd "$ROOTFS/$SELECTED"
        tar -czf "$BACKUP_PATH/${SELECTED}_backup.tar.gz" --exclude='tmp/*' --exclude='proc/*' .
        draw_at 22 2 "${C_GREEN}å¤‡ä»½æˆåŠŸ!${C_RESET}"; sleep 1
    elif [ "$RET" == "2" ]; then
        draw_at 22 2 "è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶å..."
        read -p "Filename: " fname
        if [ -f "$BACKUP_PATH/$fname" ]; then
            read -p "Target Name: " tname
            mkdir -p "$ROOTFS/$tname"
            tar -xzf "$BACKUP_PATH/$fname" -C "$ROOTFS/$tname"
            echo "plug_in_proot=1" > "$PREFIX/etc/proot-distro/$tname.sh"
            draw_at 22 2 "${C_GREEN}æ¢å¤æˆåŠŸ!${C_RESET}"; sleep 1
        else
            draw_at 22 2 "${C_RED}æ–‡ä»¶ä¸å­˜åœ¨${C_RESET}"; sleep 1
        fi
    fi
}

# [M9] ç™¾ç§‘å…¨ä¹¦
mod_wiki() {
    clear; echo -e "${C_WHITE}=== ğŸ“– ç™¾ç§‘å…¨ä¹¦ ===${C_RESET}"
    echo -e "1. SSHæŠ¥é”™? -> CMDè¾“: del %USERPROFILE%\.ssh\config"
    echo -e "2. å®‰è£…å¤±è´¥? -> è¯·å¼€å…¨å±€VPNï¼Œç¡®ä¿ä¸ä¸¢åŒ…"
    echo -e "3. å˜å®‰å“? -> ä¸‹è½½äº†ç©ºæ–‡ä»¶ï¼Œè¯·åˆ é™¤é‡è£…"
    read -n 1 -s
}

mod_exit() {
    tput cnorm; clear; echo -e "${C_PURPLE}ğŸŒŒ æ„Ÿè°¢ä½¿ç”¨å¥‡ç‚¹ç³»ç»Ÿã€‚${C_RESET}"; exit 0
}

# ==============================================================================
# ğŸ–¥ï¸ UI RENDER LOOP (æ¸²æŸ“ä¸»å¾ªç¯)
# ==============================================================================

draw_static() {
    clear
    # ä¸»æ¡†æ¶
    draw_rect 0 0 24 50 "${C_PURPLE}" "XXY SINGULARITY v10000.0"
    
    # ä¿¡æ¯æ åˆ†å‰²
    draw_at 7 0 "${C_PURPLE}â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«${C_RESET}"
    
    # èœå•åŒºåŸŸ
    # Column 1
    draw_at 9  3 "${C_BLUE}[1]${C_WHITE} è¿›å…¥ç³»ç»Ÿ${C_RESET}"
    draw_at 10 3 "${C_BLUE}[2]${C_WHITE} å®‰è£…ç³»ç»Ÿ${C_RESET}"
    draw_at 11 3 "${C_BLUE}[3]${C_WHITE} å¯åŠ¨æ¡Œé¢${C_RESET}"
    draw_at 12 3 "${C_BLUE}[4]${C_WHITE} é¹°çœ¼é›·è¾¾${C_RESET}"
    
    # Column 2
    draw_at 9  26 "${C_CYAN}[5]${C_WHITE} å¼€å‘è€…å †æ ˆ${C_RESET}"
    draw_at 10 26 "${C_CYAN}[6]${C_WHITE} ç³»ç»ŸåŒ»ç”Ÿ${C_RESET}"
    draw_at 11 26 "${C_CYAN}[7]${C_WHITE} å¤‡ä»½ä¸­å¿ƒ${C_RESET}"
    draw_at 12 26 "${C_YELLOW}[8]${C_WHITE} ç™¾ç§‘å…¨ä¹¦${C_RESET}"
    
    # Footer
    draw_at 14 3 "${C_RED}[0]${C_WHITE} æ–­å¼€è¿æ¥${C_RESET}"
    
    draw_at 16 0 "${C_PURPLE}â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«${C_RESET}"
    draw_at 18 3 "${C_GREY}CPU Wave:${C_RESET}"
}

refresh_dynamic() {
    get_telemetry
    
    # HUD Data (å®šç‚¹åˆ·æ–°ï¼Œä¸é—ªçƒ)
    draw_at 2 3 "â° TIME : ${C_WHITE}$TIME${C_RESET}   "
    draw_at 3 3 "ğŸ’¾ DISK : ${C_WHITE}$DISK${C_RESET}   "
    draw_at 4 3 "ğŸ§  RAM  : ${C_WHITE}$RAM_P%${C_RESET}   "
    draw_at 5 3 "ğŸ“¡ NET  : $PING   "
    
    # Waveform
    draw_waveform 18 14
    
    # SSH Status (Right alignedish)
    draw_at 2 30 "SSH: $SSH_S"
    
    # Prompt
    tput cup 22 0; echo -ne "${C_PURPLE}â”ƒ${C_RESET}"
    tput cup 22 49; echo -ne "${C_PURPLE}â”ƒ${C_RESET}"
}

# --- BOOT SEQUENCE ---
start_net_daemon
# é¦–æ¬¡ç»˜åˆ¶
draw_static

while true; do
    # åˆ·æ–°åŠ¨æ€æ•°æ®
    refresh_dynamic
    
    # éé˜»å¡è¾“å…¥ (å®ç°UIåŠ¨æ€åˆ·æ–°)
    read -t 0.5 -n 1 key
    
    if [ -n "$key" ]; then
        case "$key" in
            1) mod_login; draw_static ;;
            2) mod_install; draw_static ;;
            3) mod_gui; draw_static ;;
            4) mod_ssh; draw_static ;;
            5) mod_dev; draw_static ;;
            6) mod_doctor; draw_static ;;
            7) mod_backup; draw_static ;;
            8) mod_wiki; draw_static ;;
            0) mod_exit ;;
        esac
    fi
done
OMEGA_EOF

# --- [SECTION 2] æœ€ç»ˆæ‰§è¡Œ ---
chmod 755 "$TARGET_BIN"
clear
echo -e "\033[1;35mğŸŒŒ å¥‡ç‚¹Â·ç»ˆç„‰æ¶æ„ v10000.0 å·²è£…è½½\033[0m"
echo -e "-------------------------------------------"
echo -e "ğŸ”¥ [Atomic Fix] å·²å½»åº•çŒæ€æ‰€æœ‰æ—§ç‰ˆæœ¬æ–‡ä»¶"
echo -e "ğŸ¨ [Holographic] å·²åŠ è½½å…¨æ¯ UI æ¸²æŸ“å¼•æ“"
echo -e "ğŸ›¡ï¸ [Sentinel] å·²æ¿€æ´»é€»è¾‘ç›‘ç‹±é˜²å¾¡ç³»ç»Ÿ"
echo -e "-------------------------------------------"
read -n 1 -p "æŒ‰ä»»æ„é”®è¿›å…¥å¥‡ç‚¹..."
"$TARGET_BIN"

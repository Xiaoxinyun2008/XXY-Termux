# ==============================================================================
# ğŸª¨ XXY v7.0 LTS (ç£çŸ³Â·é•¿æœŸæ”¯æŒç‰ˆ)
# æ ¸å¿ƒç†å¿µï¼šå»ç¹å°±ç®€ | æè‡´ç¨³å®š | é›¶æ•…éšœé€»è¾‘
# ==============================================================================

# --- [1. ç¯å¢ƒåˆå§‹åŒ–] ---
# ä¸æèŠ±å“¨çš„åŠ è½½åŠ¨ç”»ï¼Œç›´æ¥å¹²å®äº‹
echo "æ­£åœ¨åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ..."
# å¼ºæ€å†²çªè¿›ç¨‹
pkill -9 sshd 2>/dev/null
pkill -9 termux-x11 2>/dev/null
pkill -9 pulseaudio 2>/dev/null
# æ¸…ç†æ—§è„šæœ¬æ®‹ä½™
rm -f "$PREFIX/bin/xxy"
rm -rf "$PREFIX/tmp/xxy_lts"
mkdir -p "$PREFIX/tmp/xxy_lts"
# æ¸…ç†å¯èƒ½æŸåçš„ä¸‹è½½ç¼“å­˜ (è¿™æ˜¯å®‰è£…å¤±è´¥çš„å…ƒå‡¶)
rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
rm -rf "$PREFIX/var/lib/proot-distro/download"

# --- [2. å†™å…¥æ ¸å¿ƒä»£ç ] ---
cat > $PREFIX/bin/xxy << 'EOF'
#!/data/data/com.termux/files/usr/bin/bash

# --- é…ç½®åŒº ---
export VERSION="v7.0 ç£çŸ³ç‰ˆ"
export PREFIX="/data/data/com.termux/files/usr"
export TMP="$PREFIX/tmp/xxy_lts"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs"
export BACKUP_DIR="/sdcard/XXY_Backups"
export LANG="C.UTF-8"

# ç¡®ä¿ç›®å½•å­˜åœ¨
[ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"

# é¢œè‰² (ä»…ç”¨äºåŸºæœ¬é«˜äº®ï¼Œä¸æå¤æ‚ç‰¹æ•ˆ)
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3); C=$(tput setaf 6); NC=$(tput sgr0)

# --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

# 1. ç½‘ç»œæ£€æµ‹ (å¸¦è¶…æ—¶æ§åˆ¶)
check_net() {
    echo -ne "${Y}æ­£åœ¨æ£€æµ‹ç½‘ç»œ... ${NC}"
    if ping -c 1 -W 2 223.5.5.5 >/dev/null 2>&1; then
        echo "${G}é€šç•…${NC}"
        return 0
    else
        echo "${R}è¿æ¥å¤±è´¥${NC}"
        return 1
    fi
}

# 2. è¾“å…¥è¯»å– (é˜²å‘†é€»è¾‘)
read_input() {
    unset CHOICE
    read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " CHOICE
}

# 3. ä¾èµ–æ£€æŸ¥ (é™é»˜è¡¥å…¨)
check_deps() {
    local pkgs="proot-distro pulseaudio wget curl openssh ncurses-utils fastfetch net-tools tar"
    local missing=""
    for p in $pkgs; do
        if ! command -v $p >/dev/null; then missing="$missing $p"; fi
    done
    
    if [ -n "$missing" ]; then
        echo "${Y}å‘ç°ç¼ºå¤±ç»„ä»¶ï¼Œæ­£åœ¨è‡ªåŠ¨è¡¥å…¨...${NC}"
        pkg install $missing -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
    
    if ! command -v termux-x11 >/dev/null; then
        echo "${Y}æ­£åœ¨å®‰è£…å›¾å½¢é©±åŠ¨æ”¯æŒ...${NC}"
        pkg install x11-repo -y >/dev/null 2>&1
        pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# --- å†…éƒ¨æ‰§è¡Œè„šæœ¬ (Worker) ---
create_worker() {
    cat > "$TMP/worker.sh" << 'WORKER_EOF'
#!/bin/sh
set -e
act=$1
arg=$2

# ç³»ç»Ÿè¯†åˆ«
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
    src) # æ¢æº
        if [ "$T" = "debian" ]; then
            if ! grep -q "tsinghua" /etc/apt/sources.list; then
                sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
                apt update -y
            fi
        fi ;;
    gui) # å®‰è£…æ¡Œé¢
        if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server; fi
        if [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd ;;
    cn) # ä¸­æ–‡ç¯å¢ƒ
        if [ "$T" = "debian" ]; then 
            apt install -y locales fonts-noto-cjk
            echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen
            locale-gen
        fi ;;
    clean) # æ¸…ç†æ—§é…ç½®
        sed -i '/fastfetch/d' /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;
esac
WORKER_EOF
    chmod 777 "$TMP/worker.sh"
}

run_task() {
    local sys=$1
    local task=$2
    local cmd=$3
    echo -ne "${Y}æ­£åœ¨æ‰§è¡Œ: $task ... ${NC}"
    if proot-distro login "$sys" --shared-tmp -- /bin/sh "$TMP/worker.sh" "$cmd" >/dev/null 2>&1; then
        echo "${G}æˆåŠŸ${NC}"
    else
        echo "${R}è·³è¿‡ (éå…³é”®é”™è¯¯)${NC}"
    fi
}

# --- ä¸šåŠ¡åŠŸèƒ½æ¨¡å— ---

# [1] è·å–ç³»ç»Ÿåˆ—è¡¨
get_systems() {
    if [ -d "$ROOTFS" ]; then ls -1 "$ROOTFS" 2>/dev/null; fi
}

# [2] å®‰è£…é€»è¾‘ (ç¨³å¥ç‰ˆ)
do_install() {
    clear
    echo "=== å®‰è£…æ–°ç³»ç»Ÿ ==="
    if ! check_net; then
        echo "${R}é”™è¯¯ï¼šæ²¡æœ‰ç½‘ç»œè¿æ¥ã€‚å®‰è£…ç³»ç»Ÿå¿…é¡»è”ç½‘ä¸‹è½½ã€‚${NC}"
        echo "è¯·æ‰“å¼€ WiFi æˆ–æ•°æ®æµé‡ï¼Œå»ºè®®å¼€å¯ VPNã€‚"
        read -p "æŒ‰å›è½¦è¿”å›..."
        return
    fi

    echo "1. Ubuntu (æ¨èï¼Œæœ€ç¨³å®š)"
    echo "2. Debian (è½»é‡)"
    echo "3. ArchLinux (æŠ˜è…¾)"
    echo "0. è¿”å›"
    read_input
    
    case "$CHOICE" in
        1) TARGET="ubuntu" ;;
        2) TARGET="debian" ;;
        3) TARGET="archlinux" ;;
        0) return ;;
        *) echo "${R}è¾“å…¥é”™è¯¯${NC}"; sleep 1; return ;;
    esac

    if [ -d "$ROOTFS/$TARGET" ]; then
        echo "${Y}æç¤ºï¼šè¯¥ç³»ç»Ÿå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤å®‰è£…ã€‚${NC}"
        read -p "æŒ‰å›è½¦è¿”å›..."
        return
    fi

    echo "${Y}æ­£åœ¨æ¸…ç†ç¼“å­˜å¹¶é‡ç½®ç¯å¢ƒ...${NC}"
    proot-distro reset "$TARGET" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"

    echo "${C}å¼€å§‹ä¸‹è½½... (å¦‚æœè¿›åº¦æ¡å¡ä½ï¼Œè¯·æŒ‚ VPN)${NC}"
    if proot-distro install "$TARGET"; then
        # æ ¸å¿ƒï¼šå°¸æ£€é€»è¾‘
        if [ ! -f "$ROOTFS/$TARGET/bin/sh" ]; then
            echo "${R}ä¸¥é‡é”™è¯¯ï¼šä¸‹è½½æ–‡ä»¶ä¸å®Œæ•´ï¼ˆå˜æˆäº†ç©ºå£³ç³»ç»Ÿï¼‰ã€‚${NC}"
            echo "åŸå› ï¼šç½‘ç»œè¿æ¥ä¸­æ–­ã€‚"
            echo "æ­£åœ¨è‡ªåŠ¨åˆ é™¤æŸåçš„æ–‡ä»¶..."
            proot-distro remove "$TARGET"
            read -p "æŒ‰å›è½¦è¿”å›..."
            return
        fi
        
        create_worker
        echo "${G}ä¸‹è½½æˆåŠŸï¼æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–é…ç½®...${NC}"
        run_task "$TARGET" "æ›´æ¢å›½å†…é«˜é€Ÿæº" "src"
        run_task "$TARGET" "è®¾ç½®ä¸­æ–‡ç¯å¢ƒ" "cn"
        run_task "$TARGET" "æ¸…ç†å†—ä½™é…ç½®" "clean"
        
        echo "${G}å®‰è£…å…¨éƒ¨å®Œæˆï¼${NC}"
    else
        echo "${R}å®‰è£…å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚${NC}"
    fi
    read -p "æŒ‰å›è½¦è¿”å›..."
}

# [3] ç™»å½•é€»è¾‘
do_login() {
    local sys=$(get_systems | head -n 1)
    if [ -z "$sys" ]; then
        echo "${R}æœªæ£€æµ‹åˆ°å·²å®‰è£…çš„ç³»ç»Ÿã€‚è¯·å…ˆå®‰è£…ã€‚${NC}"
        read -p "æŒ‰å›è½¦è¿”å›..."
        return
    fi
    
    # å†æ¬¡å°¸æ£€
    if [ ! -f "$ROOTFS/$sys/bin/sh" ]; then
        echo "${R}ç³»ç»Ÿæ–‡ä»¶æŸåï¼Œæ— æ³•å¯åŠ¨ã€‚å»ºè®®åˆ é™¤é‡è£…ã€‚${NC}"
        read -p "æŒ‰å›è½¦è¿”å›..."
        return
    fi

    # å¯åŠ¨
    clear
    echo "${G}æ­£åœ¨è¿›å…¥ $sys ...${NC}"
    # ä½¿ç”¨ä¸€æ¬¡æ€§å‘½ä»¤æ˜¾ç¤ºä¿¡æ¯ï¼Œä¸æ±¡æŸ“é…ç½®æ–‡ä»¶
    proot-distro login "$sys" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; else echo 'Welcome to $sys'; fi; exec bash"
}

# [4] æ¡Œé¢é€»è¾‘ (å…¼å®¹æ€§ä¿®å¤)
do_gui() {
    local sys=$(get_systems | head -n 1)
    if [ -z "$sys" ]; then echo "${R}è¯·å…ˆå®‰è£…ç³»ç»Ÿ${NC}"; read -p "å›è½¦..."; return; fi
    
    create_worker
    echo "${Y}æ­£åœ¨æ£€æŸ¥æ¡Œé¢ç¯å¢ƒ...${NC}"
    # æ£€æµ‹æ˜¯å¦å®‰è£…äº†æ¡Œé¢ï¼Œæ²¡è£…å°±è‡ªåŠ¨è£…
    if ! proot-distro login "$sys" -- command -v startxfce4 >/dev/null 2>&1; then
        echo "${C}åˆæ¬¡å¯åŠ¨éœ€è¦å®‰è£…æ¡Œé¢ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ...${NC}"
        run_task "$sys" "å®‰è£… XFCE4 æ¡Œé¢" "gui"
    fi

    clear
    echo "=== å¯åŠ¨æ¡Œé¢ ==="
    echo "1. æœ¬åœ°æ¨¡å¼ (Termux:X11 APP)"
    echo "2. è¿œç¨‹æ¨¡å¼ (VNC Viewer)"
    read_input
    
    if [ "$CHOICE" == "1" ]; then
        # å¼ºåŠ›æ¸…ç†
        pkill -9 termux-x11 >/dev/null 2>&1
        rm -rf "$PREFIX/tmp/.X11-unix"
        
        echo "${Y}æ­£åœ¨å°è¯•å”¤èµ· Termux:X11 APP...${NC}"
        echo "(å¦‚æœæ‰‹æœºæ²¡ååº”ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€ Termux:X11)"
        
        # ç›²å¯åŠ¨ï¼Œä¸ä¾èµ– pm checkï¼Œè§£å†³å®‰å“12+æƒé™é—®é¢˜
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        
        sleep 2
        echo "${G}æ­£åœ¨å¯åŠ¨å›¾å½¢å¼•æ“...${NC}"
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$sys" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        
    elif [ "$CHOICE" == "2" ]; then
        echo "${Y}æ­£åœ¨å¯åŠ¨ VNC æœåŠ¡...${NC}"
        proot-distro login "$sys" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo ""
        echo "${G}âœ… å¯åŠ¨æˆåŠŸ${NC}"
        echo "åœ°å€: 127.0.0.1:5901"
        echo "å¯†ç : 123456"
        read -p "æŒ‰å›è½¦è¿”å›..."
    fi
}

# [5] SSH ç®¡ç†
do_ssh() {
    clear
    echo "=== SSH è¿œç¨‹ç®¡ç† ==="
    
    # è·å–çŠ¶æ€
    if pgrep sshd >/dev/null; then
        echo "çŠ¶æ€: ${G}æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo "çŠ¶æ€: ${R}å·²åœæ­¢${NC}"
    fi
    
    # è·å–IP
    MYIP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://')
    USER=$(whoami)
    
    echo "æœ¬æœº IP: ${C}$MYIP${NC}"
    echo "ç”¨æˆ·å : ${C}$USER${NC}"
    echo "------------------"
    echo "1. å¯åŠ¨æœåŠ¡"
    echo "2. åœæ­¢æœåŠ¡"
    echo "3. ä¿®æ”¹å¯†ç "
    echo "0. è¿”å›"
    read_input
    
    case "$CHOICE" in
        1) 
            pkill sshd; sshd
            echo "${G}æœåŠ¡å·²å¯åŠ¨ï¼${NC}"
            echo "ç”µè„‘è¿æ¥å‘½ä»¤: ssh -p 8022 $USER@$MYIP"
            read -p "å›è½¦..." ;;
        2)
            pkill sshd; echo "${R}æœåŠ¡å·²åœæ­¢${NC}"; read -p "å›è½¦..." ;;
        3)
            passwd; read -p "å›è½¦..." ;;
        0) return ;;
    esac
}

# [6] å¤‡ä»½è¿˜åŸ
do_backup() {
    local sys=$(get_systems | head -n 1)
    if [ -z "$sys" ]; then echo "æ— ç³»ç»Ÿ"; read -p "å›è½¦..."; return; fi
    
    clear
    echo "=== å¤‡ä»½ä¸è¿˜åŸ ==="
    echo "1. å¤‡ä»½å½“å‰ç³»ç»Ÿ ($sys)"
    echo "2. ä»æ–‡ä»¶è¿˜åŸ"
    echo "0. è¿”å›"
    read_input
    
    if [ "$CHOICE" == "1" ]; then
        echo "${Y}æ­£åœ¨æ‰“åŒ…ç³»ç»Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...${NC}"
        cd "$ROOTFS/$sys"
        tar -czf "$BACKUP_DIR/backup_$sys.tar.gz" --exclude='tmp/*' --exclude='proc/*' .
        echo "${G}å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶åœ¨: $BACKUP_DIR${NC}"
        read -p "å›è½¦..."
    elif [ "$CHOICE" == "2" ]; then
        echo "å¯ç”¨å¤‡ä»½æ–‡ä»¶:"
        ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null
        echo ""
        read -p "è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶å: " fname
        if [ -f "$BACKUP_DIR/$fname" ]; then
            read -p "è¯·è¾“å…¥æ–°ç³»ç»Ÿåç§° (ä¾‹å¦‚ my_restore): " newname
            mkdir -p "$ROOTFS/$newname"
            echo "${Y}æ­£åœ¨è§£å‹...${NC}"
            tar -xzf "$BACKUP_DIR/$fname" -C "$ROOTFS/$newname"
            # æ³¨å†Œ
            echo "plug_in_proot=1" > "$PREFIX/etc/proot-distro/$newname.sh"
            echo "${G}è¿˜åŸæˆåŠŸï¼${NC}"
        else
            echo "${R}æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        fi
        read -p "å›è½¦..."
    fi
}

# [7] åˆ é™¤ç³»ç»Ÿ
do_del() {
    local sys=$(get_systems | head -n 1)
    if [ -z "$sys" ]; then echo "æ— ç³»ç»Ÿ"; read -p "å›è½¦..."; return; fi
    
    echo "${R}è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤ $sys å—ï¼Ÿæ•°æ®å°†ä¸¢å¤±ï¼${NC}"
    read -p "ç¡®è®¤åˆ é™¤è¯·è¾“å…¥ y : " confirm
    if [ "$confirm" == "y" ]; then
        proot-distro remove "$sys"
        rm -rf "$ROOTFS/$sys"
        echo "å·²åˆ é™¤ã€‚"
    fi
    read -p "å›è½¦..."
}

# --- ä¸»å¾ªç¯ ---
check_deps

while true; do
    clear
    echo -e "${C}=== XXY v7.0 ç£çŸ³ç‰ˆ (LTS) ===${NC}"
    echo "1. è¿›å…¥ç³»ç»Ÿ (Login)"
    echo "2. å®‰è£…ç³»ç»Ÿ (Install)"
    echo "3. å¯åŠ¨æ¡Œé¢ (GUI)"
    echo "4. SSH ç®¡ç† (Remote)"
    echo "5. å¤‡ä»½è¿˜åŸ (Backup)"
    echo "6. åˆ é™¤ç³»ç»Ÿ (Delete)"
    echo "0. é€€å‡ºç¨‹åº (Exit)"
    echo "------------------------"
    
    # è·å–å½“å‰ç³»ç»ŸçŠ¶æ€
    CUR_SYS=$(get_systems | head -n 1)
    if [ -n "$CUR_SYS" ]; then
        echo -e "å½“å‰å·²è£…: ${G}$CUR_SYS${NC}"
    else
        echo -e "å½“å‰å·²è£…: ${R}æ— ${NC}"
    fi
    echo "------------------------"
    
    read_input
    
    case "$CHOICE" in
        1) do_login ;;
        2) do_install ;;
        3) do_gui ;;
        4) do_ssh ;;
        5) do_backup ;;
        6) do_del ;;
        0) exit 0 ;;
        *) echo "æ— æ•ˆè¾“å…¥"; sleep 0.5 ;;
    esac
done
EOF

# --- [3. å®Œæˆ] ---
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;32mâœ… v7.0 ç£çŸ³ç‰ˆ (LTS) å·²å®‰è£…\033[0m"
echo -e "-------------------------------------------"
echo -e "1. å·²ç§»é™¤æ‰€æœ‰ä¸ç¨³å®šUIï¼Œç•Œé¢ç»å¯¹ç¨³å›º"
echo -e "2. ä¿®å¤äº†å®‰å“11+æ— æ³•å¯åŠ¨æ¡Œé¢çš„é—®é¢˜"
echo -e "3. ä¿®å¤äº†é‡å¤è¾“å…¥ fastfetch çš„é—®é¢˜"
echo -e "-------------------------------------------"
echo -e "è¾“å…¥ \033[1;33mxxy\033[0m å¯åŠ¨ã€‚"

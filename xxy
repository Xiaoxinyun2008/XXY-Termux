# 1. æ·±åº¦æ¸…ç†ç¯å¢ƒ (é˜²æ­¢æ—§ç‰ˆæ®‹ç•™å¹²æ‰°)
rm -f $PREFIX/bin/xxy
rm -f $PREFIX/tmp/xxy_*
rm -rf $PREFIX/tmp/.X11-unix
rm -rf $PREFIX/tmp/.X1-lock

# 2. å†™å…¥ v35.1 ç¨³å®šç‰ˆ
cat > $PREFIX/bin/xxy << 'INSTALL_EOF'
#!/data/data/com.termux/files/usr/bin/bash
# ==============================================================================
# PROJECT: XXY (Ultimate Edition v35.1)
# FIX: å¼ºå¥æ›´æ–°é€»è¾‘ã€IPè·å–ä¿®å¤ã€VNCæƒé™ä¿®æ­£ã€å†…å­˜è¯»å–å®¹é”™
# ==============================================================================

# --- 0. å…¨å±€é…ç½® ---
export VERSION="v35.1"
export UPDATE_URL="https://raw.githubusercontent.com/Xiaoxinyun2008/XXY-Termux/main/xxy"
export GITHUB_LINK="github.com/Xiaoxinyun2008/XXY-Termux"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export ROOTFS_DIR="$PREFIX/var/lib/proot-distro/installed-rootfs"
export TERMUX_PKG_OPTS="-y -o Dpkg::Options::=--force-confnew" 

[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); P=$(tput setaf 5); C=$(tput setaf 6)
W=$(tput setaf 7); GR=$(tput setaf 8); NC=$(tput sgr0)

# å¼‚å¸¸æ•è·ä¸æ¸…ç†
cleanup() {
    tput cnorm
    stty echo
    rm -f "$TMPDIR"/xxy_* 2>/dev/null
}
trap cleanup EXIT INT TERM

# --- 1. åŸºç¡€å·¥å…·å‡½æ•° ---

# [ä¿®å¤] è·å–æœ¬æœº IP (å¤šé‡å›é€€æœºåˆ¶)
get_ip() {
    local ip=""
    # æ–¹æ³•1: ä½¿ç”¨ ip route (æ›´ç°ä»£ï¼Œå‡†ç¡®ç‡é«˜)
    if command -v ip >/dev/null; then
        ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{print $7}')
    fi
    # æ–¹æ³•2: å›é€€åˆ° ifconfig
    if [ -z "$ip" ] && command -v ifconfig >/dev/null; then
        ip=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://')
    fi
    echo "${ip:-127.0.0.1}"
}

# 1.1 ä¾èµ–å…¨é‡è‡ªæ£€
check_dependencies() {
    if [ -f "$PREFIX/etc/xxy_checked" ]; then return; fi

    clear
    echo -e "${C}=== XXY ç¯å¢ƒåˆå§‹åŒ– (é¦–æ¬¡è¿è¡Œ) ===${NC}"
    echo -e "${GR}æ­£åœ¨æ£€æµ‹ä¾èµ–å®Œæ•´æ€§...${NC}"
    
    # å¢åŠ  iproute2 ç”¨äºè·å– IP
    DEPS="proot-distro pulseaudio wget curl ncurses-utils grep sed awk fastfetch"
    
    # æ£€æŸ¥ fastfetch
    if ! command -v fastfetch &>/dev/null; then
        echo -e "${Y}âš¡ æ­£åœ¨å®‰è£… Fastfetch...${NC}"
        pkg install fastfetch $TERMUX_PKG_OPTS >/dev/null 2>&1
    fi

    MISSING=""
    for dep in $DEPS; do
        if ! command -v $dep &>/dev/null; then MISSING="$MISSING $dep"; fi
    done

    # ç‰¹æ®Šæ£€æŸ¥ X11
    if ! command -v termux-x11 &>/dev/null; then
        echo -e "${Y}ğŸ“¦ æ­£åœ¨åˆå§‹åŒ– X11 ä»“åº“...${NC}"
        pkg install x11-repo $TERMUX_PKG_OPTS >/dev/null 2>&1
        MISSING="$MISSING termux-x11-nightly"
    fi

    if [ -n "$MISSING" ]; then
        echo -e "${P}ğŸ› ï¸  æ­£åœ¨è¡¥å…¨ç»„ä»¶...${NC}"
        pkg update -y >/dev/null 2>&1
        pkg install $MISSING $TERMUX_PKG_OPTS
        if [ $? -ne 0 ]; then
            echo -e "${R}âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·åˆ‡æ¢æºæˆ–æ£€æŸ¥ç½‘ç»œï¼${NC}"
            exit 1
        fi
    fi
    
    touch "$PREFIX/etc/xxy_checked"
}

# --- 2. å®¹å™¨æ ¸å¿ƒé€»è¾‘ ---

WORKER_SCRIPT="$TMPDIR/xxy_worker_$$.sh"
INJECT_SCRIPT="$TMPDIR/xxy_inject_$$.sh"

create_worker_script() {
    rm -f "$WORKER_SCRIPT"
    cat << 'EOF' > "$WORKER_SCRIPT"
#!/bin/sh
# å¼ºåˆ¶è®¾ç½® PATH é˜²æ­¢éƒ¨åˆ†å‘è¡Œç‰ˆæ‰¾ä¸åˆ°å‘½ä»¤
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
action=$1

is_debian=false; is_arch=false; is_alpine=false

if command -v apt >/dev/null; then
    INSTALL="apt install -y"; UPDATE="apt update -y"; is_debian=true
elif command -v pacman >/dev/null; then
    INSTALL="pacman -S --noconfirm"; UPDATE="pacman -Sy --noconfirm"; is_arch=true
elif command -v apk >/dev/null; then
    INSTALL="apk add"; UPDATE="apk update"; is_alpine=true
else
    echo "Unknown OS"; exit 1
fi

case "$action" in
  change_source)
    if [ "$is_debian" = true ]; then
        # é’ˆå¯¹ Ubuntu å’Œ Debian è¿›è¡Œæ›´é€šç”¨çš„æ›¿æ¢
        sed -i 's/http:\/\/.*archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null
        sed -i 's/http:\/\/ports.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null
        sed -i 's/http:\/\/deb.debian.org/http:\/\/mirrors.ustc.edu.cn/g' /etc/apt/sources.list 2>/dev/null
    elif [ "$is_alpine" = true ]; then
        sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
    fi
    $UPDATE
    ;;

  install_gui)
    if [ "$is_debian" = true ]; then
        DEBIAN_FRONTEND=noninteractive $INSTALL xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$is_arch" = true ]; then
        $INSTALL xfce4 dbus tigervnc
    elif [ "$is_alpine" = true ]; then
        $INSTALL xfce4 dbus-x11 tigervnc
    fi
    
    # å¼ºåˆ¶ä¿®æ­£ VNC ç›®å½•æƒé™
    mkdir -p ~/.vnc
    echo "123456" | vncpasswd -f > ~/.vnc/passwd
    chmod 600 ~/.vnc/passwd
    ;;

  install_fastfetch)
    $INSTALL fastfetch || $INSTALL neofetch
    if command -v fastfetch >/dev/null; then echo "fastfetch" > /tmp/fetch_bin
    elif command -v neofetch >/dev/null; then echo "neofetch" > /tmp/fetch_bin
    else echo "none" > /tmp/fetch_bin; fi
    ;;
    
  install_cn)
    if [ "$is_debian" = true ]; then
        DEBIAN_FRONTEND=noninteractive $INSTALL locales fonts-noto-cjk ttf-wqy-zenhei
        echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen && locale-gen
        echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/xxy_lang.sh
    fi
    ;;
esac
EOF
    chmod 755 "$WORKER_SCRIPT"
}

get_systems() {
    if [ -d "$ROOTFS_DIR" ]; then
        ls -1 "$ROOTFS_DIR" 2>/dev/null
    fi
}

run_task() {
    local sys=$1; local cmd=$2; local desc=$3
    local inner_script="/tmp/$(basename "$WORKER_SCRIPT")"
    
    tput cup 20 0
    echo -ne "${Y}âš™ï¸  [$sys] $desc...${NC}"
    # æ•è·é”™è¯¯è¾“å‡ºï¼Œé˜²æ­¢åˆ·å±
    if proot-distro login "$sys" --shared-tmp -- /bin/sh "$inner_script" "$cmd" >/dev/null 2>&1; then
        tput cup 20 0
        echo -ne "${G}âœ… [$sys] $desc å®Œæˆ          ${NC}"
    else
        tput cup 20 0
        echo -ne "${R}âŒ [$sys] $desc å¤±è´¥ (è¯¦è§æ—¥å¿—)  ${NC}"
    fi
}

select_menu() {
    mapfile -t SYS_ARRAY < <(get_systems)
    if [ ${#SYS_ARRAY[@]} -eq 0 ]; then
        echo -e "\n${R}âš ï¸  æœªæ£€æµ‹åˆ°æœ¬åœ°ç³»ç»Ÿï¼${NC} (è¯·å…ˆ [2] å®‰è£…)"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
        return 1
    fi
    for i in "${!SYS_ARRAY[@]}"; do echo -e "${G}$((i+1)).${NC} ${SYS_ARRAY[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    tput cnorm; stty echo; read -p "ğŸ‘‰ åºå·: " choice; stty -echo; tput civis
    if [ "$choice" == "0" ] || [ -z "$choice" ]; then return 1; fi
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#SYS_ARRAY[@]}" ]; then
        echo "${SYS_ARRAY[$((choice-1))]}"
        return 0
    fi
    return 1
}

# --- 3. åŠŸèƒ½æ¨¡å— ---

do_login() {
    clear; echo -e "${C}=== ç™»å½•ç³»ç»Ÿ ===${NC}"
    TARGET=$(select_menu) || return
    create_worker_script
    local inner_script="/tmp/$(basename "$WORKER_SCRIPT")"
    local inner_inject="/tmp/$(basename "$INJECT_SCRIPT")"
    
    echo -e "${B}æ­£åœ¨é…ç½®å¯åŠ¨ç¯å¢ƒ...${NC}"
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$inner_script" "install_fastfetch" >/dev/null 2>&1
    
    cat > "$INJECT_SCRIPT" << 'EOF'
RC=~/.bashrc
[ -f /etc/profile.d/xxy_lang.sh ] && . /etc/profile.d/xxy_lang.sh
if [ -f /tmp/fetch_bin ]; then
    TOOL=$(cat /tmp/fetch_bin)
    rm -f /tmp/fetch_bin
    if [ "$TOOL" != "none" ] && ! grep -q "$TOOL" "$RC" 2>/dev/null; then
        echo "" >> "$RC"; echo "clear" >> "$RC"; echo "$TOOL" >> "$RC"
    fi
fi
EOF
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$inner_inject" >/dev/null 2>&1
    cleanup; proot-distro login "$TARGET"; tput civis; stty -echo; draw_ui
}

do_install() {
    clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ (è‡ªåŠ¨ä¼˜åŒ–) ===${NC}"
    DISTROS=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!DISTROS[@]}"; do echo -e "${W}$((i+1)).${NC} ${DISTROS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    tput cnorm; stty echo; read -p "ğŸ‘‰ é€‰æ‹©: " idx; stty -echo; tput civis
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#DISTROS[@]}" ]; then
        TARGET=${DISTROS[$((idx-1))]}
        echo -e "\n${Y}æ­£åœ¨ä¸‹è½½ $TARGET...${NC}"; tput cnorm
        if proot-distro install $TARGET; then
            tput civis
            create_worker_script
            run_task "$TARGET" "change_source" "æ›´æ¢å›½å†…æº"
            run_task "$TARGET" "install_cn" "ä¸­æ–‡ç¯å¢ƒ"
            run_task "$TARGET" "install_fastfetch" "å®‰è£…å·¥å…·"
            echo -e "\n${G}ğŸ‰ å®‰è£…å®Œæˆï¼ç³»ç»Ÿå·²ä¼˜åŒ–ã€‚${NC}"; read -n 1 -s -r -p "..."
        else
            echo -e "\n${R}âŒ å®‰è£…å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œã€‚${NC}"; read -n 1 -s -r -p "..."
        fi
    fi
}

do_gui() {
    clear; echo -e "${C}=== å¯åŠ¨æ¡Œé¢ ===${NC}"
    TARGET=$(select_menu) || return
    create_worker_script
    
    echo -ne "ğŸ” æ£€æŸ¥æ¡Œé¢ç»„ä»¶...\r"
    if ! proot-distro login "$TARGET" -- bash -c "command -v startxfce4" >/dev/null 2>&1; then
        run_task "$TARGET" "install_gui" "å®‰è£… XFCE4 + VNC"
    fi

    echo -e "\n${G}é€‰æ‹©æ¨¡å¼:${NC}"
    echo -e "1. Termux:X11 ${Y}(é«˜æ€§èƒ½/æ¨è)${NC}"
    echo -e "2. VNC Viewer ${B}(æ”¯æŒç”µè„‘è¿æ¥)${NC}"
    echo -e "0. è¿”å›"
    tput cnorm; stty echo; read -p "æ¨¡å¼: " m; stty -echo; tput civis
    
    if [ "$m" == "1" ]; then
        pulseaudio --kill >/dev/null 2>&1; pkill -f com.termux.x11 >/dev/null 2>&1
        rm -rf "$TMPDIR/.X11-unix" 
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; sleep 1
        termux-x11 :0 >/dev/null 2>&1 &
        proot-distro login "$TARGET" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        
    elif [ "$m" == "2" ]; then
        LOCAL_IP=$(get_ip)
        echo -e "${Y}ğŸš€ æ­£åœ¨å¯åŠ¨ VNC Server...${NC}"
        CMD="vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X1-lock /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        proot-distro login "$TARGET" -- bash -c "$CMD"
        echo -e "\n${G}=== VNC å·²å¯åŠ¨ ===${NC}"
        echo -e "æ‰‹æœºè¿æ¥: ${W}127.0.0.1:5901${NC}"
        echo -e "ç”µè„‘è¿æ¥: ${W}${LOCAL_IP}:5901${NC}"
        echo -e "é»˜è®¤å¯†ç : ${W}123456${NC}"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# [F5] æ›´æ–°åŠŸèƒ½ (å¼ºå¥é€»è¾‘ä¿®å¤)
do_update() {
    clear; echo -e "${C}=== æ£€æŸ¥æ›´æ–° ===${NC}"
    echo -ne "${B}è¿æ¥æœåŠ¡å™¨...${NC}\r"
    
    # 1. ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ä¸‹è½½ï¼Œé¿å…ç ´ååŸæ–‡ä»¶
    local temp_file="$TMPDIR/xxy_update_tmp"
    rm -f "$temp_file"
    
    # 2. ä»…æ£€æµ‹ header é¿å…ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ (å¦‚æœæ”¯æŒ) æˆ–ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶
    HTTP_CODE=$(curl -s -o "$temp_file" -w "%{http_code}" "$UPDATE_URL")
    
    if [ "$HTTP_CODE" != "200" ]; then
        echo -e "\n${R}âŒ è¿æ¥å¤±è´¥ (HTTP $HTTP_CODE)${NC}"
        echo "è¯·æ£€æŸ¥ç½‘ç»œæˆ– GitHub è¿æ¥çŠ¶æ€ã€‚"
        read -n 1 -s -r -p "..."
        return
    fi

    # 3. éªŒè¯ä¸‹è½½çš„å†…å®¹æ˜¯å¦ä¸ºè„šæœ¬ (é˜²æ­¢ä¸‹è½½åˆ° 404 é¡µé¢ HTML)
    if ! grep -q "PROJECT: XXY" "$temp_file"; then
        echo -e "\n${R}âŒ æ ¡éªŒå¤±è´¥ï¼šä¸‹è½½çš„æ–‡ä»¶æ— æ•ˆã€‚${NC}"
        read -n 1 -s -r -p "..."
        return
    fi

    # 4. æå–ç‰ˆæœ¬å·
    REMOTE_VER=$(grep "export VERSION=" "$temp_file" | cut -d'"' -f2)

    if [[ "$REMOTE_VER" != "$VERSION" ]]; then
        echo -e "\n${Y}ğŸš€ å‘ç°æ–°ç‰ˆæœ¬: $REMOTE_VER${NC}"
        echo -e "å½“å‰ç‰ˆæœ¬: $VERSION"
        tput cnorm; stty echo
        read -p "ç¡®è®¤æ›´æ–°? (y/n): " confirm
        stty -echo; tput civis
        
        if [[ "$confirm" == "y" ]]; then
            echo -e "${G}æ­£åœ¨åº”ç”¨æ›´æ–°...${NC}"
            # 5. å®‰å…¨è¦†ç›–
            mv "$temp_file" "$PREFIX/bin/xxy"
            chmod 755 "$PREFIX/bin/xxy"
            echo -e "${G}æ›´æ–°æˆåŠŸï¼è¯·é‡å¯è„šæœ¬ã€‚${NC}"
            exit 0
        fi
    else
        echo -e "\n${G}âœ… å½“å‰å·²æ˜¯æœ€æ–° ($VERSION)${NC}"
    fi
    rm -f "$temp_file"
    read -n 1 -s -r -p "..."
}

# --- UI ç»˜åˆ¶ ---

update_status() {
    NOW=$(date "+%H:%M")
    IP=$(get_ip)
    # [ä¿®å¤] å†…å­˜è¯»å–å½»åº•å±è”½æŠ¥é”™ï¼ŒAndroid 12+ å…¼å®¹
    if (( FRAME % 50 == 0 )); then
        MEM=$(free -m 2>/dev/null | awk 'NR==2{printf "%.1fG", $3/1024}' || echo "N/A")
    fi
    
    tput cup 0 34; printf "${B}â•­â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 1 34; printf "${B}â”‚${NC} TIME: ${W}%-5s${NC} MEM: ${P}%-5s${NC}         ${B}â”‚${NC}" "$NOW" "$MEM"
    tput cup 2 34; printf "${B}â”‚${NC} IP: ${GR}%-15s${NC}             ${B}â”‚${NC}" "$IP"
    tput cup 3 34; printf "${B}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
}

draw_ui() {
    clear
    cat << EOF
${C}
â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— ${W}XXY Termux${C}
â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• ${GR}${VERSION}${C}
 â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  ${W}Ultimate${C}
 â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•   ${NC}
${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}
${GR}â”‚${NC} ${W}1.${NC} ç™»å½•ç³»ç»Ÿ (Login)    ${GR}â”‚${NC} ${W}3.${NC} å¯åŠ¨æ¡Œé¢ (GUI)
${GR}â”‚${NC} ${W}2.${NC} å®‰è£…ç³»ç»Ÿ (Install)  ${GR}â”‚${NC} ${W}5.${NC} æ£€æŸ¥æ›´æ–° (Update)
${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}
${GR}ğŸ”— GitHub: ${W}${GITHUB_LINK}${NC}
EOF
    if command -v fastfetch >/dev/null; then
        fastfetch --config structure:OS:Kernel --logo none 2>/dev/null | sed 's/^/  /'
    fi
}

# --- ä¸»å¾ªç¯ ---
check_dependencies
create_worker_script
tput civis; stty -echo
draw_ui; INPUT_BUF=""
FRAME=0; MEM="Wait"

while true; do
    update_status
    ((FRAME++))
    tput cup 14 0; echo -ne "${C}â¤ è¯·è¾“å…¥åºå·: ${W}${INPUT_BUF}_        ${NC}"
    read -t 0.05 -n 1 key
    if [[ $? -eq 0 ]]; then
        if [[ -z "$key" ]]; then
            if [[ -n "$INPUT_BUF" ]]; then
                case $INPUT_BUF in
                    1) do_login ;;
                    2) do_install ;;
                    3) do_gui ;;
                    5) do_update ;;
                    0) exit 0 ;;
                esac
                tput civis; stty -echo; draw_ui; INPUT_BUF=""
            fi
        elif [[ "$key" == $'\x7f' || "$key" == $'\b' ]]; then
            INPUT_BUF="${INPUT_BUF%?}"
        elif [[ "$key" == $'\e' ]]; then
            read -t 0.01 -n 2
        else
            INPUT_BUF="$INPUT_BUF$key"
        fi
    fi
done
INSTALL_EOF

chmod 755 $PREFIX/bin/xxy
sed -i 's/\r$//' $PREFIX/bin/xxy
echo -e "\033[1;32mâœ… XXY v35.1 å‡çº§å®Œæˆï¼\nå¼ºåŒ–äº†æ›´æ–°éªŒè¯å’Œç³»ç»Ÿå…¼å®¹æ€§ã€‚\nè¾“å…¥ xxy å¯åŠ¨ã€‚\033[0m"
exec xxy

#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v32.0 ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®±
# æ•´åˆï¼šShizukuè‡ªåŠ¨ä¿®å¤ | å¤šå‘è¡Œç‰ˆæ”¯æŒ | VSCode | äºŒçº§èœå•
# ==============================================================================

# --- [0] å…¨å±€é…ç½® ---
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export CONFIG_FILE="$HOME/.xxy_config"
export TMP_WORKER="$PREFIX/tmp/worker_script.sh"

# è¯»å–ä¸Šæ¬¡ä½¿ç”¨çš„å‘è¡Œç‰ˆï¼Œé»˜è®¤ä¸º debian
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
    export DISTRO_NAME="debian"
fi

export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs/$DISTRO_NAME"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# ä¿¡å·æ•è·
trap 'echo -e "\n${G}[XXY] å·²å®‰å…¨é€€å‡ºã€‚${NC}"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒæ¨¡å—ï¼šå®¹å™¨å†…éƒ¨æ„å»ºè„šæœ¬ (Worker)
# ==============================================================================
create_worker_script() {
    local target_distro="$1"
    mkdir -p "$PREFIX/tmp"
    
    cat > "$TMP_WORKER" << EOF
#!/bin/bash
set -e

DISTRO="$target_distro"
echo ">>> [å†…éƒ¨] æ­£åœ¨é…ç½®å›½å†…æº (Distro: \$DISTRO)..."

# æ™ºèƒ½æ¢æº
if [[ "\$DISTRO" == "debian" ]]; then
    sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
    sed -i 's/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
elif [[ "\$DISTRO" == "ubuntu" ]]; then
    sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
    sed -i 's/archive.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
elif [[ "\$DISTRO" == "kali" ]]; then
    sed -i 's/http.kali.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
fi

# ä»…é’ˆå¯¹ APT ç³»ç»Ÿè¿›è¡Œåç»­é…ç½®
if [[ "\$DISTRO" == "debian" ]] || [[ "\$DISTRO" == "ubuntu" ]] || [[ "\$DISTRO" == "kali" ]]; then
    echo ">>> [å†…éƒ¨] æ­£åœ¨å®‰è£…æ¡Œé¢å’Œç”Ÿäº§åŠ›å·¥å…· (è€—æ—¶è¾ƒé•¿)..."
    apt update -y
    export DEBIAN_FRONTEND=noninteractive

    # åŸºç¡€å·¥å…·
    apt install -y sudo nano wget curl git build-essential python3-full

    # æ¡Œé¢ç¯å¢ƒ & å·¥å…· (XFCE4)
    apt install -y xfce4 xfce4-goodies xfce4-terminal dbus-x11 firefox-esr

    # å­—ä½“ & è¾“å…¥æ³•
    apt install -y fonts-noto-cjk fonts-noto-color-emoji \
        fcitx5 fcitx5-chinese-addons fcitx5-frontend-gtk4 fcitx5-frontend-gtk3 fcitx5-frontend-qt5 \
        im-config

    # ä¸­æ–‡ç¯å¢ƒ
    echo ">>> [å†…éƒ¨] ç”Ÿæˆä¸­æ–‡ Locale..."
    apt install -y locales
    sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
    locale-gen zh_CN.UTF-8
    update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

    # ç¯å¢ƒå˜é‡
    echo ">>> [å†…éƒ¨] é…ç½®ç¯å¢ƒå˜é‡..."
    cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
    chmod +x /etc/profile.d/xxy_env.sh

    # ä¿®å¤è¡¥ä¸
    echo ">>> [å†…éƒ¨] åº”ç”¨ Firefox/VSCode é˜²é—ªé€€è¡¥ä¸..."
    echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc
    mkdir -p /usr/share/applications
    sed -i 's/Exec=firefox-esr %u/Exec=firefox-esr --no-remote %u/g' /usr/share/applications/firefox-esr.desktop 2>/dev/null || true
    
    apt autoremove -y; apt clean
else
    echo ">>> [å†…éƒ¨] æ£€æµ‹åˆ°é Debian/Ubuntu/Kali ç³»ç»Ÿ..."
    echo ">>> [å†…éƒ¨] å·²è·³è¿‡è‡ªåŠ¨åŒ–æ¡Œé¢ç¯å¢ƒé…ç½®ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ã€‚"
fi

echo ">>> [å†…éƒ¨] ç¯å¢ƒæ„å»ºå®Œæˆï¼"
EOF
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸ”§ åŠŸèƒ½å‡½æ•°
# ==============================================================================

log() { echo -e "${G}[XXY] $1${NC}"; }
warn() { echo -e "${Y}[æç¤º] $1${NC}"; }
err() { echo -e "${R}[é”™è¯¯] $1${NC}"; }

# ä¿å­˜é…ç½®
save_config() {
    echo "DISTRO_NAME=\"$DISTRO_NAME\"" > "$CONFIG_FILE"
    export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs/$DISTRO_NAME"
}

# --- è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤ Shizuku ç¯å¢ƒ ---
auto_fix_shizuku() {
    log "æ­£åœ¨æ£€æŸ¥ Shizuku ç¯å¢ƒ..."
    
    # 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ä¸‹è½½ (ä½¿ç”¨å›½å†…æº)
    if [ ! -f "$PREFIX/bin/rish" ] || [ ! -f "$PREFIX/bin/rish_shizuku.dex" ]; then
        echo -e "${Y}>>> æ­£åœ¨ä¸‹è½½ rish ç»„ä»¶ (å›½å†…é«˜é€Ÿé•œåƒ)...${NC}"
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish" -o $PREFIX/bin/rish
        curl -sL "https://mirror.ghproxy.com/https://github.com/RikkaApps/Shizuku/releases/latest/download/rish_shizuku.dex" -o $PREFIX/bin/rish_shizuku.dex
        chmod +x $PREFIX/bin/rish
    fi

    # 2. å°è¯•æ‰§è¡Œ
    log "æ­£åœ¨å°è¯•é€šè¿‡ Shizuku è§£é™¤è¿›ç¨‹é™åˆ¶..."
    echo -e "${Y}âš ï¸  æ³¨æ„ï¼šå¦‚æœ Shizuku å¼¹å‡ºæˆæƒçª—å£ï¼Œè¯·åŠ¡å¿…ç‚¹å‡»ã€å§‹ç»ˆå…è®¸ã€‘ï¼${NC}"
    
    if $PREFIX/bin/rish -c "/system/bin/device_config put activity_manager max_phantom_processes 2147483647 && cmd appops set com.termux RUN_IN_BACKGROUND allow" 2>/dev/null; then
        echo -e "${G}âœ… ä¿®å¤æˆåŠŸï¼Termux å·²è·å¾—å…æ­»é‡‘ç‰Œã€‚${NC}"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
    else
        echo -e "${R}âŒ æˆæƒå¤±è´¥ã€‚${NC}"
        echo "å¯èƒ½åŸå› ï¼šShizuku æœªå¯åŠ¨ï¼Œæˆ–æœªæˆæƒã€‚"
        echo "è¯·ç¡®ä¿ Shizuku APP æ­£åœ¨è¿è¡Œï¼Œç„¶åå†è¯•ä¸€æ¬¡ã€‚"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# --- å®‰è£…ç³»ç»Ÿ ---
install_system() {
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€ [é€‰æ‹©å‘è¡Œç‰ˆ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "1. ${G}Debian${NC} (æ¨èï¼Œç¨³å®š)"
        echo -e "2. ${C}Ubuntu${NC} (æµè¡Œï¼Œè½¯ä»¶å¤š)"
        echo -e "3. ${R}Kali${NC}   (å®‰å…¨æµ‹è¯•)"
        echo -e "4. Arch Linux (ä»…åŸºç¡€å®‰è£…)"
        echo -e "5. Alpine     (è½»é‡çº§)"
        echo -e "0. è¿”å›"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        read -p "ğŸ‘‰ è¯·é€‰æ‹©: " dist_opt
        
        case "$dist_opt" in
            1) NEW_DISTRO="debian" ;;
            2) NEW_DISTRO="ubuntu" ;;
            3) NEW_DISTRO="kali" ;;
            4) NEW_DISTRO="archlinux" ;;
            5) NEW_DISTRO="alpine" ;;
            0) return ;;
            *) continue ;;
        esac
        break
    done

    DISTRO_NAME="$NEW_DISTRO"
    save_config
    
    clear
    log "=== æ­£åœ¨å®‰è£… $DISTRO_NAME ==="
    # æ£€æŸ¥ä¾èµ–
    pkg install proot-distro pulseaudio termux-x11-nightly virglrenderer-android android-tools -y -o Dpkg::Options::="--force-confnew"

    if [ -d "$ROOTFS" ]; then
        read -p "æ£€æµ‹åˆ°ç³»ç»Ÿå·²å­˜åœ¨ï¼Œæ˜¯å¦åˆ é™¤é‡è£…? (y/n): " opt
        if [ "$opt" != "y" ]; then return; fi
        proot-distro remove "$DISTRO_NAME"
    fi

    log "æ­£åœ¨ä¸‹è½½ç³»ç»Ÿé•œåƒ (è¯·ä¿æŒç½‘ç»œç•…é€š)..."
    rm -rf "$PREFIX/var/lib/proot-distro/dlcache/$DISTRO_NAME"
    
    if proot-distro install "$DISTRO_NAME"; then
        # å†™å…¥ DNS
        if [ -f "$ROOTFS/etc/resolv.conf" ]; then
            echo "nameserver 223.5.5.5" > "$ROOTFS/etc/resolv.conf"
        fi

        create_worker_script "$DISTRO_NAME"
        
        log "æ­£åœ¨è¿›å…¥å®¹å™¨è¿›è¡Œé…ç½®..."
        # åªæœ‰ apt ç±»ç³»ç»Ÿæ‰æ‰§è¡Œå®Œæ•´ worker
        if [[ "$DISTRO_NAME" =~ ^(debian|ubuntu|kali)$ ]]; then
             proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$TMP_WORKER"
        else
             # å¯¹äºå…¶ä»–ç³»ç»Ÿï¼Œåªåšç®€å•æç¤ºæˆ–æ‰§è¡ŒåŸºç¡€é…ç½®
             proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/sh "$TMP_WORKER"
        fi
        
        rm -f "$TMP_WORKER"
        log "ğŸ‰ ç³»ç»Ÿå®‰è£…å®Œæˆï¼å½“å‰é€‰æ‹©: $DISTRO_NAME"
    else
        err "ä¸‹è½½å¤±è´¥ã€‚è¯·å¼€å¯ VPN æˆ–æ£€æŸ¥ç½‘ç»œã€‚"
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- å®‰è£… VSCode ---
install_vscode() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    if [[ ! "$DISTRO_NAME" =~ ^(debian|ubuntu|kali)$ ]]; then
        err "VSCode ä¸€é”®å®‰è£…ç›®å‰ä»…æ”¯æŒ Debian/Ubuntu/Kaliã€‚"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
        return
    fi

    log "æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… VSCode (ARM64)..."
    
    # æ³¨å…¥å®‰è£…è„šæœ¬åˆ°å®¹å™¨
    cat > "$PREFIX/tmp/vscode_inst.sh" << 'EOF'
#!/bin/bash
cd /tmp
echo ">>> [å†…éƒ¨] ä¸‹è½½ VSCode.deb..."
wget -O code.deb "https://update.code.visualstudio.com/latest/linux-deb-arm64/stable"
echo ">>> [å†…éƒ¨] å®‰è£…ä¸­..."
apt install -y ./code.deb
rm code.deb
# ä¿®å¤å¯åŠ¨
echo ">>> [å†…éƒ¨] ä¿®å¤å¯åŠ¨å‚æ•°..."
echo 'alias code="code --no-sandbox --unity-launch"' >> /etc/bash.bashrc
mkdir -p /usr/share/applications
sed -i 's/Exec=\/usr\/share\/code\/code/Exec=\/usr\/share\/code\/code --no-sandbox/g' /usr/share/applications/code.desktop 2>/dev/null || true
echo "âœ… VSCode å®‰è£…å®Œæˆã€‚"
EOF
    proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$PREFIX/tmp/vscode_inst.sh"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- å¯åŠ¨æ¡Œé¢ ---
start_desktop() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    clear
    log "ğŸš€ æ­£åœ¨å¯åŠ¨ $DISTRO_NAME æ¡Œé¢ç¯å¢ƒ..."
    
    # æ¸…ç† & å¯åŠ¨æœåŠ¡
    killall -9 termux-x11 Xwayland pulseaudio virgl_test_server_android >/dev/null 2>&1
    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    
    termux-x11 :0 -ac &
    
    # ç­‰å¾… X11 å‡†å¤‡å°±ç»ª
    local count=0
    while [ ! -S "$PREFIX/tmp/.X11-unix/X0" ]; do
        sleep 0.2
        count=$((count+1))
        if [ $count -gt 30 ]; then err "Termux:X11 å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† APP"; return; fi
    done
    
    virgl_test_server_android &
    pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    
    log "æ­£åœ¨ç™»å…¥ç³»ç»Ÿ..."
    proot-distro login "$DISTRO_NAME" --shared-tmp -- bash -c "
        export DISPLAY=:0
        export PULSE_SERVER=127.0.0.1
        # å°è¯•å¯åŠ¨è¾“å…¥æ³• (ä»…é™é…ç½®è¿‡çš„ç³»ç»Ÿ)
        if command -v fcitx5 >/dev/null; then
             fcitx5 -d &
        fi
        
        # å¯åŠ¨æ¡Œé¢
        if command -v startxfce4 >/dev/null; then
            dbus-launch --exit-with-session startxfce4
        else
            echo 'âŒ æœªæ£€æµ‹åˆ°æ¡Œé¢ç¯å¢ƒï¼Œè¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼...'
            bash
        fi
    "
}

# ==============================================================================
# ğŸ“º èœå•ç³»ç»Ÿ (äºŒçº§èœå•è®¾è®¡)
# ==============================================================================

# äºŒçº§èœå•ï¼šå®‰è£…ç®¡ç†
menu_install() {
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€ [å®‰è£…ç®¡ç†] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "1. ${G}å®‰è£…æ–°ç³»ç»Ÿ${NC} (æ”¯æŒ Deb/Ubt/Kaliç­‰)"
        echo -e "2. ${C}å®‰è£… VSCode${NC} (éœ€ Debian/Ubuntu)"
        echo -e "3. å¸è½½å½“å‰ç³»ç»Ÿ ($DISTRO_NAME)"
        echo -e "0. è¿”å›ä¸Šä¸€çº§"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        read -p "ğŸ‘‰ é€‰æ‹©: " sub_opt
        case "$sub_opt" in
            1) install_system ;;
            2) install_vscode ;;
            3) 
               read -p "ç¡®å®šåˆ é™¤ $DISTRO_NAME å—? (y/n): " del_conf
               if [ "$del_conf" == "y" ]; then proot-distro remove "$DISTRO_NAME"; fi ;;
            0) return ;;
        esac
    done
}

# äºŒçº§èœå•ï¼šç»´æŠ¤å·¥å…·
menu_maintenance() {
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€ [ç»´æŠ¤å·¥å…·] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "1. ${Y}Shizuku é˜²é—ªé€€ä¿®å¤${NC} (å…¨è‡ªåŠ¨)"
        echo -e "2. æ¸…ç†ä¸‹è½½ç¼“å­˜ (ä¿®å¤å®‰è£…å¤±è´¥)"
        echo -e "3. å¤‡ä»½ç³»ç»Ÿ (æ‰“åŒ…ä¸º tar.gz)"
        echo -e "0. è¿”å›ä¸Šä¸€çº§"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        read -p "ğŸ‘‰ é€‰æ‹©: " sub_opt
        case "$sub_opt" in
            1) auto_fix_shizuku ;;
            2) rm -rf "$PREFIX/var/lib/proot-distro/dlcache"; log "å·²æ¸…ç†ã€‚"; sleep 1 ;;
            3) 
               log "æ­£åœ¨å¤‡ä»½ $DISTRO_NAME ..."
               mkdir -p "$HOME/xxy_backups"
               TIMESTAMP=$(date +%Y%m%d_%H%M%S)
               BACKUP_FILE="$HOME/xxy_backups/${DISTRO_NAME}_backup_${TIMESTAMP}.tar.gz"
               if proot-distro backup "$DISTRO_NAME" --output "$BACKUP_FILE"; then
                   log "âœ… å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜è‡³: $BACKUP_FILE"
               else
                   err "âŒ å¤‡ä»½å¤±è´¥ã€‚ç³»ç»Ÿå¯èƒ½æœªå®‰è£…ã€‚"
               fi
               read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
               ;;
            0) return ;;
        esac
    done
}

# ä¸»èœå•
main_menu() {
    # é¦–æ¬¡å¯åŠ¨è‡ªæ£€
    if [ ! -f "$PREFIX/etc/apt/sources.list.d/x11.list" ]; then pkg install x11-repo -y; fi
    
    while true; do
        clear
        echo -e "${B}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "${B}â”‚         XXY v32.0 ç»ˆæç”Ÿäº§åŠ›å·¥å…·ç®±      â”‚${NC}"
        echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        
        STATUS_MSG="${R}æœªå®‰è£…ç³»ç»Ÿ${NC}"
        if [ -d "$ROOTFS" ]; then
             STATUS_MSG="${G}$DISTRO_NAME å·²å°±ç»ª${NC}"
        fi
        
        echo -e "å½“å‰çŠ¶æ€: $STATUS_MSG"
        echo ""
        echo -e "1. ${G}ğŸš€ å¯åŠ¨æ¡Œé¢ç¯å¢ƒ${NC} (æ—¥å¸¸ä½¿ç”¨ç‚¹è¿™ä¸ª)"
        echo -e "2. ğŸ’¿ å®‰è£…/ç®¡ç†ç³»ç»Ÿ (äºŒçº§èœå•)"
        echo -e "3. ğŸ› ï¸ ç»´æŠ¤/é˜²é—ªé€€ä¿®å¤ (äºŒçº§èœå•)"
        echo -e "0. âŒ é€€å‡º"
        echo ""
        read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " main_opt
        
        case "$main_opt" in
            1) start_desktop ;;
            2) menu_install ;;
            3) menu_maintenance ;;
            0) exit 0 ;;
            *) ;;
        esac
    done
}

# --- å¯åŠ¨ ---
main_menu

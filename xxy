# 1. æ¸…ç†æ—§çš„æŠ¥é”™æ–‡ä»¶
rm -f $PREFIX/bin/xxy

# 2. ä½¿ç”¨æ‰å¹³åŒ–æ–¹å¼å†™å…¥æ–°è„šæœ¬ (ä¿®å¤äº†åµŒå¥— EOF å¯¼è‡´çš„è¯­æ³•é”™è¯¯)
cat > $PREFIX/bin/xxy << 'INSTALL_EOF'
#!/data/data/com.termux/files/usr/bin/bash
# ==============================================================================
# PROJECT: XXY (Safe Mode v32.1)
# FIX: Removed nested heredocs to prevent syntax errors
# ==============================================================================

# --- 0. ç¯å¢ƒè‡ªæ£€ ---
if [ ! -d "$PREFIX/tmp" ]; then mkdir -p "$PREFIX/tmp"; fi

# é€€å‡ºæ—¶æ¸…ç†
cleanup() {
    tput cnorm
    stty echo
    rm -f "$WORKER_SCRIPT" "$INJECT_SCRIPT" 2>/dev/null
}
trap cleanup EXIT INT TERM

# ä¾èµ–æ£€æŸ¥
if ! command -v proot-distro &>/dev/null; then
    echo "Installing dependencies..."
    pkg update -y && pkg install proot-distro pulseaudio wget curl ncurses-utils -y
fi

# å®šä¹‰ä¸´æ—¶æ–‡ä»¶
WORKER_SCRIPT="$PREFIX/tmp/xxy_worker_$$.sh"
INJECT_SCRIPT="$PREFIX/tmp/xxy_inject_$$.sh"

# --- ğŸ¨ é¢œè‰²å®šä¹‰ ---
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); P=$(tput setaf 5); C=$(tput setaf 6)
W=$(tput setaf 7); GR=$(tput setaf 8); NC=$(tput sgr0)

# --- ğŸ”§ æ ¸å¿ƒå·¥å…· (æ”¹ç”¨ echo å†™å…¥ï¼Œæœç»è¯­æ³•é”™è¯¯) ---

generate_worker() {
    rm -f "$WORKER_SCRIPT"
    # ä½¿ç”¨ä»£ç å— echo å†™å…¥ï¼Œé¿å…åµŒå¥— EOF é—®é¢˜
    {
        echo '#!/bin/sh'
        echo 'task=$1'
        echo 'if command -v apt >/dev/null; then PM="apt"; INSTALL="apt install -y"; UPDATE="apt update -y";'
        echo 'elif command -v pacman >/dev/null; then PM="pacman"; INSTALL="pacman -S --noconfirm"; UPDATE="pacman -Sy --noconfirm";'
        echo 'elif command -v apk >/dev/null; then PM="apk"; INSTALL="apk add"; UPDATE="apk update";'
        echo 'else echo "Unknown PM"; exit 1; fi'
        echo ''
        echo 'case "$task" in'
        echo '    update) $UPDATE ;;'
        echo '    install_gui)'
        echo '        if [ "$PM" = "apt" ]; then DEBIAN_FRONTEND=noninteractive $INSTALL xfce4 xfce4-goodies dbus-x11;'
        echo '        elif [ "$PM" = "apk" ]; then $INSTALL xfce4 dbus-x11;'
        echo '        else $INSTALL xfce4 dbus; fi ;;'
        echo '    install_cn)'
        echo '        if [ "$PM" = "apt" ]; then DEBIAN_FRONTEND=noninteractive $INSTALL locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen;'
        echo '        elif [ "$PM" = "pacman" ]; then $INSTALL noto-fonts-cjk; echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen; locale-gen;'
        echo '        elif [ "$PM" = "apk" ]; then $INSTALL font-noto-cjk; fi'
        echo '        if ! grep -q "LANG=zh_CN.UTF-8" /etc/profile; then echo "export LANG=zh_CN.UTF-8" >> /etc/profile; fi ;;'
        echo '    install_tools) $INSTALL wget git nano curl ;;'
        echo '    install_fetch)'
        echo '        if $INSTALL fastfetch; then echo "FETCH_TOOL=fastfetch" > /tmp/fetch_status;'
        echo '        elif $INSTALL neofetch; then echo "FETCH_TOOL=neofetch" > /tmp/fetch_status;'
        echo '        else echo "FETCH_TOOL=none" > /tmp/fetch_status; fi ;;'
        echo 'esac'
    } > "$WORKER_SCRIPT"
    chmod +x "$WORKER_SCRIPT"
}

get_installed_systems() {
    if [ -d "$PREFIX/var/lib/proot-distro/installed-rootfs" ]; then
        ls -A "$PREFIX/var/lib/proot-distro/installed-rootfs"
    fi
}

run_bg_safe() {
    local sys=$1; local task=$2; local desc=$3
    tput cup 18 0; echo -ne "${Y}âš™ï¸  $desc ($sys)...                                ${NC}"
    proot-distro login "$sys" --shared-tmp -- /bin/sh "$WORKER_SCRIPT" "$task" >/dev/null 2>&1
    tput cup 18 0
    if [ $? -eq 0 ]; then echo -ne "${G}âœ… $desc å®Œæˆ                                  ${NC}"; else echo -ne "${R}âš ï¸ $desc å¤±è´¥                                  ${NC}"; fi
}

select_system() {
    SYS_LIST=($(get_installed_systems))
    if [ ${#SYS_LIST[@]} -eq 0 ]; then echo "æ— ç³»ç»Ÿ"; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."; return 1; fi
    for i in "${!SYS_LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${SYS_LIST[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    stty echo; tput cnorm; read -p "ğŸ‘‰ åºå·: " idx; stty -echo; tput civis
    if [ "$idx" == "0" ] || [ -z "$idx" ]; then return 1; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#SYS_LIST[@]}" ]; then
        echo "${SYS_LIST[$((idx-1))]}"
        return 0
    else return 1; fi
}

# --- ğŸ“¦ åŠŸèƒ½æ¨¡å— ---
f_login() {
    clear; echo -e "${C}=== ç™»å½•ç³»ç»Ÿ ===${NC}"
    TARGET=$(select_system) || return
    
    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$WORKER_SCRIPT" "install_fetch" >/dev/null 2>&1
    
    # ç”Ÿæˆæ³¨å…¥è„šæœ¬ (ä½¿ç”¨ echo é¿å…åµŒå¥— EOF)
    {
        echo 'RC=~/.bashrc'
        echo "sed -i '/fastfetch/d' \$RC; sed -i '/neofetch/d' \$RC"
        echo 'if [ -f /tmp/fetch_status ]; then'
        echo '    . /tmp/fetch_status'
        echo '    [ "$FETCH_TOOL" != "none" ] && echo "$FETCH_TOOL" >> $RC'
        echo '    rm -f /tmp/fetch_status'
        echo 'fi'
    } > "$INJECT_SCRIPT"

    proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$INJECT_SCRIPT" >/dev/null 2>&1
    cleanup; proot-distro login "$TARGET"; tput civis; stty -echo; draw_static
}

f_install() {
    clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ ===${NC}"
    OPTS=("ubuntu" "debian" "kali" "archlinux" "alpine")
    for i in "${!OPTS[@]}"; do echo -e "${W}$((i+1)).${NC} ${OPTS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    stty echo; tput cnorm; read -p "ğŸ‘‰ é€‰æ‹©: " idx; stty -echo; tput civis
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#OPTS[@]}" ]; then
        TARGET=${OPTS[$((idx-1))]}
        if [ -d "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET" ]; then echo "å·²å­˜åœ¨"; read -n 1 -s -r -p "..."; return; fi
        echo "æ­£åœ¨å®‰è£… $TARGET..."
        tput cnorm
        if proot-distro install $TARGET; then
            tput civis; generate_worker
            run_bg_safe "$TARGET" "update" "æ›´æ–°æº"
            run_bg_safe "$TARGET" "install_cn" "ä¸­æ–‡"
            run_bg_safe "$TARGET" "install_fetch" "ç¾åŒ–"
            echo -e "\n${G}å®Œæˆï¼${NC}"; read -n 1 -s -r -p "..."
        else echo -e "\n${R}å¤±è´¥${NC}"; read -n 1 -s -r -p "..."; fi
    fi
}

f_gui() {
    clear; echo -e "${C}=== å¯åŠ¨æ¡Œé¢ ===${NC}"
    TARGET=$(select_system) || return
    echo "æ£€æŸ¥ç¯å¢ƒ..."
    if ! proot-distro login "$TARGET" -- bash -c "command -v startxfce4" >/dev/null 2>&1; then
        run_bg_safe "$TARGET" "install_gui" "å®‰è£… XFCE"
    fi
    echo -e "\n1. Termux:X11\n2. VNC\n0. è¿”å›"
    stty echo; tput cnorm; read -p "æ¨¡å¼: " m; stty -echo; tput civis
    if [ "$m" == "1" ]; then
        pulseaudio --kill >/dev/null 2>&1; pkill -f com.termux.x11 >/dev/null 2>&1; rm -rf $PREFIX/tmp/.X11-unix
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 >/dev/null 2>&1 &
        proot-distro login "$TARGET" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        proot-distro login "$TARGET" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X1-lock; vncserver :1"
        echo "åœ°å€: 127.0.0.1:5901"; read -n 1 -s -r -p "..."
    fi
}

f_manage() {
    clear; echo -e "${R}=== å¸è½½ ===${NC}"; TARGET=$(select_system) || return
    stty echo; tput cnorm; read -p "ç¡®è®¤åˆ é™¤ $TARGET? (y/n): " c; stty -echo; tput civis
    if [[ "$c" == "y" ]]; then proot-distro remove $TARGET; rm -rf "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET"; echo "å·²åˆ é™¤"; read -n 1 -s -r -p "..."; fi
}

update_hud() {
    NOW=$(date "+%H:%M")
    if (( FRAME % 50 == 0 )); then MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}'); fi
    tput cup 0 34; printf "${B}â•­â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 1 34; printf "${B}â”‚${NC} TIME: ${W}%-5s${NC} MEM: ${P}%-5s${NC}         ${B}â”‚${NC}" "$NOW" "$MEM"
    tput cup 2 34; printf "${B}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
}

draw_static() {
    clear
    printf "${C}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— ${W}XXY ä¿®å¤ç‰ˆ${NC}\n"
    printf "${C}â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• ${GR}v32.0 | Fixed${NC}\n"
    printf "${C} â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  ${NC}\n"
    printf "${C} â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•   ${NC}\n"
    tput cup 8 0
    printf "${GR}â•­â”€â”€ [ å¸¸ç”¨ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€ [ æå®¢ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}\n"
    printf "${GR}â”‚${NC} ${W}1.${NC} ç™»å½•ç³»ç»Ÿ (Login)          ${GR}â”‚ â”‚${NC} ${W}4.${NC} å¸è½½ç³»ç»Ÿ (Uninstall)    ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}2.${NC} å®‰è£…ç³»ç»Ÿ (Install)        ${GR}â”‚ â”‚${NC} ${W}0.${NC} é€€å‡ºç¨‹åº (Exit)         ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}3.${NC} å¯åŠ¨æ¡Œé¢ (GUI Mode)       ${GR}â”‚ â”‚${NC}                                 ${GR}â”‚${NC}\n"
    printf "${GR}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}\n"
}

# --- Main ---
generate_worker; tput civis; stty -echo; draw_static
USER_IN=""; FRAME=0; COLORS=($R $Y $G $C $B $P); MEM="Wait"
while true; do
    update_hud; ((FRAME++))
    C_IDX=$((FRAME % 6)); CUR_C=${COLORS[$C_IDX]}
    tput cup 14 0; printf "${CUR_C}â•­â”€â”€ è¾“å…¥åºå· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 15 0; printf "${CUR_C}â”‚${NC} ${C}â¤${NC} %-40s           ${CUR_C}â”‚${NC}" "$USER_IN${W}â–ˆ${NC}"
    tput cup 16 0; printf "${CUR_C}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    read -t 0.05 -n 1 k
    if [[ $? -eq 0 ]]; then
        if [[ -z "$k" ]]; then
            if [[ -n "$USER_IN" ]]; then
                case $USER_IN in 1) f_login;; 2) f_install;; 3) f_gui;; 4) f_manage;; 0) exit 0;; esac
                tput civis; stty -echo; draw_static; USER_IN=""
            fi
        elif [[ "$k" == $'\x7f' || "$k" == $'\b' ]]; then USER_IN="${USER_IN%?}"
        elif [[ "$k" == $'\e' ]]; then read -t 0.01 -n 2
        else USER_IN="$USER_IN$k"; fi
    fi
done
INSTALL_EOF
chmod +x $PREFIX/bin/xxy
sed -i 's/\r$//' $PREFIX/bin/xxy
echo -e "\033[1;32mâœ… ä¿®å¤æˆåŠŸã€‚è¯·è¾“å…¥ xxy å¯åŠ¨ã€‚\033[0m"

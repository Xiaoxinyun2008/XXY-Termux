# =================================================================
# ğŸ¤– XXY v100.0 (é€»è¾‘é‡æ„Â·å¤©å¯ç‰ˆ)
# æ¶æ„ï¼šäº‹ä»¶é©±åŠ¨ | çŠ¶æ€æ„ŸçŸ¥ | å¼‚å¸¸ç†”æ–­ | é—­ç¯ä¿®å¤
# =================================================================

# --- [å±‚çº§ 0] åˆå§‹åŒ–ä¸è‡ªæ„ˆ ---
# å¯åŠ¨å‰å…ˆæ¸…ç†ç°åœºï¼Œä¸ç®¡æœ‰æ²¡æœ‰åƒåœ¾ï¼Œå…ˆæ‰«ä¸€éï¼Œç¡®ä¿é€»è¾‘èµ·ç‚¹å¹²å‡€
tput cnorm
echo "ğŸ§  æ­£åœ¨åˆå§‹åŒ–é€»è¾‘æ ¸å¿ƒ..."
pkill -9 sshd 2>/dev/null
pkill -9 termux-x11 2>/dev/null
pkill -9 pulseaudio 2>/dev/null
rm -f $PREFIX/bin/xxy
rm -rf $PREFIX/tmp/xxy_*

# [é€»è¾‘é˜²å¾¡] é¢„åˆ¤æ€§åˆ é™¤ Proot ç¼“å­˜
# å¾ˆå¤šå°ç™½ä¸‹è½½ä¸€åŠæ–­ç½‘ï¼Œå¯¼è‡´ç¼“å­˜æŸåï¼Œä¸‹æ¬¡å¿…æŠ¥ 32-bit é”™ã€‚
# è¿™é‡Œå¼ºåˆ¶æ¸…é™¤ï¼Œç¡®ä¿æ¯æ¬¡å®‰è£…éƒ½æ˜¯â€œå…¨æ–°â€çš„ã€‚
rm -rf $PREFIX/var/lib/proot-distro/dlcache
rm -rf $PREFIX/var/lib/proot-distro/download

# --- [å±‚çº§ 1] å†™å…¥ä¸»ç¨‹åº ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# --- å…¨å±€å¸¸é‡ ---
export VERSION="v100.0 Logic-Pro"
export PREFIX="/data/data/com.termux/files/usr"
export TMPDIR="$PREFIX/tmp"
export PD_CONF="$PREFIX/etc/proot-distro"
export ROOTFS_BASE="$PREFIX/var/lib/proot-distro/installed-rootfs"
export LOG_FILE="$TMPDIR/xxy_ops.log"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

[ ! -d "$TMPDIR" ] && mkdir -p "$TMPDIR"

# --- [æ¨¡å— A] é€»è¾‘åˆ¤æ–­å·¥å…·åº“ ---

# 1. ç½‘ç»œä¾¦å¯Ÿå…µ
check_net() {
    # é€»è¾‘ï¼šå°è¯• Ping ç™¾åº¦æˆ–è°·æ­Œ DNSï¼Œè¶…æ—¶1ç§’å³åˆ¤å®šæ— ç½‘
    # ç›®çš„ï¼šé˜²æ­¢æ— ç½‘çŠ¶æ€ä¸‹æ‰§è¡Œä¸‹è½½ä»»åŠ¡å¯¼è‡´è„šæœ¬å¡æ­»æˆ–æ–‡ä»¶æŸå
    if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1 || ping -c 1 -W 1 8.8.8.8 >/dev/null 2>&1; then
        return 0 # æœ‰ç½‘
    else
        return 1 # æ— ç½‘
    fi
}

# 2. ç«¯å£/è¿›ç¨‹æ£€æµ‹
check_port() {
    # é€»è¾‘ï¼šæ£€æµ‹æŒ‡å®šç«¯å£æ˜¯å¦è¢«å ç”¨
    netstat -tunlp 2>/dev/null | grep -q ":$1 "
}

# 3. ç³»ç»Ÿå­˜æ´»æ£€æµ‹
is_installed() {
    if [ -d "$ROOTFS_BASE/$1" ] && [ -f "$ROOTFS_BASE/$1/etc/os-release" ]; then
        return 0
    else
        return 1
    fi
}

# 4. ä¾èµ–è‡ªæ£€ä¸ä¿®å¤ (é™é»˜æ‰§è¡Œï¼Œæœ‰é—®é¢˜æ‰å«)
check_deps() {
    DEPS="proot-distro pulseaudio wget curl openssh ncurses-utils grep sed awk fastfetch net-tools termux-tools"
    MISSING=""
    for d in $DEPS; do 
        if ! command -v $d >/dev/null; then MISSING="$MISSING $d"; fi
    done
    
    if [ -n "$MISSING" ]; then
        echo -e "${Y}âš ï¸  æ£€æµ‹åˆ°ç¯å¢ƒç¼ºå¤±ï¼Œè§¦å‘è‡ªåŠ¨è¡¥å…¨é€»è¾‘...${NC}"
        if check_net; then
             pkg install $MISSING -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
        else
             echo -e "${R}âŒ è‡´å‘½é”™è¯¯ï¼šç¼ºç»„ä»¶ä¸”æ²¡ç½‘ï¼Œæ— æ³•ç»§ç»­ï¼${NC}"; read -n 1 -s; exit 1
        fi
    fi
    
    # X11 ä»“åº“ç‰¹æ®Šæ£€æµ‹
    if ! command -v termux-x11 &>/dev/null; then
         echo -e "${Y}ğŸ”§ æ­£åœ¨éƒ¨ç½²å›¾å½¢é©±åŠ¨å­ç³»ç»Ÿ...${NC}"
         pkg install x11-repo -y >/dev/null 2>&1
         pkg install termux-x11-nightly -y >/dev/null 2>&1
    fi
}

# --- [æ¨¡å— B] å®¹å™¨å†…éƒ¨æ‰§è¡Œå™¨ (Worker) ---
create_worker() {
    W_FILE="$TMPDIR/xxy_worker.sh"; rm -f "$W_FILE"
    # å†™å…¥å®¹é”™è„šæœ¬å¤´
    echo '#!/bin/sh' >> "$W_FILE"
    echo 'set -e' >> "$W_FILE" # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢ï¼Œé˜²æ­¢è¿é”ååº”
    echo 'export PATH=$PATH:/usr/bin:/bin' >> "$W_FILE"
    echo 'act=$1' >> "$W_FILE"
    
    # æ™ºèƒ½è¯†åˆ«å‘è¡Œç‰ˆ
    echo 'if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"' >> "$W_FILE"
    echo 'elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"' >> "$W_FILE"
    echo 'elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"' >> "$W_FILE"
    echo 'else T="unknown"; fi' >> "$W_FILE"
    
    echo 'case "$act" in' >> "$W_FILE"
    
    # æ¢æºé€»è¾‘ï¼šå…ˆåˆ¤æ–­æ˜¯å¦å·²ç»æ˜¯å›½å†…æºï¼Œé¿å…é‡å¤ä¿®æ”¹ç ´åæ–‡ä»¶
    echo '  src)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then' >> "$W_FILE"
    echo '      if ! grep -q "tsinghua" /etc/apt/sources.list; then' >> "$W_FILE"
    echo '        grep -q "ubuntu" /etc/os-release && sed -i "s|http://ports.ubuntu.com/ubuntu-ports|http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports|g" /etc/apt/sources.list' >> "$W_FILE"
    echo '        apt update -y' >> "$W_FILE"
    echo '      fi' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then' >> "$W_FILE"
    echo '      sed -i "s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g" /etc/apk/repositories; apk update' >> "$W_FILE"
    echo '    fi ;;' >> "$W_FILE"
    
    # GUIé€»è¾‘ï¼šæ£€æµ‹åŒ…çŠ¶æ€ï¼Œé¿å…é‡å¤å®‰è£…æŠ¥é”™
    echo '  gui)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then' >> "$W_FILE"
    echo '       dpkg -s xfce4 >/dev/null 2>&1 || apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server' >> "$W_FILE"
    echo '    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi' >> "$W_FILE"
    echo '    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;' >> "$W_FILE"
    
    # ä¸­æ–‡é€»è¾‘
    echo '  cn)' >> "$W_FILE"
    echo '    if [ "$T" = "debian" ]; then apt install -y locales fonts-noto-cjk; echo "zh_CN.UTF-8 UTF-8" > /etc/locale.gen; locale-gen; fi' >> "$W_FILE"
    echo '    echo "export LANG=zh_CN.UTF-8" > /etc/profile.d/cn.sh ;;' >> "$W_FILE"
    
    echo '  fetch) command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;' >> "$W_FILE"
    echo 'esac' >> "$W_FILE"; chmod 777 "$W_FILE"
}

# ä»»åŠ¡åŒ…è£…å™¨ï¼šå¸¦æ—¥å¿—è®°å½•å’ŒçŠ¶æ€åé¦ˆ
run_task() {
    tput cup 14 0; echo -ne "\033[J${Y}âš™ï¸  æ‰§è¡Œ: $2 (è¯·ç¨å€™)...${NC}"
    if proot-distro login "$1" --shared-tmp -- /bin/sh "$TMPDIR/xxy_worker.sh" "$3" >> "$LOG_FILE" 2>&1; then
         tput cup 14 0; echo -ne "\033[J${G}âœ… $2 å®Œæˆ${NC}"
    else
         tput cup 14 0; echo -ne "\033[J${R}âš ï¸ $2 é‡åˆ°é—®é¢˜ (ä½†ä¸å½±å“æ ¸å¿ƒè¿è¡Œ)${NC}"
    fi
    sleep 0.5
}

# --- [æ¨¡å— C] ä¸šåŠ¡é€»è¾‘å±‚ ---

# 1. è·å–ç³»ç»Ÿåˆ—è¡¨
get_systems() { if [ -d "$ROOTFS_BASE" ]; then ls -1 "$ROOTFS_BASE" 2>/dev/null; fi; }

# 2. æ™ºèƒ½ç³»ç»Ÿé€‰æ‹©å™¨ (å¸¦è¾“å…¥å¾ªç¯åˆ¤æ–­)
select_sys() {
    tput cnorm; stty echo; clear; echo -e "${C}--- ç³»ç»Ÿé€‰æ‹©å™¨ ---${NC}"
    mapfile -t LIST < <(get_systems)
    
    if [ ${#LIST[@]} -eq 0 ]; then 
        echo -e "\n${R}âŒ é€»è¾‘ä¸­æ–­ï¼šæœªæ£€æµ‹åˆ°ä»»ä½•ç³»ç»Ÿã€‚${NC}"
        echo -e "è¯·å…ˆæ‰§è¡Œ [2] è¿›è¡Œå®‰è£…ã€‚"; read -n 1 -s; return 1
    fi
    
    for i in "${!LIST[@]}"; do echo -e "${G}$((i+1)).${NC} ${LIST[$i]}"; done
    echo "0. è¿”å›"
    echo "-------------------------"
    
    while true; do
        read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " c
        if [[ "$c" =~ ^[0-9]+$ ]]; then
            if [ "$c" = "0" ]; then return 2; fi
            if [ -n "${LIST[$((c-1))]}" ]; then 
                SELECTED="${LIST[$((c-1))]}"
                return 0
            else
                echo "${R}åºå·è¶Šç•Œï¼Œè¯·é‡è¾“${NC}"
            fi
        else
            echo "${R}è¾“å…¥éæ³•ï¼Œè¯·è¾“å…¥æ•°å­—${NC}"
        fi
    done
}

# 3. å®‰è£…é€»è¾‘ (é‡é€»è¾‘ç‰ˆ)
do_install() {
    tput cnorm; stty echo; clear; echo -e "${C}=== æ™ºèƒ½å®‰è£…å‘å¯¼ ===${NC}"
    
    # å‰ç½®æ£€æŸ¥ï¼šæ˜¯å¦æœ‰ç½‘
    echo -ne "${Y}ğŸ“¡ æ­£åœ¨æ¢æµ‹ç½‘ç»œè¿é€šæ€§... ${NC}"
    if ! check_net; then
        echo -e "${R}å¤±è´¥${NC}"
        echo -e "\n${R}âŒ è‡´å‘½é€»è¾‘é˜»æ–­ï¼šå½“å‰æ— ç½‘ç»œè¿æ¥ã€‚${NC}"
        echo "å®‰è£… Linux éœ€è¦ä¸‹è½½çº¦ 100MB æ•°æ®ï¼Œè¯·æ£€æŸ¥ WiFi æˆ–æ•°æ®æµé‡ã€‚"
        read -n 1 -s; return
    else
        echo -e "${G}é€šç•…${NC}"
    fi

    D_NAMES=("ubuntu" "debian" "archlinux" "alpine")
    for i in "${!D_NAMES[@]}"; do echo -e "${G}$((i+1)).${NC} ${D_NAMES[$i]}"; done
    echo "0. è¿”å›"
    
    read -p "ğŸ‘‰ é€‰æ‹©: " idx
    [[ ! "$idx" =~ ^[0-9]+$ ]] && return
    [ "$idx" = "0" ] && return
    
    if [ -n "${D_NAMES[$((idx-1))]}" ]; then
        TARGET=${D_NAMES[$((idx-1))]}
        
        # çŠ¶æ€åˆ¤æ–­ï¼šå·²å®‰è£…åˆ™æ‹¦æˆª
        if is_installed "$TARGET"; then 
            echo -e "\n${G}âœ… é€»è¾‘åˆ¤æ–­ï¼š$TARGET å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤å®‰è£…ã€‚${NC}"; read -n 1 -s; return
        fi
        
        # æ¸…ç†ç°åœº
        proot-distro reset "$TARGET" >/dev/null 2>&1
        rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
        
        # ä¿®æ­£æºé…ç½®
        if [ -f "$PD_CONF/$TARGET.sh" ]; then 
            sed -i "s|https://ghproxy.net/||g" "$PD_CONF/$TARGET.sh"
        fi
        
        echo -e "${W}ğŸš€ æ­£åœ¨è°ƒç”¨ Proot ä¸‹è½½å™¨...${NC}"
        if proot-distro install $TARGET; then
            create_worker
            run_task "$TARGET" "æºä¼˜åŒ–" "src"
            run_task "$TARGET" "æ±‰åŒ–é…ç½®" "cn"
            run_task "$TARGET" "ç»„ä»¶é¢„è£…" "fetch"
            echo -e "\n${G}ğŸ‰ å®‰è£…ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ã€‚${NC}"; read -n 1 -s
        else
            # å¤±è´¥å›æ»šé€»è¾‘
            echo -e "\n${R}âŒ å¼‚å¸¸ä¸­æ–­ï¼šä¸‹è½½å¤±è´¥ã€‚${NC}"
            echo -e "${Y}ğŸ› ï¸ æ­£åœ¨æ‰§è¡Œå›æ»šæ“ä½œï¼Œæ¸…ç†æŸåæ–‡ä»¶...${NC}"
            proot-distro reset "$TARGET" >/dev/null 2>&1
            echo "æç¤ºï¼šè¯·å¼€å¯ VPN åé‡è¯•ï¼Œå¦åˆ™å¤§æ¦‚ç‡å†æ¬¡å¤±è´¥ã€‚"
            read -n 1 -s
        fi
    fi
}

# 4. ç™»å½•é€»è¾‘
do_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    # æŸåæ£€æµ‹
    if ! proot-distro login "$SELECTED" -- true >/dev/null 2>&1; then
        echo -e "${R}âŒ å®Œæ•´æ€§æ ¡éªŒå¤±è´¥ï¼šå®¹å™¨ç³»ç»Ÿå·²æŸåã€‚å»ºè®®åˆ é™¤é‡è£…ã€‚${NC}"; read -n 1 -s; return
    fi
    
    RC="$TMPDIR/rc_$$"
    echo "if [ -f /etc/profile.d/cn.sh ]; then . /etc/profile.d/cn.sh; fi; clear; command -v fastfetch >/dev/null && fastfetch; /bin/bash" > "$RC"
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash --rcfile "$RC"
    rm -f "$RC"
}

# 5. æ¡Œé¢é€»è¾‘ (å¤æ‚çš„ä¾èµ–é“¾åˆ¤æ–­)
do_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    echo -ne "${Y}ğŸ” æ­£åœ¨æ‰«æå›¾å½¢ç¯å¢ƒ...${NC}\r"
    # é€»è¾‘ï¼šå…ˆè¯•è¿è¡Œ checkï¼Œå¦‚æœå¤±è´¥è¯´æ˜æ²¡è£…
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        run_task "$SELECTED" "ç¼ºå¤± XFCE4ï¼Œæ­£åœ¨å®‰è£…" "gui"
    fi
    
    clear; echo -e "${G}1. æœ¬åœ° (Termux:X11)${NC}"; echo "2. è¿œç¨‹ (VNC)"; read -p "é€‰: " m
    if [ "$m" == "1" ]; then
        # å¼ºåŠ›æ¸…ç†é”æ–‡ä»¶ï¼Œé˜²æ­¢ X Server å¯åŠ¨å¤±è´¥
        rm -rf $TMPDIR/.X11-unix
        pkill -9 termux-x11 >/dev/null 2>&1
        
        # APP å­˜æ´»æ£€æµ‹
        if ! am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; then 
             echo "${R}âŒ é€»è¾‘é˜»æ–­ï¼šæœªå®‰è£… Termux:X11 APPã€‚${NC}"; read -n 1 -s; return
        fi
        
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        # VNC é‡ç½®é€»è¾‘
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo "åœ°å€: 127.0.0.1:5901 | å¯†ç : 123456"; read -n 1 -s
    fi
}

# 6. SSH é€»è¾‘ (æ™ºèƒ½ä¿®å¤ç‰ˆ)
do_ssh_remote() {
    tput cnorm; stty echo; clear
    echo -e "${C}=== SSH æ™ºèƒ½åŠ©æ‰‹ ===${NC}"
    
    USER=$(whoami)
    # IP è¿‡æ»¤é€»è¾‘ï¼šæ’é™¤æœ¬åœ°å›ç¯ï¼Œåªå–ç¬¬ä¸€ä¸ªçœŸå®IP
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | awk '{print $2}' | sed 's/addr://' | head -n 1)
    
    echo -e "${Y}æ£€æµ‹åˆ°ä½ çš„ IP: $IP ${NC}"
    echo -e "${Y}æ£€æµ‹åˆ°ä½ çš„ ç”¨æˆ·: $USER ${NC}"
    
    read -p "éœ€è¦é‡ç½® SSH å¯†ç å—? (y/n): " k
    if [ "$k" == "y" ]; then passwd; fi
    
    # æœåŠ¡é‡å¯é€»è¾‘
    pkill sshd; sshd
    
    if check_port 8022; then
        echo -e "\n${G}âœ… æœåŠ¡å·²å¯åŠ¨æˆåŠŸï¼${NC}"
        echo -e "----------------------------------------"
        echo -e "ğŸ‘‰ ç”µè„‘è¿æ¥å‘½ä»¤: ssh -p 8022 $USER@$IP"
        echo -e "----------------------------------------"
        echo -e "${R}ğŸ†˜ ç”µè„‘æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ${NC}"
        echo -e "å¦‚æœç”µè„‘æç¤º Host key verification failed æˆ– Bad config"
        echo -e "è¯·åœ¨ç”µè„‘ PowerShell æ‰§è¡Œä¸‹é¢è¿™è¡Œä»£ç æ¥ä¿®å¤ï¼š"
        echo -e "\033[1;33mRemove-Item -Force \"\$env:USERPROFILE\\.ssh\\config\"\033[0m"
    else
        echo -e "\n${R}âŒ å¯åŠ¨å¤±è´¥ï¼šç«¯å£å¯èƒ½è¢«å ç”¨æˆ–ç¼ºå°‘æƒé™ã€‚${NC}"
    fi
    read -n 1 -s
}

do_del() { select_sys; [ $? -ne 0 ] && return; read -p "ç¡®è®¤é”€æ¯å®¹å™¨? (y): " k; [ "$k" == "y" ] && proot-distro remove "$SELECTED" && rm -rf "$ROOTFS_BASE/$SELECTED"; }

# --- 7. UI å¼•æ“ (å±€éƒ¨åˆ·æ–° + çŠ¶æ€æ ) ---
draw_base() {
    clear
    echo -e "${C}"
    echo "â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—"
    echo "â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•"
    echo " â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• "
    echo " â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•  "
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ${W}[1] è¿›å…¥ç³»ç»Ÿ${NC}     ${W}[4] SSH è¿æ¥${NC}"
    echo -e " ${W}[2] å®‰è£…ç³»ç»Ÿ${NC}     ${W}[5] åˆ é™¤ç³»ç»Ÿ${NC}"
    echo -e " ${W}[3] å¯åŠ¨æ¡Œé¢${NC}     ${W}[6] é€€å‡ºç¨‹åº${NC}"
    echo -e "${GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${C}â¤ æŒ‡ä»¤:${NC} " 
}

refresh_info() {
    T=$(date "+%H:%M:%S")
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1 | awk '{print $2}' | sed 's/addr://')
    [ -z "$IP" ] && IP="ç¦»çº¿"
    MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    
    # ç½‘ç»œçŠ¶æ€æ¢æµ‹
    if check_net; then NET_S="${G}åœ¨çº¿${NC}"; else NET_S="${R}æ–­å¼€${NC}"; fi
    
    tput cup 5 0
    printf " ${W}Ver:${NC} ${Y}%-7s${NC} | ${W}Time:${NC} ${Y}%s${NC} | Net:${W}%-13s${NC}\033[K" "$VERSION" "$T" "$NET_S"
    tput cup 11 9
}

# --- ä¸»å¾ªç¯ ---
check_deps # å…ˆè‡ªæ£€
draw_base  # ç”»åº•å›¾

while true; do
    refresh_info
    read -t 1 -n 1 choice
    STATUS=$?
    if [ $STATUS -ne 0 ] || [ -z "$choice" ]; then continue; fi
    
    case "$choice" in
        1) do_login; draw_base ;; 
        2) do_install; draw_base ;; 
        3) do_gui; draw_base ;;
        4) do_ssh_remote; draw_base ;; 
        5) do_del; draw_base ;; 
        6) exit 0 ;;
        *) ;; 
    esac
done
MAIN_EOF

# 3. å¯åŠ¨
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;32mâœ… é€»è¾‘é‡æ„ç‰ˆ v100.0 å·²å°±ç»ªï¼\033[0m"
echo -e "-------------------------------------------"
echo -e "å·²å¢åŠ ç½‘ç»œé¢„æ£€ã€ç«¯å£å†²çªæ£€æµ‹ã€å®‰è£…å›æ»šé€»è¾‘ã€‚"
echo -e "è¾“å…¥ \033[1;33mxxy\033[0m å¯åŠ¨ã€‚"
echo -e "æŒ‰å›è½¦å¼€å§‹..."
read
xxy

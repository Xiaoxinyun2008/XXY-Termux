# ==============================================================================
# ğŸ“± XXY v10001.0 æœ€ç»ˆä¿®æ­£ç‰ˆ
# ä¿®å¤ï¼šå®‰è£…å¡é¡¿/å¤±è´¥ | å®¹å™¨æ— ç½‘ç»œ(DNS) | åˆ é™¤é€»è¾‘ | æ¶æ„æ£€æµ‹
# ==============================================================================

# --- [0] ç¯å¢ƒæ·±åº¦é‡ç½® ---
tput cnorm
clear
echo "âš™ï¸ [ç³»ç»Ÿ] æ­£åœ¨æ¸…ç†ç¯å¢ƒï¼Œè¯·ç¨å€™..."

# 1. å¼ºæ€è¿›ç¨‹
for proc in sshd termux-x11 pulseaudio Xwayland vncserver proot; do
    if pgrep -x "$proc" >/dev/null; then killall -9 "$proc" >/dev/null 2>&1; fi
done

# 2. åˆ é™¤è„šæœ¬è‡ªèº«ç¼“å­˜
rm -f "$PREFIX/bin/xxy"
rm -rf "$PREFIX/tmp/xxy_final"
mkdir -p "$PREFIX/tmp/xxy_final"

# 3. [å…³é”®] å¼ºåˆ¶ç²‰ç¢ Proot ä¸‹è½½ç¼“å­˜ (è§£å†³å®‰è£…é—®é¢˜çš„æ ¸å¿ƒ)
# å¾ˆå¤šæ—¶å€™å®‰è£…å¤±è´¥æ˜¯å› ä¸ºä¸‹è½½äº†åæ–‡ä»¶ï¼Œä¸åˆ æ‰å®ƒï¼Œä¸‹æ¬¡è¿˜ä¼šç”¨åæ–‡ä»¶å®‰è£…
rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
rm -rf "$PREFIX/var/lib/proot-distro/download"

# --- [1] å†™å…¥å®Œæ•´ä»£ç  ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# --- å…¨å±€é…ç½® ---
export VERSION="v10001.0 ä¿®æ­£ç‰ˆ"
export PREFIX="/data/data/com.termux/files/usr"
export TMP="$PREFIX/tmp/xxy_final"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs"
export LANG="C.UTF-8"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); C=$(tput setaf 6); W=$(tput setaf 7); NC=$(tput sgr0)

# å¼‚å¸¸æ•è·
trap 'echo -e "\n${G}[ç³»ç»Ÿ] å·²å®‰å…¨é€€å‡ºã€‚${NC}"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒå·¥å…·é›†
# ==============================================================================

# [å·¥å…·1] æ¶æ„æ£€æµ‹
check_arch() {
    ARCH=$(uname -m)
    echo -e "${C}>>> æ­£åœ¨æ£€æµ‹æ‰‹æœºç¡¬ä»¶...${NC}"
    case "$ARCH" in
        aarch64)
            echo -e "CPUæ¶æ„: ${G}aarch64 (64ä½)${NC} -> [å®Œç¾å…¼å®¹]"
            ;;
        armv7*|armv8l)
            echo -e "CPUæ¶æ„: ${Y}armv7 (32ä½)${NC} -> [ä»…æ”¯æŒéƒ¨åˆ†ç³»ç»Ÿ]"
            echo -e "${R}è­¦å‘Šï¼šæ‚¨çš„æ‰‹æœºè¾ƒæ—§ï¼Œå¼ºçƒˆå»ºè®®åªå®‰è£… Debianï¼${NC}"
            ;;
        x86_64)
            echo -e "CPUæ¶æ„: ${B}x86_64 (æ¨¡æ‹Ÿå™¨)${NC} -> [å…¼å®¹]"
            ;;
        *)
            echo -e "CPUæ¶æ„: ${R}$ARCH (æœªçŸ¥)${NC}"
            ;;
    esac
    echo "----------------------------------------"
}

# [å·¥å…·2] ç½‘ç»œæ£€æµ‹
check_net() {
    if ping -c 1 -W 2 223.5.5.5 >/dev/null 2>&1; then return 0; fi
    echo -e "${R}âŒ ç½‘ç»œæœªè¿æ¥ï¼${NC}"
    echo "å®‰è£…ç³»ç»Ÿå¿…é¡»ä¸‹è½½çº¦ 80MB æ•°æ®ï¼Œè¯·å¼€å¯ WiFi/æµé‡ã€‚"
    return 1
}

# [å·¥å…·3] ä¾èµ–è‡ªæ£€
check_deps() {
    local pkgs="proot-distro pulseaudio wget curl openssh ncurses-utils net-tools android-tools"
    local missing=""
    for p in $pkgs; do
        if ! command -v $p >/dev/null; then missing="$missing $p"; fi
    done
    if [ -n "$missing" ]; then
        echo -e "${Y}æ­£åœ¨è¡¥å…¨ç¼ºå¤±ç»„ä»¶...${NC}"
        pkg install $missing -y -o Dpkg::Options::="--force-confnew" >/dev/null 2>&1
    fi
}

# ==============================================================================
# ğŸ“¦ å®¹å™¨å†…éƒ¨é…ç½®è„šæœ¬ (Worker)
# ==============================================================================
create_worker() {
    cat > "$TMP/worker.sh" << 'EOF'
#!/bin/sh
set -e
act=$1
# å‘è¡Œç‰ˆè¯†åˆ«
if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src) # è‡ªåŠ¨æ¢æº
    if [ "$T" = "debian" ]; then 
      # å¤‡ä»½
      cp /etc/apt/sources.list /etc/apt/sources.list.bak 2>/dev/null || true
      # æ›¿æ¢ä¸ºæ¸…åæº
      sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null
      sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null
      sed -i 's/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list 2>/dev/null
      apt update -y
    elif [ "$T" = "alpine" ]; then
      sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
      apk update
    fi ;;
  gui) # æ¡Œé¢
    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server; fi
    if [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi
    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;
  clean) # å‡€åŒ–
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;
  fetch) # ç¾åŒ–
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$TMP/worker.sh"
}

# ==============================================================================
# ğŸ® ä¸šåŠ¡åŠŸèƒ½
# ==============================================================================

# [M1] ç³»ç»Ÿå®‰è£… (æ ¸å¿ƒä¿®å¤ç‰ˆ)
do_install() {
    clear
    echo -e "${C}=== ç³»ç»Ÿå®‰è£…å‘å¯¼ ===${NC}"
    if ! check_net; then read -n 1 -s -r -p "æŒ‰å›è½¦è¿”å›..."; return; fi
    
    check_arch
    
    echo -e "${W}è¯·é€‰æ‹©è¦å®‰è£…çš„ç³»ç»Ÿ:${NC}"
    echo "1. Ubuntu (æ¨èæ–°æ‰‹)"
    echo "2. Debian (ç¨³å®šè½»é‡)"
    echo "3. ArchLinux (æå®¢)"
    echo "4. Alpine (æå°)"
    echo "0. è¿”å›"
    
    read -p "è¯·è¾“å…¥åºå·: " idx
    case "$idx" in
        1) TARGET="ubuntu" ;;
        2) TARGET="debian" ;;
        3) TARGET="archlinux" ;;
        4) TARGET="alpine" ;;
        0) return ;;
        *) echo "${R}è¾“å…¥é”™è¯¯${NC}"; sleep 1; return ;;
    esac
    
    # æ£€æŸ¥æ®‹ç•™
    if [ -d "$ROOTFS/$TARGET" ]; then
        echo -e "${Y}æ£€æµ‹åˆ°æ—§çš„ $TARGET æ–‡ä»¶å¤¹ï¼${NC}"
        read -p "æ˜¯å¦åˆ é™¤æ—§ç³»ç»Ÿå¹¶é‡è£…? (y/n): " cov
        if [ "$cov" == "y" ]; then
            echo -e "${Y}æ­£åœ¨æ¸…ç†æ—§æ–‡ä»¶...${NC}"
            proot-distro remove "$TARGET" >/dev/null 2>&1
            chmod -R 777 "$ROOTFS/$TARGET" >/dev/null 2>&1
            rm -rf "$ROOTFS/$TARGET"
        else
            return
        fi
    fi
    
    echo -e "${Y}æ­£åœ¨æ¸…ç†ä¸‹è½½ç¼“å­˜...${NC}"
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    rm -rf "$PREFIX/var/lib/proot-distro/dlcache"
    
    echo -e "${C}ğŸš€ æ­£åœ¨ä» GitHub ä¸‹è½½ç³»ç»Ÿ (å¦‚æœè¿›åº¦æ¡ä¸åŠ¨ï¼Œè¯·åŠ¡å¿…å¼€å¯ VPN)...${NC}"
    if proot-distro install "$TARGET"; then
        # å°¸æ£€é€»è¾‘
        if [ ! -f "$ROOTFS/$TARGET/bin/sh" ]; then
            echo -e "${R}âŒ å®‰è£…å¤±è´¥ï¼šæ–‡ä»¶æ ¡éªŒä¸é€šè¿‡ (ä¸‹è½½äº†ç©ºæ–‡ä»¶)ã€‚${NC}"
            echo "åŸå› ï¼šç½‘ç»œè¿æ¥ä¸ç¨³å®šã€‚"
            echo "è§£å†³ï¼šè¯·æŒ‚æ¢¯å­(VPN)åé‡è¯•ã€‚"
            # è‡ªåŠ¨æ¸…ç†åæ–‡ä»¶
            proot-distro remove "$TARGET"
            read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
            return
        fi
        
        echo -e "${G}âœ… ç³»ç»Ÿä¸‹è½½æˆåŠŸï¼${NC}"
        echo -e "${Y}>>> æ­£åœ¨æ³¨å…¥ DNS ä¿®å¤ (è§£å†³å®¹å™¨å†…æ— ç½‘é—®é¢˜)...${NC}"
        echo "nameserver 223.5.5.5" > "$ROOTFS/$TARGET/etc/resolv.conf"
        
        create_worker
        echo -e "${Y}>>> æ­£åœ¨æ›´æ¢å›½å†…æº...${NC}"
        proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$TMP/worker.sh" "src"
        
        echo -e "${Y}>>> æ­£åœ¨å®‰è£…å¸¸ç”¨å·¥å…·...${NC}"
        proot-distro login "$TARGET" --shared-tmp -- /bin/sh "$TMP/worker.sh" "fetch"
        
        clear
        echo -e "${G}ğŸ‰ å®‰è£…å…¨éƒ¨å®Œæˆï¼${NC}"
        echo -e "ç°åœ¨ä½ å¯ä»¥è¿”å›ä¸»èœå•é€‰æ‹© [1] è¿›å…¥ç³»ç»Ÿäº†ã€‚"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
    else
        echo -e "${R}âŒ ä¸‹è½½è¿‡ç¨‹ä¸­æ–­ã€‚è¯·æ£€æŸ¥ç½‘ç»œã€‚${NC}"; read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# [M2] ç™»å½•
do_login() {
    if [ -d "$ROOTFS" ]; then SYS=$(ls "$ROOTFS" | head -n 1); fi
    if [ -z "$SYS" ]; then echo "${R}è¯·å…ˆå®‰è£…ç³»ç»Ÿ${NC}"; sleep 1; return; fi
    
    create_worker
    # å‡€åŒ– (é˜²æ­¢é‡å¤æ˜¾ç¤º)
    proot-distro login "$SYS" --shared-tmp -- /bin/sh "$TMP/worker.sh" "clean" >/dev/null 2>&1
    
    clear
    echo -e "${G}æ­£åœ¨è¿›å…¥ $SYS ...${NC}"
    # å¯åŠ¨
    proot-distro login "$SYS" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# [M3] æ¡Œé¢
do_gui() {
    if [ -d "$ROOTFS" ]; then SYS=$(ls "$ROOTFS" | head -n 1); fi
    if [ -z "$SYS" ]; then echo "${R}æ— ç³»ç»Ÿ${NC}"; sleep 1; return; fi
    
    create_worker
    if ! proot-distro login "$SYS" -- command -v startxfce4 >/dev/null 2>&1; then
        echo -e "${Y}æœªæ£€æµ‹åˆ°æ¡Œé¢ï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£… XFCE4 (è€—æ—¶è¾ƒé•¿)...${NC}"
        proot-distro login "$SYS" --shared-tmp -- /bin/sh "$TMP/worker.sh" "gui"
    fi
    
    clear
    echo -e "${C}=== å¯åŠ¨æ¡Œé¢ ===${NC}"
    echo "1. æœ¬åœ°æ¨¡å¼ (éœ€è¦ Termux:X11 APP)"
    echo "2. è¿œç¨‹æ¨¡å¼ (VNC Server)"
    read -p "é€‰æ‹©: " m
    
    if [ "$m" == "1" ]; then
        echo -e "${Y}æ­£åœ¨å”¤é†’ Termux:X11...${NC}"
        am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
        pkill -9 termux-x11 >/dev/null 2>&1
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SYS" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
    elif [ "$m" == "2" ]; then
        proot-distro login "$SYS" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        echo -e "${G}VNC å·²å¯åŠ¨: 127.0.0.1:5901 (å¯†ç 123456)${NC}"
        read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
    fi
}

# [M4] SSH
do_ssh() {
    clear
    echo -e "${C}=== SSH ç®¡ç† ===${NC}"
    USER=$(whoami)
    IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
    
    echo -e "æœ¬æœº IP: ${W}$IP${NC}"
    echo "1. å¯åŠ¨æœåŠ¡"
    echo "2. åœæ­¢æœåŠ¡"
    read -p "é€‰æ‹©: " s
    if [ "$s" == "1" ]; then
        if ! grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null; then passwd; fi
        pkill sshd; sshd
        echo -e "${G}å·²å¯åŠ¨ã€‚ç”µè„‘è¿æ¥: ssh -p 8022 $USER@$IP${NC}"
    else
        pkill sshd; echo "${R}å·²åœæ­¢${NC}"
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# [M5] ADB ä¿æ´»
do_adb() {
    clear
    echo -e "${C}=== ADB é˜²æ€åå° ===${NC}"
    if command -v adb >/dev/null && adb devices | grep -q "device"; then
        adb shell "/system/bin/device_config put activity_manager max_phantom_processes 2147483647"
        adb shell "cmd appops set com.termux RUN_IN_BACKGROUND allow"
        echo -e "${G}âœ… è‡ªåŠ¨æ‰§è¡ŒæˆåŠŸï¼${NC}"
    else
        echo -e "${R}æœªæ£€æµ‹åˆ° ADBï¼Œè¯·åœ¨ç”µè„‘/LADB è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š${NC}"
        echo "1. adb shell \"/system/bin/device_config put activity_manager max_phantom_processes 2147483647\""
        echo "2. adb shell \"cmd appops set com.termux RUN_IN_BACKGROUND allow\""
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# --- ä¸»å¾ªç¯ ---
check_deps

while true; do
    clear
    echo -e "${C}=== XXY v10001.0 æœ€ç»ˆä¿®æ­£ç‰ˆ ===${NC}"
    echo -e "${W}1. è¿›å…¥ç³»ç»Ÿ${NC}"
    echo -e "${W}2. å®‰è£…ç³»ç»Ÿ (DNSä¿®å¤+ç¼“å­˜æ¸…ç†)${NC}"
    echo -e "${W}3. å¯åŠ¨æ¡Œé¢ (GUI)${NC}"
    echo -e "${W}4. SSH ç®¡ç†${NC}"
    echo -e "${Y}5. ADB é˜²æ€åå°${NC}"
    echo -e "${R}6. åˆ é™¤ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)${NC}"
    echo -e "${W}0. é€€å‡º${NC}"
    echo "--------------------------------"
    
    if [ -d "$ROOTFS" ] && [ "$(ls -A $ROOTFS)" ]; then
        SYS_NAME=$(ls "$ROOTFS" | head -n 1)
        echo -e "å½“å‰ç³»ç»Ÿ: ${G}$SYS_NAME${NC}"
    else
        echo -e "å½“å‰ç³»ç»Ÿ: ${R}æ— ${NC}"
    fi
    
    read -p "ğŸ‘‰ è¯·è¾“å…¥åºå·: " choice
    case "$choice" in
        1) do_login ;;
        2) do_install ;;
        3) do_gui ;;
        4) do_ssh ;;
        5) do_adb ;;
        6) 
           # [ä¿®å¤åçš„åˆ é™¤é€»è¾‘]
           clear
           echo -e "${C}=== åˆ é™¤ç³»ç»Ÿ ===${NC}"
           if [ ! -d "$ROOTFS" ] || [ -z "$(ls -A "$ROOTFS")" ]; then
               echo -e "${R}æœªæ£€æµ‹åˆ°å·²å®‰è£…çš„ç³»ç»Ÿã€‚${NC}"
               read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
               continue
           fi
           mapfile -t SYSLIST < <(ls "$ROOTFS")
           echo -e "${R}âš ï¸  è­¦å‘Šï¼šæ•°æ®å°†ä¸¢å¤±ï¼${NC}"
           for i in "${!SYSLIST[@]}"; do
               echo "$((i+1)). ${SYSLIST[$i]}"
           done
           echo "0. å–æ¶ˆ"
           read -p "ğŸ‘‰ è¾“å…¥è¦åˆ é™¤çš„åºå·: " del_idx
           if [ "$del_idx" == "0" ]; then continue; fi
           if [[ "$del_idx" =~ ^[0-9]+$ ]] && [ "$del_idx" -le "${#SYSLIST[@]}" ] && [ "$del_idx" -gt 0 ]; then
               DEL_TARGET="${SYSLIST[$((del_idx-1))]}"
               echo -e "\næ‚¨é€‰æ‹©äº†: ${Y}$DEL_TARGET${NC}"
               read -p "ç¡®è®¤åˆ é™¤å—? (y/n): " confirm
               if [ "$confirm" == "y" ]; then
                   echo -e "${Y}æ­£åœ¨å¸è½½...${NC}"
                   proot-distro remove "$DEL_TARGET" >/dev/null 2>&1
                   # æš´åŠ›è¡¥åˆ€
                   if [ -d "$ROOTFS/$DEL_TARGET" ]; then
                       chmod -R 777 "$ROOTFS/$DEL_TARGET" >/dev/null 2>&1
                       rm -rf "$ROOTFS/$DEL_TARGET"
                   fi
                   echo -e "${G}âœ… å·²åˆ é™¤ã€‚${NC}"
               fi
           else
               echo -e "${R}æ— æ•ˆåºå·ã€‚${NC}"
           fi
           read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..." ;;
        0) exit 0 ;;
        *) ;; 
    esac
done
MAIN_EOF

# --- å¯åŠ¨ ---
chmod 755 $PREFIX/bin/xxy
clear
echo -e "\033[1;32mâœ… v10001.0 æœ€ç»ˆä¿®æ­£ç‰ˆ å·²å°±ç»ª\033[0m"
echo -e "-------------------------------------------"
echo -e "1. ä¿®å¤äº†å®‰è£…ç³»ç»Ÿæ—¶æ¢æºå¤±è´¥çš„é—®é¢˜ (DNSæ³¨å…¥)"
echo -e "2. ä¿®å¤äº†ä¹‹å‰ä¸‹è½½å¤±è´¥å¯¼è‡´æ— æ³•é‡è£…çš„é—®é¢˜"
echo -e "3. ä¿®å¤äº†åˆ é™¤åŠŸèƒ½æ— æ³•é€‰æ‹©çš„é—®é¢˜"
echo -e "-------------------------------------------"
read -n 1 -s -r -p "æŒ‰ä»»æ„é”®å¯åŠ¨..."
xxy

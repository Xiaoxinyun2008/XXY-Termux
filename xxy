# ==============================================================================
# ğŸŒŒ XXY v6000.0 Singularity Visual Fix (å¥‡ç‚¹Â·è§†è§‰ä¿®æ­£ç‰ˆ)
# FIX: Termux:X11 Detection Bypass | UI Refresh Artifacts
# KERNEL: Hyper-V TUI | Logic-Jail v5.0 | Fault-Tolerant Execution
# ==============================================================================

# --- [Phase 0] æ ¸å¿ƒé‡ç½® ---
tput cnorm
clear
echo -e "\033[1;36m[BOOT] æ­£åœ¨åŠ è½½ v6000.0 ä¿®æ­£å†…æ ¸...\033[0m"

# 1. è¿›ç¨‹æ¸…ç†
for p in sshd termux-x11 pulseaudio Xwayland vncserver proot; do
    pkill -9 "$p" >/dev/null 2>&1
done

# 2. ç¯å¢ƒé‡æ„
rm -f "$PREFIX/bin/xxy"
rm -rf "$PREFIX/tmp/xxy_omega"
mkdir -p "$PREFIX/tmp/xxy_omega"
rm -rf "$PREFIX/var/lib/proot-distro/dlcache"

# --- [Phase 1] æ³¨å…¥ä¿®æ­£ç‰ˆä»£ç  ---
cat > $PREFIX/bin/xxy << 'MAIN_EOF'
#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ—ï¸ GLOBAL CONFIG (å…¨åŸŸé…ç½®)
# ==============================================================================
export APP_VER="v6000.0 ä¿®æ­£"
export PREFIX="/data/data/com.termux/files/usr"
export TMP="$PREFIX/tmp/xxy_omega"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs"
export BACKUP_DIR="/sdcard/XXY_Snapshots"
export LANG="C.UTF-8"

# ç¡®ä¿ç›®å½•
[ ! -d "$TMP" ] && mkdir -p "$TMP"
[ ! -d "$BACKUP_DIR" ] && mkdir -p "$BACKUP_DIR"

# ğŸ¨ éœ“è™¹è‰²æ¿
C_R=$(tput setaf 196); C_G=$(tput setaf 46); C_Y=$(tput setaf 226)
C_B=$(tput setaf 39);  C_P=$(tput setaf 201); C_C=$(tput setaf 51)
C_W=$(tput setaf 255); C_GR=$(tput setaf 240); C_RST=$(tput sgr0)
BOLD=$(tput bold)

# å¼‚å¸¸æ¥ç®¡
trap 'tput cnorm; stty echo; echo -e "\n${C_P}ğŸ›‘ [SYSTEM HALT] èµ„æºå·²é‡Šæ”¾ã€‚${C_RST}"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ–Œï¸ RENDER ENGINE (æ¸²æŸ“å¼•æ“ - ä¿®å¤ç‰ˆ)
# ==============================================================================

# ç»å¯¹å®šä½ (åŸå­æ“ä½œ)
draw_at() { tput cup $1 $2; echo -ne "$3"; }

# ç»˜åˆ¶ç›’å­ (UI åŸºç¡€)
draw_box() {
    local y=$1; local x=$2; local h=$3; local w=$4; local color=$5
    # Top
    draw_at $y $x "${color}â•”"
    for ((i=0; i<w-2; i++)); do echo -ne "â•"; done
    echo -ne "â•—${C_RST}"
    # Body
    for ((i=1; i<h-1; i++)); do
        draw_at $((y+i)) $x "${color}â•‘${C_RST}"
        draw_at $((y+i)) $((x+w-1)) "${color}â•‘${C_RST}"
    done
    # Bottom
    draw_at $((y+h-1)) $x "${color}â•š"
    for ((i=0; i<w-2; i++)); do echo -ne "â•"; done
    echo -ne "â•${C_RST}"
}

# ç»˜åˆ¶åŠ è½½æ¡
draw_bar() {
    local pct=$1
    local width=20
    local fill=$((pct * width / 100))
    local empty=$((width - fill))
    echo -ne "${C_C}[${C_G}"
    for ((i=0; i<fill; i++)); do echo -ne "â–ˆ"; done
    echo -ne "${C_GR}"
    for ((i=0; i<empty; i++)); do echo -ne "â–‘"; done
    echo -ne "${C_C}] ${pct}%${C_RST}"
}

# ==============================================================================
# ğŸ›¡ï¸ LOGIC DEFENSE (é€»è¾‘é˜²å¾¡å¡”)
# ==============================================================================

# è¾“å…¥æ­»é” (é˜²æ­¢ä¹±æŒ‰)
ask_input() {
    local prompt=$1; local valid=$2
    while true; do
        # æ¸…é™¤æç¤ºåŒº (ç¡®ä¿æ— æ®‹ç•™)
        draw_at 22 2 "                                         "
        draw_at 22 2 "${C_C}$prompt${C_RST}"
        read -n 1 input
        if [[ "$valid" == *"$input"* ]] && [ -n "$input" ]; then
            RET="$input"; return 0
        else
            draw_at 22 30 "${C_R}âŒ æ— æ•ˆè¾“å…¥${C_RST}"; sleep 0.2
        fi
    done
}

# ç¡¬ä»¶ç†”æ–­
check_hardware() {
    local free=$(df -m "$PREFIX" | awk 'NR==2 {print $4}')
    if [ "$free" -lt 2000 ]; then return 1; fi
    return 0
}

# ç½‘ç»œçŸ©é˜µ
check_net() {
    if ping -c 1 -W 1 223.5.5.5 >/dev/null 2>&1; then return 0; fi
    if ping -c 1 -W 1 8.8.8.8 >/dev/null 2>&1; then return 0; fi
    return 1
}

# ==============================================================================
# ğŸ‘· WORKER KERNEL (å®¹å™¨æ‰§è¡Œæ ¸å¿ƒ)
# ==============================================================================
create_worker() {
    rm -f "$TMP/worker.sh"
    cat >> "$TMP/worker.sh" << 'EOF'
#!/bin/sh
set -e
export DEBIAN_FRONTEND=noninteractive
act=$1
arg1=$2

if [ -f /etc/alpine-release ]; then T="alpine"; PM="apk"
elif [ -f /etc/arch-release ]; then T="arch"; PM="pacman"
elif [ -f /etc/debian_version ]; then T="debian"; PM="apt"
else T="unknown"; fi

case "$act" in
  src) 
    if [ "$T" = "debian" ]; then 
      grep -q "tsinghua" /etc/apt/sources.list || sed -i 's/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list
      apt update -y
    elif [ "$T" = "alpine" ]; then
      sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories; apk update
    fi ;;
    
  gui)
    if [ "$T" = "debian" ]; then apt install -y xfce4 xfce4-goodies dbus-x11 tigervnc-standalone-server
    elif [ "$T" = "alpine" ]; then apk add xfce4 dbus-x11 tigervnc; fi
    mkdir -p ~/.vnc; echo "123456" | vncpasswd -f > ~/.vnc/passwd; chmod 600 ~/.vnc/passwd ;;
    
  install_pkg)
    PKG=$arg1
    if [ "$T" = "debian" ]; then apt install -y $PKG
    elif [ "$T" = "alpine" ]; then apk add $PKG; fi ;;
    
  bench_cpu)
    start=$(date +%s); count=0
    while [ $(($(date +%s) - start)) -lt 5 ]; do count=$((count+1)); dummy=$((count*count)); done
    echo $count ;;
    
  clean)
    sed -i '/fastfetch/d' /etc/profile /etc/bash.bashrc ~/.bashrc 2>/dev/null ;;
    
  fetch)
    command -v fastfetch >/dev/null || $PM install -y fastfetch || $PM install -y neofetch ;;
esac
EOF
    chmod 777 "$TMP/worker.sh"
}

run_task() {
    local sys=$1; local desc=$2; local cmd=$3; local arg=$4
    draw_at 22 2 "${C_Y}â³ [Task] $desc...                   ${C_RST}"
    if proot-distro login "$sys" --shared-tmp -- /bin/sh "$TMP/worker.sh" "$cmd" "$arg" > "$TMP/task.log" 2>&1; then
         draw_at 22 2 "${C_G}âœ… [Task] $desc æˆåŠŸ!               ${C_RST}"
         return 0
    else
         draw_at 22 2 "${C_R}âš ï¸ [Task] $desc å¤±è´¥!               ${C_RST}"
         return 1
    fi
}

# ==============================================================================
# ğŸ§© MODULES (ä¿®å¤äº†å­èœå•è¿”å›é€»è¾‘)
# ==============================================================================

get_sys_list() { if [ -d "$ROOTFS" ]; then ls -1 "$ROOTFS" 2>/dev/null; fi; }

select_sys() {
    mapfile -t LIST < <(get_sys_list)
    if [ ${#LIST[@]} -eq 0 ]; then 
        draw_at 22 2 "${C_R}ğŸš« æ— ç³»ç»Ÿ! è¯·å…ˆå®‰è£…ã€‚${C_RST}"; sleep 1; return 1
    fi
    # ç»˜åˆ¶è¦†ç›–å±‚
    local y=5
    # æ¸…é™¤èƒŒæ™¯åŒºåŸŸï¼Œé˜²æ­¢å­—ä½“é‡å 
    for ((k=5; k<18; k++)); do draw_at $k 39 "                    "; done
    
    for i in "${!LIST[@]}"; do
        draw_at $y 40 "${C_C}$((i+1)). ${LIST[$i]}${C_RST}"; let y++
    done
    local valid="0"; for i in "${!LIST[@]}"; do valid="${valid}$((i+1))"; done
    ask_input "é€‰æ‹©åºå·(0è¿”å›): " "$valid"
    [ "$RET" = "0" ] && return 2
    SELECTED="${LIST[$((RET-1))]}"
    return 0
}

# [M1] å®‰è£…ç³»ç»Ÿ (é€»è¾‘æ— å˜åŠ¨ï¼Œç¨³å¥)
mod_install() {
    tput cnorm; clear; echo -e "${C_P}=== å®‰è£…å‘å¯¼ ===${C_RST}"
    if ! check_net; then echo -e "${C_R}âŒ æ— ç½‘ç»œï¼${C_RST}"; read -n 1; return; fi
    
    echo -e "1. Ubuntu\n2. Debian\n3. ArchLinux\n4. Alpine\n0. è¿”å›"
    ask_input "é€‰æ‹©: " "01234"; [ "$RET" = "0" ] && return
    
    local map=("skip" "ubuntu" "debian" "archlinux" "alpine")
    local target=${map[$RET]}
    
    if [ -d "$ROOTFS/$target" ]; then echo "å·²å­˜åœ¨"; read -n 1; return; fi
    
    echo -e "${C_Y}æ¸…ç†ç¼“å­˜...${C_RST}"
    proot-distro reset "$target" >/dev/null 2>&1
    rm -rf "$PREFIX/var/lib/proot-distro/download"
    
    echo -e "${C_W}ä¸‹è½½ä¸­...${C_RST}"
    if proot-distro install $target; then
        create_worker
        run_task "$target" "é…ç½®ä¼˜åŒ–" "src"
        run_task "$target" "æ±‰åŒ–" "cn"
        run_task "$target" "ç¾åŒ–" "fetch"
        echo -e "${C_G}å®Œæˆ${C_RST}"; read -n 1
    else
        echo -e "${C_R}å¤±è´¥${C_RST}"; read -n 1
    fi
}

# [M2] ç™»å½• (æ·±åº¦å‡€åŒ–)
mod_login() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    run_task "$SELECTED" "å‡€åŒ–" "clean"
    tput cnorm; clear
    proot-distro login "$SELECTED" --shared-tmp -- /bin/bash -c "if command -v fastfetch >/dev/null; then fastfetch; fi; exec bash"
}

# [M3] æ¡Œé¢ (BUG FIX: ä¿®å¤æ£€æµ‹ä¸åˆ° X11 çš„é—®é¢˜)
mod_gui() {
    select_sys; [ $? -ne 0 ] && return
    create_worker
    
    if ! proot-distro login "$SELECTED" -- command -v startxfce4 >/dev/null 2>&1; then
        run_task "$SELECTED" "å®‰è£…æ¡Œé¢ç¯å¢ƒ" "gui"
    fi
    
    clear; draw_box 0 0 15 50 "${C_C}"
    draw_at 2 2 "1. æœ¬åœ° (Termux:X11)"
    draw_at 3 2 "2. è¿œç¨‹ (VNC)"
    ask_input "é€‰æ‹©: " "12"
    
    if [ "$RET" == "1" ]; then
        # [æ ¸å¿ƒä¿®å¤ç‚¹]
        # ä¸å†ä½¿ç”¨ pm list packages (é«˜ç‰ˆæœ¬å®‰å“ä¼šæ‹¦æˆª)
        # æ”¹ç”¨ pm path æ£€æµ‹ï¼Œä¸”å³ä½¿æ£€æµ‹å¤±è´¥ï¼Œä¹Ÿä¸æ‹¦æˆªï¼Œåªæ˜¯è­¦å‘Š
        
        X11_CHECK=$(pm path com.termux.x11 2>/dev/null)
        if [ -z "$X11_CHECK" ]; then
            draw_at 5 2 "${C_Y}âš ï¸ æœªæ£€æµ‹åˆ° X11 APP (å¯èƒ½æ˜¯å®‰å“æƒé™å±è”½)${C_RST}"
            draw_at 6 2 "${C_Y}ğŸ‘‰ å°è¯•å¼ºåˆ¶å¯åŠ¨...${C_RST}"
            sleep 1
        fi
        
        pkill -9 termux-x11 >/dev/null 2>&1
        rm -rf "$TMP/.X11-unix"
        
        # å°è¯•å”¤èµ· APP
        if ! am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1; then
             draw_at 8 2 "${C_R}âŒ å¯åŠ¨å¤±è´¥ï¼šè¯·ç¡®è®¤å·²å®‰è£… Termux:X11 APP${C_RST}"
             draw_at 9 2 "ä¸‹è½½åœ°å€: github.com/termux/termux-x11"
             read -n 1 -s
             return
        fi
        
        sleep 1
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 &
        proot-distro login "$SELECTED" --shared-tmp -- bash -c "export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        
    elif [ "$RET" == "2" ]; then
        proot-distro login "$SELECTED" -- bash -c "vncserver -kill :1 >/dev/null 2>&1; rm -rf /tmp/.X11-unix/X1; vncserver :1 -geometry 1280x720"
        draw_at 5 2 "åœ°å€: 127.0.0.1:5901"
        draw_at 6 2 "å¯†ç : 123456"
        read -n 1 -s
    fi
}

# [M4] é¹°çœ¼
mod_ssh() {
    while true; do
        tput cnorm; clear; draw_box 0 0 15 50 "${C_P}"
        USER=$(whoami); IP=$(ifconfig 2>/dev/null | grep -oE 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1 | awk '{print $2}' | sed 's/addr://')
        if pgrep sshd >/dev/null; then ST="${C_G}ON${C_RST}"; else ST="${C_R}OFF${C_RST}"; fi
        CONN=$(netstat -tn 2>/dev/null | grep ':8022' | grep 'ESTABLISHED' | wc -l)
        
        draw_at 2 2 "Status: $ST  IP: $IP  Conn: $CONN"
        draw_at 4 2 "1. å¼€å¯  2. å…³é—­  3. è¸¢äºº"
        draw_at 5 2 "0. è¿”å›"
        ask_input "æŒ‡ä»¤: " "0123"
        case "$RET" in
            0) return ;;
            1) grep -q "^$USER:" "$PREFIX/etc/shadow" 2>/dev/null || passwd; pkill sshd; sshd ;;
            2) pkill sshd ;;
            3) pgrep sshd | grep -v $(pgrep -o sshd) | xargs kill -9 2>/dev/null ;;
        esac
    done
}

# [M5] å•†åº—
mod_store() {
    select_sys; [ $? -ne 0 ] && return; create_worker
    while true; do
        clear; draw_box 0 0 15 50 "${C_C}"
        draw_at 2 2 "1. Python3+Pip  2. NodeJS+Nginx"
        draw_at 3 2 "3. HackerTools  4. BasicTools"
        draw_at 5 2 "0. è¿”å›"
        ask_input "é€‰æ‹©: " "01234"
        [ "$RET" = "0" ] && return
        case "$RET" in
            1) run_task "$SELECTED" "Python" "install_pkg" "python3 python3-pip" ;;
            2) run_task "$SELECTED" "WebStack" "install_pkg" "nodejs npm nginx" ;;
            3) run_task "$SELECTED" "Hacker" "install_pkg" "nmap sqlmap hydra" ;;
            4) run_task "$SELECTED" "Basic" "install_pkg" "wget curl zip git" ;;
        esac
        sleep 1
    done
}

# [M6] è·‘åˆ†
mod_bench() {
    select_sys; [ $? -ne 0 ] && return; create_worker
    clear; draw_box 0 0 10 40 "${C_Y}"
    draw_at 2 2 "Running Benchmark..."
    SCORE=$(proot-distro login "$SELECTED" --shared-tmp -- /bin/sh "$TMP/worker.sh" "bench_cpu")
    draw_at 4 2 "CPU Score: ${C_G}$SCORE${C_RST}"; read -n 1 -s
}

# [M7] å¤‡ä»½
mod_backup() {
    clear; draw_box 0 0 10 40 "${C_B}"
    draw_at 2 2 "1. å¤‡ä»½ (Backup)  2. è¿˜åŸ (Restore)"
    ask_input "é€‰æ‹©: " "12"
    if [ "$RET" == "1" ]; then
        select_sys; [ $? -ne 0 ] && return
        draw_at 22 2 "${C_Y}æ‰“åŒ…ä¸­...${C_RST}"
        cd "$ROOTFS/$SELECTED"
        tar -czf "$BACKUP_DIR/$SELECTED.tar.gz" --exclude='tmp/*' --exclude='proc/*' .
        draw_at 22 2 "${C_G}å®Œæˆ!${C_RST}"; sleep 1
    elif [ "$RET" == "2" ]; then
        ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null; echo ""
        read -p "æ–‡ä»¶å: " f; read -p "æ–°åå­—: " n
        if [ -f "$BACKUP_DIR/$f" ]; then
            mkdir -p "$ROOTFS/$n"; tar -xzf "$BACKUP_DIR/$f" -C "$ROOTFS/$n"
            echo "plug_in_proot=1" > "$PREFIX/etc/proot-distro/$n.sh"
            draw_at 22 2 "${C_G}è¿˜åŸæˆåŠŸ${C_RST}"; sleep 1
        fi
    fi
}

# ==============================================================================
# ğŸ–¥ï¸ MAIN UI (ä¸»ç•Œé¢ - ä¿®å¤å­èœå•è¿”å›é—®é¢˜)
# ==============================================================================

draw_main() {
    clear
    draw_box 0 0 24 50 "${C_P}"
    draw_at 1 15 "${BOLD}XXY SYSTEM ${APP_VER}${C_RST}"
    
    # HUD
    local T=$(date '+%H:%M'); local D=$(df -h "$PREFIX" | awk 'NR==2{print $4}')
    draw_at 3 3 "â° ${T}   ğŸ’¾ ${D}   ${C_G}ONLINE${C_RST}"
    draw_at 4 1 "${C_GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RST}"
    
    # Menu
    draw_at 6 3  "${C_B}[1]${C_RST} è¿›å…¥ç³»ç»Ÿ"
    draw_at 7 3  "${C_B}[2]${C_RST} å®‰è£…ç³»ç»Ÿ"
    draw_at 8 3  "${C_B}[3]${C_RST} å¯åŠ¨æ¡Œé¢"
    draw_at 9 3  "${C_B}[4]${C_RST} é¹°çœ¼é›·è¾¾"
    
    draw_at 6 26 "${C_C}[5]${C_RST} åº”ç”¨å•†åº—"
    draw_at 7 26 "${C_C}[6]${C_RST} æ€§èƒ½è·‘åˆ†"
    draw_at 8 26 "${C_C}[7]${C_RST} å¤‡ä»½ä¸­å¿ƒ"
    draw_at 9 26 "${C_Y}[8]${C_RST} å¸®åŠ©æ–‡æ¡£"
    
    draw_at 11 1 "${C_GR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${C_RST}"
    draw_at 13 3 "${C_R}[0]${C_RST} æ–­å¼€è¿æ¥"
    
    draw_at 22 2 "${C_C}â¤ æŒ‡ä»¤:${C_RST} " 
}

refresh_hud_onl

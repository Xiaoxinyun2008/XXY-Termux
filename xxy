#!/data/data/com.termux/files/usr/bin/bash

# ==============================================================================
# ğŸ“± XXY v3.0 ç»ˆæç”Ÿäº§åŠ›ç‰ˆ
# æ ¸å¿ƒåŠŸèƒ½ï¼šDebian + XFCE4 + ä¸­æ–‡ + Firefox + VSCode + å…ç”µè„‘ç»´æŠ¤
# ==============================================================================

# --- å…¨å±€é…ç½® ---
export PREFIX="/data/data/com.termux/files/usr"
export HOME="/data/data/com.termux/files/home"
export DISTRO_NAME="debian"
export ROOTFS="$PREFIX/var/lib/proot-distro/installed-rootfs/$DISTRO_NAME"
export TMP_WORKER="$PREFIX/tmp/worker_script.sh"

# é¢œè‰²å®šä¹‰
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3); B=$(tput setaf 4); C=$(tput setaf 6); NC=$(tput sgr0)

# ä¿¡å·æ•è·
trap 'echo -e "\n${G}[ç³»ç»Ÿ] å·²é€€å‡ºã€‚${NC}"; exit 0' EXIT INT TERM

# ==============================================================================
# ğŸ› ï¸ æ ¸å¿ƒï¼šå®¹å™¨å†…éƒ¨æ„å»ºè„šæœ¬ (Worker)
# ==============================================================================
# è¿™ä¸ªè„šæœ¬ä¼šåœ¨ Linux å®¹å™¨å†…éƒ¨è¿è¡Œï¼Œè´Ÿè´£å®‰è£…è½¯ä»¶å’Œé…ç½®ç¯å¢ƒ
create_worker_script() {
    mkdir -p "$PREFIX/tmp"
    cat > "$TMP_WORKER" << 'EOF'
#!/bin/bash
set -e

# [1] æ¢æº (æ¸…åæº Debian Bookworm)
echo ">>> [å†…éƒ¨] æ­£åœ¨é…ç½®å›½å†…æº..."
cat > /etc/apt/sources.list << SOURCES
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bookworm-updates main contrib non-free non-free-firmware
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware
SOURCES

# [2] æ›´æ–°å¹¶å®‰è£…åŸºç¡€ç”Ÿäº§åŠ›å¥—ä»¶
echo ">>> [å†…éƒ¨] æ­£åœ¨å®‰è£…æ¡Œé¢å’Œæµè§ˆå™¨ (è€—æ—¶è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…)..."
apt update -y
export DEBIAN_FRONTEND=noninteractive

# å®‰è£…åˆ—è¡¨è¯´æ˜ï¼š
# xfce4: æ¡Œé¢ç¯å¢ƒ | dbus-x11: æ¶ˆæ¯æ€»çº¿ | firefox-esr: æµè§ˆå™¨
# fonts-noto-cjk: ä¸­æ–‡å­—ä½“ | fcitx5: è¾“å…¥æ³•
# git/wget/curl: å¼€å‘å·¥å…·
apt install -y sudo nano wget curl git build-essential \
    xfce4 xfce4-goodies xfce4-terminal dbus-x11 \
    firefox-esr \
    fonts-noto-cjk fonts-noto-color-emoji \
    fcitx5 fcitx5-chinese-addons fcitx5-frontend-gtk4 fcitx5-frontend-gtk3 fcitx5-frontend-qt5 \
    im-config

# [3] ä¸­æ–‡ç¯å¢ƒæ·±åº¦é…ç½®
echo ">>> [å†…éƒ¨] ç”Ÿæˆä¸­æ–‡ Locale..."
apt install -y locales
sed -i 's/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
locale-gen zh_CN.UTF-8
update-locale LANG=zh_CN.UTF-8 LANGUAGE=zh_CN:zh

# [4] ç¯å¢ƒå˜é‡æ³¨å…¥ (è§£å†³è¾“å…¥æ³•å’Œæ˜¾ç¤ºé—®é¢˜)
echo ">>> [å†…éƒ¨] é…ç½®ç¯å¢ƒå˜é‡..."
cat > /etc/profile.d/xxy_env.sh << 'ENV_EOF'
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export GTK_IM_MODULE=fcitx
export QT_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx
export DISPLAY=:0
export PULSE_SERVER=127.0.0.1
ENV_EOF
chmod +x /etc/profile.d/xxy_env.sh

# [5] å…³é”®ä¿®å¤ï¼šFirefox é˜²é—ªé€€è¡¥ä¸
# Proot ç¯å¢ƒä¸‹æ²™ç›’æœºåˆ¶ä¼šå¯¼è‡´æµè§ˆå™¨å´©æºƒï¼Œå¿…é¡»ç¦ç”¨ Remote å’Œ Sandbox
echo ">>> [å†…éƒ¨] åº”ç”¨ Firefox ä¿®å¤è¡¥ä¸..."
echo 'alias firefox="firefox-esr --no-remote"' >> /etc/bash.bashrc
# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ä¿®å¤
mkdir -p /usr/share/applications
sed -i 's/Exec=firefox-esr %u/Exec=firefox-esr --no-remote %u/g' /usr/share/applications/firefox-esr.desktop 2>/dev/null || true

# [6] æ¸…ç†
apt autoremove -y; apt clean
echo ">>> [å†…éƒ¨] åŸºç¡€ç¯å¢ƒæ„å»ºå®Œæˆï¼"
EOF
    chmod +x "$TMP_WORKER"
}

# ==============================================================================
# ğŸ“¦ åŠŸèƒ½æ¨¡å—ï¼šå®‰è£… VSCode
# ==============================================================================
install_vscode_internal() {
    cat > "$PREFIX/tmp/vscode_install.sh" << 'EOF'
#!/bin/bash
echo ">>> [å†…éƒ¨] å¼€å§‹ä¸‹è½½ VSCode (ARM64)..."
# ä½¿ç”¨å¾®è½¯å®˜æ–¹/ç¤¾åŒºæ„å»ºçš„ ARM64 deb åŒ… (è¿™é‡Œä½¿ç”¨ code-oss å…¼å®¹æ€§æ›´å¥½ï¼Œæˆ–è€… vscode å®˜æ–¹)
# è€ƒè™‘åˆ°ç¨³å®šæ€§ï¼Œæˆ‘ä»¬ä¸‹è½½å®˜æ–¹ ARM64 deb
cd /tmp
wget -O vscode.deb "https://update.code.visualstudio.com/latest/linux-deb-arm64/stable"
echo ">>> [å†…éƒ¨] æ­£åœ¨å®‰è£… VSCode..."
apt install -y ./vscode.deb
rm vscode.deb
# ä¿®å¤å¯åŠ¨å‚æ•° (åŒæ ·éœ€è¦ --no-sandbox)
echo 'alias code="code --no-sandbox --unity-launch"' >> /etc/bash.bashrc
sed -i 's/Exec=\/usr\/share\/code\/code/Exec=\/usr\/share\/code\/code --no-sandbox/g' /usr/share/applications/code.desktop 2>/dev/null || true
echo ">>> [å†…éƒ¨] VSCode å®‰è£…å®Œæˆï¼è¯·åœ¨ç»ˆç«¯è¾“å…¥ code æˆ–åœ¨èœå•ä¸­å¯»æ‰¾ã€‚"
EOF
    chmod +x "$PREFIX/tmp/vscode_install.sh"
    
    log "æ­£åœ¨è°ƒç”¨å®¹å™¨å®‰è£… VSCode..."
    proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$PREFIX/tmp/vscode_install.sh"
    log "âœ… VSCode å®‰è£…æµç¨‹ç»“æŸã€‚"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# ==============================================================================
# ğŸ® ä¸»æœºç«¯é€»è¾‘
# ==============================================================================

log() { echo -e "${G}[XXY] $1${NC}"; }
err() { echo -e "${R}[é”™è¯¯] $1${NC}"; }

# 1. ç¯å¢ƒæ£€æŸ¥
check_deps() {
    log "è‡ªæ£€è¿è¡Œç¯å¢ƒ..."
    # ç¡®ä¿ X11 æºå­˜åœ¨
    if [ ! -f "$PREFIX/etc/apt/sources.list.d/x11.list" ]; then
        echo -e "${Y}æ·»åŠ  X11 æº...${NC}"
        pkg install x11-repo -y
    fi
    
    PKGS="proot-distro pulseaudio termux-x11-nightly virglrenderer-android android-tools"
    MISSING=""
    for p in $PKGS; do
        if ! command -v $p >/dev/null && ! dpkg -s $p >/dev/null 2>&1; then
             MISSING="$MISSING $p"
        fi
    done

    if [ -n "$MISSING" ]; then
        log "å®‰è£…ç¼ºå¤±ä¾èµ–: $MISSING"
        pkg update -y
        pkg install $MISSING -y -o Dpkg::Options::="--force-confnew"
    fi
}

# 2. ç³»ç»Ÿå®‰è£… (é‡æ„ç‰ˆ)
do_install() {
    clear
    log "=== å®‰è£… Debian ç”Ÿäº§åŠ›ç³»ç»Ÿ ==="
    ping -c 1 223.5.5.5 >/dev/null 2>&1 || { err "æ— ç½‘ç»œï¼è¯·æ£€æŸ¥ WiFi/æµé‡ã€‚"; sleep 2; return; }

    if [ -d "$ROOTFS" ]; then
        read -p "ç³»ç»Ÿå·²å­˜åœ¨ï¼Œæ˜¯å¦åˆ é™¤é‡è£…? (y/n): " opt
        if [ "$opt" == "y" ]; then
            proot-distro remove "$DISTRO_NAME"
        else
            return
        fi
    fi

    log "æ­£åœ¨ä¸‹è½½ Rootfs (å¦‚æœå¡ä½è¯·å¼€å¯ VPN)..."
    # æ¸…ç†æ—§ç¼“å­˜ä»¥é˜²ä¸‡ä¸€
    rm -rf "$PREFIX/var/lib/proot-distro/dlcache/$DISTRO_NAME"
    
    if proot-distro install "$DISTRO_NAME"; then
        # å†™å…¥ DNS é˜²æ­¢æ— ç½‘
        echo "nameserver 223.5.5.5" > "$ROOTFS/etc/resolv.conf"
        
        create_worker_script
        log "æ­£åœ¨è¿›å…¥å®¹å™¨é…ç½®ç¯å¢ƒ (Firefox/ä¸­æ–‡/æ¡Œé¢)..."
        proot-distro login "$DISTRO_NAME" --shared-tmp -- /bin/bash "$TMP_WORKER"
        
        rm -f "$TMP_WORKER"
        log "ğŸ‰ ç³»ç»Ÿå®‰è£…å®Œæˆï¼"
    else
        err "ä¸‹è½½å¤±è´¥ã€‚"
    fi
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# 3. å¯åŠ¨ X11 æ¡Œé¢
do_start() {
    if [ ! -d "$ROOTFS" ]; then err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; sleep 1; return; fi
    clear
    log "ğŸš€ æ­£åœ¨å¯åŠ¨ç”Ÿäº§åŠ›æ¡Œé¢..."
    
    # A. å”¤é†’ App
    am start --user 0 -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
    
    # B. æ¸…ç†æ—§è¿›ç¨‹
    killall -9 termux-x11 Xwayland pulseaudio virgl_test_server_android >/dev/null 2>&1
    
    # C. å¯åŠ¨ X11 æœåŠ¡
    termux-x11 :0 -ac &
    
    # D. ç­‰å¾… Socket
    count=0
    while [ ! -S "$PREFIX/tmp/.X11-unix/X0" ]; do
        sleep 0.2
        count=$((count+1))
        if [ $count -gt 25 ]; then err "Termux:X11 å¯åŠ¨è¶…æ—¶ï¼è¯·æ£€æŸ¥ APP æ˜¯å¦å®‰è£…ã€‚"; return; fi
    done
    
    # E. å¯åŠ¨ç¡¬ä»¶åŠ é€Ÿå’ŒéŸ³é¢‘
    virgl_test_server_android &
    pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
    
    log "æ­£åœ¨è¿›å…¥æ¡Œé¢..."
    log "æç¤ºï¼šæµè§ˆå™¨è¯·åœ¨èœå•ç‚¹å‡» Firefoxï¼Œæˆ–ç»ˆç«¯è¾“å…¥ firefox"
    
    # F. ç™»å½•å®¹å™¨
    proot-distro login "$DISTRO_NAME" --shared-tmp -- bash -c "
        export DISPLAY=:0
        export PULSE_SERVER=127.0.0.1
        # å¯åŠ¨è¾“å…¥æ³•åå°
        fcitx5 -d &
        # å¯åŠ¨æ¡Œé¢
        dbus-launch --exit-with-session startxfce4
    "
}

# 4. å…ç”µè„‘ç»´æŠ¤æ¨¡å—
do_adb_fix() {
    while true; do
        clear
        echo -e "${C}=== å…ç”µè„‘ç»´æŠ¤å·¥å…· ===${NC}"
        echo -e "${Y}å¦‚æœä¸æ‰§è¡Œæ­¤é¡¹ï¼Œæ‰“å¼€æµè§ˆå™¨/VSCode æ—¶ Termux ä¼šé—ªé€€ã€‚${NC}"
        echo "1. ä½¿ç”¨ Shizuku æˆæƒ (æ¨è)"
        echo "2. ä½¿ç”¨ æ— çº¿è°ƒè¯• (éœ€åˆ†å±)"
        echo "0. è¿”å›"
        read -p "é€‰æ‹©: " m
        case "$m" in
            1)
                if pkg list-installed | grep -q "rish"; then
                    cat > "$PREFIX/tmp/fix.sh" << 'EOF'
#!/system/bin/sh
/system/bin/device_config put activity_manager max_phantom_processes 2147483647
cmd appops set com.termux RUN_IN_BACKGROUND allow
echo "OK"
EOF
                    if rish -c "sh $PREFIX/tmp/fix.sh" | grep "OK"; then
                        echo -e "${G}âœ… ä¿®å¤æˆåŠŸï¼${NC}"; 
                    else
                        echo -e "${R}Shizuku æ‰§è¡Œå¤±è´¥ã€‚${NC}"
                    fi
                else
                    echo -e "${R}æœªå®‰è£… rish (Shizukuç»ˆç«¯å·¥å…·)ã€‚${NC}"
                fi
                read -n 1 -s -r -p "æŒ‰ä»»æ„é”®..." ;;
            2)
                # æ— çº¿è°ƒè¯•é€»è¾‘
                echo -e "${Y}è¯·å¼€å¯åˆ†å±ï¼Œæ‰“å¼€ å¼€å‘è€…é€‰é¡¹->æ— çº¿è°ƒè¯•${NC}"
                read -p "è¾“å…¥ IP:ç«¯å£ (é…å¯¹ç•Œé¢): " p_addr
                read -p "è¾“å…¥ é…å¯¹ç : " p_code
                adb pair "$p_addr" "$p_code"
                echo "----------------"
                read -p "è¾“å…¥ IP:ç«¯å£ (ä¸»ç•Œé¢): " c_addr
                adb connect "$c_addr"
                sleep 1
                adb shell "/system/bin/device_config put activity_manager max_phantom_processes 2147483647"
                adb shell "cmd appops set com.termux RUN_IN_BACKGROUND allow"
                echo -e "${G}âœ… æŒ‡ä»¤å·²å‘é€${NC}"
                read -n 1 -s -r -p "æŒ‰ä»»æ„é”®..." ;;
            0) return ;;
        esac
    done
}

# ==============================================================================
# ğŸ“º ä¸»èœå•
# ==============================================================================
check_deps

while true; do
    clear
    echo -e "${B}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${B}â”‚    XXY ç”Ÿäº§åŠ›å·¥å…·ç®± (Termux:X11)       â”‚${NC}"
    echo -e "${B}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "ç³»ç»ŸçŠ¶æ€: $(if [ -d "$ROOTFS" ]; then echo "${G}Debian å·²å®‰è£…${NC}"; else echo "${R}æœªå®‰è£…${NC}"; fi)"
    echo ""
    echo -e "1. ${G}å¯åŠ¨æ¡Œé¢ç¯å¢ƒ${NC} (XFCE4 + Firefox)"
    echo -e "2. ${Y}å®‰è£…/é‡ç½®ç³»ç»Ÿ${NC} (å…¨è‡ªåŠ¨é…ç½®ä¸­æ–‡)"
    echo -e "3. ${C}å®‰è£… VSCode${NC} (å®‰è£…ç³»ç»Ÿåæ‰§è¡Œ)"
    echo -e "4. ${R}ADB é˜²é—ªé€€ä¿®å¤${NC} (å…ç”µè„‘)"
    echo -e "5. æ¸…ç†ç¼“å­˜"
    echo -e "0. é€€å‡º"
    echo ""
    read -p "ğŸ‘‰ è¯·é€‰æ‹©: " choice
    
    case "$choice" in
        1) do_start ;;
        2) do_install ;;
        3) 
           if [ -d "$ROOTFS" ]; then install_vscode_internal; 
           else err "è¯·å…ˆå®‰è£…ç³»ç»Ÿï¼"; read -n 1 -s -r -p "Wait..."; fi ;;
        4) do_adb_fix ;;
        5) rm -rf "$PREFIX/var/lib/proot-distro/dlcache"; log "å·²æ¸…ç†"; sleep 1 ;;
        0) exit 0 ;;
        *) ;;
    esac
done

cat > $PREFIX/bin/xxy << 'EOF'
#!/bin/bash
# ==============================================================================
# PROJECT: XXY (UI FIXED EDITION v31.0)
# AUTHOR: XXY Team
# FIX: ä¿®å¤äº†å±å¹•æ»šåŠ¨/é¬¼å½±é‡å é—®é¢˜ (Ghosting Fix)
# ==============================================================================

# --- 0. ä¾èµ–è‡ªæ£€ ---
if ! command -v proot-distro &>/dev/null; then
    echo "æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ..."
    pkg update -y && pkg install proot-distro pulseaudio wget curl -y
fi

# --- ğŸ¨ é¢œè‰²å®šä¹‰ ---
R=$(tput setaf 1); G=$(tput setaf 2); Y=$(tput setaf 3)
B=$(tput setaf 4); P=$(tput setaf 5); C=$(tput setaf 6)
W=$(tput setaf 7); GR=$(tput setaf 8); NC=$(tput sgr0)

# --- ğŸ§  ç‰©ç†æ ¸å¿ƒ ---
get_installed_systems() {
    ROOTFS_DIR="$PREFIX/var/lib/proot-distro/installed-rootfs"
    if [ -d "$ROOTFS_DIR" ] && [ "$(ls -A $ROOTFS_DIR)" ]; then ls "$ROOTFS_DIR"; else echo ""; fi
}

# --- ğŸ”§ ä¸‡èƒ½å¼•æ“ ---
create_worker_script() {
    cat > $PREFIX/tmp/xxy_worker.sh << 'WORKER_EOF'
#!/bin/sh
task=$1
if command -v apt >/dev/null; then PM="apt"; INSTALL="apt install -y"; UPDATE="apt update -y";
elif command -v pacman >/dev/null; then PM="pacman"; INSTALL="pacman -S --noconfirm"; UPDATE="pacman -Sy --noconfirm";
elif command -v apk >/dev/null; then PM="apk"; INSTALL="apk add"; UPDATE="apk update";
else echo "Unknown PM"; exit 1; fi

case "$task" in
    update) $UPDATE ;;
    install_gui)
        if [ "$PM" = "apt" ]; then DEBIAN_FRONTEND=noninteractive $INSTALL xfce4 xfce4-goodies dbus-x11;
        elif [ "$PM" = "apk" ]; then $INSTALL xfce4 dbus-x11;
        else $INSTALL xfce4 dbus; fi ;;
    install_cn)
        if [ "$PM" = "apt" ]; then DEBIAN_FRONTEND=noninteractive $INSTALL locales fonts-noto-cjk; echo 'zh_CN.UTF-8 UTF-8' > /etc/locale.gen; locale-gen;
        elif [ "$PM" = "pacman" ]; then $INSTALL noto-fonts-cjk; echo 'zh_CN.UTF-8 UTF-8' >> /etc/locale.gen; locale-gen;
        elif [ "$PM" = "apk" ]; then $INSTALL font-noto-cjk; fi
        if ! grep -q "LANG=zh_CN.UTF-8" /etc/profile; then echo 'export LANG=zh_CN.UTF-8' >> /etc/profile; fi ;;
    install_tools) $INSTALL wget git nano curl ;;
    install_fetch)
        if $INSTALL fastfetch; then echo "FETCH_TOOL=fastfetch" > /tmp/fetch_status;
        elif $INSTALL neofetch; then echo "FETCH_TOOL=neofetch" > /tmp/fetch_status;
        else echo "FETCH_TOOL=none" > /tmp/fetch_status; fi ;;
esac
WORKER_EOF
    chmod +x $PREFIX/tmp/xxy_worker.sh
}

run_bg_safe() {
    local sys=$1; local task=$2; local desc=$3
    # æš‚æ—¶æ¢å¤å…‰æ ‡ä½ç½®æ‰“å°æ—¥å¿—
    tput cup 18 0; echo -ne "${Y}âš™ï¸  $desc ($sys)...                                ${NC}"
    create_worker_script
    proot-distro login "$sys" --shared-tmp -- /bin/sh /tmp/xxy_worker.sh "$task" >/dev/null 2>&1
    tput cup 18 0; 
    if [ $? -eq 0 ]; then echo -ne "${G}âœ… $desc å®Œæˆ                                  ${NC}"; else echo -ne "${R}âš ï¸ $desc å¤±è´¥                                  ${NC}"; fi
    rm -f $PREFIX/tmp/xxy_worker.sh
}

# --- ğŸ“¦ åŠŸèƒ½æ¨¡å— ---
f_login() {
    clear; echo -e "${C}=== ç™»å½•ç³»ç»Ÿ ===${NC}"
    SYS_LIST=$(get_installed_systems)
    if [ -z "$SYS_LIST" ]; then echo "æ— ç³»ç»Ÿ"; read -p "..."; return; fi
    SYS=($SYS_LIST)
    for i in "${!SYS[@]}"; do echo -e "${G}$((i+1)).${NC} ${SYS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    read -p "ğŸ‘‰ åºå·: " idx
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#SYS[@]}" ]; then
        TARGET=${SYS[$((idx-1))]}
        create_worker_script
        proot-distro login "$TARGET" --shared-tmp -- /bin/sh /tmp/xxy_worker.sh "install_fetch" >/dev/null 2>&1
        INJECTor="RC=~/.bashrc; sed -i '/fastfetch/d' \$RC; sed -i '/neofetch/d' \$RC;
        if [ -f /tmp/fetch_status ]; then . /tmp/fetch_status; [ \"\$FETCH_TOOL\" != \"none\" ] && echo \"\$FETCH_TOOL\" >> \$RC; rm -f /tmp/fetch_status; fi"
        echo "$INJECTor" > $PREFIX/tmp/injector.sh
        proot-distro login "$TARGET" --shared-tmp -- /bin/sh /tmp/injector.sh >/dev/null 2>&1
        rm $PREFIX/tmp/injector.sh
        tput cnorm; proot-distro login $TARGET; tput civis
    fi
}

f_install() {
    clear; echo -e "${C}=== å®‰è£…ç³»ç»Ÿ ===${NC}"
    OPTS=("ubuntu" "debian" "kali" "archlinux" "alpine")
    for i in "${!OPTS[@]}"; do echo -e "${W}$((i+1)).${NC} ${OPTS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    read -p "ğŸ‘‰ é€‰æ‹©: " idx
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -ge 1 ] && [ "$idx" -le "${#OPTS[@]}" ]; then
        TARGET=${OPTS[$((idx-1))]}
        if [ -d "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET" ]; then echo "å·²å­˜åœ¨"; read -p "..."; return; fi
        echo "æ­£åœ¨å®‰è£… $TARGET ..."
        if proot-distro install $TARGET; then
            run_bg_safe "$TARGET" "update" "æ›´æ–°"
            run_bg_safe "$TARGET" "install_cn" "ä¸­æ–‡"
            run_bg_safe "$TARGET" "install_fetch" "ç¾åŒ–"
            echo -e "\n${G}å®Œæˆï¼${NC}"; read -p "..."
        fi
    fi
}

f_gui() {
    clear; echo -e "${C}=== å¯åŠ¨æ¡Œé¢ ===${NC}"
    SYS_LIST=$(get_installed_systems)
    if [ -z "$SYS_LIST" ]; then echo "æ— ç³»ç»Ÿ"; read -p "..."; return; fi
    SYS=($SYS_LIST)
    for i in "${!SYS[@]}"; do echo -e "${G}$((i+1)).${NC} ${SYS[$i]}"; done
    echo -e "${W}0.${NC} è¿”å›"
    read -p "ğŸ‘‰ åºå·: " idx
    if [ "$idx" == "0" ]; then return; fi
    TARGET=${SYS[$((idx-1))]}
    
    echo "æ£€æŸ¥ç¯å¢ƒ..."
    proot-distro login "$TARGET" -- bash -c "command -v startxfce4" >/dev/null 2>&1
    if [ $? -ne 0 ]; then run_bg_safe "$TARGET" "install_gui" "å®‰è£…XFCE"; fi

    echo -e "\n1. Termux:X11\n2. VNC\n0. è¿”å›"
    read -p "æ¨¡å¼: " m
    if [ "$m" == "1" ]; then
        pulseaudio --kill >/dev/null 2>&1; pkill -f com.termux.x11 >/dev/null 2>&1; rm -rf $PREFIX/tmp/.X11-unix
        pulseaudio --start --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" --exit-idle-time=-1
        termux-x11 :0 >/dev/null 2>&1 &
        CMD="export DISPLAY=:0 PULSE_SERVER=127.0.0.1; dbus-launch --exit-with-session startxfce4"
        proot-distro login "$TARGET" --shared-tmp -- bash -c "$CMD"
    elif [ "$m" == "2" ]; then
        proot-distro login "$TARGET" -- bash -c "vncserver -kill :1; rm -rf /tmp/.X1-lock; vncserver :1"
        echo "åœ°å€: 127.0.0.1:5901"; read -p "..."
    fi
}

f_manage() {
    clear; SYS_LIST=$(get_installed_systems)
    if [ -z "$SYS_LIST" ]; then echo "æ— ç³»ç»Ÿ"; read -p "..."; return; fi
    SYS=($SYS_LIST); for i in "${!SYS[@]}"; do echo "$((i+1)). ${SYS[$i]}"; done
    read -p "åˆ é™¤åºå·: " idx
    TARGET=${SYS[$((idx-1))]}
    [ ! -z "$TARGET" ] && proot-distro remove $TARGET && rm -rf "$PREFIX/var/lib/proot-distro/installed-rootfs/$TARGET"
    echo "å·²åˆ é™¤"; read -p "..."
}

# --- UI æ ¸å¿ƒä¿®å¤ (ä½¿ç”¨ printf é˜²æ­¢æ¢è¡Œæ»šåŠ¨) ---
update_hud() {
    NOW=$(date "+%H:%M")
    if (( FRAME % 20 == 0 )); then
        MEM=$(free -m | awk 'NR==2{printf "%.1fG", $3/1024}')
    fi
    # ç»å¯¹å®šä½æ›´æ–°ï¼Œä¸ä½¿ç”¨ echo é¿å…æ¢è¡Œ
    tput cup 0 34; printf "${B}â•­â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 1 34; printf "${B}â”‚${NC} TIME: ${W}%-5s${NC} MEM: ${P}%-5s${NC}         ${B}â”‚${NC}" "$NOW" "$MEM"
    tput cup 2 34; printf "${B}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
}

draw_static() {
    clear
    printf "${C}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— ${W}XXY ç»ˆæç‰ˆ${NC}\n"
    printf "${C}â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â• ${GR}v31.0 | UI Fixed${NC}\n"
    printf "${C} â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  ${NC}\n"
    printf "${C} â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ•”â•   ${NC}\n"
    
    tput cup 8 0
    printf "${GR}â•­â”€â”€ [ å¸¸ç”¨åŠŸèƒ½ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€ [ æå®¢åŠŸèƒ½ ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}\n"
    printf "${GR}â”‚${NC} ${W}1.${NC} ç™»å½•ç³»ç»Ÿ (Login)          ${GR}â”‚ â”‚${NC} ${W}4.${NC} å¸è½½ç³»ç»Ÿ (Uninstall)    ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}2.${NC} å®‰è£…æ–°ç³»ç»Ÿ (Install)      ${GR}â”‚ â”‚${NC} ${W}0.${NC} é€€å‡ºç¨‹åº (Exit)         ${GR}â”‚${NC}\n"
    printf "${GR}â”‚${NC} ${W}3.${NC} å¯åŠ¨æ¡Œé¢ (GUI Mode)       ${GR}â”‚ â”‚${NC}                                 ${GR}â”‚${NC}\n"
    printf "${GR}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}\n"
}

# --- ä¸»å¾ªç¯ ---
tput civis # éšè—å…‰æ ‡
stty -echo # å…³é—­å›æ˜¾
draw_static
USER_IN=""; FRAME=0; COLORS=($R $Y $G $C $B $P)

while true; do
    update_hud
    ((FRAME++))
    C_IDX=$((FRAME % 6)); CUR_C=${COLORS[$C_IDX]}
    
    # ä¿®å¤ï¼šä½¿ç”¨ç»å¯¹å®šä½ + printf ç»˜åˆ¶è¾“å…¥æ¡†ï¼Œç¡®ä¿ä¸äº§ç”Ÿæ¢è¡Œç¬¦
    tput cup 14 0; printf "${CUR_C}â•­â”€â”€ è¯·è¾“å…¥åºå· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    tput cup 15 0; printf "${CUR_C}â”‚${NC} ${C}â¤${NC} %-40s           ${CUR_C}â”‚${NC}" "$USER_IN${W}â–ˆ${NC}"
    tput cup 16 0; printf "${CUR_C}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"

    read -t 0.1 -n 1 k
    if [[ $? -eq 0 ]]; then
        if [[ "$k" == "" ]]; then
            if [[ -n "$USER_IN" ]]; then
                tput cnorm; stty echo; # æ¢å¤å…‰æ ‡å’Œå›æ˜¾
                case $USER_IN in
                    1) f_login ;;
                    2) f_install ;;
                    3) f_gui ;;
                    4) f_manage ;;
                    0) clear; exit 0 ;;
                esac
                tput civis; stty -echo; draw_static; USER_IN=""
            fi
        elif [[ "$k" == $'\x7f' ]]; then USER_IN="${USER_IN%?}"
        elif [[ "$k" == $'\e' ]]; then read -t 0.01 -n 2
        else USER_IN="$USER_IN$k"
        fi
    fi
done
EOF
chmod +x $PREFIX/bin/xxy
echo -e "\033[1;32mâœ… XXY v31.0 (UI ä¿®å¤ç‰ˆ) å·²å®‰è£…ã€‚\nä¸å†é—ªå±ï¼Œç”»é¢ç¨³å®šå¦‚é“ï¼\033[0m"
